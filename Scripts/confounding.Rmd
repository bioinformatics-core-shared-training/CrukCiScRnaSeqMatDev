---
title: "CRUK CI Summer School 2020 - introduction to single-cell RNA-seq analysis"
subtitle: 'Detection of confounding factors'

author: "Stephane Ballereau, Zeynep Kalender Atak, Katarzyna Kania"
output:
  html_notebook:
    code_folding: hide
    toc: yes
    toc_float: yes
    number_sections: true
  html_document:
    df_print: paged
    toc: yes
    number_sections: true
    code_folding: hide
  html_book:
    code_folding: hide
params:
  projDir: "/ssd/personal/baller01/20200511_FernandesM_ME_crukBiSs2020"
  dirRel: ".."
  inpDirBit: "AnaWiSce/Ana1"
  outDirBit: "AnaWiSce/Ana1"
  bookType: "mk"
  cacheBool: FALSE
---

# Identifying confounding factors - `r "{{setNameUpp}}"` set

```{r {{setNameUpp}}_confound_setup, cache=FALSE, dev="CairoPNG"}
knitr::opts_chunk$set(dev="CairoPNG")
```

```{r {{setNameUpp}}_confound_variables, cache=FALSE}
normPlotDirBit <- "Plots/Norm" # "ConfoundPlots"
#setNameUpp <- "Caron"
#setNameLow <- "caron"
setName <- tolower("{{setNameUpp}}")
setSuf <- "_5hCellPerSpl"
typeNorm <- "scran"

projDir <- params$projDir
dirRel <- params$dirRel
outDirBit <- params$outDirBit
```

`r setName`

```{r {{setNameUpp}}_confound_libraries, include=FALSE}
library(scater)
library(scran)
library(ggplot2)
library(dplyr)
library(BiocSingular)
```

<!--
Should have Caron and HCA separately
-->

## Load object 

```{r {{setNameUpp}}_confound_readIn, cache=FALSE}
# Read object in:
tmpFn <- sprintf("%s/%s/Robjects/%s_sce_nz_postDeconv%s.Rds",
		 projDir, outDirBit, setName, setSuf)
tmpFn
#getwd()
#file.exists(tmpFn)
sce <- readRDS(tmpFn)
sce
```

## PCA

Remember scran PCA:

Normalised counts are stored in 'logcounts' assay

```{r {{setNameUpp}}_confound_postQcPcaPlotDraw, eval=FALSE}
# 
scranPca <- runPCA(
  sce,
  exprs_values = "logcounts"
)
```

PCA plot for the '`r typeNorm`' counts in the `r setName` set.

```{r {{setNameUpp}}_confound_postQcPcaPlotShow, out.width="80%", eval=FALSE}
tmpFn <- sprintf("%s/%s/%s/%s_sce_nz_postQc%s_%sPca.png",
		 #projDir, outDirBit, normPlotDirBit, setName, setSuf, typeNorm)
		 dirRel, normPlotDirBit, setName, setSuf, typeNorm)
tmpFn
knitr::include_graphics(tmpFn, auto_pdf = TRUE)
```

```{r {{setNameUpp}}_confound_postDeconvPcaComp, eval=FALSE}
#options(BiocSingularParam.default=IrlbaParam())
options(BiocSingularParam.default=ExactParam())

qclust <- quickCluster(sce, min.size = 30, use.ranks = FALSE)
sce <- computeSumFactors(sce, sizes = 15, clusters = qclust)
sce <- logNormCounts(sce)
```

Perform PCA:

```{r {{setNameUpp}}_confound_postDeconvPcaPlotShow}
reducedDim(sce, "PCA") <- reducedDim(
  runPCA(sce, exprs_values = "logcounts", ncomponents = 10), "PCA")

plotPCA(
    sce,
    colour_by = "Sample.Name",
    size_by = "sum",
    shape_by = "source_name"
)
```

<!--
## Raw counts
-->

<!--
Correlation with PCs: logcounts_raw:
-->

```{r {{setNameUpp}}_confound_logcounts_raw, eval=FALSE}
assay(sce, "logcounts_raw") <- log2(counts(sce)+1)
```

```{r {{setNameUpp}}_confound_raw_getExpPc, eval=FALSE}
# on norm count https://biocellgen-public.svi.edu.au/mig_2019_scrnaseq-workshop/public/normalization-confounders-and-batch-correction.html#identifying-confounding-factors
# on logcounts_raw https://scrnaseq-course.cog.sanger.ac.uk/website/cleaning-the-expression-matrix.html#correlations-with-pcs
# a bit long

# issue with scale, trying with explanPc/100
# see next chunk too

explanPc <- getExplanatoryPCs(
    sce,
    exprs_values = "logcounts_raw",
    variables = c(
        "sum",
	"detected",
        "source_name",
        "Sample.Name",
	"subsets_Mito_percent"
    )
)
plotExplanatoryPCs(explanPc/100) 
```

<!--
Explanatory variables: logcounts_raw:
-->

```{r {{setNameUpp}}_confound_raw_getExpVar, eval=FALSE}

# on logcounts_raw
# https://biocellgen-public.svi.edu.au/mig_2019_scrnaseq-workshop/public/normalization-confounders-and-batch-correction.html#identifying-confounding-factors

plotExplanatoryVariables(
    sce,
    exprs_values = "logcounts_raw",
    #exprs_values = "counts",
    #exprs_values = "logcounts",
    variables = c(
        "sum",
	"detected",
        "source_name",
        "Sample.Name",
	"subsets_Mito_percent"
    )
)
```

## Normalised counts

Correlation with PCs: logcounts (normalised):

```{r {{setNameUpp}}_confound_norm_getExpPc}
# on norm count https://biocellgen-public.svi.edu.au/mig_2019_scrnaseq-workshop/public/normalization-confounders-and-batch-correction.html#identifying-confounding-factors
# on logcounts_raw https://scrnaseq-course.cog.sanger.ac.uk/website/cleaning-the-expression-matrix.html#correlations-with-pcs
# a bit long
colData(sce)$source_name <- factor(colData(sce)$source_name)
explanPc <- getExplanatoryPCs(sce,
    #exprs_values = "logcounts", # default
    variables = c(
        "sum",
        "detected",
        "source_name",
        "Sample.Name",
        "subsets_Mito_percent"
    )
)
plotExplanatoryPCs(explanPc/100) 
```

Explanatory variables: logcounts (normalised):

```{r {{setNameUpp}}_confound_norm_getExpVar}

# on logcounts_raw
# https://biocellgen-public.svi.edu.au/mig_2019_scrnaseq-workshop/public/normalization-confounders-and-batch-correction.html#identifying-confounding-factors

plotExplanatoryVariables(
    sce,
    # exprs_values = "logcounts", # default
    variables = c(
        "sum",
        "detected",
        "source_name",
        "Sample.Name",
        "subsets_Mito_percent"
    )
)
```

```{r tidy_confounding}
rm(sce)
```
