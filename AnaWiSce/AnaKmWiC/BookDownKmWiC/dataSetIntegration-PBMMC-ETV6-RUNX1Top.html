<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 18 Data integration - PBMMC + ETV6-RUNX | CRUK Bioinformatics Summer School 2020 - single-cell RNA-seq analysis</title>
  <meta name="description" content="A report for all analyses (bookdown::gitbook)." />
  <meta name="generator" content="bookdown 0.22 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 18 Data integration - PBMMC + ETV6-RUNX | CRUK Bioinformatics Summer School 2020 - single-cell RNA-seq analysis" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="A report for all analyses (bookdown::gitbook)." />
  <meta name="github-repo" content="rstudio/bookdown-demo" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 18 Data integration - PBMMC + ETV6-RUNX | CRUK Bioinformatics Summer School 2020 - single-cell RNA-seq analysis" />
  
  <meta name="twitter:description" content="A report for all analyses (bookdown::gitbook)." />
  

<meta name="author" content="Stephane Ballereau, Zeynep Kalender Atak" />


<meta name="date" content="2021-05-13" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="DataIntegrationPretTop.html"/>
<link rel="next" href="dataSetIntegration-allSetsTop.html"/>
<script src="libs/jquery-3.5.1/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script>
<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>
<script src="libs/htmlwidgets-1.5.3/htmlwidgets.js"></script>
<link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet" />
<script src="libs/datatables-binding-0.18/datatables.js"></script>
<link href="libs/dt-core-1.10.20/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="libs/dt-core-1.10.20/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="libs/dt-core-1.10.20/js/jquery.dataTables.min.js"></script>
<link href="libs/crosstalk-1.1.1/css/crosstalk.css" rel="stylesheet" />
<script src="libs/crosstalk-1.1.1/js/crosstalk.min.js"></script>
<link href="libs/nouislider-7.0.10/jquery.nouislider.min.css" rel="stylesheet" />
<script src="libs/nouislider-7.0.10/jquery.nouislider.min.js"></script>
<link href="libs/selectize-0.12.0/selectize.bootstrap3.css" rel="stylesheet" />
<script src="libs/selectize-0.12.0/selectize.min.js"></script>

<script>
/* ========================================================================
 * Bootstrap: transition.js v3.3.7
 * http://getbootstrap.com/javascript/#transitions
 * ========================================================================
 * Copyright 2011-2016 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 * ======================================================================== */


+function ($) {
  'use strict';

  // CSS TRANSITION SUPPORT (Shoutout: http://www.modernizr.com/)
  // ============================================================

  function transitionEnd() {
    var el = document.createElement('bootstrap')

    var transEndEventNames = {
      WebkitTransition : 'webkitTransitionEnd',
      MozTransition    : 'transitionend',
      OTransition      : 'oTransitionEnd otransitionend',
      transition       : 'transitionend'
    }

    for (var name in transEndEventNames) {
      if (el.style[name] !== undefined) {
        return { end: transEndEventNames[name] }
      }
    }

    return false // explicit for ie8 (  ._.)
  }

  // http://blog.alexmaccaw.com/css-transitions
  $.fn.emulateTransitionEnd = function (duration) {
    var called = false
    var $el = this
    $(this).one('bsTransitionEnd', function () { called = true })
    var callback = function () { if (!called) $($el).trigger($.support.transition.end) }
    setTimeout(callback, duration)
    return this
  }

  $(function () {
    $.support.transition = transitionEnd()

    if (!$.support.transition) return

    $.event.special.bsTransitionEnd = {
      bindType: $.support.transition.end,
      delegateType: $.support.transition.end,
      handle: function (e) {
        if ($(e.target).is(this)) return e.handleObj.handler.apply(this, arguments)
      }
    }
  })

}(jQuery);
</script>
<script>
/* ========================================================================
 * Bootstrap: collapse.js v3.3.7
 * http://getbootstrap.com/javascript/#collapse
 * ========================================================================
 * Copyright 2011-2016 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 * ======================================================================== */

/* jshint latedef: false */

+function ($) {
  'use strict';

  // COLLAPSE PUBLIC CLASS DEFINITION
  // ================================

  var Collapse = function (element, options) {
    this.$element      = $(element)
    this.options       = $.extend({}, Collapse.DEFAULTS, options)
    this.$trigger      = $('[data-toggle="collapse"][href="#' + element.id + '"],' +
                           '[data-toggle="collapse"][data-target="#' + element.id + '"]')
    this.transitioning = null

    if (this.options.parent) {
      this.$parent = this.getParent()
    } else {
      this.addAriaAndCollapsedClass(this.$element, this.$trigger)
    }

    if (this.options.toggle) this.toggle()
  }

  Collapse.VERSION  = '3.3.7'

  Collapse.TRANSITION_DURATION = 350

  Collapse.DEFAULTS = {
    toggle: true
  }

  Collapse.prototype.dimension = function () {
    var hasWidth = this.$element.hasClass('width')
    return hasWidth ? 'width' : 'height'
  }

  Collapse.prototype.show = function () {
    if (this.transitioning || this.$element.hasClass('in')) return

    var activesData
    var actives = this.$parent && this.$parent.children('.panel').children('.in, .collapsing')

    if (actives && actives.length) {
      activesData = actives.data('bs.collapse')
      if (activesData && activesData.transitioning) return
    }

    var startEvent = $.Event('show.bs.collapse')
    this.$element.trigger(startEvent)
    if (startEvent.isDefaultPrevented()) return

    if (actives && actives.length) {
      Plugin.call(actives, 'hide')
      activesData || actives.data('bs.collapse', null)
    }

    var dimension = this.dimension()

    this.$element
      .removeClass('collapse')
      .addClass('collapsing')[dimension](0)
      .attr('aria-expanded', true)

    this.$trigger
      .removeClass('collapsed')
      .attr('aria-expanded', true)

    this.transitioning = 1

    var complete = function () {
      this.$element
        .removeClass('collapsing')
        .addClass('collapse in')[dimension]('')
      this.transitioning = 0
      this.$element
        .trigger('shown.bs.collapse')
    }

    if (!$.support.transition) return complete.call(this)

    var scrollSize = $.camelCase(['scroll', dimension].join('-'))

    this.$element
      .one('bsTransitionEnd', $.proxy(complete, this))
      .emulateTransitionEnd(Collapse.TRANSITION_DURATION)[dimension](this.$element[0][scrollSize])
  }

  Collapse.prototype.hide = function () {
    if (this.transitioning || !this.$element.hasClass('in')) return

    var startEvent = $.Event('hide.bs.collapse')
    this.$element.trigger(startEvent)
    if (startEvent.isDefaultPrevented()) return

    var dimension = this.dimension()

    this.$element[dimension](this.$element[dimension]())[0].offsetHeight

    this.$element
      .addClass('collapsing')
      .removeClass('collapse in')
      .attr('aria-expanded', false)

    this.$trigger
      .addClass('collapsed')
      .attr('aria-expanded', false)

    this.transitioning = 1

    var complete = function () {
      this.transitioning = 0
      this.$element
        .removeClass('collapsing')
        .addClass('collapse')
        .trigger('hidden.bs.collapse')
    }

    if (!$.support.transition) return complete.call(this)

    this.$element
      [dimension](0)
      .one('bsTransitionEnd', $.proxy(complete, this))
      .emulateTransitionEnd(Collapse.TRANSITION_DURATION)
  }

  Collapse.prototype.toggle = function () {
    this[this.$element.hasClass('in') ? 'hide' : 'show']()
  }

  Collapse.prototype.getParent = function () {
    return $(this.options.parent)
      .find('[data-toggle="collapse"][data-parent="' + this.options.parent + '"]')
      .each($.proxy(function (i, element) {
        var $element = $(element)
        this.addAriaAndCollapsedClass(getTargetFromTrigger($element), $element)
      }, this))
      .end()
  }

  Collapse.prototype.addAriaAndCollapsedClass = function ($element, $trigger) {
    var isOpen = $element.hasClass('in')

    $element.attr('aria-expanded', isOpen)
    $trigger
      .toggleClass('collapsed', !isOpen)
      .attr('aria-expanded', isOpen)
  }

  function getTargetFromTrigger($trigger) {
    var href
    var target = $trigger.attr('data-target')
      || (href = $trigger.attr('href')) && href.replace(/.*(?=#[^\s]+$)/, '') // strip for ie7

    return $(target)
  }


  // COLLAPSE PLUGIN DEFINITION
  // ==========================

  function Plugin(option) {
    return this.each(function () {
      var $this   = $(this)
      var data    = $this.data('bs.collapse')
      var options = $.extend({}, Collapse.DEFAULTS, $this.data(), typeof option == 'object' && option)

      if (!data && options.toggle && /show|hide/.test(option)) options.toggle = false
      if (!data) $this.data('bs.collapse', (data = new Collapse(this, options)))
      if (typeof option == 'string') data[option]()
    })
  }

  var old = $.fn.collapse

  $.fn.collapse             = Plugin
  $.fn.collapse.Constructor = Collapse


  // COLLAPSE NO CONFLICT
  // ====================

  $.fn.collapse.noConflict = function () {
    $.fn.collapse = old
    return this
  }


  // COLLAPSE DATA-API
  // =================

  $(document).on('click.bs.collapse.data-api', '[data-toggle="collapse"]', function (e) {
    var $this   = $(this)

    if (!$this.attr('data-target')) e.preventDefault()

    var $target = getTargetFromTrigger($this)
    var data    = $target.data('bs.collapse')
    var option  = data ? 'toggle' : $this.data()

    Plugin.call($target, option)
  })

}(jQuery);
</script>
<script>
window.initializeCodeFolding = function(show) {

  // handlers for show-all and hide all
  $("#rmd-show-all-code").click(function() {
    $('div.r-code-collapse').each(function() {
      $(this).collapse('show');
    });
  });
  $("#rmd-hide-all-code").click(function() {
    $('div.r-code-collapse').each(function() {
      $(this).collapse('hide');
    });
  });

  // index for unique code element ids
  var currentIndex = 1;

  // select all R code blocks
  var rCodeBlocks = $('pre.sourceCode, pre.r, pre.python, pre.bash, pre.sql, pre.cpp, pre.stan');
  rCodeBlocks.each(function() {

    // create a collapsable div to wrap the code in
    var div = $('<div class="collapse r-code-collapse"></div>');
    if (show)
      div.addClass('in');
    var id = 'rcode-643E0F36' + currentIndex++;
    div.attr('id', id);
    $(this).before(div);
    $(this).detach().appendTo(div);

    // add a show code button right above
    var showCodeText = $('<span>' + (show ? 'Hide' : 'Code') + '</span>');
    var showCodeButton = $('<button type="button" class="btn btn-default btn-xs code-folding-btn pull-right"></button>');
    showCodeButton.append(showCodeText);
    showCodeButton
        .attr('data-toggle', 'collapse')
        .attr('data-target', '#' + id)
        .attr('aria-expanded', show)
        .attr('aria-controls', id);

    var buttonRow = $('<div class="row"></div>');
    var buttonCol = $('<div class="col-md-12"></div>');

    buttonCol.append(showCodeButton);
    buttonRow.append(buttonCol);

    div.before(buttonRow);

    // update state of button on show/hide
    div.on('hidden.bs.collapse', function () {
      showCodeText.text('Code');
    });
    div.on('show.bs.collapse', function () {
      showCodeText.text('Hide');
    });
  });

}
</script>
<script>
/* ========================================================================
 * Bootstrap: dropdown.js v3.3.7
 * http://getbootstrap.com/javascript/#dropdowns
 * ========================================================================
 * Copyright 2011-2016 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 * ======================================================================== */


+function ($) {
  'use strict';

  // DROPDOWN CLASS DEFINITION
  // =========================

  var backdrop = '.dropdown-backdrop'
  var toggle   = '[data-toggle="dropdown"]'
  var Dropdown = function (element) {
    $(element).on('click.bs.dropdown', this.toggle)
  }

  Dropdown.VERSION = '3.3.7'

  function getParent($this) {
    var selector = $this.attr('data-target')

    if (!selector) {
      selector = $this.attr('href')
      selector = selector && /#[A-Za-z]/.test(selector) && selector.replace(/.*(?=#[^\s]*$)/, '') // strip for ie7
    }

    var $parent = selector && $(selector)

    return $parent && $parent.length ? $parent : $this.parent()
  }

  function clearMenus(e) {
    if (e && e.which === 3) return
    $(backdrop).remove()
    $(toggle).each(function () {
      var $this         = $(this)
      var $parent       = getParent($this)
      var relatedTarget = { relatedTarget: this }

      if (!$parent.hasClass('open')) return

      if (e && e.type == 'click' && /input|textarea/i.test(e.target.tagName) && $.contains($parent[0], e.target)) return

      $parent.trigger(e = $.Event('hide.bs.dropdown', relatedTarget))

      if (e.isDefaultPrevented()) return

      $this.attr('aria-expanded', 'false')
      $parent.removeClass('open').trigger($.Event('hidden.bs.dropdown', relatedTarget))
    })
  }

  Dropdown.prototype.toggle = function (e) {
    var $this = $(this)

    if ($this.is('.disabled, :disabled')) return

    var $parent  = getParent($this)
    var isActive = $parent.hasClass('open')

    clearMenus()

    if (!isActive) {
      if ('ontouchstart' in document.documentElement && !$parent.closest('.navbar-nav').length) {
        // if mobile we use a backdrop because click events don't delegate
        $(document.createElement('div'))
          .addClass('dropdown-backdrop')
          .insertAfter($(this))
          .on('click', clearMenus)
      }

      var relatedTarget = { relatedTarget: this }
      $parent.trigger(e = $.Event('show.bs.dropdown', relatedTarget))

      if (e.isDefaultPrevented()) return

      $this
        .trigger('focus')
        .attr('aria-expanded', 'true')

      $parent
        .toggleClass('open')
        .trigger($.Event('shown.bs.dropdown', relatedTarget))
    }

    return false
  }

  Dropdown.prototype.keydown = function (e) {
    if (!/(38|40|27|32)/.test(e.which) || /input|textarea/i.test(e.target.tagName)) return

    var $this = $(this)

    e.preventDefault()
    e.stopPropagation()

    if ($this.is('.disabled, :disabled')) return

    var $parent  = getParent($this)
    var isActive = $parent.hasClass('open')

    if (!isActive && e.which != 27 || isActive && e.which == 27) {
      if (e.which == 27) $parent.find(toggle).trigger('focus')
      return $this.trigger('click')
    }

    var desc = ' li:not(.disabled):visible a'
    var $items = $parent.find('.dropdown-menu' + desc)

    if (!$items.length) return

    var index = $items.index(e.target)

    if (e.which == 38 && index > 0)                 index--         // up
    if (e.which == 40 && index < $items.length - 1) index++         // down
    if (!~index)                                    index = 0

    $items.eq(index).trigger('focus')
  }


  // DROPDOWN PLUGIN DEFINITION
  // ==========================

  function Plugin(option) {
    return this.each(function () {
      var $this = $(this)
      var data  = $this.data('bs.dropdown')

      if (!data) $this.data('bs.dropdown', (data = new Dropdown(this)))
      if (typeof option == 'string') data[option].call($this)
    })
  }

  var old = $.fn.dropdown

  $.fn.dropdown             = Plugin
  $.fn.dropdown.Constructor = Dropdown


  // DROPDOWN NO CONFLICT
  // ====================

  $.fn.dropdown.noConflict = function () {
    $.fn.dropdown = old
    return this
  }


  // APPLY TO STANDARD DROPDOWN ELEMENTS
  // ===================================

  $(document)
    .on('click.bs.dropdown.data-api', clearMenus)
    .on('click.bs.dropdown.data-api', '.dropdown form', function (e) { e.stopPropagation() })
    .on('click.bs.dropdown.data-api', toggle, Dropdown.prototype.toggle)
    .on('keydown.bs.dropdown.data-api', toggle, Dropdown.prototype.keydown)
    .on('keydown.bs.dropdown.data-api', '.dropdown-menu', Dropdown.prototype.keydown)

}(jQuery);
</script>
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
.row { display: flex; }
.collapse { display: none; }
.in { display:block }
.pull-right > .dropdown-menu {
    right: 0;
    left: auto;
}
.open > .dropdown-menu {
    display: block;
}
.dropdown-menu {
    position: absolute;
    top: 100%;
    left: 0;
    z-index: 1000;
    display: none;
    float: left;
    min-width: 160px;
    padding: 5px 0;
    margin: 2px 0 0;
    font-size: 14px;
    text-align: left;
    list-style: none;
    background-color: #fff;
    -webkit-background-clip: padding-box;
    background-clip: padding-box;
    border: 1px solid #ccc;
    border: 1px solid rgba(0,0,0,.15);
    border-radius: 4px;
    -webkit-box-shadow: 0 6px 12px rgba(0,0,0,.175);
    box-shadow: 0 6px 12px rgba(0,0,0,.175);
}
</style>
<script>
$(document).ready(function () {
  window.initializeCodeFolding("show" === "hide");
});
</script>


<script>
document.write('<div class="btn-group pull-right" style="position: absolute; top: 20%; right: 2%; z-index: 200"><button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true" data-_extension-text-contrast=""><span>Code</span> <span class="caret"></span></button><ul class="dropdown-menu" style="min-width: 50px;"><li><a id="rmd-show-all-code" href="#">Show All Code</a></li><li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li></ul></div>')
</script>


<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">CRUK Functional Genomics Summer School 2020</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Preamble</a><ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#the-study"><i class="fa fa-check"></i><b>1.1</b> The study</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#the-plan"><i class="fa fa-check"></i><b>1.2</b> The plan</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#the-analyses"><i class="fa fa-check"></i><b>1.3</b> The analyses</a></li>
<li class="chapter" data-level="1.4" data-path="index.html"><a href="index.html#overall-summary"><i class="fa fa-check"></i><b>1.4</b> Overall summary</a></li>
<li class="chapter" data-level="1.5" data-path="index.html"><a href="index.html#conclusion"><i class="fa fa-check"></i><b>1.5</b> Conclusion</a></li>
<li class="chapter" data-level="1.6" data-path="index.html"><a href="index.html#abbreviations"><i class="fa fa-check"></i><b>1.6</b> Abbreviations</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="SeqQualTop.html"><a href="SeqQualTop.html"><i class="fa fa-check"></i><b>2</b> Sequence Quality</a><ul>
<li class="chapter" data-level="2.1" data-path="SeqQualTop.html"><a href="SeqQualTop.html#introduction"><i class="fa fa-check"></i><b>2.1</b> Introduction</a></li>
<li class="chapter" data-level="2.2" data-path="SeqQualTop.html"><a href="SeqQualTop.html#caronbourque2020---fastqc"><i class="fa fa-check"></i><b>2.2</b> CaronBourque2020 - fastqc</a></li>
<li class="chapter" data-level="2.3" data-path="SeqQualTop.html"><a href="SeqQualTop.html#caronbourque2020---multiqc"><i class="fa fa-check"></i><b>2.3</b> CaronBourque2020 - MultiQC</a><ul>
<li class="chapter" data-level="2.3.1" data-path="SeqQualTop.html"><a href="SeqQualTop.html#sample-index-i1"><i class="fa fa-check"></i><b>2.3.1</b> sample index: I1</a></li>
<li class="chapter" data-level="2.3.2" data-path="SeqQualTop.html"><a href="SeqQualTop.html#cell-barcode-umi-r1"><i class="fa fa-check"></i><b>2.3.2</b> cell barcode + UMI: R1</a></li>
<li class="chapter" data-level="2.3.3" data-path="SeqQualTop.html"><a href="SeqQualTop.html#insert-r2"><i class="fa fa-check"></i><b>2.3.3</b> insert: R2</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="SeqQualTop.html"><a href="SeqQualTop.html#hca-adult-bmmc---fastqc"><i class="fa fa-check"></i><b>2.4</b> HCA adult BMMC - fastqc</a></li>
<li class="chapter" data-level="2.5" data-path="SeqQualTop.html"><a href="SeqQualTop.html#hca-adult-bmmc---multiqc"><i class="fa fa-check"></i><b>2.5</b> HCA adult BMMC - MultiQC</a><ul>
<li class="chapter" data-level="2.5.1" data-path="SeqQualTop.html"><a href="SeqQualTop.html#sample-index-i1-1"><i class="fa fa-check"></i><b>2.5.1</b> sample index: I1</a></li>
<li class="chapter" data-level="2.5.2" data-path="SeqQualTop.html"><a href="SeqQualTop.html#cell-barcode-umi-r1-1"><i class="fa fa-check"></i><b>2.5.2</b> cell barcode + UMI: R1</a></li>
<li class="chapter" data-level="2.5.3" data-path="SeqQualTop.html"><a href="SeqQualTop.html#insert-r2-1"><i class="fa fa-check"></i><b>2.5.3</b> insert: R2</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="AliFeatCountTop.html"><a href="AliFeatCountTop.html"><i class="fa fa-check"></i><b>3</b> Alignment and feature counting</a><ul>
<li class="chapter" data-level="3.1" data-path="AliFeatCountTop.html"><a href="AliFeatCountTop.html#introduction-1"><i class="fa fa-check"></i><b>3.1</b> Introduction</a></li>
<li class="chapter" data-level="3.2" data-path="AliFeatCountTop.html"><a href="AliFeatCountTop.html#x-cellranger-pipeline-in-brief"><i class="fa fa-check"></i><b>3.2</b> 10X cellranger pipeline in brief</a></li>
<li class="chapter" data-level="3.3" data-path="AliFeatCountTop.html"><a href="AliFeatCountTop.html#sample-sheet"><i class="fa fa-check"></i><b>3.3</b> sample sheet</a></li>
<li class="chapter" data-level="3.4" data-path="AliFeatCountTop.html"><a href="AliFeatCountTop.html#x-cellranger-reports-for-caronbourque2020"><i class="fa fa-check"></i><b>3.4</b> 10X cellranger reports for CaronBourque2020</a></li>
<li class="chapter" data-level="3.5" data-path="AliFeatCountTop.html"><a href="AliFeatCountTop.html#x-cellranger-reports-for-hcas-adult-bmmcs"><i class="fa fa-check"></i><b>3.5</b> 10X cellranger reports for HCA’s adult BMMCs</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html"><i class="fa fa-check"></i><b>4</b> Quality Control - with 2-5k cells per sample</a><ul>
<li class="chapter" data-level="4.1" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#introduction-2"><i class="fa fa-check"></i><b>4.1</b> Introduction</a></li>
<li class="chapter" data-level="4.2" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#load-packages"><i class="fa fa-check"></i><b>4.2</b> Load packages</a></li>
<li class="chapter" data-level="4.3" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#sample-sheet-1"><i class="fa fa-check"></i><b>4.3</b> Sample sheet</a></li>
<li class="chapter" data-level="4.4" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#data-representation"><i class="fa fa-check"></i><b>4.4</b> Data representation</a></li>
<li class="chapter" data-level="4.5" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#example"><i class="fa fa-check"></i><b>4.5</b> Example</a></li>
<li class="chapter" data-level="4.6" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#mapping-qc"><i class="fa fa-check"></i><b>4.6</b> Mapping QC</a><ul>
<li class="chapter" data-level="4.6.1" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#gene-body-coverage"><i class="fa fa-check"></i><b>4.6.1</b> Gene body coverage</a></li>
<li class="chapter" data-level="4.6.2" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#amplification-rate"><i class="fa fa-check"></i><b>4.6.2</b> Amplification rate</a></li>
</ul></li>
<li class="chapter" data-level="4.7" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#cell-calling-for-droplet-data"><i class="fa fa-check"></i><b>4.7</b> Cell calling for droplet data</a><ul>
<li class="chapter" data-level="4.7.1" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#mixture-model"><i class="fa fa-check"></i><b>4.7.1</b> Mixture model</a></li>
<li class="chapter" data-level="4.7.2" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#barcode-rank-plot"><i class="fa fa-check"></i><b>4.7.2</b> Barcode rank plot</a></li>
<li class="chapter" data-level="4.7.3" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#inflection-point"><i class="fa fa-check"></i><b>4.7.3</b> Inflection point</a></li>
<li class="chapter" data-level="4.7.4" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#cellranger-v1-and-v2"><i class="fa fa-check"></i><b>4.7.4</b> Cellranger v1 and v2</a></li>
<li class="chapter" data-level="4.7.5" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#dropletutils-and-emptydrops"><i class="fa fa-check"></i><b>4.7.5</b> DropletUtils and EmptyDrops</a></li>
</ul></li>
<li class="chapter" data-level="4.8" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#load-filtered-matrices"><i class="fa fa-check"></i><b>4.8</b> Load filtered matrices</a></li>
<li class="chapter" data-level="4.9" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#properties-of-scrna-seq-data"><i class="fa fa-check"></i><b>4.9</b> Properties of scRNA-seq data</a></li>
<li class="chapter" data-level="4.10" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#quality-control"><i class="fa fa-check"></i><b>4.10</b> Quality control</a><ul>
<li class="chapter" data-level="4.10.1" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#qc-metric-distribution"><i class="fa fa-check"></i><b>4.10.1</b> QC metric distribution</a></li>
</ul></li>
<li class="chapter" data-level="4.11" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#identification-of-low-quality-cells-with-adaptive-thresholds"><i class="fa fa-check"></i><b>4.11</b> Identification of low-quality cells with adaptive thresholds</a><ul>
<li class="chapter" data-level="4.11.1" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#library-size"><i class="fa fa-check"></i><b>4.11.1</b> Library size</a></li>
<li class="chapter" data-level="4.11.2" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#number-of-genes"><i class="fa fa-check"></i><b>4.11.2</b> Number of genes</a></li>
<li class="chapter" data-level="4.11.3" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#mitochondrial-content"><i class="fa fa-check"></i><b>4.11.3</b> Mitochondrial content</a></li>
<li class="chapter" data-level="4.11.4" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#summary"><i class="fa fa-check"></i><b>4.11.4</b> Summary</a></li>
<li class="chapter" data-level="4.11.5" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#all-steps-at-once"><i class="fa fa-check"></i><b>4.11.5</b> All steps at once</a></li>
<li class="chapter" data-level="4.11.6" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#assumptions"><i class="fa fa-check"></i><b>4.11.6</b> Assumptions</a></li>
</ul></li>
<li class="chapter" data-level="4.12" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#experimental-factors"><i class="fa fa-check"></i><b>4.12</b> Experimental factors</a><ul>
<li class="chapter" data-level="4.12.1" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#identify-poor-quality-batches"><i class="fa fa-check"></i><b>4.12.1</b> Identify poor-quality batches</a><ul>
<li class="chapter" data-level="4.12.1.1" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#number-of-genes-detected"><i class="fa fa-check"></i><b>4.12.1.1</b> Number of genes detected</a><ul>
<li class="chapter" data-level="4.12.1.1.1" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#mitochondrial-content-1"><i class="fa fa-check"></i><b>4.12.1.1.1</b> Mitochondrial content</a></li>
</ul></li>
<li class="chapter" data-level="4.12.1.2" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#samples-to-check"><i class="fa fa-check"></i><b>4.12.1.2</b> Samples to check</a></li>
</ul></li>
<li class="chapter" data-level="4.12.2" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#qc-metrics-space"><i class="fa fa-check"></i><b>4.12.2</b> QC metrics space</a></li>
<li class="chapter" data-level="4.12.3" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#qc-pca"><i class="fa fa-check"></i><b>4.12.3</b> QC PCA</a></li>
<li class="chapter" data-level="4.12.4" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#other-diagnostic-plots"><i class="fa fa-check"></i><b>4.12.4</b> Other diagnostic plots</a></li>
<li class="chapter" data-level="4.12.5" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#filter-low-quality-cells-out"><i class="fa fa-check"></i><b>4.12.5</b> Filter low-quality cells out</a></li>
</ul></li>
<li class="chapter" data-level="4.13" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#novelty"><i class="fa fa-check"></i><b>4.13</b> Novelty</a></li>
<li class="chapter" data-level="4.14" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#qc-based-on-sparsity"><i class="fa fa-check"></i><b>4.14</b> QC based on sparsity</a><ul>
<li class="chapter" data-level="4.14.1" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#remove-genes-that-are-not-expressed-at-all"><i class="fa fa-check"></i><b>4.14.1</b> Remove genes that are not expressed at all</a></li>
<li class="chapter" data-level="4.14.2" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#sparsity-plots"><i class="fa fa-check"></i><b>4.14.2</b> Sparsity plots</a></li>
<li class="chapter" data-level="4.14.3" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#filters"><i class="fa fa-check"></i><b>4.14.3</b> Filters</a></li>
<li class="chapter" data-level="4.14.4" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#separate-caron-and-hca-batches"><i class="fa fa-check"></i><b>4.14.4</b> Separate Caron and Hca batches</a></li>
<li class="chapter" data-level="4.14.5" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#caron-only"><i class="fa fa-check"></i><b>4.14.5</b> Caron only</a></li>
<li class="chapter" data-level="4.14.6" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#hca-only"><i class="fa fa-check"></i><b>4.14.6</b> Hca only</a></li>
</ul></li>
<li class="chapter" data-level="4.15" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#subsample-hca-set"><i class="fa fa-check"></i><b>4.15</b> Subsample Hca set</a></li>
<li class="chapter" data-level="4.16" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#session-information"><i class="fa fa-check"></i><b>4.16</b> Session information</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="PreProcTop.html"><a href="PreProcTop.html"><i class="fa fa-check"></i><b>5</b> Quality Control - with 500 cells per sample</a><ul>
<li class="chapter" data-level="5.1" data-path="PreProcTop.html"><a href="PreProcTop.html#introduction-3"><i class="fa fa-check"></i><b>5.1</b> Introduction</a></li>
<li class="chapter" data-level="5.2" data-path="PreProcTop.html"><a href="PreProcTop.html#load-packages-1"><i class="fa fa-check"></i><b>5.2</b> Load packages</a></li>
<li class="chapter" data-level="5.3" data-path="PreProcTop.html"><a href="PreProcTop.html#sample-sheet-2"><i class="fa fa-check"></i><b>5.3</b> Sample sheet</a></li>
<li class="chapter" data-level="5.4" data-path="PreProcTop.html"><a href="PreProcTop.html#data-representation-1"><i class="fa fa-check"></i><b>5.4</b> Data representation</a></li>
<li class="chapter" data-level="5.5" data-path="PreProcTop.html"><a href="PreProcTop.html#example-1"><i class="fa fa-check"></i><b>5.5</b> Example</a></li>
<li class="chapter" data-level="5.6" data-path="PreProcTop.html"><a href="PreProcTop.html#mapping-qc-1"><i class="fa fa-check"></i><b>5.6</b> Mapping QC</a><ul>
<li class="chapter" data-level="5.6.1" data-path="PreProcTop.html"><a href="PreProcTop.html#gene-body-coverage-1"><i class="fa fa-check"></i><b>5.6.1</b> Gene body coverage</a></li>
<li class="chapter" data-level="5.6.2" data-path="PreProcTop.html"><a href="PreProcTop.html#amplification-rate-1"><i class="fa fa-check"></i><b>5.6.2</b> Amplification rate</a></li>
</ul></li>
<li class="chapter" data-level="5.7" data-path="PreProcTop.html"><a href="PreProcTop.html#cell-calling-for-droplet-data-1"><i class="fa fa-check"></i><b>5.7</b> Cell calling for droplet data</a><ul>
<li class="chapter" data-level="5.7.1" data-path="PreProcTop.html"><a href="PreProcTop.html#mixture-model-1"><i class="fa fa-check"></i><b>5.7.1</b> Mixture model</a></li>
<li class="chapter" data-level="5.7.2" data-path="PreProcTop.html"><a href="PreProcTop.html#barcode-rank-plot-1"><i class="fa fa-check"></i><b>5.7.2</b> Barcode rank plot</a></li>
<li class="chapter" data-level="5.7.3" data-path="PreProcTop.html"><a href="PreProcTop.html#inflection-point-1"><i class="fa fa-check"></i><b>5.7.3</b> Inflection point</a></li>
<li class="chapter" data-level="5.7.4" data-path="PreProcTop.html"><a href="PreProcTop.html#cellranger-v1-and-v2-1"><i class="fa fa-check"></i><b>5.7.4</b> Cellranger v1 and v2</a></li>
<li class="chapter" data-level="5.7.5" data-path="PreProcTop.html"><a href="PreProcTop.html#dropletutils-and-emptydrops-1"><i class="fa fa-check"></i><b>5.7.5</b> DropletUtils and EmptyDrops</a></li>
</ul></li>
<li class="chapter" data-level="5.8" data-path="PreProcTop.html"><a href="PreProcTop.html#load-filtered-matrices-1"><i class="fa fa-check"></i><b>5.8</b> Load filtered matrices</a></li>
<li class="chapter" data-level="5.9" data-path="PreProcTop.html"><a href="PreProcTop.html#properties-of-scrna-seq-data-1"><i class="fa fa-check"></i><b>5.9</b> Properties of scRNA-seq data</a></li>
<li class="chapter" data-level="5.10" data-path="PreProcTop.html"><a href="PreProcTop.html#quality-control-1"><i class="fa fa-check"></i><b>5.10</b> Quality control</a><ul>
<li class="chapter" data-level="5.10.1" data-path="PreProcTop.html"><a href="PreProcTop.html#qc-metric-distribution-1"><i class="fa fa-check"></i><b>5.10.1</b> QC metric distribution</a></li>
</ul></li>
<li class="chapter" data-level="5.11" data-path="PreProcTop.html"><a href="PreProcTop.html#identification-of-low-quality-cells-with-adaptive-thresholds-1"><i class="fa fa-check"></i><b>5.11</b> Identification of low-quality cells with adaptive thresholds</a><ul>
<li class="chapter" data-level="5.11.1" data-path="PreProcTop.html"><a href="PreProcTop.html#library-size-1"><i class="fa fa-check"></i><b>5.11.1</b> Library size</a></li>
<li class="chapter" data-level="5.11.2" data-path="PreProcTop.html"><a href="PreProcTop.html#number-of-genes-1"><i class="fa fa-check"></i><b>5.11.2</b> Number of genes</a></li>
<li class="chapter" data-level="5.11.3" data-path="PreProcTop.html"><a href="PreProcTop.html#mitochondrial-content-2"><i class="fa fa-check"></i><b>5.11.3</b> Mitochondrial content</a></li>
<li class="chapter" data-level="5.11.4" data-path="PreProcTop.html"><a href="PreProcTop.html#summary-1"><i class="fa fa-check"></i><b>5.11.4</b> Summary</a></li>
<li class="chapter" data-level="5.11.5" data-path="PreProcTop.html"><a href="PreProcTop.html#all-steps-at-once-1"><i class="fa fa-check"></i><b>5.11.5</b> All steps at once</a></li>
<li class="chapter" data-level="5.11.6" data-path="PreProcTop.html"><a href="PreProcTop.html#assumptions-1"><i class="fa fa-check"></i><b>5.11.6</b> Assumptions</a></li>
</ul></li>
<li class="chapter" data-level="5.12" data-path="PreProcTop.html"><a href="PreProcTop.html#experimental-factors-1"><i class="fa fa-check"></i><b>5.12</b> Experimental factors</a><ul>
<li class="chapter" data-level="5.12.1" data-path="PreProcTop.html"><a href="PreProcTop.html#identify-poor-quality-batches-1"><i class="fa fa-check"></i><b>5.12.1</b> Identify poor-quality batches</a><ul>
<li class="chapter" data-level="5.12.1.1" data-path="PreProcTop.html"><a href="PreProcTop.html#number-of-genes-detected-1"><i class="fa fa-check"></i><b>5.12.1.1</b> Number of genes detected</a><ul>
<li class="chapter" data-level="5.12.1.1.1" data-path="PreProcTop.html"><a href="PreProcTop.html#mitochondrial-content-3"><i class="fa fa-check"></i><b>5.12.1.1.1</b> Mitochondrial content</a></li>
</ul></li>
<li class="chapter" data-level="5.12.1.2" data-path="PreProcTop.html"><a href="PreProcTop.html#samples-to-check-1"><i class="fa fa-check"></i><b>5.12.1.2</b> Samples to check</a></li>
</ul></li>
<li class="chapter" data-level="5.12.2" data-path="PreProcTop.html"><a href="PreProcTop.html#qc-metrics-space-1"><i class="fa fa-check"></i><b>5.12.2</b> QC metrics space</a></li>
<li class="chapter" data-level="5.12.3" data-path="PreProcTop.html"><a href="PreProcTop.html#qc-pca-1"><i class="fa fa-check"></i><b>5.12.3</b> QC PCA</a></li>
<li class="chapter" data-level="5.12.4" data-path="PreProcTop.html"><a href="PreProcTop.html#other-diagnostic-plots-1"><i class="fa fa-check"></i><b>5.12.4</b> Other diagnostic plots</a></li>
<li class="chapter" data-level="5.12.5" data-path="PreProcTop.html"><a href="PreProcTop.html#filter-low-quality-cells-out-1"><i class="fa fa-check"></i><b>5.12.5</b> Filter low-quality cells out</a></li>
</ul></li>
<li class="chapter" data-level="5.13" data-path="PreProcTop.html"><a href="PreProcTop.html#novelty-1"><i class="fa fa-check"></i><b>5.13</b> Novelty</a></li>
<li class="chapter" data-level="5.14" data-path="PreProcTop.html"><a href="PreProcTop.html#qc-based-on-sparsity-1"><i class="fa fa-check"></i><b>5.14</b> QC based on sparsity</a><ul>
<li class="chapter" data-level="5.14.1" data-path="PreProcTop.html"><a href="PreProcTop.html#remove-genes-that-are-not-expressed-at-all-1"><i class="fa fa-check"></i><b>5.14.1</b> Remove genes that are not expressed at all</a></li>
<li class="chapter" data-level="5.14.2" data-path="PreProcTop.html"><a href="PreProcTop.html#sparsity-plots-1"><i class="fa fa-check"></i><b>5.14.2</b> Sparsity plots</a></li>
<li class="chapter" data-level="5.14.3" data-path="PreProcTop.html"><a href="PreProcTop.html#filters-1"><i class="fa fa-check"></i><b>5.14.3</b> Filters</a></li>
<li class="chapter" data-level="5.14.4" data-path="PreProcTop.html"><a href="PreProcTop.html#separate-caron-and-hca-batches-1"><i class="fa fa-check"></i><b>5.14.4</b> Separate Caron and Hca batches</a></li>
<li class="chapter" data-level="5.14.5" data-path="PreProcTop.html"><a href="PreProcTop.html#caron-only-1"><i class="fa fa-check"></i><b>5.14.5</b> Caron only</a></li>
<li class="chapter" data-level="5.14.6" data-path="PreProcTop.html"><a href="PreProcTop.html#hca-only-1"><i class="fa fa-check"></i><b>5.14.6</b> Hca only</a></li>
</ul></li>
<li class="chapter" data-level="5.15" data-path="PreProcTop.html"><a href="PreProcTop.html#session-information-1"><i class="fa fa-check"></i><b>5.15</b> Session information</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="NormalisationAllCellsTop.html"><a href="NormalisationAllCellsTop.html"><i class="fa fa-check"></i><b>6</b> Normalisation - with 2-5k cells per sample</a><ul>
<li class="chapter" data-level="6.1" data-path="NormalisationAllCellsTop.html"><a href="NormalisationAllCellsTop.html#caron"><i class="fa fa-check"></i><b>6.1</b> Caron</a><ul>
<li class="chapter" data-level="6.1.1" data-path="NormalisationAllCellsTop.html"><a href="NormalisationAllCellsTop.html#library-size-normalization"><i class="fa fa-check"></i><b>6.1.1</b> Library size normalization</a></li>
<li class="chapter" data-level="6.1.2" data-path="NormalisationAllCellsTop.html"><a href="NormalisationAllCellsTop.html#deconvolution"><i class="fa fa-check"></i><b>6.1.2</b> Deconvolution</a></li>
<li class="chapter" data-level="6.1.3" data-path="NormalisationAllCellsTop.html"><a href="NormalisationAllCellsTop.html#compute-size-factors"><i class="fa fa-check"></i><b>6.1.3</b> Compute size factors</a><ul>
<li class="chapter" data-level="6.1.3.1" data-path="NormalisationAllCellsTop.html"><a href="NormalisationAllCellsTop.html#apply-size-factors"><i class="fa fa-check"></i><b>6.1.3.1</b> Apply size factors</a></li>
<li class="chapter" data-level="6.1.3.2" data-path="NormalisationAllCellsTop.html"><a href="NormalisationAllCellsTop.html#save-object"><i class="fa fa-check"></i><b>6.1.3.2</b> Save object</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="NormalisationAllCellsTop.html"><a href="NormalisationAllCellsTop.html#hca"><i class="fa fa-check"></i><b>6.2</b> Hca</a><ul>
<li class="chapter" data-level="6.2.1" data-path="NormalisationAllCellsTop.html"><a href="NormalisationAllCellsTop.html#library-size-normalization-1"><i class="fa fa-check"></i><b>6.2.1</b> Library size normalization</a></li>
<li class="chapter" data-level="6.2.2" data-path="NormalisationAllCellsTop.html"><a href="NormalisationAllCellsTop.html#deconvolution-1"><i class="fa fa-check"></i><b>6.2.2</b> Deconvolution</a></li>
<li class="chapter" data-level="6.2.3" data-path="NormalisationAllCellsTop.html"><a href="NormalisationAllCellsTop.html#compute-size-factors-1"><i class="fa fa-check"></i><b>6.2.3</b> Compute size factors</a><ul>
<li class="chapter" data-level="6.2.3.1" data-path="NormalisationAllCellsTop.html"><a href="NormalisationAllCellsTop.html#apply-size-factors-1"><i class="fa fa-check"></i><b>6.2.3.1</b> Apply size factors</a></li>
<li class="chapter" data-level="6.2.3.2" data-path="NormalisationAllCellsTop.html"><a href="NormalisationAllCellsTop.html#save-object-1"><i class="fa fa-check"></i><b>6.2.3.2</b> Save object</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="NormalisationAllCellsTop.html"><a href="NormalisationAllCellsTop.html#sctransform"><i class="fa fa-check"></i><b>6.3</b> SCTransform</a><ul>
<li class="chapter" data-level="6.3.1" data-path="NormalisationAllCellsTop.html"><a href="NormalisationAllCellsTop.html#caron-1"><i class="fa fa-check"></i><b>6.3.1</b> Caron</a></li>
<li class="chapter" data-level="6.3.2" data-path="NormalisationAllCellsTop.html"><a href="NormalisationAllCellsTop.html#hca-1"><i class="fa fa-check"></i><b>6.3.2</b> Hca</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="NormalisationAllCellsTop.html"><a href="NormalisationAllCellsTop.html#session-information-2"><i class="fa fa-check"></i><b>6.4</b> Session information</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="normalisation-caron-set.html"><a href="normalisation-caron-set.html"><i class="fa fa-check"></i><b>7</b> Normalisation - Caron set</a><ul>
<li class="chapter" data-level="7.1" data-path="normalisation-caron-set.html"><a href="normalisation-caron-set.html#scaling-normalization"><i class="fa fa-check"></i><b>7.1</b> Scaling normalization</a><ul>
<li class="chapter" data-level="7.1.1" data-path="normalisation-caron-set.html"><a href="normalisation-caron-set.html#cpm"><i class="fa fa-check"></i><b>7.1.1</b> CPM</a></li>
<li class="chapter" data-level="7.1.2" data-path="normalisation-caron-set.html"><a href="normalisation-caron-set.html#deseqs-size-factor"><i class="fa fa-check"></i><b>7.1.2</b> DESeq’s size factor</a></li>
<li class="chapter" data-level="7.1.3" data-path="normalisation-caron-set.html"><a href="normalisation-caron-set.html#weighted-trimmed-mean-of-m-values"><i class="fa fa-check"></i><b>7.1.3</b> Weighted Trimmed mean of M-values</a></li>
<li class="chapter" data-level="7.1.4" data-path="normalisation-caron-set.html"><a href="normalisation-caron-set.html#library-size-normalization-2"><i class="fa fa-check"></i><b>7.1.4</b> Library size normalization</a></li>
<li class="chapter" data-level="7.1.5" data-path="normalisation-caron-set.html"><a href="normalisation-caron-set.html#deconvolution-2"><i class="fa fa-check"></i><b>7.1.5</b> Deconvolution</a><ul>
<li class="chapter" data-level="7.1.5.1" data-path="normalisation-caron-set.html"><a href="normalisation-caron-set.html#cluster-cells"><i class="fa fa-check"></i><b>7.1.5.1</b> Cluster cells</a></li>
<li class="chapter" data-level="7.1.5.2" data-path="normalisation-caron-set.html"><a href="normalisation-caron-set.html#compute-size-factors-2"><i class="fa fa-check"></i><b>7.1.5.2</b> Compute size factors</a></li>
<li class="chapter" data-level="7.1.5.3" data-path="normalisation-caron-set.html"><a href="normalisation-caron-set.html#apply-size-factors-2"><i class="fa fa-check"></i><b>7.1.5.3</b> Apply size factors</a></li>
<li class="chapter" data-level="7.1.5.4" data-path="normalisation-caron-set.html"><a href="normalisation-caron-set.html#save-object-2"><i class="fa fa-check"></i><b>7.1.5.4</b> Save object</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="normalisation-caron-set.html"><a href="normalisation-caron-set.html#sctransform-1"><i class="fa fa-check"></i><b>7.2</b> SCTransform</a><ul>
<li class="chapter" data-level="7.2.1" data-path="normalisation-caron-set.html"><a href="normalisation-caron-set.html#inspect-data"><i class="fa fa-check"></i><b>7.2.1</b> Inspect data</a></li>
<li class="chapter" data-level="7.2.2" data-path="normalisation-caron-set.html"><a href="normalisation-caron-set.html#transformation"><i class="fa fa-check"></i><b>7.2.2</b> Transformation</a></li>
<li class="chapter" data-level="7.2.3" data-path="normalisation-caron-set.html"><a href="normalisation-caron-set.html#save-sce-object"><i class="fa fa-check"></i><b>7.2.3</b> Save SCE object</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="normalisation-caron-set.html"><a href="normalisation-caron-set.html#visualisation"><i class="fa fa-check"></i><b>7.3</b> Visualisation</a><ul>
<li class="chapter" data-level="7.3.1" data-path="normalisation-caron-set.html"><a href="normalisation-caron-set.html#log-raw-counts"><i class="fa fa-check"></i><b>7.3.1</b> log raw counts</a></li>
<li class="chapter" data-level="7.3.2" data-path="normalisation-caron-set.html"><a href="normalisation-caron-set.html#log-cpm"><i class="fa fa-check"></i><b>7.3.2</b> log CPM</a></li>
<li class="chapter" data-level="7.3.3" data-path="normalisation-caron-set.html"><a href="normalisation-caron-set.html#scran"><i class="fa fa-check"></i><b>7.3.3</b> scran</a></li>
<li class="chapter" data-level="7.3.4" data-path="normalisation-caron-set.html"><a href="normalisation-caron-set.html#sctransform-2"><i class="fa fa-check"></i><b>7.3.4</b> SCTransform</a></li>
</ul></li>
<li class="chapter" data-level="7.4" data-path="normalisation-caron-set.html"><a href="normalisation-caron-set.html#session-information-3"><i class="fa fa-check"></i><b>7.4</b> Session information</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="NormalisationGSM3872434Top.html"><a href="NormalisationGSM3872434Top.html"><i class="fa fa-check"></i><b>8</b> Normalisation - GSM3872434 set</a><ul>
<li class="chapter" data-level="8.1" data-path="NormalisationGSM3872434Top.html"><a href="NormalisationGSM3872434Top.html#scaling-normalization-1"><i class="fa fa-check"></i><b>8.1</b> Scaling normalization</a><ul>
<li class="chapter" data-level="8.1.1" data-path="NormalisationGSM3872434Top.html"><a href="NormalisationGSM3872434Top.html#cpm-1"><i class="fa fa-check"></i><b>8.1.1</b> CPM</a></li>
<li class="chapter" data-level="8.1.2" data-path="NormalisationGSM3872434Top.html"><a href="NormalisationGSM3872434Top.html#deseqs-size-factor-1"><i class="fa fa-check"></i><b>8.1.2</b> DESeq’s size factor</a></li>
<li class="chapter" data-level="8.1.3" data-path="NormalisationGSM3872434Top.html"><a href="NormalisationGSM3872434Top.html#weighted-trimmed-mean-of-m-values-1"><i class="fa fa-check"></i><b>8.1.3</b> Weighted Trimmed mean of M-values</a></li>
<li class="chapter" data-level="8.1.4" data-path="NormalisationGSM3872434Top.html"><a href="NormalisationGSM3872434Top.html#library-size-factor-distribution"><i class="fa fa-check"></i><b>8.1.4</b> Library size factor distribution</a></li>
<li class="chapter" data-level="8.1.5" data-path="NormalisationGSM3872434Top.html"><a href="NormalisationGSM3872434Top.html#deconvolution-3"><i class="fa fa-check"></i><b>8.1.5</b> Deconvolution</a><ul>
<li class="chapter" data-level="8.1.5.1" data-path="NormalisationGSM3872434Top.html"><a href="NormalisationGSM3872434Top.html#cluster-cells-1"><i class="fa fa-check"></i><b>8.1.5.1</b> Cluster cells</a></li>
<li class="chapter" data-level="8.1.5.2" data-path="NormalisationGSM3872434Top.html"><a href="NormalisationGSM3872434Top.html#compute-size-factors-3"><i class="fa fa-check"></i><b>8.1.5.2</b> Compute size factors</a></li>
<li class="chapter" data-level="8.1.5.3" data-path="NormalisationGSM3872434Top.html"><a href="NormalisationGSM3872434Top.html#apply-size-factors-3"><i class="fa fa-check"></i><b>8.1.5.3</b> Apply size factors</a></li>
<li class="chapter" data-level="8.1.5.4" data-path="NormalisationGSM3872434Top.html"><a href="NormalisationGSM3872434Top.html#save-object-3"><i class="fa fa-check"></i><b>8.1.5.4</b> Save object</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="NormalisationGSM3872434Top.html"><a href="NormalisationGSM3872434Top.html#sctransform-3"><i class="fa fa-check"></i><b>8.2</b> SCTransform</a><ul>
<li class="chapter" data-level="8.2.1" data-path="NormalisationGSM3872434Top.html"><a href="NormalisationGSM3872434Top.html#inspect-data-1"><i class="fa fa-check"></i><b>8.2.1</b> Inspect data</a></li>
<li class="chapter" data-level="8.2.2" data-path="NormalisationGSM3872434Top.html"><a href="NormalisationGSM3872434Top.html#transformation-1"><i class="fa fa-check"></i><b>8.2.2</b> Transformation</a></li>
<li class="chapter" data-level="8.2.3" data-path="NormalisationGSM3872434Top.html"><a href="NormalisationGSM3872434Top.html#save-sce-object-1"><i class="fa fa-check"></i><b>8.2.3</b> Save SCE object</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="NormalisationGSM3872434Top.html"><a href="NormalisationGSM3872434Top.html#visualisation-1"><i class="fa fa-check"></i><b>8.3</b> Visualisation</a><ul>
<li class="chapter" data-level="8.3.1" data-path="NormalisationGSM3872434Top.html"><a href="NormalisationGSM3872434Top.html#log-raw-counts-1"><i class="fa fa-check"></i><b>8.3.1</b> log raw counts</a></li>
<li class="chapter" data-level="8.3.2" data-path="NormalisationGSM3872434Top.html"><a href="NormalisationGSM3872434Top.html#log-cpm-1"><i class="fa fa-check"></i><b>8.3.2</b> log CPM</a></li>
<li class="chapter" data-level="8.3.3" data-path="NormalisationGSM3872434Top.html"><a href="NormalisationGSM3872434Top.html#scran-1"><i class="fa fa-check"></i><b>8.3.3</b> scran</a></li>
<li class="chapter" data-level="8.3.4" data-path="NormalisationGSM3872434Top.html"><a href="NormalisationGSM3872434Top.html#sctransform-4"><i class="fa fa-check"></i><b>8.3.4</b> SCTransform</a></li>
</ul></li>
<li class="chapter" data-level="8.4" data-path="NormalisationGSM3872434Top.html"><a href="NormalisationGSM3872434Top.html#session-information-4"><i class="fa fa-check"></i><b>8.4</b> Session information</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="dimRedForVizTop.html"><a href="dimRedForVizTop.html"><i class="fa fa-check"></i><b>9</b> Dimensionality reduction for visualisation</a><ul>
<li class="chapter" data-level="9.1" data-path="dimRedForVizTop.html"><a href="dimRedForVizTop.html#principal-component-analysis"><i class="fa fa-check"></i><b>9.1</b> Principal Component Analysis</a><ul>
<li class="chapter" data-level="9.1.1" data-path="dimRedForVizTop.html"><a href="dimRedForVizTop.html#description"><i class="fa fa-check"></i><b>9.1.1</b> Description</a></li>
<li class="chapter" data-level="9.1.2" data-path="dimRedForVizTop.html"><a href="dimRedForVizTop.html#example-2"><i class="fa fa-check"></i><b>9.1.2</b> Example</a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="dimRedForVizTop.html"><a href="dimRedForVizTop.html#load-packages-2"><i class="fa fa-check"></i><b>9.2</b> Load packages</a></li>
<li class="chapter" data-level="9.3" data-path="dimRedForVizTop.html"><a href="dimRedForVizTop.html#load-data"><i class="fa fa-check"></i><b>9.3</b> Load data</a></li>
<li class="chapter" data-level="9.4" data-path="dimRedForVizTop.html"><a href="dimRedForVizTop.html#pca"><i class="fa fa-check"></i><b>9.4</b> PCA</a><ul>
<li class="chapter" data-level="9.4.1" data-path="dimRedForVizTop.html"><a href="dimRedForVizTop.html#correlation-between-pcs-and-the-total-number-of-features-detected"><i class="fa fa-check"></i><b>9.4.1</b> Correlation between PCs and the total number of features detected</a></li>
</ul></li>
<li class="chapter" data-level="9.5" data-path="dimRedForVizTop.html"><a href="dimRedForVizTop.html#t-sne-t-distributed-stochastic-neighbor-embedding"><i class="fa fa-check"></i><b>9.5</b> t-SNE: t-Distributed Stochastic Neighbor Embedding</a><ul>
<li class="chapter" data-level="9.5.1" data-path="dimRedForVizTop.html"><a href="dimRedForVizTop.html#perplexity"><i class="fa fa-check"></i><b>9.5.1</b> Perplexity</a></li>
<li class="chapter" data-level="9.5.2" data-path="dimRedForVizTop.html"><a href="dimRedForVizTop.html#stochasticity"><i class="fa fa-check"></i><b>9.5.2</b> Stochasticity</a></li>
</ul></li>
<li class="chapter" data-level="9.6" data-path="dimRedForVizTop.html"><a href="dimRedForVizTop.html#umap"><i class="fa fa-check"></i><b>9.6</b> UMAP</a></li>
<li class="chapter" data-level="9.7" data-path="dimRedForVizTop.html"><a href="dimRedForVizTop.html#session-information-5"><i class="fa fa-check"></i><b>9.7</b> Session information</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="identifying-confounding-factors-caron-set.html"><a href="identifying-confounding-factors-caron-set.html"><i class="fa fa-check"></i><b>10</b> Identifying confounding factors - Caron set</a><ul>
<li class="chapter" data-level="10.1" data-path="identifying-confounding-factors-caron-set.html"><a href="identifying-confounding-factors-caron-set.html#load-object"><i class="fa fa-check"></i><b>10.1</b> Load object</a></li>
<li class="chapter" data-level="10.2" data-path="identifying-confounding-factors-caron-set.html"><a href="identifying-confounding-factors-caron-set.html#pca-1"><i class="fa fa-check"></i><b>10.2</b> PCA</a></li>
<li class="chapter" data-level="10.3" data-path="identifying-confounding-factors-caron-set.html"><a href="identifying-confounding-factors-caron-set.html#normalised-counts"><i class="fa fa-check"></i><b>10.3</b> Normalised counts</a></li>
<li class="chapter" data-level="10.4" data-path="identifying-confounding-factors-caron-set.html"><a href="identifying-confounding-factors-caron-set.html#session-information-6"><i class="fa fa-check"></i><b>10.4</b> Session information</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="featSelecTop.html"><a href="featSelecTop.html"><i class="fa fa-check"></i><b>11</b> Feature selection</a><ul>
<li class="chapter" data-level="11.1" data-path="featSelecTop.html"><a href="featSelecTop.html#load-data-1"><i class="fa fa-check"></i><b>11.1</b> Load data</a></li>
<li class="chapter" data-level="11.2" data-path="featSelecTop.html"><a href="featSelecTop.html#feature-selection-with-scran"><i class="fa fa-check"></i><b>11.2</b> Feature selection with scran</a><ul>
<li class="chapter" data-level="11.2.1" data-path="featSelecTop.html"><a href="featSelecTop.html#modelling-and-removing-technical-noise"><i class="fa fa-check"></i><b>11.2.1</b> Modelling and removing technical noise</a></li>
<li class="chapter" data-level="11.2.2" data-path="featSelecTop.html"><a href="featSelecTop.html#choosing-some-hvgs"><i class="fa fa-check"></i><b>11.2.2</b> Choosing some HVGs</a></li>
</ul></li>
<li class="chapter" data-level="11.3" data-path="featSelecTop.html"><a href="featSelecTop.html#session-information-7"><i class="fa fa-check"></i><b>11.3</b> Session information</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="batch-correction-gsm3872442-set.html"><a href="batch-correction-gsm3872442-set.html"><i class="fa fa-check"></i><b>12</b> batch correction - GSM3872442 set</a><ul>
<li class="chapter" data-level="12.1" data-path="batch-correction-gsm3872442-set.html"><a href="batch-correction-gsm3872442-set.html#prepare-data"><i class="fa fa-check"></i><b>12.1</b> Prepare data</a></li>
<li class="chapter" data-level="12.2" data-path="batch-correction-gsm3872442-set.html"><a href="batch-correction-gsm3872442-set.html#normalise-each-separately-and-re-pool"><i class="fa fa-check"></i><b>12.2</b> Normalise each separately and re-pool</a></li>
<li class="chapter" data-level="12.3" data-path="batch-correction-gsm3872442-set.html"><a href="batch-correction-gsm3872442-set.html#normalise-batches-together"><i class="fa fa-check"></i><b>12.3</b> Normalise batches together</a></li>
<li class="chapter" data-level="12.4" data-path="batch-correction-gsm3872442-set.html"><a href="batch-correction-gsm3872442-set.html#batch-correction"><i class="fa fa-check"></i><b>12.4</b> Batch correction</a><ul>
<li class="chapter" data-level="12.4.1" data-path="batch-correction-gsm3872442-set.html"><a href="batch-correction-gsm3872442-set.html#gaussian-normal-linear-models"><i class="fa fa-check"></i><b>12.4.1</b> Gaussian (normal) linear models</a></li>
</ul></li>
<li class="chapter" data-level="12.5" data-path="batch-correction-gsm3872442-set.html"><a href="batch-correction-gsm3872442-set.html#sctransform-5"><i class="fa fa-check"></i><b>12.5</b> SCTransform</a><ul>
<li class="chapter" data-level="12.5.1" data-path="batch-correction-gsm3872442-set.html"><a href="batch-correction-gsm3872442-set.html#batch-only"><i class="fa fa-check"></i><b>12.5.1</b> Batch only</a></li>
<li class="chapter" data-level="12.5.2" data-path="batch-correction-gsm3872442-set.html"><a href="batch-correction-gsm3872442-set.html#both-library-size-and-batch"><i class="fa fa-check"></i><b>12.5.2</b> Both library size and batch</a></li>
</ul></li>
<li class="chapter" data-level="12.6" data-path="batch-correction-gsm3872442-set.html"><a href="batch-correction-gsm3872442-set.html#mnncorrect"><i class="fa fa-check"></i><b>12.6</b> mnnCorrect</a><ul>
<li class="chapter" data-level="12.6.1" data-path="batch-correction-gsm3872442-set.html"><a href="batch-correction-gsm3872442-set.html#check-presence-of-batch-effect"><i class="fa fa-check"></i><b>12.6.1</b> Check presence of batch effect</a></li>
<li class="chapter" data-level="12.6.2" data-path="batch-correction-gsm3872442-set.html"><a href="batch-correction-gsm3872442-set.html#correct-batch-effect-with-mnncorrect"><i class="fa fa-check"></i><b>12.6.2</b> Correct batch effect with mnnCorrect</a></li>
</ul></li>
<li class="chapter" data-level="12.7" data-path="batch-correction-gsm3872442-set.html"><a href="batch-correction-gsm3872442-set.html#fastmnn"><i class="fa fa-check"></i><b>12.7</b> fastMNN</a></li>
<li class="chapter" data-level="12.8" data-path="batch-correction-gsm3872442-set.html"><a href="batch-correction-gsm3872442-set.html#harmony"><i class="fa fa-check"></i><b>12.8</b> Harmony</a></li>
<li class="chapter" data-level="12.9" data-path="batch-correction-gsm3872442-set.html"><a href="batch-correction-gsm3872442-set.html#session-information-8"><i class="fa fa-check"></i><b>12.9</b> Session information</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="dimensionality-reduction-for-analysis.html"><a href="dimensionality-reduction-for-analysis.html"><i class="fa fa-check"></i><b>13</b> Dimensionality reduction for analysis</a><ul>
<li class="chapter" data-level="13.1" data-path="dimensionality-reduction-for-analysis.html"><a href="dimensionality-reduction-for-analysis.html#load-data-2"><i class="fa fa-check"></i><b>13.1</b> Load data</a></li>
<li class="chapter" data-level="13.2" data-path="dimensionality-reduction-for-analysis.html"><a href="dimensionality-reduction-for-analysis.html#denoising-expression-values-using-pca"><i class="fa fa-check"></i><b>13.2</b> Denoising expression values using PCA</a></li>
<li class="chapter" data-level="13.3" data-path="dimensionality-reduction-for-analysis.html"><a href="dimensionality-reduction-for-analysis.html#visualise-expression-patterns-of-some-hvgs"><i class="fa fa-check"></i><b>13.3</b> Visualise expression patterns of some HVGs</a></li>
<li class="chapter" data-level="13.4" data-path="dimensionality-reduction-for-analysis.html"><a href="dimensionality-reduction-for-analysis.html#session-information-9"><i class="fa fa-check"></i><b>13.4</b> Session information</a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="DataIntegration-PBMMCTop.html"><a href="DataIntegration-PBMMCTop.html"><i class="fa fa-check"></i><b>14</b> Data integration - PBMMC</a><ul>
<li class="chapter" data-level="14.1" data-path="DataIntegration-PBMMCTop.html"><a href="DataIntegration-PBMMCTop.html#abbreviations-1"><i class="fa fa-check"></i><b>14.1</b> Abbreviations</a></li>
<li class="chapter" data-level="14.2" data-path="DataIntegration-PBMMCTop.html"><a href="DataIntegration-PBMMCTop.html#motivation"><i class="fa fa-check"></i><b>14.2</b> Motivation</a></li>
<li class="chapter" data-level="14.3" data-path="DataIntegration-PBMMCTop.html"><a href="DataIntegration-PBMMCTop.html#loading-the-data"><i class="fa fa-check"></i><b>14.3</b> Loading the data</a></li>
<li class="chapter" data-level="14.4" data-path="DataIntegration-PBMMCTop.html"><a href="DataIntegration-PBMMCTop.html#diagnosing-batch-effects"><i class="fa fa-check"></i><b>14.4</b> Diagnosing batch effects</a></li>
<li class="chapter" data-level="14.5" data-path="DataIntegration-PBMMCTop.html"><a href="DataIntegration-PBMMCTop.html#linear-regression"><i class="fa fa-check"></i><b>14.5</b> Linear regression</a></li>
<li class="chapter" data-level="14.6" data-path="DataIntegration-PBMMCTop.html"><a href="DataIntegration-PBMMCTop.html#performing-mnn-correction"><i class="fa fa-check"></i><b>14.6</b> Performing MNN correction</a><ul>
<li class="chapter" data-level="14.6.1" data-path="DataIntegration-PBMMCTop.html"><a href="DataIntegration-PBMMCTop.html#algorithm-overview"><i class="fa fa-check"></i><b>14.6.1</b> Algorithm overview</a></li>
<li class="chapter" data-level="14.6.2" data-path="DataIntegration-PBMMCTop.html"><a href="DataIntegration-PBMMCTop.html#application-to-the-data"><i class="fa fa-check"></i><b>14.6.2</b> Application to the data</a></li>
</ul></li>
<li class="chapter" data-level="14.7" data-path="DataIntegration-PBMMCTop.html"><a href="DataIntegration-PBMMCTop.html#correction-diagnostics"><i class="fa fa-check"></i><b>14.7</b> Correction diagnostics</a><ul>
<li class="chapter" data-level="14.7.1" data-path="DataIntegration-PBMMCTop.html"><a href="DataIntegration-PBMMCTop.html#mixing-between-batches"><i class="fa fa-check"></i><b>14.7.1</b> Mixing between batches</a></li>
</ul></li>
<li class="chapter" data-level="14.8" data-path="DataIntegration-PBMMCTop.html"><a href="DataIntegration-PBMMCTop.html#preserving-biological-heterogeneity"><i class="fa fa-check"></i><b>14.8</b> Preserving biological heterogeneity</a><ul>
<li class="chapter" data-level="14.8.1" data-path="DataIntegration-PBMMCTop.html"><a href="DataIntegration-PBMMCTop.html#comparison-to-within-batch-clusters"><i class="fa fa-check"></i><b>14.8.1</b> Comparison to within-batch clusters</a></li>
<li class="chapter" data-level="14.8.2" data-path="DataIntegration-PBMMCTop.html"><a href="DataIntegration-PBMMCTop.html#encouraging-consistency-with-marker-genes"><i class="fa fa-check"></i><b>14.8.2</b> Encouraging consistency with marker genes</a></li>
</ul></li>
<li class="chapter" data-level="14.9" data-path="DataIntegration-PBMMCTop.html"><a href="DataIntegration-PBMMCTop.html#session-information-10"><i class="fa fa-check"></i><b>14.9</b> Session information</a></li>
</ul></li>
<li class="chapter" data-level="15" data-path="dataSetIntegration-ETV6-RUNX1Top.html"><a href="dataSetIntegration-ETV6-RUNX1Top.html"><i class="fa fa-check"></i><b>15</b> Data integration - ETV6-RUNX1</a><ul>
<li class="chapter" data-level="15.1" data-path="dataSetIntegration-ETV6-RUNX1Top.html"><a href="dataSetIntegration-ETV6-RUNX1Top.html#abbreviations-2"><i class="fa fa-check"></i><b>15.1</b> Abbreviations</a></li>
<li class="chapter" data-level="15.2" data-path="dataSetIntegration-ETV6-RUNX1Top.html"><a href="dataSetIntegration-ETV6-RUNX1Top.html#motivation-1"><i class="fa fa-check"></i><b>15.2</b> Motivation</a></li>
<li class="chapter" data-level="15.3" data-path="dataSetIntegration-ETV6-RUNX1Top.html"><a href="dataSetIntegration-ETV6-RUNX1Top.html#loading-the-data-1"><i class="fa fa-check"></i><b>15.3</b> Loading the data</a></li>
<li class="chapter" data-level="15.4" data-path="dataSetIntegration-ETV6-RUNX1Top.html"><a href="dataSetIntegration-ETV6-RUNX1Top.html#diagnosing-batch-effects-1"><i class="fa fa-check"></i><b>15.4</b> Diagnosing batch effects</a></li>
<li class="chapter" data-level="15.5" data-path="dataSetIntegration-ETV6-RUNX1Top.html"><a href="dataSetIntegration-ETV6-RUNX1Top.html#linear-regression-1"><i class="fa fa-check"></i><b>15.5</b> Linear regression</a></li>
<li class="chapter" data-level="15.6" data-path="dataSetIntegration-ETV6-RUNX1Top.html"><a href="dataSetIntegration-ETV6-RUNX1Top.html#performing-mnn-correction-1"><i class="fa fa-check"></i><b>15.6</b> Performing MNN correction</a><ul>
<li class="chapter" data-level="15.6.1" data-path="dataSetIntegration-ETV6-RUNX1Top.html"><a href="dataSetIntegration-ETV6-RUNX1Top.html#algorithm-overview-1"><i class="fa fa-check"></i><b>15.6.1</b> Algorithm overview</a></li>
<li class="chapter" data-level="15.6.2" data-path="dataSetIntegration-ETV6-RUNX1Top.html"><a href="dataSetIntegration-ETV6-RUNX1Top.html#application-to-the-data-1"><i class="fa fa-check"></i><b>15.6.2</b> Application to the data</a></li>
</ul></li>
<li class="chapter" data-level="15.7" data-path="dataSetIntegration-ETV6-RUNX1Top.html"><a href="dataSetIntegration-ETV6-RUNX1Top.html#correction-diagnostics-1"><i class="fa fa-check"></i><b>15.7</b> Correction diagnostics</a><ul>
<li class="chapter" data-level="15.7.1" data-path="dataSetIntegration-ETV6-RUNX1Top.html"><a href="dataSetIntegration-ETV6-RUNX1Top.html#mixing-between-batches-1"><i class="fa fa-check"></i><b>15.7.1</b> Mixing between batches</a></li>
<li class="chapter" data-level="15.7.2" data-path="dataSetIntegration-ETV6-RUNX1Top.html"><a href="dataSetIntegration-ETV6-RUNX1Top.html#preserving-biological-heterogeneity-1"><i class="fa fa-check"></i><b>15.7.2</b> Preserving biological heterogeneity</a><ul>
<li class="chapter" data-level="15.7.2.1" data-path="dataSetIntegration-ETV6-RUNX1Top.html"><a href="dataSetIntegration-ETV6-RUNX1Top.html#comparison-between-within-batch-clusters-and-across-batch-clusters-obtained-after-mnn-correction"><i class="fa fa-check"></i><b>15.7.2.1</b> Comparison between within-batch clusters and across-batch clusters obtained after MNN correction</a></li>
<li class="chapter" data-level="15.7.2.2" data-path="dataSetIntegration-ETV6-RUNX1Top.html"><a href="dataSetIntegration-ETV6-RUNX1Top.html#coassignment-probabilities"><i class="fa fa-check"></i><b>15.7.2.2</b> Coassignment probabilities</a></li>
<li class="chapter" data-level="15.7.2.3" data-path="dataSetIntegration-ETV6-RUNX1Top.html"><a href="dataSetIntegration-ETV6-RUNX1Top.html#rand-index"><i class="fa fa-check"></i><b>15.7.2.3</b> Rand index</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="15.8" data-path="dataSetIntegration-ETV6-RUNX1Top.html"><a href="dataSetIntegration-ETV6-RUNX1Top.html#encouraging-consistency-with-marker-genes-1"><i class="fa fa-check"></i><b>15.8</b> Encouraging consistency with marker genes</a></li>
<li class="chapter" data-level="15.9" data-path="dataSetIntegration-ETV6-RUNX1Top.html"><a href="dataSetIntegration-ETV6-RUNX1Top.html#session-information-11"><i class="fa fa-check"></i><b>15.9</b> Session information</a></li>
</ul></li>
<li class="chapter" data-level="16" data-path="dataSetIntegration-HHDTop.html"><a href="dataSetIntegration-HHDTop.html"><i class="fa fa-check"></i><b>16</b> Data integration - HDD</a><ul>
<li class="chapter" data-level="16.1" data-path="dataSetIntegration-HHDTop.html"><a href="dataSetIntegration-HHDTop.html#abbreviations-3"><i class="fa fa-check"></i><b>16.1</b> Abbreviations</a></li>
<li class="chapter" data-level="16.2" data-path="dataSetIntegration-HHDTop.html"><a href="dataSetIntegration-HHDTop.html#motivation-2"><i class="fa fa-check"></i><b>16.2</b> Motivation</a></li>
<li class="chapter" data-level="16.3" data-path="dataSetIntegration-HHDTop.html"><a href="dataSetIntegration-HHDTop.html#load-data-3"><i class="fa fa-check"></i><b>16.3</b> Load data</a></li>
<li class="chapter" data-level="16.4" data-path="dataSetIntegration-HHDTop.html"><a href="dataSetIntegration-HHDTop.html#loading-the-data-2"><i class="fa fa-check"></i><b>16.4</b> Loading the data</a></li>
<li class="chapter" data-level="16.5" data-path="dataSetIntegration-HHDTop.html"><a href="dataSetIntegration-HHDTop.html#diagnosing-batch-effects-2"><i class="fa fa-check"></i><b>16.5</b> Diagnosing batch effects</a></li>
<li class="chapter" data-level="16.6" data-path="dataSetIntegration-HHDTop.html"><a href="dataSetIntegration-HHDTop.html#linear-regression-2"><i class="fa fa-check"></i><b>16.6</b> Linear regression</a></li>
<li class="chapter" data-level="16.7" data-path="dataSetIntegration-HHDTop.html"><a href="dataSetIntegration-HHDTop.html#performing-mnn-correction-2"><i class="fa fa-check"></i><b>16.7</b> Performing MNN correction</a><ul>
<li class="chapter" data-level="16.7.1" data-path="dataSetIntegration-HHDTop.html"><a href="dataSetIntegration-HHDTop.html#algorithm-overview-2"><i class="fa fa-check"></i><b>16.7.1</b> Algorithm overview</a></li>
<li class="chapter" data-level="16.7.2" data-path="dataSetIntegration-HHDTop.html"><a href="dataSetIntegration-HHDTop.html#application-to-the-data-2"><i class="fa fa-check"></i><b>16.7.2</b> Application to the data</a></li>
</ul></li>
<li class="chapter" data-level="16.8" data-path="dataSetIntegration-HHDTop.html"><a href="dataSetIntegration-HHDTop.html#correction-diagnostics-2"><i class="fa fa-check"></i><b>16.8</b> Correction diagnostics</a><ul>
<li class="chapter" data-level="16.8.1" data-path="dataSetIntegration-HHDTop.html"><a href="dataSetIntegration-HHDTop.html#mixing-between-batches-2"><i class="fa fa-check"></i><b>16.8.1</b> Mixing between batches</a></li>
<li class="chapter" data-level="16.8.2" data-path="dataSetIntegration-HHDTop.html"><a href="dataSetIntegration-HHDTop.html#preserving-biological-heterogeneity-2"><i class="fa fa-check"></i><b>16.8.2</b> Preserving biological heterogeneity</a><ul>
<li class="chapter" data-level="16.8.2.1" data-path="dataSetIntegration-HHDTop.html"><a href="dataSetIntegration-HHDTop.html#comparison-between-within-batch-clusters-and-across-batch-clusters-obtained-after-mnn-correction-1"><i class="fa fa-check"></i><b>16.8.2.1</b> Comparison between within-batch clusters and across-batch clusters obtained after MNN correction</a></li>
<li class="chapter" data-level="16.8.2.2" data-path="dataSetIntegration-HHDTop.html"><a href="dataSetIntegration-HHDTop.html#coassignment-probabilities-1"><i class="fa fa-check"></i><b>16.8.2.2</b> Coassignment probabilities</a></li>
<li class="chapter" data-level="16.8.2.3" data-path="dataSetIntegration-HHDTop.html"><a href="dataSetIntegration-HHDTop.html#rand-index-1"><i class="fa fa-check"></i><b>16.8.2.3</b> Rand index</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="16.9" data-path="dataSetIntegration-HHDTop.html"><a href="dataSetIntegration-HHDTop.html#encouraging-consistency-with-marker-genes-2"><i class="fa fa-check"></i><b>16.9</b> Encouraging consistency with marker genes</a></li>
<li class="chapter" data-level="16.10" data-path="dataSetIntegration-HHDTop.html"><a href="dataSetIntegration-HHDTop.html#session-information-12"><i class="fa fa-check"></i><b>16.10</b> Session information</a></li>
</ul></li>
<li class="chapter" data-level="17" data-path="DataIntegrationPretTop.html"><a href="DataIntegrationPretTop.html"><i class="fa fa-check"></i><b>17</b> Data integration - PRE-T</a><ul>
<li class="chapter" data-level="17.1" data-path="DataIntegrationPretTop.html"><a href="DataIntegrationPretTop.html#abbreviations-4"><i class="fa fa-check"></i><b>17.1</b> Abbreviations</a></li>
<li class="chapter" data-level="17.2" data-path="DataIntegrationPretTop.html"><a href="DataIntegrationPretTop.html#motivation-3"><i class="fa fa-check"></i><b>17.2</b> Motivation</a></li>
<li class="chapter" data-level="17.3" data-path="DataIntegrationPretTop.html"><a href="DataIntegrationPretTop.html#load-data-4"><i class="fa fa-check"></i><b>17.3</b> Load data</a></li>
<li class="chapter" data-level="17.4" data-path="DataIntegrationPretTop.html"><a href="DataIntegrationPretTop.html#loading-the-data-3"><i class="fa fa-check"></i><b>17.4</b> Loading the data</a></li>
<li class="chapter" data-level="17.5" data-path="DataIntegrationPretTop.html"><a href="DataIntegrationPretTop.html#diagnosing-batch-effects-3"><i class="fa fa-check"></i><b>17.5</b> Diagnosing batch effects</a></li>
<li class="chapter" data-level="17.6" data-path="DataIntegrationPretTop.html"><a href="DataIntegrationPretTop.html#linear-regression-3"><i class="fa fa-check"></i><b>17.6</b> Linear regression</a></li>
<li class="chapter" data-level="17.7" data-path="DataIntegrationPretTop.html"><a href="DataIntegrationPretTop.html#performing-mnn-correction-3"><i class="fa fa-check"></i><b>17.7</b> Performing MNN correction</a><ul>
<li class="chapter" data-level="17.7.1" data-path="DataIntegrationPretTop.html"><a href="DataIntegrationPretTop.html#algorithm-overview-3"><i class="fa fa-check"></i><b>17.7.1</b> Algorithm overview</a></li>
<li class="chapter" data-level="17.7.2" data-path="DataIntegrationPretTop.html"><a href="DataIntegrationPretTop.html#application-to-the-data-3"><i class="fa fa-check"></i><b>17.7.2</b> Application to the data</a></li>
</ul></li>
<li class="chapter" data-level="17.8" data-path="DataIntegrationPretTop.html"><a href="DataIntegrationPretTop.html#correction-diagnostics-3"><i class="fa fa-check"></i><b>17.8</b> Correction diagnostics</a><ul>
<li class="chapter" data-level="17.8.1" data-path="DataIntegrationPretTop.html"><a href="DataIntegrationPretTop.html#mixing-between-batches-3"><i class="fa fa-check"></i><b>17.8.1</b> Mixing between batches</a></li>
<li class="chapter" data-level="17.8.2" data-path="DataIntegrationPretTop.html"><a href="DataIntegrationPretTop.html#preserving-biological-heterogeneity-3"><i class="fa fa-check"></i><b>17.8.2</b> Preserving biological heterogeneity</a><ul>
<li class="chapter" data-level="17.8.2.1" data-path="DataIntegrationPretTop.html"><a href="DataIntegrationPretTop.html#comparison-between-within-batch-clusters-and-across-batch-clusters-obtained-after-mnn-correction-2"><i class="fa fa-check"></i><b>17.8.2.1</b> Comparison between within-batch clusters and across-batch clusters obtained after MNN correction</a></li>
<li class="chapter" data-level="17.8.2.2" data-path="DataIntegrationPretTop.html"><a href="DataIntegrationPretTop.html#coassignment-probabilities-2"><i class="fa fa-check"></i><b>17.8.2.2</b> Coassignment probabilities</a></li>
<li class="chapter" data-level="17.8.2.3" data-path="DataIntegrationPretTop.html"><a href="DataIntegrationPretTop.html#rand-index-2"><i class="fa fa-check"></i><b>17.8.2.3</b> Rand index</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="17.9" data-path="DataIntegrationPretTop.html"><a href="DataIntegrationPretTop.html#encouraging-consistency-with-marker-genes-3"><i class="fa fa-check"></i><b>17.9</b> Encouraging consistency with marker genes</a></li>
<li class="chapter" data-level="17.10" data-path="DataIntegrationPretTop.html"><a href="DataIntegrationPretTop.html#session-information-13"><i class="fa fa-check"></i><b>17.10</b> Session information</a></li>
</ul></li>
<li class="chapter" data-level="18" data-path="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html"><i class="fa fa-check"></i><b>18</b> Data integration - PBMMC + ETV6-RUNX</a><ul>
<li class="chapter" data-level="18.1" data-path="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#abbreviations-5"><i class="fa fa-check"></i><b>18.1</b> Abbreviations</a></li>
<li class="chapter" data-level="18.2" data-path="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#motivation-4"><i class="fa fa-check"></i><b>18.2</b> Motivation</a></li>
<li class="chapter" data-level="18.3" data-path="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#load-data-5"><i class="fa fa-check"></i><b>18.3</b> Load data</a></li>
<li class="chapter" data-level="18.4" data-path="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#loading-the-data-4"><i class="fa fa-check"></i><b>18.4</b> Loading the data</a></li>
<li class="chapter" data-level="18.5" data-path="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#diagnosing-batch-effects-4"><i class="fa fa-check"></i><b>18.5</b> Diagnosing batch effects</a></li>
<li class="chapter" data-level="18.6" data-path="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#linear-regression-4"><i class="fa fa-check"></i><b>18.6</b> Linear regression</a></li>
<li class="chapter" data-level="18.7" data-path="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#performing-mnn-correction-4"><i class="fa fa-check"></i><b>18.7</b> Performing MNN correction</a><ul>
<li class="chapter" data-level="18.7.1" data-path="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#algorithm-overview-4"><i class="fa fa-check"></i><b>18.7.1</b> Algorithm overview</a></li>
<li class="chapter" data-level="18.7.2" data-path="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#application-to-the-data-4"><i class="fa fa-check"></i><b>18.7.2</b> Application to the data</a></li>
</ul></li>
<li class="chapter" data-level="18.8" data-path="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#correction-diagnostics-4"><i class="fa fa-check"></i><b>18.8</b> Correction diagnostics</a><ul>
<li class="chapter" data-level="18.8.1" data-path="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#mixing-between-batches-4"><i class="fa fa-check"></i><b>18.8.1</b> Mixing between batches</a></li>
<li class="chapter" data-level="18.8.2" data-path="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#preserving-biological-heterogeneity-4"><i class="fa fa-check"></i><b>18.8.2</b> Preserving biological heterogeneity</a><ul>
<li class="chapter" data-level="18.8.2.1" data-path="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#comparison-between-within-batch-clusters-and-across-batch-clusters-obtained-after-mnn-correction-3"><i class="fa fa-check"></i><b>18.8.2.1</b> Comparison between within-batch clusters and across-batch clusters obtained after MNN correction</a></li>
<li class="chapter" data-level="18.8.2.2" data-path="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#coassignment-probabilities-3"><i class="fa fa-check"></i><b>18.8.2.2</b> Coassignment probabilities</a></li>
<li class="chapter" data-level="18.8.2.3" data-path="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#rand-index-3"><i class="fa fa-check"></i><b>18.8.2.3</b> Rand index</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="18.9" data-path="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#encouraging-consistency-with-marker-genes-4"><i class="fa fa-check"></i><b>18.9</b> Encouraging consistency with marker genes</a></li>
<li class="chapter" data-level="18.10" data-path="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#identify-clusters-with-pbmmc-cells"><i class="fa fa-check"></i><b>18.10</b> Identify clusters with PBMMC cells</a></li>
<li class="chapter" data-level="18.11" data-path="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#session-information-14"><i class="fa fa-check"></i><b>18.11</b> Session information</a></li>
</ul></li>
<li class="chapter" data-level="19" data-path="dataSetIntegration-allSetsTop.html"><a href="dataSetIntegration-allSetsTop.html"><i class="fa fa-check"></i><b>19</b> Data integration - all Caron sample types</a><ul>
<li class="chapter" data-level="19.1" data-path="dataSetIntegration-allSetsTop.html"><a href="dataSetIntegration-allSetsTop.html#motivation-5"><i class="fa fa-check"></i><b>19.1</b> Motivation</a></li>
<li class="chapter" data-level="19.2" data-path="dataSetIntegration-allSetsTop.html"><a href="dataSetIntegration-allSetsTop.html#load-data-6"><i class="fa fa-check"></i><b>19.2</b> Load data</a></li>
<li class="chapter" data-level="19.3" data-path="dataSetIntegration-allSetsTop.html"><a href="dataSetIntegration-allSetsTop.html#diagnosing-batch-effects-5"><i class="fa fa-check"></i><b>19.3</b> Diagnosing batch effects</a></li>
<li class="chapter" data-level="19.4" data-path="dataSetIntegration-allSetsTop.html"><a href="dataSetIntegration-allSetsTop.html#linear-regression-5"><i class="fa fa-check"></i><b>19.4</b> Linear regression</a></li>
<li class="chapter" data-level="19.5" data-path="dataSetIntegration-allSetsTop.html"><a href="dataSetIntegration-allSetsTop.html#performing-mnn-correction-5"><i class="fa fa-check"></i><b>19.5</b> Performing MNN correction</a><ul>
<li class="chapter" data-level="19.5.1" data-path="dataSetIntegration-allSetsTop.html"><a href="dataSetIntegration-allSetsTop.html#algorithm-overview-5"><i class="fa fa-check"></i><b>19.5.1</b> Algorithm overview</a></li>
<li class="chapter" data-level="19.5.2" data-path="dataSetIntegration-allSetsTop.html"><a href="dataSetIntegration-allSetsTop.html#application-to-the-data-5"><i class="fa fa-check"></i><b>19.5.2</b> Application to the data</a></li>
<li class="chapter" data-level="19.5.3" data-path="dataSetIntegration-allSetsTop.html"><a href="dataSetIntegration-allSetsTop.html#correction-diagnostics-5"><i class="fa fa-check"></i><b>19.5.3</b> Correction diagnostics</a></li>
</ul></li>
<li class="chapter" data-level="19.6" data-path="dataSetIntegration-allSetsTop.html"><a href="dataSetIntegration-allSetsTop.html#preserving-biological-heterogeneity-5"><i class="fa fa-check"></i><b>19.6</b> Preserving biological heterogeneity</a><ul>
<li class="chapter" data-level="19.6.1" data-path="dataSetIntegration-allSetsTop.html"><a href="dataSetIntegration-allSetsTop.html#comparison-to-within-batch-clusters-1"><i class="fa fa-check"></i><b>19.6.1</b> Comparison to within-batch clusters</a></li>
<li class="chapter" data-level="19.6.2" data-path="dataSetIntegration-allSetsTop.html"><a href="dataSetIntegration-allSetsTop.html#encouraging-consistency-with-marker-genes-5"><i class="fa fa-check"></i><b>19.6.2</b> Encouraging consistency with marker genes</a></li>
<li class="chapter" data-level="19.6.3" data-path="dataSetIntegration-allSetsTop.html"><a href="dataSetIntegration-allSetsTop.html#using-the-corrected-values"><i class="fa fa-check"></i><b>19.6.3</b> Using the corrected values</a></li>
</ul></li>
<li class="chapter" data-level="19.7" data-path="dataSetIntegration-allSetsTop.html"><a href="dataSetIntegration-allSetsTop.html#challenge-same-but-with-an-ordered-merging"><i class="fa fa-check"></i><b>19.7</b> <strong>Challenge</strong> Same but with an ordered merging</a></li>
<li class="chapter" data-level="19.8" data-path="dataSetIntegration-allSetsTop.html"><a href="dataSetIntegration-allSetsTop.html#session-information-15"><i class="fa fa-check"></i><b>19.8</b> Session information</a></li>
</ul></li>
<li class="chapter" data-level="20" data-path="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html"><a href="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html"><i class="fa fa-check"></i><b>20</b> Clustering with ‘’PBMMC,ETV6-RUNX1’’ and ’_5hCellPerSpl’ {#clustering’PBMMC_ETV6-RUNX1__5hCellPerSpl’Top}</a><ul>
<li class="chapter" data-level="20.1" data-path="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html"><a href="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html#load-data-7"><i class="fa fa-check"></i><b>20.1</b> Load data</a></li>
<li class="chapter" data-level="20.2" data-path="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html"><a href="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html#clustering-cells-into-putative-subpopulations"><i class="fa fa-check"></i><b>20.2</b> Clustering cells into putative subpopulations</a><ul>
<li class="chapter" data-level="20.2.1" data-path="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html"><a href="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html#hierarchical-clustering"><i class="fa fa-check"></i><b>20.2.1</b> Hierarchical clustering</a><ul>
<li class="chapter" data-level="20.2.1.1" data-path="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html"><a href="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html#clustering"><i class="fa fa-check"></i><b>20.2.1.1</b> Clustering</a></li>
<li class="chapter" data-level="20.2.1.2" data-path="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html"><a href="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html#separatedness"><i class="fa fa-check"></i><b>20.2.1.2</b> Separatedness</a></li>
</ul></li>
<li class="chapter" data-level="20.2.2" data-path="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html"><a href="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html#k-means"><i class="fa fa-check"></i><b>20.2.2</b> k-means</a><ul>
<li class="chapter" data-level="20.2.2.1" data-path="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html"><a href="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html#description-1"><i class="fa fa-check"></i><b>20.2.2.1</b> Description</a></li>
<li class="chapter" data-level="20.2.2.2" data-path="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html"><a href="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html#example-3"><i class="fa fa-check"></i><b>20.2.2.2</b> Example</a></li>
<li class="chapter" data-level="20.2.2.3" data-path="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html"><a href="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html#within-cluster-sum-of-squares"><i class="fa fa-check"></i><b>20.2.2.3</b> Within-cluster sum-of-squares</a></li>
<li class="chapter" data-level="20.2.2.4" data-path="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html"><a href="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html#silhouette"><i class="fa fa-check"></i><b>20.2.2.4</b> Silhouette</a></li>
<li class="chapter" data-level="20.2.2.5" data-path="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html"><a href="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html#gap-statistic"><i class="fa fa-check"></i><b>20.2.2.5</b> Gap statistic</a></li>
<li class="chapter" data-level="20.2.2.6" data-path="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html"><a href="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html#multi-metric"><i class="fa fa-check"></i><b>20.2.2.6</b> Multi-metric</a></li>
</ul></li>
<li class="chapter" data-level="20.2.3" data-path="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html"><a href="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html#graph-based-clustering"><i class="fa fa-check"></i><b>20.2.3</b> Graph-based clustering</a><ul>
<li class="chapter" data-level="20.2.3.1" data-path="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html"><a href="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html#modularity"><i class="fa fa-check"></i><b>20.2.3.1</b> Modularity</a></li>
<li class="chapter" data-level="20.2.3.2" data-path="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html"><a href="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html#walktrap-method"><i class="fa fa-check"></i><b>20.2.3.2</b> Walktrap method</a></li>
<li class="chapter" data-level="20.2.3.3" data-path="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html"><a href="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html#louvain-method"><i class="fa fa-check"></i><b>20.2.3.3</b> Louvain method</a></li>
<li class="chapter" data-level="20.2.3.4" data-path="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html"><a href="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html#leiden-method"><i class="fa fa-check"></i><b>20.2.3.4</b> Leiden method</a></li>
<li class="chapter" data-level="20.2.3.5" data-path="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html"><a href="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html#modularity-to-assess-clusters-quality"><i class="fa fa-check"></i><b>20.2.3.5</b> Modularity to assess clusters quality</a></li>
<li class="chapter" data-level="20.2.3.6" data-path="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html"><a href="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html#choose-the-number-of-clusters"><i class="fa fa-check"></i><b>20.2.3.6</b> Choose the number of clusters</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="20.3" data-path="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html"><a href="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html#comparing-two-sets-of-clusters"><i class="fa fa-check"></i><b>20.3</b> Comparing two sets of clusters</a></li>
<li class="chapter" data-level="20.4" data-path="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html"><a href="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html#expression-of-known-marker-genes"><i class="fa fa-check"></i><b>20.4</b> Expression of known marker genes</a></li>
<li class="chapter" data-level="20.5" data-path="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html"><a href="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html#save-data"><i class="fa fa-check"></i><b>20.5</b> Save data</a></li>
<li class="chapter" data-level="20.6" data-path="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html"><a href="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html#session-information-16"><i class="fa fa-check"></i><b>20.6</b> Session information</a></li>
</ul></li>
<li class="chapter" data-level="21" data-path="cluster-marker-genes.html"><a href="cluster-marker-genes.html"><i class="fa fa-check"></i><b>21</b> Cluster marker genes</a><ul>
<li class="chapter" data-level="21.1" data-path="cluster-marker-genes.html"><a href="cluster-marker-genes.html#learning-objectives"><i class="fa fa-check"></i><b>21.1</b> Learning objectives</a></li>
<li class="chapter" data-level="21.2" data-path="cluster-marker-genes.html"><a href="cluster-marker-genes.html#load-data-8"><i class="fa fa-check"></i><b>21.2</b> Load data</a></li>
<li class="chapter" data-level="21.3" data-path="cluster-marker-genes.html"><a href="cluster-marker-genes.html#detecting-genes-differentially-expressed-between-clusters"><i class="fa fa-check"></i><b>21.3</b> Detecting genes differentially expressed between clusters</a><ul>
<li class="chapter" data-level="21.3.1" data-path="cluster-marker-genes.html"><a href="cluster-marker-genes.html#differential-expression-analysis"><i class="fa fa-check"></i><b>21.3.1</b> Differential expression analysis</a></li>
<li class="chapter" data-level="21.3.2" data-path="cluster-marker-genes.html"><a href="cluster-marker-genes.html#heatmap"><i class="fa fa-check"></i><b>21.3.2</b> Heatmap</a></li>
</ul></li>
<li class="chapter" data-level="21.4" data-path="cluster-marker-genes.html"><a href="cluster-marker-genes.html#using-the-log-fold-change"><i class="fa fa-check"></i><b>21.4</b> Using the log-fold change</a></li>
<li class="chapter" data-level="21.5" data-path="cluster-marker-genes.html"><a href="cluster-marker-genes.html#finding-cluster-specific-markers"><i class="fa fa-check"></i><b>21.5</b> Finding cluster-specific markers</a></li>
<li class="chapter" data-level="21.6" data-path="cluster-marker-genes.html"><a href="cluster-marker-genes.html#using-the-wilcoxon-rank-sum-test"><i class="fa fa-check"></i><b>21.6</b> Using the Wilcoxon rank sum test</a></li>
<li class="chapter" data-level="21.7" data-path="cluster-marker-genes.html"><a href="cluster-marker-genes.html#using-a-binomial-test"><i class="fa fa-check"></i><b>21.7</b> Using a binomial test</a></li>
<li class="chapter" data-level="21.8" data-path="cluster-marker-genes.html"><a href="cluster-marker-genes.html#combining-multiple-marker-statistics"><i class="fa fa-check"></i><b>21.8</b> Combining multiple marker statistics</a></li>
<li class="chapter" data-level="21.9" data-path="cluster-marker-genes.html"><a href="cluster-marker-genes.html#invalidity-of-p-values"><i class="fa fa-check"></i><b>21.9</b> Invalidity of p-values</a><ul>
<li class="chapter" data-level="21.9.1" data-path="cluster-marker-genes.html"><a href="cluster-marker-genes.html#from-data-snooping"><i class="fa fa-check"></i><b>21.9.1</b> From data snooping</a></li>
<li class="chapter" data-level="21.9.2" data-path="cluster-marker-genes.html"><a href="cluster-marker-genes.html#nature-of-replication"><i class="fa fa-check"></i><b>21.9.2</b> Nature of replication</a></li>
</ul></li>
<li class="chapter" data-level="21.10" data-path="cluster-marker-genes.html"><a href="cluster-marker-genes.html#session-information-17"><i class="fa fa-check"></i><b>21.10</b> Session information</a></li>
</ul></li>
<li class="chapter" data-level="22" data-path="cellCyclePhasesTop.html"><a href="cellCyclePhasesTop.html"><i class="fa fa-check"></i><b>22</b> Cell cycle assignment</a><ul>
<li class="chapter" data-level="22.1" data-path="cellCyclePhasesTop.html"><a href="cellCyclePhasesTop.html#load-data-9"><i class="fa fa-check"></i><b>22.1</b> Load data</a></li>
<li class="chapter" data-level="22.2" data-path="cellCyclePhasesTop.html"><a href="cellCyclePhasesTop.html#motivation-6"><i class="fa fa-check"></i><b>22.2</b> Motivation</a></li>
<li class="chapter" data-level="22.3" data-path="cellCyclePhasesTop.html"><a href="cellCyclePhasesTop.html#using-the-cyclins"><i class="fa fa-check"></i><b>22.3</b> Using the cyclins</a></li>
<li class="chapter" data-level="22.4" data-path="cellCyclePhasesTop.html"><a href="cellCyclePhasesTop.html#using-the-cyclone-classifier"><i class="fa fa-check"></i><b>22.4</b> Using the cyclone() classifier</a></li>
<li class="chapter" data-level="22.5" data-path="cellCyclePhasesTop.html"><a href="cellCyclePhasesTop.html#regressing-out-cell-cycle-phase"><i class="fa fa-check"></i><b>22.5</b> Regressing out cell cycle phase</a></li>
<li class="chapter" data-level="22.6" data-path="cellCyclePhasesTop.html"><a href="cellCyclePhasesTop.html#session-information-18"><i class="fa fa-check"></i><b>22.6</b> Session information</a></li>
</ul></li>
<li class="chapter" data-level="23" data-path="differential-expression-and-abundance-between-conditions.html"><a href="differential-expression-and-abundance-between-conditions.html"><i class="fa fa-check"></i><b>23</b> Differential expression and abundance between conditions</a><ul>
<li class="chapter" data-level="23.1" data-path="differential-expression-and-abundance-between-conditions.html"><a href="differential-expression-and-abundance-between-conditions.html#motivation-7"><i class="fa fa-check"></i><b>23.1</b> Motivation</a></li>
<li class="chapter" data-level="23.2" data-path="differential-expression-and-abundance-between-conditions.html"><a href="differential-expression-and-abundance-between-conditions.html#setting-up-the-data"><i class="fa fa-check"></i><b>23.2</b> Setting up the data</a></li>
<li class="chapter" data-level="23.3" data-path="differential-expression-and-abundance-between-conditions.html"><a href="differential-expression-and-abundance-between-conditions.html#differential-expression-between-conditions"><i class="fa fa-check"></i><b>23.3</b> Differential expression between conditions</a><ul>
<li class="chapter" data-level="23.3.1" data-path="differential-expression-and-abundance-between-conditions.html"><a href="differential-expression-and-abundance-between-conditions.html#creating-pseudo-bulk-samples"><i class="fa fa-check"></i><b>23.3.1</b> Creating pseudo-bulk samples</a></li>
<li class="chapter" data-level="23.3.2" data-path="differential-expression-and-abundance-between-conditions.html"><a href="differential-expression-and-abundance-between-conditions.html#performing-the-de-analysis"><i class="fa fa-check"></i><b>23.3.2</b> Performing the DE analysis</a><ul>
<li class="chapter" data-level="23.3.2.1" data-path="differential-expression-and-abundance-between-conditions.html"><a href="differential-expression-and-abundance-between-conditions.html#introduction-4"><i class="fa fa-check"></i><b>23.3.2.1</b> Introduction</a></li>
<li class="chapter" data-level="23.3.2.2" data-path="differential-expression-and-abundance-between-conditions.html"><a href="differential-expression-and-abundance-between-conditions.html#pre-processing"><i class="fa fa-check"></i><b>23.3.2.2</b> Pre-processing</a></li>
<li class="chapter" data-level="23.3.2.3" data-path="differential-expression-and-abundance-between-conditions.html"><a href="differential-expression-and-abundance-between-conditions.html#statistical-modelling"><i class="fa fa-check"></i><b>23.3.2.3</b> Statistical modelling</a></li>
<li class="chapter" data-level="23.3.2.4" data-path="differential-expression-and-abundance-between-conditions.html"><a href="differential-expression-and-abundance-between-conditions.html#differential-expression-for-each-cluster"><i class="fa fa-check"></i><b>23.3.2.4</b> Differential expression for each cluster</a><ul>
<li class="chapter" data-level="23.3.2.4.1" data-path="differential-expression-and-abundance-between-conditions.html"><a href="differential-expression-and-abundance-between-conditions.html#number-of-degs-by-cluster-and-direction"><i class="fa fa-check"></i><b>23.3.2.4.1</b> Number of DEGs by cluster and direction</a></li>
<li class="chapter" data-level="23.3.2.4.2" data-path="differential-expression-and-abundance-between-conditions.html"><a href="differential-expression-and-abundance-between-conditions.html#list-of-degs"><i class="fa fa-check"></i><b>23.3.2.4.2</b> List of DEGs</a></li>
<li class="chapter" data-level="23.3.2.4.3" data-path="differential-expression-and-abundance-between-conditions.html"><a href="differential-expression-and-abundance-between-conditions.html#number-of-clusters-skipped"><i class="fa fa-check"></i><b>23.3.2.4.3</b> Number of clusters skipped</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="23.3.3" data-path="differential-expression-and-abundance-between-conditions.html"><a href="differential-expression-and-abundance-between-conditions.html#putting-it-all-together"><i class="fa fa-check"></i><b>23.3.3</b> Putting it all together</a></li>
</ul></li>
<li class="chapter" data-level="23.4" data-path="differential-expression-and-abundance-between-conditions.html"><a href="differential-expression-and-abundance-between-conditions.html#differential-abundance-between-conditions"><i class="fa fa-check"></i><b>23.4</b> Differential abundance between conditions</a><ul>
<li class="chapter" data-level="23.4.1" data-path="differential-expression-and-abundance-between-conditions.html"><a href="differential-expression-and-abundance-between-conditions.html#overview"><i class="fa fa-check"></i><b>23.4.1</b> Overview</a></li>
<li class="chapter" data-level="23.4.2" data-path="differential-expression-and-abundance-between-conditions.html"><a href="differential-expression-and-abundance-between-conditions.html#handling-composition-effects"><i class="fa fa-check"></i><b>23.4.2</b> Handling composition effects</a><ul>
<li class="chapter" data-level="23.4.2.1" data-path="differential-expression-and-abundance-between-conditions.html"><a href="differential-expression-and-abundance-between-conditions.html#background"><i class="fa fa-check"></i><b>23.4.2.1</b> Background</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="23.5" data-path="differential-expression-and-abundance-between-conditions.html"><a href="differential-expression-and-abundance-between-conditions.html#session-information-19"><i class="fa fa-check"></i><b>23.5</b> Session information</a></li>
</ul></li>
<li class="chapter" data-level="24" data-path="pseudoTimeTop.html"><a href="pseudoTimeTop.html"><i class="fa fa-check"></i><b>24</b> Pseudotime analysis</a><ul>
<li class="chapter" data-level="24.0.1" data-path="pseudoTimeTop.html"><a href="pseudoTimeTop.html#variance-modeling"><i class="fa fa-check"></i><b>24.0.1</b> Variance modeling</a></li>
<li class="chapter" data-level="24.0.2" data-path="pseudoTimeTop.html"><a href="pseudoTimeTop.html#data-integration"><i class="fa fa-check"></i><b>24.0.2</b> Data integration</a></li>
<li class="chapter" data-level="24.0.3" data-path="pseudoTimeTop.html"><a href="pseudoTimeTop.html#dimensionality-reduction"><i class="fa fa-check"></i><b>24.0.3</b> Dimensionality Reduction</a></li>
<li class="chapter" data-level="24.0.4" data-path="pseudoTimeTop.html"><a href="pseudoTimeTop.html#clustering-1"><i class="fa fa-check"></i><b>24.0.4</b> Clustering</a></li>
<li class="chapter" data-level="24.0.5" data-path="pseudoTimeTop.html"><a href="pseudoTimeTop.html#cell-type-classification"><i class="fa fa-check"></i><b>24.0.5</b> Cell type classification</a></li>
<li class="chapter" data-level="24.0.6" data-path="pseudoTimeTop.html"><a href="pseudoTimeTop.html#extract-t-cells"><i class="fa fa-check"></i><b>24.0.6</b> Extract T-cells</a></li>
<li class="chapter" data-level="24.1" data-path="pseudoTimeTop.html"><a href="pseudoTimeTop.html#pseudoTimeSetUp"><i class="fa fa-check"></i><b>24.1</b> Setting up the data</a><ul>
<li class="chapter" data-level="24.1.1" data-path="pseudoTimeTop.html"><a href="pseudoTimeTop.html#trajectory-inference-with-destiny"><i class="fa fa-check"></i><b>24.1.1</b> Trajectory inference with destiny</a></li>
<li class="chapter" data-level="24.1.2" data-path="pseudoTimeTop.html"><a href="pseudoTimeTop.html#find-temporally-expressed-genes"><i class="fa fa-check"></i><b>24.1.2</b> Find temporally expressed genes</a></li>
<li class="chapter" data-level="24.1.3" data-path="pseudoTimeTop.html"><a href="pseudoTimeTop.html#pseudotime-analysis-for-another-hca-sample"><i class="fa fa-check"></i><b>24.1.3</b> Pseudotime analysis for another HCA sample</a></li>
<li class="chapter" data-level="24.1.4" data-path="pseudoTimeTop.html"><a href="pseudoTimeTop.html#exercise-1"><i class="fa fa-check"></i><b>24.1.4</b> Exercise 1</a></li>
</ul></li>
<li class="chapter" data-level="24.2" data-path="pseudoTimeTop.html"><a href="pseudoTimeTop.html#pseudoTime3Top"><i class="fa fa-check"></i><b>24.2</b> <strong>Pseudotime Alignment</strong></a></li>
<li class="chapter" data-level="24.3" data-path="pseudoTimeTop.html"><a href="pseudoTimeTop.html#ackowledgements"><i class="fa fa-check"></i><b>24.3</b> Ackowledgements</a></li>
<li class="chapter" data-level="24.4" data-path="pseudoTimeTop.html"><a href="pseudoTimeTop.html#session-information-20"><i class="fa fa-check"></i><b>24.4</b> Session information</a></li>
</ul></li>
<li class="chapter" data-level="25" data-path="doubletDetectionTop.html"><a href="doubletDetectionTop.html"><i class="fa fa-check"></i><b>25</b> Doublet detection</a><ul>
<li class="chapter" data-level="25.1" data-path="doubletDetectionTop.html"><a href="doubletDetectionTop.html#learning-objectives-1"><i class="fa fa-check"></i><b>25.1</b> Learning objectives</a></li>
<li class="chapter" data-level="25.2" data-path="doubletDetectionTop.html"><a href="doubletDetectionTop.html#set-up-analysis"><i class="fa fa-check"></i><b>25.2</b> Set up analysis</a></li>
<li class="chapter" data-level="25.3" data-path="doubletDetectionTop.html"><a href="doubletDetectionTop.html#load-data-10"><i class="fa fa-check"></i><b>25.3</b> Load data</a></li>
<li class="chapter" data-level="25.4" data-path="doubletDetectionTop.html"><a href="doubletDetectionTop.html#overview-1"><i class="fa fa-check"></i><b>25.4</b> Overview</a></li>
<li class="chapter" data-level="25.5" data-path="doubletDetectionTop.html"><a href="doubletDetectionTop.html#doublet-detection-by-simulation"><i class="fa fa-check"></i><b>25.5</b> Doublet detection by simulation</a></li>
<li class="chapter" data-level="25.6" data-path="doubletDetectionTop.html"><a href="doubletDetectionTop.html#further-comments"><i class="fa fa-check"></i><b>25.6</b> Further comments</a></li>
<li class="chapter" data-level="25.7" data-path="doubletDetectionTop.html"><a href="doubletDetectionTop.html#session-information-21"><i class="fa fa-check"></i><b>25.7</b> Session information</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">CRUK Bioinformatics Summer School 2020 - single-cell RNA-seq analysis</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="dataSetIntegration_PBMMC_ETV6-RUNX1Top" class="section level1">
<h1><span class="header-section-number">Chapter 18</span> Data integration - PBMMC + ETV6-RUNX</h1>
<div class="sourceCode" id="cb1371"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1371-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1371-1"></a><span class="co"># OLD</span></span>
<span id="cb1371-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1371-2"></a><span class="co">#projDir &lt;- &quot;/mnt/scratcha/bioinformatics/baller01/20200511_FernandesM_ME_crukBiSs2020&quot;</span></span>
<span id="cb1371-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1371-3"></a>projDir &lt;-<span class="st"> &quot;/data/personal/baller01/20200511_FernandesM_ME_crukBiSs2020&quot;</span></span>
<span id="cb1371-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1371-4"></a>outDirBit &lt;-<span class="st"> &quot;AnaWiSce/Attempt3&quot;</span></span>
<span id="cb1371-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1371-5"></a>nbPcToComp &lt;-<span class="st"> </span><span class="dv">50</span></span>
<span id="cb1371-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1371-6"></a><span class="co">#splSetToGet &lt;- params$splSetToGet # params may not be read in if knitting book.</span></span>
<span id="cb1371-7"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1371-7"></a>splSetToGet &lt;-<span class="st"> &quot;PRE-T&quot;</span> <span class="co"># params may not be read in if knitting book.</span></span></code></pre></div>
<div class="sourceCode" id="cb1372"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1372-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1372-1"></a>projDir &lt;-<span class="st"> </span>params<span class="op">$</span>projDir</span>
<span id="cb1372-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1372-2"></a>dirRel &lt;-<span class="st"> </span>params<span class="op">$</span>dirRel</span>
<span id="cb1372-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1372-3"></a>outDirBit &lt;-<span class="st"> </span>params<span class="op">$</span>outDirBit</span>
<span id="cb1372-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1372-4"></a>cacheBool &lt;-<span class="st"> </span>params<span class="op">$</span>cacheBool</span>
<span id="cb1372-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1372-5"></a>splSetToGet &lt;-<span class="st"> </span>params<span class="op">$</span>splSetToGet</span>
<span id="cb1372-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1372-6"></a>setName &lt;-<span class="st"> </span>params<span class="op">$</span>setName</span>
<span id="cb1372-7"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1372-7"></a>setSuf &lt;-<span class="st"> </span>params<span class="op">$</span>setSuf</span>
<span id="cb1372-8"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1372-8"></a><span class="cf">if</span>(params<span class="op">$</span>bookType <span class="op">==</span><span class="st"> &quot;mk&quot;</span>){</span>
<span id="cb1372-9"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1372-9"></a>    splSetToGet &lt;-<span class="st"> &quot;PBMMC,ETV6-RUNX1&quot;</span></span>
<span id="cb1372-10"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1372-10"></a>    setName &lt;-<span class="st"> &quot;caron&quot;</span></span>
<span id="cb1372-11"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1372-11"></a>    setSuf &lt;-<span class="st"> &quot;_5hCellPerSpl&quot;</span></span>
<span id="cb1372-12"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1372-12"></a>}</span>
<span id="cb1372-13"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1372-13"></a>splSetVec &lt;-<span class="st"> </span><span class="kw">unlist</span>(<span class="kw">strsplit</span>(splSetToGet, <span class="st">&quot;,&quot;</span>)) <span class="co"># params may not be read in if knitting book.</span></span>
<span id="cb1372-14"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1372-14"></a>splSetToGet2 &lt;-<span class="st"> </span><span class="kw">gsub</span>(<span class="st">&quot;,&quot;</span>, <span class="st">&quot;_&quot;</span>, splSetToGet)</span>
<span id="cb1372-15"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1372-15"></a>nbPcToComp &lt;-<span class="st"> </span><span class="dv">50</span></span>
<span id="cb1372-16"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1372-16"></a>figSize &lt;-<span class="st"> </span><span class="dv">7</span></span></code></pre></div>
<p>Source: <a href="https://osca.bioconductor.org/integrating-datasets.html">‘Integrating Datasets’</a> chapter in the OSCA book. Its text is reproduced below with few modifications to adapt it to the data set under scrutiny here.</p>
<div id="abbreviations-5" class="section level2">
<h2><span class="header-section-number">18.1</span> Abbreviations</h2>
<ul>
<li>HVG: highly variable genes</li>
<li>MNN: mutual nearest neighbors</li>
<li>PBMMC: peripheral blood mononuclear cell</li>
<li>SCE: SingleCellExperiment</li>
</ul>
</div>
<div id="motivation-4" class="section level2">
<h2><span class="header-section-number">18.2</span> Motivation</h2>
<p>Large single-cell RNA sequencing (scRNA-seq) projects usually need to generate data across multiple batches due to logistical constraints. However, the processing of different batches is often subject to uncontrollable differences, e.g., changes in operator, differences in reagent quality. This results in systematic differences in the observed expression in cells from different batches, which we refer to as “batch effects”. Batch effects are problematic as they can be major drivers of heterogeneity in the data, masking the relevant biological differences and complicating interpretation of the results.</p>
</div>
<div id="load-data-5" class="section level2">
<h2><span class="header-section-number">18.3</span> Load data</h2>
<p>Computational correction of these effects is critical for eliminating batch-to-batch variation, allowing data across multiple batches to be combined for common downstream analysis. However, existing methods based on linear models (Ritchie et al. 2015; Leek et al. 2012) assume that the composition of cell populations are either known or the same across batches. To overcome these limitations, bespoke methods have been developed for batch correction of single-cell data (Haghverdi et al. 2018; Butler et al. 2018; Lin et al. 2019) that do not require a priori knowledge about the composition of the population. This allows them to be used in workflows for exploratory analyses of scRNA-seq data where such knowledge is usually unavailable.</p>
</div>
<div id="loading-the-data-4" class="section level2">
<h2><span class="header-section-number">18.4</span> Loading the data</h2>
<p>We will load the R file keeping the SCE object with the normalised counts, and subset 1000 cells per sample.</p>
<div class="sourceCode" id="cb1373"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1373-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1373-1"></a><span class="co">##setName &lt;- &quot;caron&quot;</span></span>
<span id="cb1373-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1373-2"></a><span class="co">#setSuf &lt;- &quot;&quot;</span></span>
<span id="cb1373-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1373-3"></a><span class="co">##setSuf &lt;- &quot;_allCells&quot;</span></span>
<span id="cb1373-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1373-4"></a>tmpFn &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/%s/Robjects/%s_sce_nz_postDeconv%s.Rds&quot;</span>,</span>
<span id="cb1373-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1373-5"></a>                 projDir, outDirBit, setName, setSuf)</span>
<span id="cb1373-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1373-6"></a><span class="kw">print</span>(tmpFn)</span></code></pre></div>
<pre><code>## [1] &quot;/ssd/personal/baller01/20200511_FernandesM_ME_crukBiSs2020/AnaWiSce/AnaKmWiC/Robjects/caron_sce_nz_postDeconv_5hCellPerSpl.Rds&quot;</code></pre>
<div class="sourceCode" id="cb1375"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1375-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1375-1"></a><span class="cf">if</span>(<span class="op">!</span><span class="kw">file.exists</span>(tmpFn))</span>
<span id="cb1375-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1375-2"></a>{</span>
<span id="cb1375-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1375-3"></a>    knitr<span class="op">::</span><span class="kw">knit_exit</span>()</span>
<span id="cb1375-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1375-4"></a>}</span>
<span id="cb1375-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1375-5"></a>sce &lt;-<span class="st"> </span><span class="kw">readRDS</span>(tmpFn)</span>
<span id="cb1375-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1375-6"></a>sce</span></code></pre></div>
<pre><code>## class: SingleCellExperiment 
## dim: 16629 5500 
## metadata(0):
## assays(2): counts logcounts
## rownames(16629): ENSG00000237491 ENSG00000225880 ... ENSG00000275063
##   ENSG00000271254
## rowData names(11): ensembl_gene_id external_gene_name ... detected
##   gene_sparsity
## colnames: NULL
## colData names(16): Barcode Run ... cell_sparsity sizeFactor
## reducedDimNames(0):
## altExpNames(0):</code></pre>
<div class="sourceCode" id="cb1377"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1377-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1377-1"></a><span class="kw">colnames</span>(<span class="kw">rowData</span>(sce))[<span class="kw">colnames</span>(<span class="kw">rowData</span>(sce)) <span class="op">==</span><span class="st"> &quot;strand&quot;</span>] &lt;-<span class="st"> &quot;strandNum&quot;</span></span></code></pre></div>
<p>We next subset the data for the PBMMC,ETV6-RUNX1 sample group:</p>
<div class="sourceCode" id="cb1378"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1378-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1378-1"></a><span class="co"># CaronBourque2020</span></span>
<span id="cb1378-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1378-2"></a>cb_sampleSheetFn &lt;-<span class="st"> </span><span class="kw">file.path</span>(projDir, <span class="st">&quot;Data/CaronBourque2020/SraRunTable.txt&quot;</span>)</span>
<span id="cb1378-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1378-3"></a>cb_sampleSheet &lt;-<span class="st"> </span><span class="kw">read.table</span>(cb_sampleSheetFn, <span class="dt">header=</span>T, <span class="dt">sep=</span><span class="st">&quot;,&quot;</span>)</span>
<span id="cb1378-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1378-4"></a><span class="co">#splVec &lt;- cb_sampleSheet %&gt;% filter(source_name == splSetToGet) %&gt;%</span></span>
<span id="cb1378-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1378-5"></a>splVec &lt;-<span class="st"> </span>cb_sampleSheet <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(source_name <span class="op">%in%</span><span class="st"> </span>splSetVec) <span class="op">%&gt;%</span></span>
<span id="cb1378-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1378-6"></a><span class="st">    </span><span class="kw">pull</span>(Sample.Name) <span class="op">%&gt;%</span><span class="st"> </span>unique</span>
<span id="cb1378-7"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1378-7"></a></span>
<span id="cb1378-8"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1378-8"></a>sourceNames &lt;-<span class="st"> </span><span class="kw">unique</span>(<span class="kw">colData</span>(sce)<span class="op">$</span>source_name)</span>
<span id="cb1378-9"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1378-9"></a>sceOrig &lt;-<span class="st"> </span>sce</span>
<span id="cb1378-10"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1378-10"></a>sce &lt;-<span class="st"> </span>sceOrig[,sce<span class="op">$</span>source_name <span class="op">%in%</span><span class="st"> </span>splSetVec ]</span>
<span id="cb1378-11"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1378-11"></a>nbCells &lt;-<span class="st"> </span><span class="dv">1000</span></span>
<span id="cb1378-12"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1378-12"></a><span class="co">#nbCells &lt;- 3000</span></span>
<span id="cb1378-13"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1378-13"></a>all.sce &lt;-<span class="st"> </span><span class="kw">list</span>()</span>
<span id="cb1378-14"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1378-14"></a></span>
<span id="cb1378-15"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1378-15"></a><span class="co"># if &#39;_allCells&#39;, then downsample for faster run</span></span>
<span id="cb1378-16"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1378-16"></a><span class="co"># else (ie _5hCellPerSpl so far), do not downsample.</span></span>
<span id="cb1378-17"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1378-17"></a><span class="cf">if</span>(setSuf <span class="op">==</span><span class="st"> &quot;_allCells&quot;</span>)</span>
<span id="cb1378-18"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1378-18"></a>{</span>
<span id="cb1378-19"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1378-19"></a>  <span class="cf">for</span>(spx <span class="cf">in</span> splVec)</span>
<span id="cb1378-20"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1378-20"></a>  {</span>
<span id="cb1378-21"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1378-21"></a>    nbCellsToGet &lt;-<span class="st"> </span><span class="kw">min</span>(<span class="kw">ncol</span>(sce), nbCells)</span>
<span id="cb1378-22"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1378-22"></a>    vec.bc &lt;-<span class="st"> </span><span class="kw">colData</span>(sce) <span class="op">%&gt;%</span></span>
<span id="cb1378-23"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1378-23"></a><span class="st">        </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span></span>
<span id="cb1378-24"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1378-24"></a><span class="st">        </span><span class="kw">filter</span>(Sample.Name <span class="op">==</span><span class="st"> </span>spx) <span class="op">%&gt;%</span></span>
<span id="cb1378-25"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1378-25"></a><span class="st">        </span><span class="co">###slice_sample(n=nbCellsToGet) %&gt;%</span></span>
<span id="cb1378-26"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1378-26"></a><span class="st">        </span><span class="kw">pull</span>(Barcode)</span>
<span id="cb1378-27"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1378-27"></a>    tmpInd &lt;-<span class="st"> </span><span class="kw">which</span>(<span class="kw">colData</span>(sce)<span class="op">$</span>Barcode <span class="op">%in%</span><span class="st"> </span>vec.bc)</span>
<span id="cb1378-28"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1378-28"></a>    </span>
<span id="cb1378-29"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1378-29"></a>    all.sce[[spx]] &lt;-<span class="st"> </span>sce[,tmpInd]</span>
<span id="cb1378-30"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1378-30"></a>  }</span>
<span id="cb1378-31"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1378-31"></a>} <span class="cf">else</span> {</span>
<span id="cb1378-32"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1378-32"></a>  <span class="cf">for</span>(spx <span class="cf">in</span> splVec)</span>
<span id="cb1378-33"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1378-33"></a>  {</span>
<span id="cb1378-34"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1378-34"></a>    vec.bc &lt;-<span class="st"> </span><span class="kw">colData</span>(sce) <span class="op">%&gt;%</span></span>
<span id="cb1378-35"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1378-35"></a><span class="st">        </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span></span>
<span id="cb1378-36"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1378-36"></a><span class="st">        </span><span class="kw">filter</span>(Sample.Name <span class="op">==</span><span class="st"> </span>spx) <span class="op">%&gt;%</span></span>
<span id="cb1378-37"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1378-37"></a><span class="st">        </span><span class="kw">pull</span>(Barcode)</span>
<span id="cb1378-38"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1378-38"></a>    tmpInd &lt;-<span class="st"> </span><span class="kw">which</span>(<span class="kw">colData</span>(sce)<span class="op">$</span>Barcode <span class="op">%in%</span><span class="st"> </span>vec.bc)</span>
<span id="cb1378-39"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1378-39"></a>    </span>
<span id="cb1378-40"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1378-40"></a>    all.sce[[spx]] &lt;-<span class="st"> </span>sce[,tmpInd]</span>
<span id="cb1378-41"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1378-41"></a>  }</span>
<span id="cb1378-42"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1378-42"></a>}  </span>
<span id="cb1378-43"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1378-43"></a>nbSpl &lt;-<span class="st"> </span><span class="kw">length</span>(all.sce)</span></code></pre></div>
<p>We then apply the standard workflow to each sample separately:
* normalisation,
* variance modelling
* dimensionality reduction
* clustering</p>
<div class="sourceCode" id="cb1379"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1379-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1379-1"></a><span class="co">#--- normalization ---#</span></span>
<span id="cb1379-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1379-2"></a><span class="co"># use logNormCounts()</span></span>
<span id="cb1379-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1379-3"></a>all.sce &lt;-<span class="st"> </span><span class="kw">lapply</span>(all.sce, logNormCounts)</span>
<span id="cb1379-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1379-4"></a></span>
<span id="cb1379-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1379-5"></a><span class="co">#--- variance-modelling ---#</span></span>
<span id="cb1379-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1379-6"></a><span class="co"># model varaince with modelGeneVar()</span></span>
<span id="cb1379-7"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1379-7"></a><span class="co"># find highly variable genes (HVGs) with getTopHVGs()</span></span>
<span id="cb1379-8"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1379-8"></a>all.dec &lt;-<span class="st"> </span><span class="kw">lapply</span>(all.sce, modelGeneVar)</span>
<span id="cb1379-9"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1379-9"></a>all.hvgs &lt;-<span class="st"> </span><span class="kw">lapply</span>(all.dec, getTopHVGs, <span class="dt">prop=</span><span class="fl">0.1</span>)</span>
<span id="cb1379-10"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1379-10"></a></span>
<span id="cb1379-11"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1379-11"></a><span class="co">#--- dimensionality-reduction ---#</span></span>
<span id="cb1379-12"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1379-12"></a><span class="co"># use runPCA()</span></span>
<span id="cb1379-13"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1379-13"></a><span class="co"># then compute embeddings with runTSNE() and runUMAP()</span></span>
<span id="cb1379-14"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1379-14"></a><span class="kw">library</span>(BiocSingular)</span>
<span id="cb1379-15"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1379-15"></a><span class="kw">set.seed</span>(<span class="dv">10000</span>)</span>
<span id="cb1379-16"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1379-16"></a>all.sce &lt;-<span class="st"> </span><span class="kw">mapply</span>(<span class="dt">FUN=</span>runPCA, <span class="dt">x=</span>all.sce, <span class="dt">subset_row=</span>all.hvgs,</span>
<span id="cb1379-17"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1379-17"></a>    <span class="dt">MoreArgs=</span><span class="kw">list</span>(<span class="dt">ncomponents=</span><span class="dv">25</span>, <span class="dt">BSPARAM=</span><span class="kw">RandomParam</span>()),</span>
<span id="cb1379-18"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1379-18"></a>    <span class="dt">SIMPLIFY=</span><span class="ot">FALSE</span>)</span>
<span id="cb1379-19"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1379-19"></a></span>
<span id="cb1379-20"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1379-20"></a><span class="kw">set.seed</span>(<span class="dv">100000</span>)</span>
<span id="cb1379-21"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1379-21"></a>all.sce &lt;-<span class="st"> </span><span class="kw">lapply</span>(all.sce, runTSNE, <span class="dt">dimred=</span><span class="st">&quot;PCA&quot;</span>)</span>
<span id="cb1379-22"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1379-22"></a></span>
<span id="cb1379-23"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1379-23"></a><span class="kw">set.seed</span>(<span class="dv">1000000</span>)</span>
<span id="cb1379-24"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1379-24"></a>all.sce &lt;-<span class="st"> </span><span class="kw">lapply</span>(all.sce, runUMAP, <span class="dt">dimred=</span><span class="st">&quot;PCA&quot;</span>)</span>
<span id="cb1379-25"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1379-25"></a></span>
<span id="cb1379-26"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1379-26"></a><span class="co">#--- clustering ---#</span></span>
<span id="cb1379-27"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1379-27"></a><span class="co"># cluster each sample separately</span></span>
<span id="cb1379-28"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1379-28"></a><span class="cf">for</span> (n <span class="cf">in</span> <span class="kw">names</span>(all.sce)) {</span>
<span id="cb1379-29"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1379-29"></a>    g &lt;-<span class="st"> </span><span class="kw">buildSNNGraph</span>(all.sce[[n]], <span class="dt">k=</span><span class="dv">10</span>, <span class="dt">use.dimred=</span><span class="st">&#39;PCA&#39;</span>)</span>
<span id="cb1379-30"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1379-30"></a>    clust &lt;-<span class="st"> </span>igraph<span class="op">::</span><span class="kw">cluster_walktrap</span>(g)<span class="op">$</span>membership</span>
<span id="cb1379-31"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1379-31"></a>    <span class="co">#colLabels(all.sce[[n]])  &lt;- factor(clust)</span></span>
<span id="cb1379-32"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1379-32"></a>    all.sce[[n]]<span class="op">$</span>label  &lt;-<span class="st"> </span><span class="kw">factor</span>(clust)</span>
<span id="cb1379-33"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1379-33"></a>}</span></code></pre></div>
<p>To prepare for the batch correction:</p>
<ul>
<li>We subset all batches to the common “universe” of features. In this case, it is straightforward as both batches use Ensembl gene annotation.</li>
</ul>
<div class="sourceCode" id="cb1380"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1380-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1380-1"></a>allNames &lt;-<span class="st"> </span><span class="kw">unlist</span>(<span class="kw">lapply</span>(all.sce, <span class="cf">function</span>(x){<span class="kw">rownames</span>(x)}))</span>
<span id="cb1380-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1380-2"></a>allNamesNb &lt;-<span class="st"> </span><span class="kw">table</span>(allNames)</span>
<span id="cb1380-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1380-3"></a>universe &lt;-<span class="st"> </span><span class="kw">names</span>(allNamesNb)[allNamesNb<span class="op">==</span>nbSpl]</span>
<span id="cb1380-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1380-4"></a><span class="co">#length(universe)</span></span></code></pre></div>
<ul>
<li>The size of this common “universe” of features here is the number of features shared by all 7 samples is: 16629.</li>
</ul>
<div class="sourceCode" id="cb1381"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1381-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1381-1"></a><span class="co"># Subsetting the SingleCellExperiment object.</span></span>
<span id="cb1381-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1381-2"></a>uni.sce &lt;-<span class="st"> </span><span class="kw">lapply</span>(all.sce, <span class="cf">function</span>(x){x[universe,]})</span>
<span id="cb1381-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1381-3"></a><span class="co"># Also subsetting the variance modelling results, for convenience.</span></span>
<span id="cb1381-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1381-4"></a>uni.dec &lt;-<span class="st"> </span><span class="kw">lapply</span>(all.dec, <span class="cf">function</span>(x){x[universe,]})</span></code></pre></div>
<ul>
<li>We rescale each batch to adjust for differences in sequencing depth between batches. The multiBatchNorm() function recomputes log-normalized expression values after adjusting the size factors for systematic differences in coverage between SingleCellExperiment (SCE) objects. (Size factors only remove biases between cells within a single batch.) This improves the quality of the correction by removing one aspect of the technical differences between batches.</li>
</ul>
<div class="sourceCode" id="cb1382"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1382-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1382-1"></a><span class="co"># rescale each batch to adjust for differences in sequencing depth between batches</span></span>
<span id="cb1382-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1382-2"></a>rescaled &lt;-<span class="st"> </span><span class="kw">multiBatchNorm</span>(uni.sce, <span class="dt">batch =</span> <span class="st">&quot;Sample.Name&quot;</span>)</span></code></pre></div>
<ul>
<li>We perform feature selection by averaging the variance components across all batches with the combineVar() function. We compute the average as it is responsive to batch-specific HVGs while still preserving the within-batch ranking of genes.</li>
</ul>
<div class="sourceCode" id="cb1383"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1383-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1383-1"></a><span class="co"># compute average variance components across samples</span></span>
<span id="cb1383-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1383-2"></a><span class="co">#combined.dec &lt;- combineVar(uni.dec[[1]], uni.dec[[2]], uni.dec[[3]], uni.dec[[4]])</span></span>
<span id="cb1383-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1383-3"></a>combined.dec &lt;-<span class="st"> </span><span class="kw">combineVar</span>(uni.dec)</span>
<span id="cb1383-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1383-4"></a><span class="co"># identify highly variables genes</span></span>
<span id="cb1383-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1383-5"></a><span class="co"># here as those with a positive biological component</span></span>
<span id="cb1383-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1383-6"></a>chosen.hvgs &lt;-<span class="st"> </span>combined.dec<span class="op">$</span>bio <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span></span>
<span id="cb1383-7"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1383-7"></a><span class="co">#sum(chosen.hvgs)</span></span></code></pre></div>
<p>Number of HVGs: 7930.</p>
<p>When integrating datasets of variable composition, it is generally safer to err on the side of including more genes than are used in a single dataset analysis, to ensure that markers are retained for any dataset-specific subpopulations that might be present. For a top X selection, this means using a larger X (say, ~5000), or in this case, we simply take all genes above the trend.</p>
<p>Alternatively, a more forceful approach to feature selection can be used based on marker genes from within-batch comparisons.</p>
</div>
<div id="diagnosing-batch-effects-4" class="section level2">
<h2><span class="header-section-number">18.5</span> Diagnosing batch effects</h2>
<p>Before we actually perform any correction, it is worth examining whether there is any batch effect in this dataset. We combine the SCE objects and perform a PCA on the log-expression values for all genes with positive (average) biological components.</p>
<div class="sourceCode" id="cb1384"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1384-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1384-1"></a><span class="co"># Synchronizing the metadata for cbind()ing.</span></span>
<span id="cb1384-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1384-2"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="op">:</span>nbSpl)</span>
<span id="cb1384-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1384-3"></a>{</span>
<span id="cb1384-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1384-4"></a>  <span class="kw">identical</span>(<span class="kw">rowData</span>(rescaled[[<span class="dv">1</span>]]), <span class="kw">rowData</span>(rescaled[[i]]))</span>
<span id="cb1384-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1384-5"></a>}</span>
<span id="cb1384-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1384-6"></a></span>
<span id="cb1384-7"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1384-7"></a>rescaled[[<span class="dv">1</span>]]<span class="op">$</span>batch &lt;-<span class="st"> </span>rescaled[[<span class="dv">1</span>]]<span class="op">$</span>Sample.Name</span>
<span id="cb1384-8"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1384-8"></a>rescaled2 &lt;-<span class="st"> </span><span class="kw">lapply</span>(rescaled, <span class="cf">function</span>(x){x<span class="op">$</span>batch &lt;-<span class="st"> </span>x<span class="op">$</span>Sample.Name; x})</span>
<span id="cb1384-9"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1384-9"></a>rescaled &lt;-<span class="st"> </span>rescaled2</span>
<span id="cb1384-10"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1384-10"></a></span>
<span id="cb1384-11"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1384-11"></a><span class="co"># concat matrices:</span></span>
<span id="cb1384-12"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1384-12"></a>uncorrected &lt;-<span class="st"> </span><span class="kw">do.call</span>(cbind, rescaled)</span>
<span id="cb1384-13"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1384-13"></a></span>
<span id="cb1384-14"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1384-14"></a><span class="co"># Perform PCA</span></span>
<span id="cb1384-15"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1384-15"></a><span class="co"># Using RandomParam() as it is more efficient for file-backed matrices.</span></span>
<span id="cb1384-16"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1384-16"></a><span class="kw">set.seed</span>(<span class="dv">0010101010</span>)</span>
<span id="cb1384-17"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1384-17"></a>uncorrected &lt;-<span class="st"> </span><span class="kw">runPCA</span>(uncorrected,</span>
<span id="cb1384-18"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1384-18"></a>                      <span class="dt">subset_row=</span>chosen.hvgs,</span>
<span id="cb1384-19"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1384-19"></a>                      <span class="dt">BSPARAM=</span>BiocSingular<span class="op">::</span><span class="kw">RandomParam</span>())</span></code></pre></div>
<p>We use graph-based clustering on the components to obtain a summary of the population structure.</p>
<p>As the samples should be replicates, each cluster should ideally consist of cells from each batch. However, we instead see clusters that are comprised of cells from a single batch. This indicates that cells of the same type are artificially separated due to technical differences between batches.</p>
<div class="sourceCode" id="cb1385"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1385-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1385-1"></a><span class="co"># build shared nearest-neighbour graph</span></span>
<span id="cb1385-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1385-2"></a>snn.gr &lt;-<span class="st"> </span><span class="kw">buildSNNGraph</span>(uncorrected, <span class="dt">use.dimred=</span><span class="st">&quot;PCA&quot;</span>)</span>
<span id="cb1385-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1385-3"></a><span class="co"># identify cluster with the walk trap method</span></span>
<span id="cb1385-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1385-4"></a>clusters &lt;-<span class="st"> </span>igraph<span class="op">::</span><span class="kw">cluster_walktrap</span>(snn.gr)<span class="op">$</span>membership</span>
<span id="cb1385-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1385-5"></a><span class="co"># get number of cells for each {cluster, batch} pair</span></span>
<span id="cb1385-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1385-6"></a>tab &lt;-<span class="st"> </span><span class="kw">table</span>(<span class="dt">Cluster=</span>clusters, <span class="dt">Batch=</span>uncorrected<span class="op">$</span>batch)</span>
<span id="cb1385-7"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1385-7"></a><span class="co">#tab</span></span></code></pre></div>
<div class="sourceCode" id="cb1386"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1386-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1386-1"></a>tmpMat &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="st">&quot;clusters&quot;</span>=clusters, <span class="st">&quot;batch&quot;</span>=uncorrected<span class="op">$</span>batch)</span></code></pre></div>
<p>Cluster size and cell contribution by sample:</p>
<div class="sourceCode" id="cb1387"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1387-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1387-1"></a>tmpMatTab &lt;-<span class="st"> </span><span class="kw">table</span>(tmpMat)</span>
<span id="cb1387-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1387-2"></a>sortVecNames &lt;-<span class="st"> </span>tmpMatTab <span class="op">%&gt;%</span><span class="st"> </span>rowSums <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">sort</span>(<span class="dt">decreasing=</span><span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span>names</span>
<span id="cb1387-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1387-3"></a>tmpMat<span class="op">$</span>clusters &lt;-<span class="st"> </span><span class="kw">factor</span>(tmpMat<span class="op">$</span>clusters, <span class="dt">levels=</span>sortVecNames)</span>
<span id="cb1387-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1387-4"></a>tmpMatDf &lt;-<span class="st"> </span>tmpMatTab[sortVecNames,] <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">data.frame</span>()</span>
<span id="cb1387-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1387-5"></a>p1 &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data=</span>tmpMatDf, <span class="kw">aes</span>(<span class="dt">x=</span>clusters,<span class="dt">y=</span>Freq, <span class="dt">fill=</span>batch)) <span class="op">+</span></span>
<span id="cb1387-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1387-6"></a><span class="st">    </span><span class="kw">geom_col</span>() <span class="op">+</span></span>
<span id="cb1387-7"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1387-7"></a><span class="st">    </span><span class="kw">theme</span>(<span class="dt">axis.text.x=</span><span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">90</span>, <span class="dt">hjust =</span> <span class="dv">0</span>)) <span class="op">+</span></span>
<span id="cb1387-8"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1387-8"></a><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;uncorrected, cell numbers&quot;</span>)</span>
<span id="cb1387-9"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1387-9"></a>p2 &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data=</span>tmpMat, <span class="kw">aes</span>(<span class="dt">x=</span>clusters, <span class="dt">fill=</span>batch)) <span class="op">+</span></span>
<span id="cb1387-10"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1387-10"></a><span class="st">  </span><span class="kw">geom_bar</span>(<span class="dt">position =</span> <span class="st">&quot;fill&quot;</span>) <span class="op">+</span></span>
<span id="cb1387-11"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1387-11"></a><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> scales<span class="op">::</span>percent) <span class="op">+</span></span>
<span id="cb1387-12"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1387-12"></a><span class="st">    </span><span class="kw">theme</span>(<span class="dt">axis.text.x=</span><span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">90</span>, <span class="dt">hjust =</span> <span class="dv">0</span>)) <span class="op">+</span></span>
<span id="cb1387-13"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1387-13"></a><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;uncorrected, proportions&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb1388"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1388-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1388-1"></a>gridExtra<span class="op">::</span><span class="kw">grid.arrange</span>(p1, p2)</span></code></pre></div>
<p><img src="dataSetIntegration_PBMMC_ETV6-RUNX1_files/figure-html/unnamed-chunk-16-1.png" width="672" /></p>
<p>We can also visualize the uncorrected coordinates using a t-SNE plot. The strong separation between cells from different batches is consistent with the clustering results.</p>
<div class="sourceCode" id="cb1389"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1389-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1389-1"></a><span class="kw">set.seed</span>(<span class="dv">1111001</span>)</span>
<span id="cb1389-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1389-2"></a>uncorrected &lt;-<span class="st"> </span><span class="kw">runTSNE</span>(uncorrected, <span class="dt">dimred=</span><span class="st">&quot;PCA&quot;</span>)</span>
<span id="cb1389-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1389-3"></a>p &lt;-<span class="st"> </span><span class="kw">plotTSNE</span>(uncorrected, <span class="dt">colour_by=</span><span class="st">&quot;batch&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb1390"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1390-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1390-1"></a>p</span></code></pre></div>
<p><img src="dataSetIntegration_PBMMC_ETV6-RUNX1_files/figure-html/unnamed-chunk-18-1.png" width="672" /></p>
<div class="sourceCode" id="cb1391"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1391-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1391-1"></a>p <span class="op">+</span><span class="st"> </span><span class="kw">facet_wrap</span>(<span class="op">~</span>uncorrected<span class="op">$</span>source_name)</span></code></pre></div>
<p><img src="dataSetIntegration_PBMMC_ETV6-RUNX1_files/figure-html/unnamed-chunk-19-1.png" width="672" /></p>
<p>Of course, the other explanation for batch-specific clusters is that there are cell types that are unique to each batch. The degree of intermingling of cells from different batches is not an effective diagnostic when the batches involved might actually contain unique cell subpopulations. If a cluster only contains cells from a single batch, one can always debate whether that is caused by a failure of the correction method or if there is truly a batch-specific subpopulation. For example, do batch-specific metabolic or differentiation states represent distinct subpopulations? Or should they be merged together? We will not attempt to answer this here, only noting that each batch correction algorithm will make different (and possibly inappropriate) decisions on what constitutes “shared” and “unique” populations.</p>
<p>Let us write the corresponding SCE object.</p>
<div class="sourceCode" id="cb1392"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1392-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1392-1"></a>splSetToGet2 &lt;-<span class="st"> </span><span class="kw">gsub</span>(<span class="st">&quot;,&quot;</span>, <span class="st">&quot;_&quot;</span>, splSetToGet)</span>
<span id="cb1392-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1392-2"></a><span class="co"># save object?</span></span>
<span id="cb1392-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1392-3"></a>fn &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/%s/Robjects/%s_sce_nz_postDeconv%s_dsi_%s_uncorr.Rds&quot;</span>,</span>
<span id="cb1392-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1392-4"></a>              projDir,</span>
<span id="cb1392-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1392-5"></a>              outDirBit,</span>
<span id="cb1392-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1392-6"></a>              setName,</span>
<span id="cb1392-7"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1392-7"></a>              setSuf,</span>
<span id="cb1392-8"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1392-8"></a>              splSetToGet2) <span class="co"># &#39;dsi&#39; for data set integration</span></span>
<span id="cb1392-9"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1392-9"></a><span class="kw">saveRDS</span>(uncorrected, <span class="dt">file=</span>fn)</span></code></pre></div>
</div>
<div id="linear-regression-4" class="section level2">
<h2><span class="header-section-number">18.6</span> Linear regression</h2>
<p>Batch effects in bulk RNA sequencing studies are commonly removed with linear regression. This involves fitting a linear model to each gene’s expression profile, setting the undesirable batch term to zero and recomputing the observations sans the batch effect, yielding a set of corrected expression values for downstream analyses. Linear modelling is the basis of the <code>removeBatchEffect()</code> function from the limma package (Ritchie et al. 2015) as well the <code>comBat()</code> function from the sva package (Leek et al. 2012).</p>
<p>To use this approach in a scRNA-seq context, we assume that the composition of cell subpopulations is the same across batches. We also assume that the batch effect is additive, i.e., any batch-induced fold-change in expression is the same across different cell subpopulations for any given gene. These are strong assumptions as batches derived from different individuals will naturally exhibit variation in cell type abundances and expression. Nonetheless, they may be acceptable when dealing with batches that are technical replicates generated from the same population of cells. (In fact, when its assumptions hold, linear regression is the most statistically efficient as it uses information from all cells to compute the common batch vector.) Linear modelling can also accommodate situations where the composition is known a priori by including the cell type as a factor in the linear model, but this situation is even less common.</p>
<p>We use the <code>rescaleBatches()</code> function from the <code>batchelor</code> package to remove the batch effect. This is roughly equivalent to applying a linear regression to the log-expression values per gene, with some adjustments to improve performance and efficiency. For each gene, the mean expression in each batch is scaled down until it is equal to the lowest mean across all batches. We deliberately choose to scale all expression values down as this mitigates differences in variance when batches lie at different positions on the mean-variance trend. (Specifically, the shrinkage effect of the pseudo-count is greater for smaller counts, suppressing any differences in variance across batches.) An additional feature of <code>rescaleBatches()</code> is that it will preserve sparsity in the input matrix for greater efficiency, whereas other methods like <code>removeBatchEffect()</code> will always return a dense matrix.</p>
<div class="sourceCode" id="cb1393"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1393-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1393-1"></a>rescaled2 &lt;-<span class="st"> </span><span class="kw">rescaleBatches</span>(rescaled)</span>
<span id="cb1393-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1393-2"></a>rescaled2</span></code></pre></div>
<pre><code>## class: SingleCellExperiment 
## dim: 16629 3500 
## metadata(0):
## assays(1): corrected
## rownames(16629): ENSG00000000003 ENSG00000000419 ... ENSG00000285486
##   ENSG00000285492
## rowData names(0):
## colnames: NULL
## colData names(1): batch
## reducedDimNames(0):
## altExpNames(0):</code></pre>
<p>After clustering, we observe that most clusters consist of mixtures of cells from the two replicate batches, consistent with the removal of the batch effect. This conclusion is supported by the apparent mixing of cells from different batches in Figure 13.2. However, at least one batch-specific cluster is still present, indicating that the correction is not entirely complete. This is attributable to violation of one of the aforementioned assumptions, even in this simple case involving replicated batches.</p>
<div class="sourceCode" id="cb1395"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1395-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1395-1"></a><span class="kw">set.seed</span>(<span class="dv">1010101010</span>) <span class="co"># To ensure reproducibility of IRLBA.</span></span>
<span id="cb1395-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1395-2"></a>rescaled2 &lt;-<span class="st"> </span><span class="kw">runPCA</span>(rescaled2, <span class="dt">subset_row=</span>chosen.hvgs, <span class="dt">exprs_values=</span><span class="st">&quot;corrected&quot;</span>)</span>
<span id="cb1395-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1395-3"></a></span>
<span id="cb1395-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1395-4"></a>snn.gr &lt;-<span class="st"> </span><span class="kw">buildSNNGraph</span>(rescaled2, <span class="dt">use.dimred=</span><span class="st">&quot;PCA&quot;</span>)</span>
<span id="cb1395-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1395-5"></a>clusters.resc &lt;-<span class="st"> </span>igraph<span class="op">::</span><span class="kw">cluster_walktrap</span>(snn.gr)<span class="op">$</span>membership</span>
<span id="cb1395-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1395-6"></a>tab.resc &lt;-<span class="st"> </span><span class="kw">table</span>(<span class="dt">Cluster=</span>clusters.resc, <span class="dt">Batch=</span>rescaled2<span class="op">$</span>batch)</span>
<span id="cb1395-7"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1395-7"></a><span class="co">#tab.resc</span></span></code></pre></div>
<div class="sourceCode" id="cb1396"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1396-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1396-1"></a>tmpMat &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="st">&quot;clusters&quot;</span>=clusters.resc, <span class="st">&quot;batch&quot;</span>=rescaled2<span class="op">$</span>batch)</span></code></pre></div>
<p>Cluster size and cell contribution by sample, with clusters sorted by size:</p>
<div class="sourceCode" id="cb1397"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1397-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1397-1"></a>tmpMatTab &lt;-<span class="st"> </span><span class="kw">table</span>(tmpMat)</span>
<span id="cb1397-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1397-2"></a>sortVecNames &lt;-<span class="st"> </span>tmpMatTab <span class="op">%&gt;%</span><span class="st"> </span>rowSums <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">sort</span>(<span class="dt">decreasing=</span><span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span>names</span>
<span id="cb1397-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1397-3"></a>tmpMat<span class="op">$</span>clusters &lt;-<span class="st"> </span><span class="kw">factor</span>(tmpMat<span class="op">$</span>clusters, <span class="dt">levels=</span>sortVecNames)</span>
<span id="cb1397-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1397-4"></a>tmpMatDf &lt;-<span class="st"> </span>tmpMatTab[sortVecNames,] <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">data.frame</span>()</span>
<span id="cb1397-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1397-5"></a>p1 &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data=</span>tmpMatDf, <span class="kw">aes</span>(<span class="dt">x=</span>clusters,<span class="dt">y=</span>Freq, <span class="dt">fill=</span>batch)) <span class="op">+</span></span>
<span id="cb1397-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1397-6"></a><span class="st">    </span><span class="kw">theme</span>(<span class="dt">axis.text.x=</span><span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">90</span>, <span class="dt">hjust =</span> <span class="dv">0</span>)) <span class="op">+</span></span>
<span id="cb1397-7"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1397-7"></a><span class="st">    </span><span class="kw">geom_col</span>()</span>
<span id="cb1397-8"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1397-8"></a>p2 &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data=</span>tmpMat, <span class="kw">aes</span>(<span class="dt">x=</span>clusters, <span class="dt">fill=</span>batch)) <span class="op">+</span></span>
<span id="cb1397-9"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1397-9"></a><span class="st">  </span><span class="kw">geom_bar</span>(<span class="dt">position =</span> <span class="st">&quot;fill&quot;</span>) <span class="op">+</span></span>
<span id="cb1397-10"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1397-10"></a><span class="st">    </span><span class="kw">theme</span>(<span class="dt">axis.text.x=</span><span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">90</span>, <span class="dt">hjust =</span> <span class="dv">0</span>)) <span class="op">+</span></span>
<span id="cb1397-11"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1397-11"></a><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> scales<span class="op">::</span>percent)</span></code></pre></div>
<div class="sourceCode" id="cb1398"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1398-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1398-1"></a>gridExtra<span class="op">::</span><span class="kw">grid.arrange</span>(p1, p2)</span></code></pre></div>
<p><img src="dataSetIntegration_PBMMC_ETV6-RUNX1_files/figure-html/unnamed-chunk-25-1.png" width="672" /></p>
<p>Compute and plot t-SNE:</p>
<div class="sourceCode" id="cb1399"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1399-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1399-1"></a>rescaled2 &lt;-<span class="st"> </span><span class="kw">runTSNE</span>(rescaled2, <span class="dt">dimred=</span><span class="st">&quot;PCA&quot;</span>)</span>
<span id="cb1399-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1399-2"></a>rescaled2<span class="op">$</span>batch &lt;-<span class="st"> </span><span class="kw">factor</span>(rescaled2<span class="op">$</span>batch)</span>
<span id="cb1399-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1399-3"></a><span class="kw">plotTSNE</span>(rescaled2, <span class="dt">colour_by=</span><span class="st">&quot;batch&quot;</span>)</span></code></pre></div>
<p><img src="dataSetIntegration_PBMMC_ETV6-RUNX1_files/figure-html/unnamed-chunk-26-1.png" width="672" /></p>
</div>
<div id="performing-mnn-correction-4" class="section level2">
<h2><span class="header-section-number">18.7</span> Performing MNN correction</h2>
<div id="algorithm-overview-4" class="section level3">
<h3><span class="header-section-number">18.7.1</span> Algorithm overview</h3>
<p>Consider a cell a in batch A, and identify the cells in batch B that are nearest neighbors to a in the expression space defined by the selected features. Repeat this for a cell b in batch B, identifying its nearest neighbors in A. Mutual nearest neighbors are pairs of cells from different batches that belong in each other’s set of nearest neighbors. The reasoning is that MNN pairs represent cells from the same biological state prior to the application of a batch effect - see Haghverdi et al. (2018) for full theoretical details. Thus, the difference between cells in MNN pairs can be used as an estimate of the batch effect, the subtraction of which yields batch-corrected values.</p>
<p>Compared to linear regression, MNN correction does not assume that the population composition is the same or known beforehand. This is because it learns the shared population structure via identification of MNN pairs and uses this information to obtain an appropriate estimate of the batch effect. Instead, the key assumption of MNN-based approaches is that the batch effect is orthogonal to the biology in high-dimensional expression space. Violations reduce the effectiveness and accuracy of the correction, with the most common case arising from variations in the direction of the batch effect between clusters. Nonetheless, the assumption is usually reasonable as a random vector is very likely to be orthogonal in high-dimensional space.</p>
</div>
<div id="application-to-the-data-4" class="section level3">
<h3><span class="header-section-number">18.7.2</span> Application to the data</h3>
<p>The <code>batchelor</code> package provides an implementation of the MNN approach via the <code>fastMNN()</code> function. (Unlike the MNN method originally described by Haghverdi et al. (2018), the <code>fastMNN()</code> function performs PCA to reduce the dimensions beforehand and speed up the downstream neighbor detection steps.) We apply it to our two PBMC batches to remove the batch effect across the highly variable genes in <code>chosen.hvgs</code>. To reduce computational work and technical noise, all cells in all batches are projected into the low-dimensional space defined by the top d principal components. Identification of MNNs and calculation of correction vectors are then performed in this low-dimensional space.</p>
<div class="sourceCode" id="cb1400"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1400-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1400-1"></a><span class="co"># Using randomized SVD here, as this is faster than </span></span>
<span id="cb1400-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1400-2"></a><span class="co"># irlba for file-backed matrices.</span></span>
<span id="cb1400-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1400-3"></a><span class="kw">set.seed</span>(<span class="dv">1000101001</span>)</span>
<span id="cb1400-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1400-4"></a>mnn.out &lt;-<span class="st"> </span><span class="kw">fastMNN</span>(rescaled,</span>
<span id="cb1400-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1400-5"></a>                   <span class="dt">auto.merge=</span><span class="ot">TRUE</span>,</span>
<span id="cb1400-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1400-6"></a>                   <span class="dt">d=</span><span class="dv">50</span>,</span>
<span id="cb1400-7"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1400-7"></a>                   <span class="dt">k=</span><span class="dv">20</span>,</span>
<span id="cb1400-8"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1400-8"></a>                   <span class="dt">subset.row=</span>chosen.hvgs,</span>
<span id="cb1400-9"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1400-9"></a>                   <span class="dt">BSPARAM=</span>BiocSingular<span class="op">::</span><span class="kw">RandomParam</span>(<span class="dt">deferred=</span><span class="ot">TRUE</span>))</span>
<span id="cb1400-10"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1400-10"></a>mnn.out</span></code></pre></div>
<pre><code>## class: SingleCellExperiment 
## dim: 7930 3500 
## metadata(2): merge.info pca.info
## assays(1): reconstructed
## rownames(7930): ENSG00000000938 ENSG00000001084 ... ENSG00000285476
##   ENSG00000285486
## rowData names(1): rotation
## colnames: NULL
## colData names(1): batch
## reducedDimNames(1): corrected
## altExpNames(0):</code></pre>
<div class="sourceCode" id="cb1402"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1402-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1402-1"></a>mnn.out.corre.dim &lt;-<span class="st"> </span><span class="kw">dim</span>(<span class="kw">reducedDim</span>(mnn.out, <span class="st">&quot;corrected&quot;</span>))</span>
<span id="cb1402-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1402-2"></a>mnn.out.corre.dim</span></code></pre></div>
<pre><code>## [1] 3500   50</code></pre>
<div class="sourceCode" id="cb1404"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1404-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1404-1"></a>mnn.out.recon.dim &lt;-<span class="st"> </span><span class="kw">dim</span>(<span class="kw">assay</span>(mnn.out, <span class="st">&quot;reconstructed&quot;</span>))</span>
<span id="cb1404-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1404-2"></a>mnn.out.recon.dim</span></code></pre></div>
<pre><code>## [1] 7930 3500</code></pre>
<p>The function returns a SCE object containing corrected values for downstream analyses like clustering or visualization. Each column of <code>mnn.out</code> corresponds to a cell in one of the batches, while each row corresponds to an input gene in <code>chosen.hvgs</code>. The batch field in the column metadata contains a vector specifying the batch of origin of each cell.</p>
<p>The <code>corrected</code> matrix in the <code>reducedDims()</code> contains the low-dimensional corrected coordinates for all cells, which we will use in place of the PCs in our downstream analyses (3500 cells and 50 PCs).</p>
<p>A <code>reconstructed</code> matrix in the <code>assays()</code> contains the corrected expression values for each gene in each cell, obtained by projecting the low-dimensional coordinates in corrected back into gene expression space (7930 genes and 3500 cells). We do not recommend using this for anything other than visualization.</p>
<div class="sourceCode" id="cb1406"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1406-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1406-1"></a><span class="kw">print</span>(<span class="kw">assay</span>(mnn.out, <span class="st">&quot;reconstructed&quot;</span>)[<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>,<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>])</span></code></pre></div>
<pre><code>## &lt;5 x 3&gt; matrix of class LowRankMatrix and type &quot;double&quot;:
##                          [,1]          [,2]          [,3]
## ENSG00000000938 -1.778764e-03 -9.573360e-04 -1.024012e-04
## ENSG00000001084 -5.499423e-04 -1.165937e-03 -8.177201e-04
## ENSG00000001461 -4.356311e-04 -4.438449e-04 -4.345478e-04
## ENSG00000001561 -1.754212e-04  7.425442e-06  4.786712e-05
## ENSG00000001617 -3.443706e-04 -2.886196e-04 -2.352076e-04</code></pre>
<p>The most relevant parameter for tuning <code>fastMNN()</code> is <code>k</code>, which specifies the number of nearest neighbors to consider when defining MNN pairs. This can be interpreted as the minimum anticipated frequency of any shared cell type or state in each batch. Increasing <code>k</code> will generally result in more aggressive merging as the algorithm is more generous in matching subpopulations across batches. It can occasionally be desirable to increase <code>k</code> if one clearly sees that the same cell types are not being adequately merged across batches.</p>
<!--
See Chapter 32 for an example of a more complex fastMNN() merge involving several human pancreas datasets generated by different authors on different patients with different technologies.
-->
<div class="sourceCode" id="cb1408"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1408-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1408-1"></a>colDataList &lt;-<span class="st"> </span><span class="kw">lapply</span>(rescaled, <span class="cf">function</span>(x){<span class="kw">colData</span>(x)})</span>
<span id="cb1408-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1408-2"></a>colDataDf &lt;-<span class="st"> </span><span class="kw">do.call</span>(rbind, colDataList)</span>
<span id="cb1408-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1408-3"></a><span class="co">#colData(mnn.out) &lt;- cbind(colDataDf, colData(mnn.out)$cluster)</span></span>
<span id="cb1408-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1408-4"></a><span class="kw">colData</span>(mnn.out) &lt;-<span class="st"> </span><span class="kw">DataFrame</span>(colDataDf) <span class="co"># no rearrainging of columns by mnncorrect</span></span></code></pre></div>
</div>
</div>
<div id="correction-diagnostics-4" class="section level2">
<h2><span class="header-section-number">18.8</span> Correction diagnostics</h2>
<div id="mixing-between-batches-4" class="section level3">
<h3><span class="header-section-number">18.8.1</span> Mixing between batches</h3>
<p>We cluster on the low-dimensional corrected coordinates to obtain a partitioning of the cells that serves as a proxy for the population structure. If the batch effect is successfully corrected, clusters corresponding to shared cell types or states should contain cells from multiple batches. We see that all clusters contain contributions from each batch after correction, consistent with our expectation that the batches are replicates of each other.</p>
<div class="sourceCode" id="cb1409"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1409-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1409-1"></a>snn.gr &lt;-<span class="st"> </span><span class="kw">buildSNNGraph</span>(mnn.out, <span class="dt">use.dimred=</span><span class="st">&quot;corrected&quot;</span>, <span class="dt">k=</span><span class="dv">20</span>)</span>
<span id="cb1409-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1409-2"></a>clusters.mnn &lt;-<span class="st"> </span>igraph<span class="op">::</span><span class="kw">cluster_walktrap</span>(snn.gr)<span class="op">$</span>membership</span>
<span id="cb1409-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1409-3"></a>tab.mnn &lt;-<span class="st"> </span><span class="kw">table</span>(<span class="dt">Cluster=</span>clusters.mnn, <span class="dt">Batch=</span>mnn.out<span class="op">$</span>batch)</span>
<span id="cb1409-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1409-4"></a>tab.mnn</span></code></pre></div>
<pre><code>##        Batch
## Cluster GSM3872434 GSM3872435 GSM3872436 GSM3872437 GSM3872442 GSM3872443
##      1           2          0          6          6          4         21
##      2          40         38         14         47         63          9
##      3          87          1          3          3         62         16
##      4          31        273        154         82         64         16
##      5           0          1          7         16          1         30
##      6           0          0          0          0         30         17
##      7           1         15        157         21        183        128
##      8           0          0          3         19          0         22
##      9          88         34         22         73         32          2
##      10          2         10         50         12         13         51
##      11          0          0         12         48          0         66
##      12          1          0          5          7          3         35
##      13          0          0         11         30          0         37
##      14        233        112         36        125          6          2
##      15          2          1         13          4         20         23
##      16          0          2          2          2          4          4
##      17         13         13          5          4          5          5
##      18          0          0          0          1         10         16
##        Batch
## Cluster GSM3872444
##      1           6
##      2          36
##      3          18
##      4          88
##      5           6
##      6          23
##      7         131
##      8           5
##      9          20
##      10         54
##      11          3
##      12         59
##      13          3
##      14          6
##      15         30
##      16          3
##      17          0
##      18          9</code></pre>
<p>Cluster size and cell contribution by tissue type, with clusters sorted by size:</p>
<div class="sourceCode" id="cb1411"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1411-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1411-1"></a><span class="co">#mnn.out$source_name &lt;- uncorrected$source_name # cell order is maintained by scran functions</span></span>
<span id="cb1411-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1411-2"></a>mnn.out<span class="op">$</span>Sample.Name &lt;-<span class="st"> </span>uncorrected<span class="op">$</span>Sample.Name <span class="co"># cell order is maintained by scran functions</span></span>
<span id="cb1411-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1411-3"></a></span>
<span id="cb1411-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1411-4"></a>tmpMat &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="st">&quot;clusters&quot;</span>=clusters.mnn, <span class="st">&quot;batch&quot;</span>=mnn.out<span class="op">$</span>Sample.Name)</span>
<span id="cb1411-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1411-5"></a>tmpMatTab &lt;-<span class="st"> </span><span class="kw">table</span>(tmpMat)</span>
<span id="cb1411-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1411-6"></a>sortVecNames &lt;-<span class="st"> </span>tmpMatTab <span class="op">%&gt;%</span><span class="st"> </span>rowSums <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">sort</span>(<span class="dt">decreasing=</span><span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span>names</span>
<span id="cb1411-7"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1411-7"></a>tmpMat<span class="op">$</span>clusters &lt;-<span class="st"> </span><span class="kw">factor</span>(tmpMat<span class="op">$</span>clusters, <span class="dt">levels=</span>sortVecNames)</span>
<span id="cb1411-8"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1411-8"></a>tmpMatTab &lt;-<span class="st"> </span><span class="kw">table</span>(tmpMat)</span>
<span id="cb1411-9"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1411-9"></a>tmpMatDf &lt;-<span class="st"> </span>tmpMatTab[sortVecNames,] <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">data.frame</span>()</span>
<span id="cb1411-10"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1411-10"></a>p1 &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data=</span>tmpMatDf, <span class="kw">aes</span>(<span class="dt">x=</span>clusters,<span class="dt">y=</span>Freq, <span class="dt">fill=</span>batch)) <span class="op">+</span></span>
<span id="cb1411-11"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1411-11"></a><span class="st">    </span><span class="kw">theme</span>(<span class="dt">axis.text.x=</span><span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">90</span>, <span class="dt">hjust =</span> <span class="dv">0</span>)) <span class="op">+</span></span>
<span id="cb1411-12"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1411-12"></a><span class="st">    </span><span class="kw">geom_col</span>()</span>
<span id="cb1411-13"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1411-13"></a>p2 &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data=</span>tmpMat, <span class="kw">aes</span>(<span class="dt">x=</span>clusters, <span class="dt">fill=</span>batch)) <span class="op">+</span></span>
<span id="cb1411-14"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1411-14"></a><span class="st">  </span><span class="kw">geom_bar</span>(<span class="dt">position =</span> <span class="st">&quot;fill&quot;</span>) <span class="op">+</span></span>
<span id="cb1411-15"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1411-15"></a><span class="st">    </span><span class="kw">theme</span>(<span class="dt">axis.text.x=</span><span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">90</span>, <span class="dt">hjust =</span> <span class="dv">0</span>)) <span class="op">+</span></span>
<span id="cb1411-16"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1411-16"></a><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> scales<span class="op">::</span>percent)</span></code></pre></div>
<div class="sourceCode" id="cb1412"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1412-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1412-1"></a>gridExtra<span class="op">::</span><span class="kw">grid.arrange</span>(p1, p2)</span></code></pre></div>
<p><img src="dataSetIntegration_PBMMC_ETV6-RUNX1_files/figure-html/unnamed-chunk-32-1.png" width="672" /></p>
<p>Cluster size and cell contribution by sample type, with clusters sorted by size:</p>
<div class="sourceCode" id="cb1413"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1413-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1413-1"></a>mnn.out<span class="op">$</span>source_name &lt;-<span class="st"> </span>uncorrected<span class="op">$</span>source_name <span class="co"># cell order is maintained by scran functions</span></span>
<span id="cb1413-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1413-2"></a>tmpMat &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="st">&quot;clusters&quot;</span>=clusters.mnn, <span class="st">&quot;batch&quot;</span>=mnn.out<span class="op">$</span>source_name)</span>
<span id="cb1413-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1413-3"></a>tmpMatTab &lt;-<span class="st"> </span><span class="kw">table</span>(tmpMat)</span>
<span id="cb1413-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1413-4"></a>sortVecNames &lt;-<span class="st"> </span>tmpMatTab <span class="op">%&gt;%</span><span class="st"> </span>rowSums <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">sort</span>(<span class="dt">decreasing=</span><span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span>names</span>
<span id="cb1413-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1413-5"></a>tmpMat<span class="op">$</span>clusters &lt;-<span class="st"> </span><span class="kw">factor</span>(tmpMat<span class="op">$</span>clusters, <span class="dt">levels=</span>sortVecNames)</span>
<span id="cb1413-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1413-6"></a>tmpMatTab &lt;-<span class="st"> </span><span class="kw">table</span>(tmpMat)</span>
<span id="cb1413-7"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1413-7"></a>tmpMatDf &lt;-<span class="st"> </span>tmpMatTab[sortVecNames,] <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">data.frame</span>()</span>
<span id="cb1413-8"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1413-8"></a>p1 &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data=</span>tmpMatDf, <span class="kw">aes</span>(<span class="dt">x=</span>clusters,<span class="dt">y=</span>Freq, <span class="dt">fill=</span>batch)) <span class="op">+</span></span>
<span id="cb1413-9"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1413-9"></a><span class="st">    </span><span class="kw">theme</span>(<span class="dt">axis.text.x=</span><span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">90</span>, <span class="dt">hjust =</span> <span class="dv">0</span>)) <span class="op">+</span></span>
<span id="cb1413-10"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1413-10"></a><span class="st">    </span><span class="kw">geom_col</span>()</span>
<span id="cb1413-11"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1413-11"></a>p2 &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data=</span>tmpMat, <span class="kw">aes</span>(<span class="dt">x=</span>clusters, <span class="dt">fill=</span>batch)) <span class="op">+</span></span>
<span id="cb1413-12"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1413-12"></a><span class="st">  </span><span class="kw">geom_bar</span>(<span class="dt">position =</span> <span class="st">&quot;fill&quot;</span>) <span class="op">+</span></span>
<span id="cb1413-13"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1413-13"></a><span class="st">    </span><span class="kw">theme</span>(<span class="dt">axis.text.x=</span><span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">90</span>, <span class="dt">hjust =</span> <span class="dv">0</span>)) <span class="op">+</span></span>
<span id="cb1413-14"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1413-14"></a><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> scales<span class="op">::</span>percent)</span></code></pre></div>
<div class="sourceCode" id="cb1414"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1414-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1414-1"></a>gridExtra<span class="op">::</span><span class="kw">grid.arrange</span>(p1, p2)</span></code></pre></div>
<p><img src="dataSetIntegration_PBMMC_ETV6-RUNX1_files/figure-html/unnamed-chunk-34-1.png" width="672" /></p>
<p>We can also compute the variation in the log-abundances to rank the clusters with the greatest variability in their proportional abundances across batches. We can then focus on batch-specific clusters that may be indicative of incomplete batch correction. Obviously, though, this diagnostic is subject to interpretation as the same outcome can be caused by batch-specific populations; some prior knowledge about the biological context is necessary to distinguish between these two possibilities. The table below shows the number of cells for each cluster (row) and sample (column) together with the variance in cell number across these samples (‘var’ column).</p>
<div class="sourceCode" id="cb1415"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1415-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1415-1"></a><span class="co"># Avoid minor difficulties with the &#39;table&#39; class.</span></span>
<span id="cb1415-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1415-2"></a>tab.mnn &lt;-<span class="st"> </span><span class="kw">unclass</span>(tab.mnn)</span>
<span id="cb1415-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1415-3"></a></span>
<span id="cb1415-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1415-4"></a><span class="co"># Using a large pseudo.count to avoid unnecessarily</span></span>
<span id="cb1415-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1415-5"></a><span class="co"># large variances when the counts are low.</span></span>
<span id="cb1415-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1415-6"></a>norm &lt;-<span class="st"> </span><span class="kw">normalizeCounts</span>(tab.mnn, <span class="dt">pseudo_count=</span><span class="dv">10</span>)</span>
<span id="cb1415-7"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1415-7"></a></span>
<span id="cb1415-8"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1415-8"></a><span class="co"># Ranking clusters by the largest variances.</span></span>
<span id="cb1415-9"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1415-9"></a>rv &lt;-<span class="st"> </span><span class="kw">rowVars</span>(norm) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">round</span>(<span class="dv">2</span>)</span>
<span id="cb1415-10"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1415-10"></a></span>
<span id="cb1415-11"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1415-11"></a><span class="co"># show</span></span>
<span id="cb1415-12"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1415-12"></a><span class="co">#DataFrame(Batch=tab.mnn, var=rv)[order(rv, decreasing=TRUE),]</span></span>
<span id="cb1415-13"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1415-13"></a><span class="kw">DataFrame</span>(tab.mnn, <span class="dt">var=</span>rv)[<span class="kw">order</span>(rv, <span class="dt">decreasing=</span><span class="ot">TRUE</span>),]</span></code></pre></div>
<pre><code>## DataFrame with 18 rows and 8 columns
##     GSM3872434 GSM3872435 GSM3872436 GSM3872437 GSM3872442 GSM3872443
##      &lt;integer&gt;  &lt;integer&gt;  &lt;integer&gt;  &lt;integer&gt;  &lt;integer&gt;  &lt;integer&gt;
## 14         233        112         36        125          6          2
## 7            1         15        157         21        183        128
## 11           0          0         12         48          0         66
## 3           87          1          3          3         62         16
## 4           31        273        154         82         64         16
## ...        ...        ...        ...        ...        ...        ...
## 2           40         38         14         47         63          9
## 18           0          0          0          1         10         16
## 1            2          0          6          6          4         21
## 17          13         13          5          4          5          5
## 16           0          2          2          2          4          4
##     GSM3872444       var
##      &lt;integer&gt; &lt;numeric&gt;
## 14           6      3.09
## 7          131      2.73
## 11           3      1.58
## 3           18      1.55
## 4           88      1.34
## ...        ...       ...
## 2           36      0.48
## 18           9      0.35
## 1            6      0.26
## 17           0      0.18
## 16           3      0.03</code></pre>
<p>We can also visualize the corrected coordinates using a t-SNE plot. The presence of visual clusters containing cells from both batches provides a comforting illusion that the correction was successful.</p>
<div class="sourceCode" id="cb1417"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1417-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1417-1"></a><span class="kw">set.seed</span>(<span class="dv">0010101010</span>)</span>
<span id="cb1417-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1417-2"></a>mnn.out &lt;-<span class="st"> </span><span class="kw">runTSNE</span>(mnn.out, <span class="dt">dimred=</span><span class="st">&quot;corrected&quot;</span>)</span>
<span id="cb1417-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1417-3"></a></span>
<span id="cb1417-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1417-4"></a>mnn.out<span class="op">$</span>batch &lt;-<span class="st"> </span><span class="kw">factor</span>(mnn.out<span class="op">$</span>batch)</span>
<span id="cb1417-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1417-5"></a>p &lt;-<span class="st"> </span><span class="kw">plotTSNE</span>(mnn.out, <span class="dt">colour_by=</span><span class="st">&quot;batch&quot;</span>)</span>
<span id="cb1417-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1417-6"></a>p</span></code></pre></div>
<p><img src="dataSetIntegration_PBMMC_ETV6-RUNX1_files/figure-html/unnamed-chunk-36-1.png" width="672" /></p>
<div class="sourceCode" id="cb1418"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1418-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1418-1"></a><span class="co">#mnn.out$type &lt;- gsub(&quot;_[1-4]&quot;,&quot;&quot;,mnn.out$batch)</span></span>
<span id="cb1418-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1418-2"></a><span class="co">#p &lt;- plotTSNE(mnn.out, colour_by=&quot;batch&quot;, shape_by=&quot;type&quot;)</span></span>
<span id="cb1418-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1418-3"></a><span class="co">#p + facet_wrap(. ~ mnn.out$type)</span></span></code></pre></div>
<div class="sourceCode" id="cb1419"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1419-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1419-1"></a>p <span class="op">+</span><span class="st"> </span><span class="kw">facet_wrap</span>(. <span class="op">~</span><span class="st"> </span>mnn.out<span class="op">$</span>source_name)</span></code></pre></div>
<p><img src="dataSetIntegration_PBMMC_ETV6-RUNX1_files/figure-html/unnamed-chunk-37-1.png" width="672" /></p>
<p>For <code>fastMNN()</code>, one useful diagnostic is the proportion of variance within each batch that is lost during MNN correction. Specifically, this refers to the within-batch variance that is removed during orthogonalization with respect to the average correction vector at each merge step. This is returned via the <code>lost.var</code> field in the metadata of <code>mnn.out</code>, which contains a matrix of the variance lost in each batch (column) at each merge step (row).</p>
<div class="sourceCode" id="cb1420"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1420-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1420-1"></a><span class="kw">round</span>(<span class="kw">metadata</span>(mnn.out)<span class="op">$</span>merge.info<span class="op">$</span>lost.var,<span class="dv">2</span>)</span></code></pre></div>
<pre><code>##      GSM3872434 GSM3872435 GSM3872436 GSM3872437 GSM3872442 GSM3872443
## [1,]       0.00       0.00       0.00       0.00       0.03       0.00
## [2,]       0.00       0.00       0.00       0.00       0.02       0.08
## [3,]       0.00       0.00       0.10       0.00       0.01       0.01
## [4,]       0.00       0.00       0.01       0.09       0.01       0.00
## [5,]       0.00       0.08       0.00       0.00       0.01       0.00
## [6,]       0.08       0.01       0.01       0.01       0.01       0.01
##      GSM3872444
## [1,]       0.03
## [2,]       0.03
## [3,]       0.01
## [4,]       0.00
## [5,]       0.01
## [6,]       0.00</code></pre>
<p>Large proportions of lost variance (&gt;10%) suggest that correction is removing genuine biological heterogeneity. This would occur due to violations of the assumption of orthogonality between the batch effect and the biological subspace (Haghverdi et al. 2018). In this case, the proportion of lost variance is small, indicating that non-orthogonality is not a major concern.</p>
<p>The following t-SNE shows the clusters identified:</p>
<div class="sourceCode" id="cb1422"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1422-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1422-1"></a>mnn.out<span class="op">$</span>cluster &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;c&quot;</span>, clusters.mnn)</span>
<span id="cb1422-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1422-2"></a>p &lt;-<span class="st"> </span><span class="kw">plotTSNE</span>(mnn.out, <span class="dt">colour_by=</span><span class="st">&quot;cluster&quot;</span>)</span>
<span id="cb1422-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1422-3"></a>p</span></code></pre></div>
<p><img src="dataSetIntegration_PBMMC_ETV6-RUNX1_files/figure-html/unnamed-chunk-39-1.png" width="672" /></p>
<div class="sourceCode" id="cb1423"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1423-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1423-1"></a>p <span class="op">+</span><span class="st"> </span><span class="kw">facet_wrap</span>(<span class="op">~</span><span class="kw">colData</span>(mnn.out)<span class="op">$</span>batch)</span></code></pre></div>
<p><img src="dataSetIntegration_PBMMC_ETV6-RUNX1_files/figure-html/unnamed-chunk-40-1.png" width="672" /></p>
<p>The following t-SNE plots show expression levels of known cell type marker genes.</p>
<div class="sourceCode" id="cb1424"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1424-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1424-1"></a>genesToShow &lt;-<span class="st"> </span><span class="kw">c</span>(</span>
<span id="cb1424-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1424-2"></a>         <span class="st">&quot;CD79A&quot;</span>, <span class="co"># CD79A   B ***</span></span>
<span id="cb1424-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1424-3"></a>         <span class="st">&quot;CST3&quot;</span>, <span class="co"># CST3     monocytes ***</span></span>
<span id="cb1424-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1424-4"></a>         <span class="st">&quot;CD3D&quot;</span>, <span class="co"># CD3D      T cells ***</span></span>
<span id="cb1424-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1424-5"></a>         <span class="st">&quot;HBA1&quot;</span> <span class="co"># HBA1   erythrocytes ***</span></span>
<span id="cb1424-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1424-6"></a>        )</span>
<span id="cb1424-7"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1424-7"></a></span>
<span id="cb1424-8"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1424-8"></a>tmpInd &lt;-<span class="st"> </span><span class="kw">which</span>(<span class="kw">rowData</span>(uncorrected)<span class="op">$</span>Symbol <span class="op">%in%</span><span class="st"> </span>genesToShow)</span>
<span id="cb1424-9"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1424-9"></a>ensToShow &lt;-<span class="st"> </span><span class="kw">rowData</span>(uncorrected)<span class="op">$</span>ensembl_gene_id[tmpInd]</span></code></pre></div>
<p>B cells:</p>
<div class="sourceCode" id="cb1425"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1425-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1425-1"></a>genex &lt;-<span class="st"> </span>ensToShow[<span class="dv">1</span>]</span>
<span id="cb1425-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1425-2"></a>    p &lt;-<span class="st"> </span><span class="kw">plotTSNE</span>(mnn.out, <span class="dt">colour_by =</span> genex, <span class="dt">by_exprs_values=</span><span class="st">&quot;reconstructed&quot;</span>)</span>
<span id="cb1425-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1425-3"></a>    p &lt;-<span class="st"> </span>p <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(</span>
<span id="cb1425-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1425-4"></a>            <span class="kw">paste</span>(<span class="st">&quot;B cells&quot;</span>, genex,</span>
<span id="cb1425-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1425-5"></a>            <span class="kw">rowData</span>(uncorrected)[genex,<span class="st">&quot;Symbol&quot;</span>])</span>
<span id="cb1425-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1425-6"></a>        )</span>
<span id="cb1425-7"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1425-7"></a>    <span class="kw">print</span>(p)</span></code></pre></div>
<p><img src="dataSetIntegration_PBMMC_ETV6-RUNX1_files/figure-html/unnamed-chunk-42-1.png" width="672" /></p>
<p>T cells:</p>
<div class="sourceCode" id="cb1426"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1426-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1426-1"></a>genex &lt;-<span class="st"> </span>ensToShow[<span class="dv">3</span>]</span>
<span id="cb1426-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1426-2"></a>    p &lt;-<span class="st"> </span><span class="kw">plotTSNE</span>(mnn.out, <span class="dt">colour_by =</span> genex, <span class="dt">by_exprs_values=</span><span class="st">&quot;reconstructed&quot;</span>)</span>
<span id="cb1426-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1426-3"></a>    p &lt;-<span class="st"> </span>p <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(</span>
<span id="cb1426-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1426-4"></a>            <span class="kw">paste</span>(<span class="st">&quot;T cells&quot;</span>, genex,</span>
<span id="cb1426-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1426-5"></a>            <span class="kw">rowData</span>(uncorrected)[genex,<span class="st">&quot;Symbol&quot;</span>])</span>
<span id="cb1426-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1426-6"></a>        )</span>
<span id="cb1426-7"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1426-7"></a>    <span class="kw">print</span>(p)</span></code></pre></div>
<p><img src="dataSetIntegration_PBMMC_ETV6-RUNX1_files/figure-html/unnamed-chunk-43-1.png" width="672" /></p>
<p>monocytes:</p>
<div class="sourceCode" id="cb1427"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1427-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1427-1"></a>genex &lt;-<span class="st"> </span>ensToShow[<span class="dv">2</span>]</span>
<span id="cb1427-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1427-2"></a>    p &lt;-<span class="st"> </span><span class="kw">plotTSNE</span>(mnn.out, <span class="dt">colour_by =</span> genex, <span class="dt">by_exprs_values=</span><span class="st">&quot;reconstructed&quot;</span>)</span>
<span id="cb1427-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1427-3"></a>    p &lt;-<span class="st"> </span>p <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(</span>
<span id="cb1427-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1427-4"></a>            <span class="kw">paste</span>(<span class="st">&quot;monocytes&quot;</span>, genex,</span>
<span id="cb1427-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1427-5"></a>            <span class="kw">rowData</span>(uncorrected)[genex,<span class="st">&quot;Symbol&quot;</span>])</span>
<span id="cb1427-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1427-6"></a>        )</span>
<span id="cb1427-7"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1427-7"></a>    <span class="kw">print</span>(p)</span></code></pre></div>
<p><img src="dataSetIntegration_PBMMC_ETV6-RUNX1_files/figure-html/unnamed-chunk-44-1.png" width="672" /></p>
<p>erythrocytes:</p>
<div class="sourceCode" id="cb1428"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1428-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1428-1"></a>genex &lt;-<span class="st"> </span>ensToShow[<span class="dv">4</span>]</span>
<span id="cb1428-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1428-2"></a>    p &lt;-<span class="st"> </span><span class="kw">plotTSNE</span>(mnn.out, <span class="dt">colour_by =</span> genex, <span class="dt">by_exprs_values=</span><span class="st">&quot;reconstructed&quot;</span>)</span>
<span id="cb1428-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1428-3"></a>    p &lt;-<span class="st"> </span>p <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(</span>
<span id="cb1428-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1428-4"></a>            <span class="kw">paste</span>(<span class="st">&quot;erythrocytes&quot;</span>, genex,</span>
<span id="cb1428-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1428-5"></a>            <span class="kw">rowData</span>(uncorrected)[genex,<span class="st">&quot;Symbol&quot;</span>])</span>
<span id="cb1428-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1428-6"></a>        )</span>
<span id="cb1428-7"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1428-7"></a>    <span class="kw">print</span>(p)</span></code></pre></div>
<p><img src="dataSetIntegration_PBMMC_ETV6-RUNX1_files/figure-html/unnamed-chunk-45-1.png" width="672" /></p>
<p>Compare to the uncorrected values, T cells:</p>
<div class="sourceCode" id="cb1429"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1429-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1429-1"></a>genex &lt;-<span class="st"> </span>ensToShow[<span class="dv">3</span>]</span>
<span id="cb1429-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1429-2"></a>    p &lt;-<span class="st"> </span><span class="kw">plotTSNE</span>(uncorrected, <span class="dt">colour_by =</span> genex)</span>
<span id="cb1429-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1429-3"></a>    p &lt;-<span class="st"> </span>p <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(</span>
<span id="cb1429-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1429-4"></a>            <span class="kw">paste</span>(<span class="st">&quot;T cells&quot;</span>, genex,</span>
<span id="cb1429-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1429-5"></a>            <span class="kw">rowData</span>(uncorrected)[genex,<span class="st">&quot;Symbol&quot;</span>])</span>
<span id="cb1429-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1429-6"></a>        )</span>
<span id="cb1429-7"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1429-7"></a>    <span class="kw">print</span>(p)</span></code></pre></div>
<p><img src="dataSetIntegration_PBMMC_ETV6-RUNX1_files/figure-html/unnamed-chunk-46-1.png" width="672" />
Compare to the uncorrected values, erythrocytes:</p>
<div class="sourceCode" id="cb1430"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1430-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1430-1"></a>genex &lt;-<span class="st"> </span>ensToShow[<span class="dv">4</span>]</span>
<span id="cb1430-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1430-2"></a>    p &lt;-<span class="st"> </span><span class="kw">plotTSNE</span>(uncorrected, <span class="dt">colour_by =</span> genex)</span>
<span id="cb1430-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1430-3"></a>    p &lt;-<span class="st"> </span>p <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(</span>
<span id="cb1430-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1430-4"></a>            <span class="kw">paste</span>(<span class="st">&quot;erythrocytes&quot;</span>, genex,</span>
<span id="cb1430-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1430-5"></a>            <span class="kw">rowData</span>(uncorrected)[genex,<span class="st">&quot;Symbol&quot;</span>])</span>
<span id="cb1430-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1430-6"></a>        )</span>
<span id="cb1430-7"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1430-7"></a>    <span class="kw">print</span>(p)</span></code></pre></div>
<p><img src="dataSetIntegration_PBMMC_ETV6-RUNX1_files/figure-html/unnamed-chunk-47-1.png" width="672" /></p>
<p>Other genes (exercise)</p>
<div class="sourceCode" id="cb1431"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1431-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1431-1"></a>genesToShow2 &lt;-<span class="st"> </span><span class="kw">c</span>(</span>
<span id="cb1431-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1431-2"></a>         <span class="st">&quot;IL7R&quot;</span>, <span class="co"># IL7R, CCR7   Naive CD4+ T</span></span>
<span id="cb1431-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1431-3"></a>         <span class="st">&quot;CCR7&quot;</span>, <span class="co"># IL7R, CCR7   Naive CD4+ T</span></span>
<span id="cb1431-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1431-4"></a>         <span class="st">&quot;S100A4&quot;</span>, <span class="co"># IL7R, S100A4   Memory CD4+</span></span>
<span id="cb1431-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1431-5"></a>         <span class="st">&quot;CD14&quot;</span>, <span class="co"># CD14, LYZ    CD14+ Mono</span></span>
<span id="cb1431-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1431-6"></a>         <span class="st">&quot;LYZ&quot;</span>, <span class="co"># CD14, LYZ     CD14+ Mono</span></span>
<span id="cb1431-7"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1431-7"></a>         <span class="st">&quot;MS4A1&quot;</span>, <span class="co"># MS4A1   B</span></span>
<span id="cb1431-8"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1431-8"></a>         <span class="st">&quot;CD8A&quot;</span>, <span class="co"># CD8A     CD8+ T</span></span>
<span id="cb1431-9"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1431-9"></a>         <span class="st">&quot;FCGR3A&quot;</span>, <span class="co"># FCGR3A, MS4A7  FCGR3A+ Mono</span></span>
<span id="cb1431-10"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1431-10"></a>         <span class="st">&quot;MS4A7&quot;</span>, <span class="co"># FCGR3A, MS4A7   FCGR3A+ Mono</span></span>
<span id="cb1431-11"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1431-11"></a>         <span class="st">&quot;GNLY&quot;</span>, <span class="co"># GNLY, NKG7   NK</span></span>
<span id="cb1431-12"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1431-12"></a>         <span class="st">&quot;NKG7&quot;</span>, <span class="co"># GNLY, NKG7   NK</span></span>
<span id="cb1431-13"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1431-13"></a>         <span class="st">&quot;FCER1A&quot;</span>, <span class="co"># DC</span></span>
<span id="cb1431-14"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1431-14"></a>         <span class="st">&quot;CST3&quot;</span>, <span class="co"># DC</span></span>
<span id="cb1431-15"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1431-15"></a>         <span class="st">&quot;PPBP&quot;</span> <span class="co"># Platelet</span></span>
<span id="cb1431-16"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1431-16"></a>        )</span></code></pre></div>
<div class="sourceCode" id="cb1432"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1432-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1432-1"></a>tmpInd &lt;-<span class="st"> </span><span class="kw">which</span>(<span class="kw">rowData</span>(uncorrected)<span class="op">$</span>Symbol <span class="op">%in%</span><span class="st"> </span>genesToShow2)</span>
<span id="cb1432-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1432-2"></a>ensToShow &lt;-<span class="st"> </span><span class="kw">rowData</span>(uncorrected)<span class="op">$</span>ensembl_gene_id[tmpInd]</span>
<span id="cb1432-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1432-3"></a><span class="kw">table</span>(ensToShow <span class="op">%in%</span><span class="st"> </span><span class="kw">rownames</span>(<span class="kw">rowData</span>(mnn.out)))</span>
<span id="cb1432-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1432-4"></a>ensToShow &lt;-<span class="st"> </span>ensToShow[ensToShow <span class="op">%in%</span><span class="st"> </span><span class="kw">rownames</span>(<span class="kw">rowData</span>(mnn.out))]</span></code></pre></div>
<div class="sourceCode" id="cb1433"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1433-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1433-1"></a><span class="cf">for</span> (genex <span class="cf">in</span> ensToShow)</span>
<span id="cb1433-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1433-2"></a>{</span>
<span id="cb1433-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1433-3"></a>    p &lt;-<span class="st"> </span><span class="kw">plotTSNE</span>(mnn.out, <span class="dt">colour_by =</span> genex, <span class="dt">by_exprs_values=</span><span class="st">&quot;reconstructed&quot;</span>)</span>
<span id="cb1433-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1433-4"></a>    p &lt;-<span class="st"> </span>p <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(<span class="kw">paste</span>(genex, <span class="kw">rowData</span>(uncorrected)[genex,<span class="st">&quot;Symbol&quot;</span>]))</span>
<span id="cb1433-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1433-5"></a>    <span class="kw">print</span>(p)</span>
<span id="cb1433-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1433-6"></a>}</span></code></pre></div>
</div>
<div id="preserving-biological-heterogeneity-4" class="section level3">
<h3><span class="header-section-number">18.8.2</span> Preserving biological heterogeneity</h3>
<div id="comparison-between-within-batch-clusters-and-across-batch-clusters-obtained-after-mnn-correction-3" class="section level4">
<h4><span class="header-section-number">18.8.2.1</span> Comparison between within-batch clusters and across-batch clusters obtained after MNN correction</h4>
<p>Another useful diagnostic check is to compare the clustering within each batch to the clustering of the merged data. Accurate data integration should preserve variance within each batch as there should be nothing to remove between cells in the same batch. This check complements the previously mentioned diagnostics that only focus on the removal of differences between batches. Specifically, it protects us against cases where the correction method simply aggregates all cells together, which would achieve perfect mixing but also discard the biological heterogeneity of interest.</p>
<p>Ideally, we should see a many-to-1 mapping where the across-batch clustering is nested inside the within-batch clusterings. This indicates that any within-batch structure was preserved after correction while acknowledging that greater resolution is possible with more cells. In practice, more discrepancies can be expected even when the correction is perfect, due to the existence of closely related clusters that were arbitrarily separated in the within-batch clustering. As a general rule, we can be satisfied with the correction if the vast majority of entries are zero, though this may depend on whether specific clusters of interest are gained or lost.</p>
<p>One heatmap is generated for each dataset, where each entry is colored according to the number of cells with each pair of labels (before and after correction), on the log10 scale with pseudocounts (+10) for a smoother color transition (so a minimum value of log10(0+10) == 1).</p>
<div class="sourceCode" id="cb1434"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1434-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1434-1"></a>plotList &lt;-<span class="st"> </span><span class="kw">vector</span>(<span class="dt">mode =</span> <span class="st">&quot;list&quot;</span>, <span class="dt">length =</span> <span class="kw">length</span>(splVec))</span>
<span id="cb1434-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1434-2"></a>treeList &lt;-<span class="st"> </span><span class="kw">vector</span>(<span class="dt">mode =</span> <span class="st">&quot;list&quot;</span>, <span class="dt">length =</span> <span class="kw">length</span>(splVec))</span>
<span id="cb1434-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1434-3"></a><span class="cf">for</span> (splIdx <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(splVec)) {</span>
<span id="cb1434-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1434-4"></a>  <span class="co"># heatmap</span></span>
<span id="cb1434-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1434-5"></a>  tab &lt;-<span class="st"> </span><span class="kw">table</span>(</span>
<span id="cb1434-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1434-6"></a>    <span class="kw">paste</span>(<span class="st">&quot;before&quot;</span>, <span class="kw">colLabels</span>(rescaled[[splIdx]]), <span class="dt">sep=</span><span class="st">&quot;_&quot;</span>),</span>
<span id="cb1434-7"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1434-7"></a>    <span class="kw">paste</span>(<span class="st">&quot;after&quot;</span>, clusters.mnn[rescaled2<span class="op">$</span>batch<span class="op">==</span>splVec[splIdx]], <span class="dt">sep=</span><span class="st">&quot;_&quot;</span>)</span>
<span id="cb1434-8"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1434-8"></a>    )</span>
<span id="cb1434-9"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1434-9"></a>  plotList[[splIdx]] &lt;-<span class="st"> </span><span class="kw">pheatmap</span>(<span class="kw">log10</span>(tab<span class="op">+</span><span class="dv">10</span>),</span>
<span id="cb1434-10"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1434-10"></a>                                 <span class="dt">cluster_row=</span><span class="ot">FALSE</span>,</span>
<span id="cb1434-11"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1434-11"></a>                                 <span class="dt">cluster_col=</span><span class="ot">FALSE</span>,</span>
<span id="cb1434-12"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1434-12"></a>                                 <span class="dt">col=</span><span class="kw">rev</span>(viridis<span class="op">::</span><span class="kw">magma</span>(<span class="dv">100</span>)),</span>
<span id="cb1434-13"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1434-13"></a>                                 <span class="dt">main=</span><span class="kw">sprintf</span>(<span class="st">&quot;%s&quot;</span>,</span>
<span id="cb1434-14"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1434-14"></a>                                              splVec[splIdx]),</span>
<span id="cb1434-15"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1434-15"></a>                                 <span class="dt">silent=</span><span class="ot">TRUE</span>,</span>
<span id="cb1434-16"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1434-16"></a>                                 <span class="dt">fontsize=</span><span class="dv">7</span>)</span>
<span id="cb1434-17"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1434-17"></a>  <span class="co"># cluster tree:</span></span>
<span id="cb1434-18"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1434-18"></a>  combined &lt;-<span class="st"> </span><span class="kw">cbind</span>(</span>
<span id="cb1434-19"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1434-19"></a>    <span class="dt">cl.1=</span><span class="kw">colLabels</span>(rescaled[[splIdx]]),</span>
<span id="cb1434-20"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1434-20"></a>    <span class="dt">cl.2=</span>clusters.mnn[rescaled2<span class="op">$</span>batch<span class="op">==</span>splVec[splIdx]])</span>
<span id="cb1434-21"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1434-21"></a>  treeList[[splIdx]]  &lt;-<span class="st"> </span><span class="kw">clustree</span>(combined, <span class="dt">prefix=</span><span class="st">&quot;cl.&quot;</span>, <span class="dt">edge_arrow=</span><span class="ot">FALSE</span>) <span class="op">+</span></span>
<span id="cb1434-22"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1434-22"></a><span class="st">    </span><span class="kw">ggtitle</span>(splVec[splIdx]) <span class="op">+</span></span>
<span id="cb1434-23"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1434-23"></a><span class="st">    </span><span class="co">#theme(legend.background = element_rect(color = &quot;yellow&quot;)) +</span></span>
<span id="cb1434-24"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1434-24"></a><span class="st">    </span><span class="co">#theme(legend.position=&#39;bottom&#39;) +</span></span>
<span id="cb1434-25"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1434-25"></a><span class="st">    </span><span class="co">#theme(legend.box=&quot;vertical&quot;) +</span></span>
<span id="cb1434-26"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1434-26"></a><span class="st">    </span><span class="co">#theme(legend.box=&quot;horizontal&quot;) +</span></span>
<span id="cb1434-27"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1434-27"></a><span class="st">    </span><span class="kw">theme</span>(<span class="dt">legend.margin=</span><span class="kw">margin</span>()) <span class="co">#+</span></span>
<span id="cb1434-28"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1434-28"></a>    <span class="co">#guides(fill=guide_legend(nrow=2, byrow=FALSE))</span></span>
<span id="cb1434-29"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1434-29"></a>    <span class="co">#theme(legend.position = &quot;none&quot;)</span></span>
<span id="cb1434-30"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1434-30"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb1435"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1435-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-1"></a>g_legend&lt;-<span class="cf">function</span>(a.gplot){</span>
<span id="cb1435-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-2"></a>   tmp &lt;-<span class="st"> </span><span class="kw">ggplot_gtable</span>(<span class="kw">ggplot_build</span>(a.gplot))</span>
<span id="cb1435-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-3"></a>   leg &lt;-<span class="st"> </span><span class="kw">which</span>(<span class="kw">sapply</span>(tmp<span class="op">$</span>grobs, <span class="cf">function</span>(x) x<span class="op">$</span>name) <span class="op">==</span><span class="st"> &quot;guide-box&quot;</span>)</span>
<span id="cb1435-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-4"></a>   legend &lt;-<span class="st"> </span>tmp<span class="op">$</span>grobs[[leg]]</span>
<span id="cb1435-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-5"></a>   <span class="kw">return</span>(legend)</span>
<span id="cb1435-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-6"></a>}</span>
<span id="cb1435-7"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-7"></a></span>
<span id="cb1435-8"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-8"></a>redrawClutree &lt;-<span class="st"> </span><span class="cf">function</span>(p){</span>
<span id="cb1435-9"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-9"></a><span class="co">#p &lt;- treeList[[1]] + theme(legend.position=&#39;bottom&#39;)</span></span>
<span id="cb1435-10"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-10"></a><span class="co">#p &lt;- p + theme(legend.background = element_rect(color = &quot;yellow&quot;))</span></span>
<span id="cb1435-11"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-11"></a>p &lt;-<span class="st"> </span>p <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">legend.justification =</span> <span class="st">&quot;left&quot;</span>)</span>
<span id="cb1435-12"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-12"></a><span class="co">#p &lt;- p + theme(legend.justification = c(0,1))</span></span>
<span id="cb1435-13"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-13"></a><span class="co">#lemon::gtable_show_names(p)</span></span>
<span id="cb1435-14"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-14"></a>pNoLeg &lt;-<span class="st"> </span>p <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;none&quot;</span>)</span>
<span id="cb1435-15"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-15"></a><span class="co"># edge colour:</span></span>
<span id="cb1435-16"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-16"></a>pEdgeCol &lt;-<span class="st"> </span>p <span class="op">+</span></span>
<span id="cb1435-17"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-17"></a><span class="st">  </span><span class="co">#guides(edge_colour = FALSE) +</span></span>
<span id="cb1435-18"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-18"></a><span class="st">  </span><span class="kw">guides</span>(<span class="dt">edge_alpha =</span> <span class="ot">FALSE</span>) <span class="op">+</span></span>
<span id="cb1435-19"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-19"></a><span class="st">  </span><span class="kw">guides</span>(<span class="dt">size =</span> <span class="ot">FALSE</span>) <span class="op">+</span></span>
<span id="cb1435-20"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-20"></a><span class="st">  </span><span class="kw">guides</span>(<span class="dt">colour =</span> <span class="ot">FALSE</span>) </span>
<span id="cb1435-21"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-21"></a>pEdgeCol.leg &lt;-<span class="st"> </span><span class="kw">g_legend</span>(pEdgeCol)</span>
<span id="cb1435-22"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-22"></a><span class="co"># edge alpha:</span></span>
<span id="cb1435-23"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-23"></a>pEdgeAlpha &lt;-<span class="st"> </span>p <span class="op">+</span></span>
<span id="cb1435-24"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-24"></a><span class="st">  </span><span class="kw">guides</span>(<span class="dt">edge_colour =</span> <span class="ot">FALSE</span>) <span class="op">+</span></span>
<span id="cb1435-25"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-25"></a><span class="st">  </span><span class="co">#guides(edge_alpha = FALSE) +</span></span>
<span id="cb1435-26"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-26"></a><span class="st">  </span><span class="kw">guides</span>(<span class="dt">size =</span> <span class="ot">FALSE</span>) <span class="op">+</span></span>
<span id="cb1435-27"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-27"></a><span class="st">  </span><span class="kw">guides</span>(<span class="dt">colour =</span> <span class="ot">FALSE</span>) </span>
<span id="cb1435-28"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-28"></a>pEdgeAlpha.leg &lt;-<span class="st"> </span><span class="kw">g_legend</span>(pEdgeAlpha)</span>
<span id="cb1435-29"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-29"></a><span class="co"># size</span></span>
<span id="cb1435-30"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-30"></a>pSize &lt;-<span class="st"> </span>p <span class="op">+</span></span>
<span id="cb1435-31"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-31"></a><span class="st">  </span><span class="kw">guides</span>(<span class="dt">edge_colour =</span> <span class="ot">FALSE</span>) <span class="op">+</span></span>
<span id="cb1435-32"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-32"></a><span class="st">  </span><span class="kw">guides</span>(<span class="dt">edge_alpha =</span> <span class="ot">FALSE</span>) <span class="op">+</span></span>
<span id="cb1435-33"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-33"></a><span class="st">  </span><span class="co">#guides(size = FALSE) +</span></span>
<span id="cb1435-34"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-34"></a><span class="st">  </span><span class="kw">guides</span>(<span class="dt">colour =</span> <span class="ot">FALSE</span>) </span>
<span id="cb1435-35"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-35"></a>pSize.leg &lt;-<span class="st"> </span><span class="kw">g_legend</span>(pSize)</span>
<span id="cb1435-36"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-36"></a><span class="co"># colour</span></span>
<span id="cb1435-37"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-37"></a>pColour &lt;-<span class="st"> </span>p <span class="op">+</span></span>
<span id="cb1435-38"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-38"></a><span class="st">  </span><span class="kw">guides</span>(<span class="dt">edge_colour =</span> <span class="ot">FALSE</span>) <span class="op">+</span></span>
<span id="cb1435-39"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-39"></a><span class="st">  </span><span class="kw">guides</span>(<span class="dt">edge_alpha =</span> <span class="ot">FALSE</span>) <span class="op">+</span></span>
<span id="cb1435-40"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-40"></a><span class="st">  </span><span class="kw">guides</span>(<span class="dt">size =</span> <span class="ot">FALSE</span>) <span class="co">#+</span></span>
<span id="cb1435-41"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-41"></a>  <span class="co">#guides(colour = FALSE) </span></span>
<span id="cb1435-42"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-42"></a>pColour.leg &lt;-<span class="st"> </span><span class="kw">g_legend</span>(pColour)</span>
<span id="cb1435-43"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-43"></a></span>
<span id="cb1435-44"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-44"></a><span class="co">#gridExtra::grid.arrange(pNoLeg, pEdgeCol.leg, nrow=2, ncol=1, heights=c(unit(.8, &quot;npc&quot;), unit(.2, &quot;npc&quot;)))</span></span>
<span id="cb1435-45"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-45"></a><span class="cf">if</span>(<span class="ot">FALSE</span>)</span>
<span id="cb1435-46"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-46"></a>{</span>
<span id="cb1435-47"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-47"></a>grobx &lt;-<span class="st"> </span>gridExtra<span class="op">::</span><span class="kw">grid.arrange</span>(pNoLeg,</span>
<span id="cb1435-48"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-48"></a>                        pEdgeCol.leg,</span>
<span id="cb1435-49"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-49"></a>                        pEdgeAlpha.leg,</span>
<span id="cb1435-50"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-50"></a>                        pColour.leg,</span>
<span id="cb1435-51"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-51"></a>                        pSize.leg,</span>
<span id="cb1435-52"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-52"></a>                        <span class="dt">nrow=</span><span class="dv">3</span>, <span class="dt">ncol=</span><span class="dv">2</span>,</span>
<span id="cb1435-53"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-53"></a>                        <span class="dt">heights=</span><span class="kw">c</span>(<span class="kw">unit</span>(.<span class="dv">8</span>, <span class="st">&quot;npc&quot;</span>),</span>
<span id="cb1435-54"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-54"></a>                                  <span class="kw">unit</span>(.<span class="dv">1</span>, <span class="st">&quot;npc&quot;</span>),</span>
<span id="cb1435-55"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-55"></a>                                  <span class="kw">unit</span>(.<span class="dv">1</span>, <span class="st">&quot;npc&quot;</span>)),</span>
<span id="cb1435-56"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-56"></a>                        <span class="dt">widths=</span><span class="kw">c</span>(<span class="kw">unit</span>(.<span class="dv">3</span>, <span class="st">&quot;npc&quot;</span>), <span class="kw">unit</span>(.<span class="dv">7</span>, <span class="st">&quot;npc&quot;</span>)),</span>
<span id="cb1435-57"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-57"></a>                        <span class="dt">layout_matrix=</span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">5</span>,<span class="dv">4</span>,<span class="dv">3</span>), <span class="dt">ncol=</span><span class="dv">2</span>, <span class="dt">byrow=</span><span class="ot">TRUE</span>)</span>
<span id="cb1435-58"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-58"></a>                        )</span>
<span id="cb1435-59"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-59"></a>}</span>
<span id="cb1435-60"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-60"></a><span class="cf">if</span>(<span class="ot">FALSE</span>)</span>
<span id="cb1435-61"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-61"></a>{</span>
<span id="cb1435-62"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-62"></a>grobx &lt;-<span class="st"> </span>gridExtra<span class="op">::</span><span class="kw">arrangeGrob</span>(pNoLeg,</span>
<span id="cb1435-63"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-63"></a>                        pEdgeCol.leg,</span>
<span id="cb1435-64"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-64"></a>                        pEdgeAlpha.leg,</span>
<span id="cb1435-65"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-65"></a>                        pColour.leg,</span>
<span id="cb1435-66"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-66"></a>                        pSize.leg,</span>
<span id="cb1435-67"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-67"></a>                        <span class="co">#nrow=3, ncol=2,</span></span>
<span id="cb1435-68"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-68"></a>                        <span class="co">#layout_matrix=matrix(c(1,1,2,5,4,3), ncol=2, byrow=TRUE),</span></span>
<span id="cb1435-69"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-69"></a>                        <span class="dt">nrow=</span><span class="dv">2</span>, <span class="dt">ncol=</span><span class="dv">3</span>,</span>
<span id="cb1435-70"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-70"></a>                        <span class="dt">layout_matrix=</span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">5</span>,<span class="dv">4</span>,<span class="dv">3</span>), <span class="dt">ncol=</span><span class="dv">3</span>, <span class="dt">byrow=</span><span class="ot">FALSE</span>),</span>
<span id="cb1435-71"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-71"></a>                        <span class="dt">widths=</span><span class="kw">c</span>(<span class="kw">unit</span>(.<span class="dv">70</span>, <span class="st">&quot;npc&quot;</span>),</span>
<span id="cb1435-72"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-72"></a>                                  <span class="kw">unit</span>(.<span class="dv">15</span>, <span class="st">&quot;npc&quot;</span>),</span>
<span id="cb1435-73"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-73"></a>                                  <span class="kw">unit</span>(.<span class="dv">15</span>, <span class="st">&quot;npc&quot;</span>)),</span>
<span id="cb1435-74"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-74"></a>                        <span class="dt">heights=</span><span class="kw">c</span>(<span class="kw">unit</span>(.<span class="dv">7</span>, <span class="st">&quot;npc&quot;</span>),</span>
<span id="cb1435-75"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-75"></a>                                 <span class="kw">unit</span>(.<span class="dv">3</span>, <span class="st">&quot;npc&quot;</span>))</span>
<span id="cb1435-76"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-76"></a>                        )</span>
<span id="cb1435-77"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-77"></a>}</span>
<span id="cb1435-78"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-78"></a></span>
<span id="cb1435-79"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-79"></a>grobx &lt;-<span class="st"> </span>gridExtra<span class="op">::</span><span class="kw">arrangeGrob</span>(pNoLeg,</span>
<span id="cb1435-80"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-80"></a>                        pEdgeCol.leg,</span>
<span id="cb1435-81"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-81"></a>                        pEdgeAlpha.leg,</span>
<span id="cb1435-82"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-82"></a>                        <span class="co">#pColour.leg,</span></span>
<span id="cb1435-83"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-83"></a>                        pSize.leg,</span>
<span id="cb1435-84"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-84"></a>                        <span class="dt">nrow=</span><span class="dv">1</span>, <span class="dt">ncol=</span><span class="dv">4</span>,</span>
<span id="cb1435-85"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-85"></a>                        <span class="dt">layout_matrix=</span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>), <span class="dt">ncol=</span><span class="dv">4</span>, <span class="dt">byrow=</span><span class="ot">TRUE</span>),</span>
<span id="cb1435-86"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-86"></a>                        <span class="dt">widths=</span><span class="kw">c</span>(<span class="kw">unit</span>(.<span class="dv">64</span>, <span class="st">&quot;npc&quot;</span>),</span>
<span id="cb1435-87"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-87"></a>                                  <span class="kw">unit</span>(.<span class="dv">12</span>, <span class="st">&quot;npc&quot;</span>),</span>
<span id="cb1435-88"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-88"></a>                                  <span class="kw">unit</span>(.<span class="dv">12</span>, <span class="st">&quot;npc&quot;</span>),</span>
<span id="cb1435-89"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-89"></a>                                  <span class="kw">unit</span>(.<span class="dv">12</span>, <span class="st">&quot;npc&quot;</span>))</span>
<span id="cb1435-90"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-90"></a>                        )</span>
<span id="cb1435-91"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-91"></a>}</span>
<span id="cb1435-92"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-92"></a><span class="co">##gx &lt;- redrawClutree(treeList[[1]] + theme(legend.position=&#39;bottom&#39;))</span></span>
<span id="cb1435-93"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-93"></a><span class="co">##grid::grid.draw(gx)</span></span>
<span id="cb1435-94"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-94"></a><span class="co">## fine # gxList &lt;- lapply(treeList, function(x){redrawClutree(x+theme(legend.position=&#39;bottom&#39;))})</span></span>
<span id="cb1435-95"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-95"></a>gxList &lt;-<span class="st"> </span><span class="kw">lapply</span>(treeList, <span class="cf">function</span>(x){<span class="kw">redrawClutree</span>(x)})</span>
<span id="cb1435-96"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1435-96"></a><span class="co">##gridExtra::marrangeGrob(gxList, nrow=2, ncol=2)</span></span></code></pre></div>
<div class="sourceCode" id="cb1436"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1436-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1436-1"></a>grobList &lt;-<span class="st"> </span><span class="kw">lapply</span>(plotList, <span class="cf">function</span>(x){x[[<span class="dv">4</span>]]})</span>
<span id="cb1436-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1436-2"></a>gridExtra<span class="op">::</span><span class="kw">grid.arrange</span>(<span class="dt">grobs =</span> grobList,</span>
<span id="cb1436-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1436-3"></a>      <span class="dt">ncol=</span><span class="dv">2</span>,</span>
<span id="cb1436-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1436-4"></a>      <span class="dt">top =</span> grid<span class="op">::</span><span class="kw">textGrob</span>(<span class="st">&quot;clusterings concordance (number of cells, log10 scale)&quot;</span>,</span>
<span id="cb1436-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1436-5"></a>                     <span class="dt">gp=</span>grid<span class="op">::</span><span class="kw">gpar</span>(<span class="dt">fontsize=</span><span class="dv">12</span>,<span class="dt">font=</span><span class="dv">3</span>))</span>
<span id="cb1436-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1436-6"></a>)</span></code></pre></div>
<p><img src="dataSetIntegration_PBMMC_ETV6-RUNX1_files/figure-html/unnamed-chunk-58-1.png" width="672" /></p>
<p>The redistribution of cells from one set of clusters to another, here ‘within-batch before’ and ‘across-batch after’ correction, may also be visualized with a clustering tree <a href="https://cran.r-project.org/package=clustree">clustree</a>. Clusters are represented as filled circles colored by cluster set (‘before’ in pink, ‘after’ in blue) and sized by cell number. A pair of clusters from two sets are linked according to the number of cells they share with a link that informs on the number of cells shared (color) and the ‘incoming node’ proportion for the node it points to (transparency). Although these plots convey more information than heatmaps below, they may not be as easy to read.</p>
<div class="sourceCode" id="cb1437"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1437-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1437-1"></a><span class="co">#```{r, fig.height=figSize*length(treeList)/2, fig.width=figSize}</span></span>
<span id="cb1437-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1437-2"></a><span class="co">#gridExtra::grid.arrange(grobs = treeList,</span></span>
<span id="cb1437-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1437-3"></a>gridExtra<span class="op">::</span><span class="kw">grid.arrange</span>(<span class="dt">grobs =</span> gxList,</span>
<span id="cb1437-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1437-4"></a>      <span class="dt">ncol=</span><span class="dv">1</span></span>
<span id="cb1437-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1437-5"></a>)</span></code></pre></div>
<p><img src="dataSetIntegration_PBMMC_ETV6-RUNX1_files/figure-html/unnamed-chunk-60-1.png" width="672" /></p>
<p>The same plots in more compact form with no legend:</p>
<!-- remove legend and have plots in two columns -->
<div class="sourceCode" id="cb1438"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1438-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1438-1"></a>treeList &lt;-<span class="st"> </span><span class="kw">lapply</span>(treeList, <span class="cf">function</span>(p){</span>
<span id="cb1438-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1438-2"></a>  p <span class="op">+</span></span>
<span id="cb1438-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1438-3"></a><span class="st">    </span><span class="kw">guides</span>(<span class="dt">edge_colour =</span> <span class="ot">FALSE</span>) <span class="op">+</span></span>
<span id="cb1438-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1438-4"></a><span class="st">    </span><span class="kw">guides</span>(<span class="dt">edge_alpha =</span> <span class="ot">FALSE</span>) <span class="op">+</span></span>
<span id="cb1438-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1438-5"></a><span class="st">    </span><span class="kw">guides</span>(<span class="dt">size =</span> <span class="ot">FALSE</span>) <span class="op">+</span></span>
<span id="cb1438-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1438-6"></a><span class="st">    </span><span class="kw">guides</span>(<span class="dt">colour =</span> <span class="ot">FALSE</span>) </span>
<span id="cb1438-7"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1438-7"></a>})</span></code></pre></div>
<div class="sourceCode" id="cb1439"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1439-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1439-1"></a>gridExtra<span class="op">::</span><span class="kw">grid.arrange</span>(<span class="dt">grobs =</span> treeList,</span>
<span id="cb1439-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1439-2"></a>      <span class="dt">ncol=</span><span class="dv">2</span></span>
<span id="cb1439-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1439-3"></a>)</span></code></pre></div>
<p><img src="dataSetIntegration_PBMMC_ETV6-RUNX1_files/figure-html/unnamed-chunk-63-1.png" width="672" /></p>
<div class="sourceCode" id="cb1440"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1440-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1440-1"></a>knitr<span class="op">::</span><span class="kw">knit_exit</span>()</span></code></pre></div>
</div>
<div id="coassignment-probabilities-3" class="section level4">
<h4><span class="header-section-number">18.8.2.2</span> Coassignment probabilities</h4>
<p>Another evaluation approach is to compute the <strong>coassignment probabilities</strong>, i.e. the probability that cells from two within-batch clusters are clustered together in the across-batch clustering. High probabilities off the diagonal indicate that within-batch clusters are merged in the across-batch analysis. We would generally expect low off-diagonal probabilities for most pairs of clusters, though this may not be reasonably possible if the within-batch clusters were poorly separated in the first place.</p>
<p>The plots below display the coassignment probabilities for the within-batch clusters, based on coassignment of cells in the across-batch clusters obtained after MNN correction. One heatmap is generated for each sample, where each entry is colored according to the coassignment probability between each pair of within-batch clusters:</p>
<div class="sourceCode" id="cb1441"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1441-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1441-1"></a><span class="co"># coassignProb manual: now deprecated for pairwiseRand. </span></span>
<span id="cb1441-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1441-2"></a><span class="co"># Note that the coassignment probability is closely related to the Rand index-based ratios broken down by cluster pair in pairwiseRand with mode=&quot;ratio&quot; and adjusted=FALSE. The off-diagonal coassignment probabilities are simply 1 minus the off-diagonal ratio, while the on-diagonal values differ only by the lack of consideration of pairs of the same cell in pairwiseRand. </span></span>
<span id="cb1441-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1441-3"></a></span>
<span id="cb1441-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1441-4"></a>plotList &lt;-<span class="st"> </span><span class="kw">vector</span>(<span class="dt">mode =</span> <span class="st">&quot;list&quot;</span>, <span class="dt">length =</span> <span class="kw">length</span>(splVec))</span>
<span id="cb1441-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1441-5"></a><span class="cf">for</span> (splIdx <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(splVec)) {</span>
<span id="cb1441-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1441-6"></a>  tab &lt;-<span class="st"> </span><span class="kw">coassignProb</span>(<span class="kw">colLabels</span>(rescaled[[splIdx]]),</span>
<span id="cb1441-7"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1441-7"></a>                      clusters.mnn[rescaled2<span class="op">$</span>batch<span class="op">==</span>splVec[splIdx]])</span>
<span id="cb1441-8"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1441-8"></a>  plotList[[splIdx]] &lt;-<span class="st"> </span><span class="kw">pheatmap</span>(tab,</span>
<span id="cb1441-9"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1441-9"></a>                                 <span class="dt">cluster_row=</span><span class="ot">FALSE</span>,</span>
<span id="cb1441-10"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1441-10"></a>                                 <span class="dt">cluster_col=</span><span class="ot">FALSE</span>,</span>
<span id="cb1441-11"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1441-11"></a>                                 <span class="dt">col=</span><span class="kw">rev</span>(viridis<span class="op">::</span><span class="kw">magma</span>(<span class="dv">100</span>)),</span>
<span id="cb1441-12"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1441-12"></a>                                 <span class="dt">main=</span><span class="kw">sprintf</span>(<span class="st">&quot;%s probabilities&quot;</span>, splVec[splIdx]),</span>
<span id="cb1441-13"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1441-13"></a>                                 <span class="dt">silent=</span><span class="ot">TRUE</span>)</span>
<span id="cb1441-14"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1441-14"></a>}</span>
<span id="cb1441-15"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1441-15"></a>grobList &lt;-<span class="st"> </span><span class="kw">lapply</span>(plotList, <span class="cf">function</span>(x){x[[<span class="dv">4</span>]]})</span>
<span id="cb1441-16"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1441-16"></a>gridExtra<span class="op">::</span><span class="kw">grid.arrange</span>(<span class="dt">grobs =</span> grobList,</span>
<span id="cb1441-17"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1441-17"></a>      <span class="dt">ncol=</span><span class="dv">2</span></span>
<span id="cb1441-18"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1441-18"></a>)</span></code></pre></div>
<p><img src="dataSetIntegration_PBMMC_ETV6-RUNX1_files/figure-html/unnamed-chunk-66-1.png" width="672" /></p>
<p>Note that the coassignment probability is closely related to the Rand index-based ratios broken down by cluster pair (in <code>pairwiseRand()</code> with mode=“ratio” and adjusted=FALSE). The Rand index is introduced below.</p>
</div>
<div id="rand-index-3" class="section level4">
<h4><span class="header-section-number">18.8.2.3</span> Rand index</h4>
<p>Finally, we can summarize the agreement between clusterings by computing the <strong>Rand index</strong>. This provides a simple metric that we can use to assess the preservation of variation by different correction methods. Larger rand indices (i.e., closer to 1) are more desirable, though this must be balanced against the ability of each method to actually remove the batch effect.</p>
<div class="sourceCode" id="cb1442"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1442-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1442-1"></a><span class="co"># pairwiseRand(), index, adjusted</span></span>
<span id="cb1442-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1442-2"></a>ariVec &lt;-<span class="st"> </span><span class="kw">vector</span>(<span class="dt">mode =</span> <span class="st">&quot;numeric&quot;</span>, <span class="dt">length =</span> <span class="kw">length</span>(splVec))</span>
<span id="cb1442-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1442-3"></a><span class="kw">names</span>(ariVec) &lt;-<span class="st"> </span>splVec</span>
<span id="cb1442-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1442-4"></a><span class="cf">for</span> (splIdx <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(splVec)) {</span>
<span id="cb1442-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1442-5"></a>  ariVec[splIdx] &lt;-<span class="st"> </span><span class="kw">pairwiseRand</span>(</span>
<span id="cb1442-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1442-6"></a>    <span class="dt">ref=</span><span class="kw">as.integer</span>(clusters.mnn[rescaled2<span class="op">$</span>batch<span class="op">==</span>splVec[splIdx]]),</span>
<span id="cb1442-7"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1442-7"></a>    <span class="dt">alt=</span><span class="kw">as.integer</span>(<span class="kw">colLabels</span>(rescaled[[splIdx]])),</span>
<span id="cb1442-8"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1442-8"></a>    <span class="dt">mode=</span><span class="st">&quot;index&quot;</span>)</span>
<span id="cb1442-9"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1442-9"></a>}</span>
<span id="cb1442-10"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1442-10"></a>ariVec &lt;-<span class="st"> </span><span class="kw">round</span>(ariVec,<span class="dv">2</span>)</span>
<span id="cb1442-11"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1442-11"></a>ariVec</span></code></pre></div>
<pre><code>## GSM3872434 GSM3872435 GSM3872436 GSM3872437 GSM3872442 GSM3872443 GSM3872444 
##       0.29       0.21       0.76       0.50       0.74       0.63       0.78</code></pre>
<p>A sample may show a low Rand index value if cells grouped together in a small cluster before correction are split into distinct clusters after correction because the latter comprise cell populations not observed in that sample but present in other samples.</p>
<p>This would be the case of GSM3872434 with far fewer erythrocytes (grouped in a single cluster) than GSM3872443, in which subtypes can be distinguished.
<!--
--></p>
<p>We can also break down the <strong>adjusted Rand index (ARI)</strong> into per-cluster ratios for more detailed diagnostics. For example, we could see low ratios off the diagonal if distinct clusters in the within-batch clustering were incorrectly aggregated in the merged clustering. Conversely, we might see low ratios on the diagonal if the correction inflated or introduced spurious heterogeneity inside a within-batch cluster.</p>
<div class="sourceCode" id="cb1444"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1444-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1444-1"></a><span class="co"># pairwiseRand(), ratio, adjusted</span></span>
<span id="cb1444-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1444-2"></a><span class="co"># square numeric matrix is returned with number of rows equal to the number of unique levels in ref.</span></span>
<span id="cb1444-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1444-3"></a></span>
<span id="cb1444-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1444-4"></a>tabList &lt;-<span class="st"> </span><span class="kw">vector</span>(<span class="dt">mode =</span> <span class="st">&quot;list&quot;</span>, <span class="dt">length =</span> <span class="kw">length</span>(splVec))</span>
<span id="cb1444-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1444-5"></a><span class="cf">for</span> (splIdx <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(splVec)) {</span>
<span id="cb1444-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1444-6"></a>  tabList[[splIdx]] &lt;-<span class="st"> </span><span class="kw">pairwiseRand</span>(</span>
<span id="cb1444-7"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1444-7"></a>      <span class="dt">ref=</span><span class="kw">as.integer</span>(<span class="kw">colLabels</span>(rescaled[[splIdx]])),</span>
<span id="cb1444-8"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1444-8"></a>    <span class="dt">alt=</span><span class="kw">as.integer</span>(clusters.mnn[rescaled2<span class="op">$</span>batch<span class="op">==</span>splVec[splIdx]])</span>
<span id="cb1444-9"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1444-9"></a>    )</span>
<span id="cb1444-10"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1444-10"></a>}</span>
<span id="cb1444-11"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1444-11"></a>randVal &lt;-<span class="st"> </span><span class="kw">unlist</span>(tabList) </span>
<span id="cb1444-12"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1444-12"></a></span>
<span id="cb1444-13"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1444-13"></a><span class="co">## make breaks from combined range</span></span>
<span id="cb1444-14"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1444-14"></a>limits &lt;-<span class="st"> </span><span class="kw">c</span>(</span>
<span id="cb1444-15"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1444-15"></a>  <span class="kw">min</span>(randVal, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),</span>
<span id="cb1444-16"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1444-16"></a>  <span class="kw">max</span>(randVal, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))</span>
<span id="cb1444-17"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1444-17"></a>limits &lt;-<span class="st"> </span><span class="kw">quantile</span>(randVal, <span class="dt">probs=</span><span class="kw">c</span>(<span class="fl">0.05</span>, <span class="fl">0.95</span>), <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</span>
<span id="cb1444-18"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1444-18"></a></span>
<span id="cb1444-19"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1444-19"></a>Breaks &lt;-<span class="st"> </span><span class="kw">seq</span>(limits[<span class="dv">1</span>], limits[<span class="dv">2</span>],</span>
<span id="cb1444-20"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1444-20"></a>              <span class="dt">length =</span> <span class="dv">100</span>)</span>
<span id="cb1444-21"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1444-21"></a></span>
<span id="cb1444-22"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1444-22"></a>plotList &lt;-<span class="st"> </span><span class="kw">vector</span>(<span class="dt">mode =</span> <span class="st">&quot;list&quot;</span>, <span class="dt">length =</span> <span class="kw">length</span>(splVec))</span>
<span id="cb1444-23"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1444-23"></a><span class="cf">for</span> (splIdx <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(splVec)) {</span>
<span id="cb1444-24"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1444-24"></a>  plotList[[splIdx]] &lt;-<span class="st"> </span><span class="kw">pheatmap</span>(tabList[[splIdx]],</span>
<span id="cb1444-25"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1444-25"></a>                                 <span class="dt">cluster_row=</span><span class="ot">FALSE</span>,</span>
<span id="cb1444-26"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1444-26"></a>                                 <span class="dt">cluster_col=</span><span class="ot">FALSE</span>,</span>
<span id="cb1444-27"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1444-27"></a>                                 <span class="dt">col=</span><span class="kw">rev</span>(viridis<span class="op">::</span><span class="kw">magma</span>(<span class="dv">100</span>)),</span>
<span id="cb1444-28"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1444-28"></a>                                 <span class="dt">breaks=</span>Breaks,</span>
<span id="cb1444-29"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1444-29"></a>                                 <span class="dt">main=</span><span class="kw">sprintf</span>(<span class="st">&quot;%s ratio&quot;</span>, splVec[splIdx]),</span>
<span id="cb1444-30"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1444-30"></a>                                 <span class="dt">silent=</span><span class="ot">TRUE</span>)</span>
<span id="cb1444-31"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1444-31"></a>}</span>
<span id="cb1444-32"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1444-32"></a>grobList &lt;-<span class="st"> </span><span class="kw">lapply</span>(plotList, <span class="cf">function</span>(x){x[[<span class="dv">4</span>]]})</span>
<span id="cb1444-33"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1444-33"></a>gridExtra<span class="op">::</span><span class="kw">grid.arrange</span>(<span class="dt">grobs =</span> grobList,</span>
<span id="cb1444-34"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1444-34"></a>      <span class="dt">ncol=</span><span class="dv">2</span></span>
<span id="cb1444-35"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1444-35"></a>)</span></code></pre></div>
<p><img src="dataSetIntegration_PBMMC_ETV6-RUNX1_files/figure-html/unnamed-chunk-73-1.png" width="672" /></p>
</div>
</div>
</div>
<div id="encouraging-consistency-with-marker-genes-4" class="section level2">
<h2><span class="header-section-number">18.9</span> Encouraging consistency with marker genes</h2>
<p>In some situations, we will already have performed within-batch analyses to characterize salient aspects of population heterogeneity. This is not uncommon when merging datasets from different sources where each dataset has already been analyzed, annotated and interpreted separately. It is subsequently desirable for the integration procedure to retain these “known interesting” aspects of each dataset in the merged dataset. We can encourage this outcome by using the marker genes within each dataset as our selected feature set for <code>fastMNN()</code> and related methods. This focuses on the relevant heterogeneity and represents a semi-supervised approach that is a natural extension of the strategy described in Section 8.4.</p>
<p>We identify the top marker genes from pairwise Wilcoxon ranked sum tests between every pair of clusters within each batch, analogous to the method used by <a href="https://www.bioconductor.org/packages/release/bioc/html/SingleR.html">SingleR</a>. In this case, we use the top 10 marker genes but any value can be used depending on the acceptable trade-off between signal and noise (and speed). We then take the union across all comparisons in all batches and use that in place of our HVG set in <code>fastMNN()</code>.</p>
<div class="sourceCode" id="cb1445"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1445-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1445-1"></a><span class="co"># Recall that groups for marker detection</span></span>
<span id="cb1445-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1445-2"></a><span class="co"># are automatically defined from &#39;colLabels()&#39;. </span></span>
<span id="cb1445-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1445-3"></a>markerList &lt;-<span class="st"> </span><span class="kw">lapply</span>(rescaled, <span class="cf">function</span>(x){</span>
<span id="cb1445-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1445-4"></a>  y &lt;-<span class="st"> </span><span class="kw">pairwiseWilcox</span>(x, <span class="dt">direction=</span><span class="st">&quot;up&quot;</span>)</span>
<span id="cb1445-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1445-5"></a>  <span class="kw">getTopMarkers</span>(y[[<span class="dv">1</span>]], y[[<span class="dv">2</span>]], <span class="dt">n=</span><span class="dv">10</span>) <span class="op">%&gt;%</span><span class="st"> </span>unlist <span class="op">%&gt;%</span><span class="st"> </span>unlist</span>
<span id="cb1445-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1445-6"></a>  })</span>
<span id="cb1445-7"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1445-7"></a>marker.set &lt;-<span class="st"> </span><span class="kw">unique</span>(<span class="kw">unlist</span>(markerList))</span>
<span id="cb1445-8"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1445-8"></a><span class="co">#length(marker.set) # getting the total number of genes selected in this manner.</span></span></code></pre></div>
<p>The total number of genes selected in this manner is: 430.</p>
<div class="sourceCode" id="cb1446"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1446-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1446-1"></a><span class="kw">set.seed</span>(<span class="dv">1000110</span>)</span>
<span id="cb1446-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1446-2"></a>mnn.out2 &lt;-<span class="st"> </span><span class="kw">fastMNN</span>(rescaled,</span>
<span id="cb1446-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1446-3"></a>                    <span class="dt">subset.row=</span>marker.set,</span>
<span id="cb1446-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1446-4"></a>                    <span class="dt">BSPARAM=</span>BiocSingular<span class="op">::</span><span class="kw">RandomParam</span>(<span class="dt">deferred=</span><span class="ot">TRUE</span>))</span>
<span id="cb1446-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1446-5"></a>mnn.out2<span class="op">$</span>source_name &lt;-<span class="st"> </span>uncorrected<span class="op">$</span>source_name <span class="co"># cell order is maintained by scran functions</span></span>
<span id="cb1446-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1446-6"></a></span>
<span id="cb1446-7"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1446-7"></a><span class="co"># compute t-SNE:</span></span>
<span id="cb1446-8"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1446-8"></a>mnn.out2 &lt;-<span class="st"> </span><span class="kw">runTSNE</span>(mnn.out2, <span class="dt">dimred=</span><span class="st">&quot;corrected&quot;</span>)</span></code></pre></div>
<p>We can also visualize the corrected coordinates using a t-SNE plot:</p>
<div class="sourceCode" id="cb1447"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1447-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1447-1"></a><span class="kw">plotTSNE</span>(mnn.out2, <span class="dt">colour_by=</span><span class="st">&quot;batch&quot;</span>)</span></code></pre></div>
<p><img src="dataSetIntegration_PBMMC_ETV6-RUNX1_files/figure-html/unnamed-chunk-76-1.png" width="672" /></p>
<div class="sourceCode" id="cb1448"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1448-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1448-1"></a><span class="kw">plotTSNE</span>(mnn.out2, <span class="dt">colour_by=</span><span class="st">&quot;batch&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">facet_wrap</span>(<span class="op">~</span><span class="kw">colData</span>(mnn.out2)<span class="op">$</span>batch)</span></code></pre></div>
<p><img src="dataSetIntegration_PBMMC_ETV6-RUNX1_files/figure-html/unnamed-chunk-77-1.png" width="672" /></p>
<div class="sourceCode" id="cb1449"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1449-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1449-1"></a><span class="kw">plotTSNE</span>(mnn.out2, <span class="dt">colour_by=</span><span class="st">&quot;source_name&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">facet_wrap</span>(<span class="op">~</span><span class="kw">colData</span>(mnn.out2)<span class="op">$</span>source_name)</span></code></pre></div>
<p><img src="dataSetIntegration_PBMMC_ETV6-RUNX1_files/figure-html/unnamed-chunk-78-1.png" width="672" /></p>
<p>A quick inspection indicates that the original within-batch structure is indeed preserved in the corrected data. This highlights the utility of a marker-based feature set for integrating datasets that have already been characterized separately in a manner that preserves existing interpretations of each dataset. We note that some within-batch clusters have merged, most likely due to the lack of robust separation in the first place, though this may also be treated as a diagnostic on the appropriateness of the integration depending on the context.</p>
<div class="sourceCode" id="cb1450"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1450-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1450-1"></a>plotList &lt;-<span class="st"> </span><span class="kw">vector</span>(<span class="dt">mode =</span> <span class="st">&quot;list&quot;</span>, <span class="dt">length =</span> <span class="kw">length</span>(splVec))</span>
<span id="cb1450-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1450-2"></a><span class="cf">for</span> (x <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(splVec)) {</span>
<span id="cb1450-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1450-3"></a>  plotList[[x]] &lt;-<span class="st"> </span><span class="kw">plotTSNE</span>(mnn.out2[,mnn.out2<span class="op">$</span>batch<span class="op">==</span>splVec[x]],</span>
<span id="cb1450-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1450-4"></a>                              <span class="dt">colour_by=</span><span class="kw">I</span>(<span class="kw">colLabels</span>(rescaled[[x]]))) <span class="op">+</span></span>
<span id="cb1450-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1450-5"></a><span class="st">                  </span><span class="kw">ggtitle</span>(splVec[x])</span>
<span id="cb1450-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1450-6"></a>}</span>
<span id="cb1450-7"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1450-7"></a>gridExtra<span class="op">::</span><span class="kw">grid.arrange</span>(<span class="dt">grobs =</span> plotList,</span>
<span id="cb1450-8"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1450-8"></a>      <span class="dt">ncol=</span><span class="dv">2</span></span>
<span id="cb1450-9"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1450-9"></a>)</span></code></pre></div>
<p><img src="dataSetIntegration_PBMMC_ETV6-RUNX1_files/figure-html/unnamed-chunk-79-1.png" width="672" /></p>
<div class="sourceCode" id="cb1451"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1451-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1451-1"></a><span class="co"># by_exprs_values, : cannot find &#39;ENSG00000090382&#39; for ETV6-RUNX1</span></span>
<span id="cb1451-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1451-2"></a><span class="co"># B cells</span></span>
<span id="cb1451-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1451-3"></a>genex &lt;-<span class="st"> </span>ensToShow[<span class="dv">1</span>]</span>
<span id="cb1451-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1451-4"></a>p &lt;-<span class="st"> </span><span class="kw">plotTSNE</span>(mnn.out2, <span class="dt">colour_by =</span> genex, <span class="dt">by_exprs_values=</span><span class="st">&quot;reconstructed&quot;</span>)</span>
<span id="cb1451-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1451-5"></a>p &lt;-<span class="st"> </span>p <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(</span>
<span id="cb1451-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1451-6"></a>        <span class="kw">paste</span>(<span class="st">&quot;B cells&quot;</span>, genex,</span>
<span id="cb1451-7"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1451-7"></a>            <span class="kw">rowData</span>(uncorrected)[genex,<span class="st">&quot;Symbol&quot;</span>])</span>
<span id="cb1451-8"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1451-8"></a>            )</span>
<span id="cb1451-9"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1451-9"></a><span class="kw">print</span>(p)</span></code></pre></div>
<div class="sourceCode" id="cb1452"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1452-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1452-1"></a>ensToShowPostCor &lt;-<span class="st"> </span>ensToShow[ensToShow <span class="op">%in%</span><span class="st"> </span><span class="kw">rownames</span>(mnn.out2)]</span>
<span id="cb1452-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1452-2"></a><span class="kw">rowData</span>(uncorrected)[ensToShowPostCor,<span class="kw">c</span>(<span class="st">&quot;ensembl_gene_id&quot;</span>, <span class="st">&quot;external_gene_name&quot;</span>)]</span></code></pre></div>
<div class="sourceCode" id="cb1453"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1453-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1453-1"></a>genex &lt;-<span class="st"> &quot;ENSG00000156738&quot;</span> <span class="co"># MS4A1 # ensToShowPostCor[1]</span></span>
<span id="cb1453-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1453-2"></a>p &lt;-<span class="st"> </span><span class="kw">plotTSNE</span>(mnn.out2, <span class="dt">colour_by =</span> genex, <span class="dt">by_exprs_values=</span><span class="st">&quot;reconstructed&quot;</span>)</span>
<span id="cb1453-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1453-3"></a>p &lt;-<span class="st"> </span>p <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(</span>
<span id="cb1453-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1453-4"></a>        <span class="kw">paste</span>(genex,</span>
<span id="cb1453-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1453-5"></a>              <span class="kw">rowData</span>(uncorrected)[genex,<span class="st">&quot;Symbol&quot;</span>])</span>
<span id="cb1453-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1453-6"></a>            )</span>
<span id="cb1453-7"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1453-7"></a><span class="kw">print</span>(p)</span></code></pre></div>
<div class="sourceCode" id="cb1454"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1454-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1454-1"></a><span class="co"># ENSG00000203747 is FCGR3A</span></span>
<span id="cb1454-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1454-2"></a>genex &lt;-<span class="st"> &quot;ENSG00000203747&quot;</span> <span class="co"># FCGR3A # ensToShowPostCor[1]</span></span>
<span id="cb1454-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1454-3"></a>p &lt;-<span class="st"> </span><span class="kw">plotTSNE</span>(mnn.out2, <span class="dt">colour_by =</span> genex, <span class="dt">by_exprs_values=</span><span class="st">&quot;reconstructed&quot;</span>)</span>
<span id="cb1454-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1454-4"></a>p &lt;-<span class="st"> </span>p <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(</span>
<span id="cb1454-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1454-5"></a>        <span class="kw">paste</span>(genex,</span>
<span id="cb1454-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1454-6"></a>              <span class="kw">rowData</span>(uncorrected)[genex,<span class="st">&quot;Symbol&quot;</span>])</span>
<span id="cb1454-7"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1454-7"></a>            )</span>
<span id="cb1454-8"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1454-8"></a><span class="kw">print</span>(p)</span></code></pre></div>
<div class="sourceCode" id="cb1455"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1455-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1455-1"></a>m.out &lt;-<span class="st"> </span><span class="kw">findMarkers</span>(uncorrected,</span>
<span id="cb1455-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1455-2"></a>                     clusters.mnn,</span>
<span id="cb1455-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1455-3"></a>                     <span class="dt">block=</span>uncorrected<span class="op">$</span>batch,</span>
<span id="cb1455-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1455-4"></a>                     <span class="dt">direction=</span><span class="st">&quot;up&quot;</span>,</span>
<span id="cb1455-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1455-5"></a>                     <span class="dt">lfc=</span><span class="dv">1</span>,</span>
<span id="cb1455-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1455-6"></a>                     <span class="dt">row.data=</span><span class="kw">rowData</span>(uncorrected)[,<span class="kw">c</span>(<span class="st">&quot;ensembl_gene_id&quot;</span>,<span class="st">&quot;Symbol&quot;</span>),<span class="dt">drop=</span><span class="ot">FALSE</span>])</span>
<span id="cb1455-7"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1455-7"></a></span>
<span id="cb1455-8"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1455-8"></a><span class="co">#lapply(m.out, function(x){head(x[,2:6])})</span></span>
<span id="cb1455-9"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1455-9"></a></span>
<span id="cb1455-10"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1455-10"></a><span class="co"># A (probably activated?) T cell subtype of some sort:</span></span>
<span id="cb1455-11"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1455-11"></a>tl1 &lt;-<span class="st"> </span><span class="kw">lapply</span>(m.out, <span class="cf">function</span>(x){x[x<span class="op">$</span>Symbol<span class="op">==</span><span class="st">&quot;CD3D&quot;</span> <span class="op">&amp;</span><span class="st"> </span>x<span class="op">$</span>Top <span class="op">&lt;=</span><span class="st"> </span><span class="dv">50</span> <span class="op">&amp;</span><span class="st"> </span>x<span class="op">$</span>FDR <span class="op">&lt;</span><span class="st"> </span><span class="fl">0.10</span>,<span class="dv">2</span><span class="op">:</span><span class="dv">6</span>]}) <span class="co"># T-cell</span></span>
<span id="cb1455-12"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1455-12"></a>tl2 &lt;-<span class="st"> </span><span class="kw">lapply</span>(m.out, <span class="cf">function</span>(x){x[x<span class="op">$</span>Symbol<span class="op">==</span><span class="st">&quot;CD69&quot;</span> <span class="op">&amp;</span><span class="st"> </span>x<span class="op">$</span>Top <span class="op">&lt;=</span><span class="st"> </span><span class="dv">50</span> <span class="op">&amp;</span><span class="st"> </span>x<span class="op">$</span>FDR <span class="op">&lt;</span><span class="st"> </span><span class="fl">0.20</span>,<span class="dv">2</span><span class="op">:</span><span class="dv">6</span>]}) <span class="co"># activation</span></span>
<span id="cb1455-13"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1455-13"></a></span>
<span id="cb1455-14"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1455-14"></a>tb1 &lt;-<span class="st"> </span><span class="kw">unlist</span>(<span class="kw">lapply</span>(tl1, nrow)) <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span></span>
<span id="cb1455-15"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1455-15"></a>tb2 &lt;-<span class="st"> </span><span class="kw">unlist</span>(<span class="kw">lapply</span>(tl2, nrow)) <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span></span>
<span id="cb1455-16"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1455-16"></a></span>
<span id="cb1455-17"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1455-17"></a>cluToGet &lt;-<span class="st"> </span><span class="kw">unique</span>(<span class="kw">c</span>(<span class="kw">which</span>(tb1), <span class="kw">which</span>(tb2)))[<span class="dv">1</span>] <span class="co"># 3 # 19 # 4</span></span>
<span id="cb1455-18"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1455-18"></a>demo &lt;-<span class="st"> </span>m.out[[cluToGet]]</span>
<span id="cb1455-19"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1455-19"></a><span class="co">#as.data.frame(demo[1:20,c(&quot;Symbol&quot;, &quot;Top&quot;, &quot;p.value&quot;, &quot;FDR&quot;, &quot;summary.logFC&quot;)]) </span></span></code></pre></div>
<p>Expression level for the top gene, on violin plots:</p>
<div class="sourceCode" id="cb1456"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1456-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1456-1"></a>geneEnsId &lt;-<span class="st"> </span><span class="kw">rownames</span>(demo)[<span class="dv">1</span>]</span>
<span id="cb1456-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1456-2"></a><span class="kw">plotExpression</span>(uncorrected,</span>
<span id="cb1456-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1456-3"></a>               <span class="dt">x=</span><span class="kw">I</span>(<span class="kw">factor</span>(clusters.mnn)),</span>
<span id="cb1456-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1456-4"></a>               <span class="dt">features=</span>geneEnsId, <span class="dt">colour_by=</span><span class="st">&quot;batch&quot;</span>) <span class="op">+</span></span>
<span id="cb1456-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1456-5"></a><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>colour_by) <span class="op">+</span></span>
<span id="cb1456-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1456-6"></a><span class="st">    </span><span class="kw">theme</span>(<span class="dt">axis.text.x=</span><span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">90</span>, <span class="dt">hjust =</span> <span class="dv">0</span>)) <span class="op">+</span></span>
<span id="cb1456-7"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1456-7"></a><span class="st">  </span><span class="kw">ggtitle</span>(<span class="kw">sprintf</span>(<span class="st">&quot;%s %s&quot;</span>,</span>
<span id="cb1456-8"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1456-8"></a>          geneEnsId,</span>
<span id="cb1456-9"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1456-9"></a>          <span class="kw">rowData</span>(uncorrected)[geneEnsId,<span class="st">&quot;Symbol&quot;</span>])</span>
<span id="cb1456-10"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1456-10"></a>          )</span></code></pre></div>
<p><img src="dataSetIntegration_PBMMC_ETV6-RUNX1_files/figure-html/unnamed-chunk-85-1.png" width="672" /></p>
<p>Expression level for the top gene, ENSG00000008517 on t-SNE plot:</p>
<p><strong>Not Encouraging consistency</strong> with marker genes</p>
<div class="sourceCode" id="cb1457"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1457-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1457-1"></a>genex &lt;-<span class="st"> </span><span class="kw">rownames</span>(demo)[<span class="dv">1</span>]</span>
<span id="cb1457-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1457-2"></a>p &lt;-<span class="st"> </span><span class="kw">plotTSNE</span>(mnn.out, <span class="dt">colour_by =</span> genex, <span class="dt">by_exprs_values=</span><span class="st">&quot;reconstructed&quot;</span>)</span>
<span id="cb1457-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1457-3"></a>p &lt;-<span class="st"> </span>p <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(</span>
<span id="cb1457-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1457-4"></a>            <span class="kw">paste</span>(<span class="st">&quot;cluster&quot;</span>, cluToGet, genex,</span>
<span id="cb1457-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1457-5"></a>            <span class="kw">rowData</span>(uncorrected)[genex,<span class="st">&quot;Symbol&quot;</span>])</span>
<span id="cb1457-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1457-6"></a>        )</span>
<span id="cb1457-7"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1457-7"></a><span class="kw">print</span>(p)</span></code></pre></div>
<p><img src="dataSetIntegration_PBMMC_ETV6-RUNX1_files/figure-html/unnamed-chunk-86-1.png" width="672" /></p>
<div class="sourceCode" id="cb1458"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1458-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1458-1"></a>p <span class="op">+</span><span class="st"> </span><span class="kw">facet_wrap</span>(<span class="op">~</span><span class="kw">colData</span>(mnn.out)<span class="op">$</span>batch)</span></code></pre></div>
<p><img src="dataSetIntegration_PBMMC_ETV6-RUNX1_files/figure-html/unnamed-chunk-87-1.png" width="672" /></p>
<p>** Encouraging consistency** with marker genes</p>
<div class="sourceCode" id="cb1459"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1459-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1459-1"></a>genex &lt;-<span class="st"> </span><span class="kw">rownames</span>(demo)[<span class="dv">1</span>]</span>
<span id="cb1459-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1459-2"></a>p &lt;-<span class="st"> </span><span class="kw">plotTSNE</span>(mnn.out2, <span class="dt">colour_by =</span> genex, <span class="dt">by_exprs_values=</span><span class="st">&quot;reconstructed&quot;</span>)</span>
<span id="cb1459-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1459-3"></a>p &lt;-<span class="st"> </span>p <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(</span>
<span id="cb1459-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1459-4"></a>            <span class="kw">paste</span>(<span class="st">&quot;cluster&quot;</span>, cluToGet, genex,</span>
<span id="cb1459-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1459-5"></a>            <span class="kw">rowData</span>(uncorrected)[genex,<span class="st">&quot;Symbol&quot;</span>])</span>
<span id="cb1459-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1459-6"></a>        )</span>
<span id="cb1459-7"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1459-7"></a><span class="kw">print</span>(p)</span></code></pre></div>
<p><img src="dataSetIntegration_PBMMC_ETV6-RUNX1_files/figure-html/unnamed-chunk-88-1.png" width="672" /></p>
<div class="sourceCode" id="cb1460"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1460-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1460-1"></a>p <span class="op">+</span><span class="st"> </span><span class="kw">facet_wrap</span>(<span class="op">~</span><span class="kw">colData</span>(mnn.out2)<span class="op">$</span>batch)</span></code></pre></div>
<p><img src="dataSetIntegration_PBMMC_ETV6-RUNX1_files/figure-html/unnamed-chunk-89-1.png" width="672" /></p>
<p>We suggest limiting the use of per-gene corrected values to visualization, e.g., when coloring points on a t-SNE plot by per-cell expression. This can be more aesthetically pleasing than uncorrected expression values that may contain large shifts on the colour scale between cells in different batches. Use of the corrected values in any quantitative procedure should be treated with caution, and should be backed up by similar results from an analysis on the uncorrected values.</p>
<div class="sourceCode" id="cb1461"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1461-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1461-1"></a><span class="co"># before we save the mnn.out object in a file,</span></span>
<span id="cb1461-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1461-2"></a><span class="co"># we should copy some of the cell meta data over,</span></span>
<span id="cb1461-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1461-3"></a><span class="co"># eg Barcode and lib size.</span></span>
<span id="cb1461-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1461-4"></a></span>
<span id="cb1461-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1461-5"></a><span class="co"># Mind sets may have been downsampled, eg with nbCells set to 1000.</span></span>
<span id="cb1461-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1461-6"></a><span class="co"># But that is not in the file name (yet?)</span></span>
<span id="cb1461-7"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1461-7"></a></span>
<span id="cb1461-8"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1461-8"></a><span class="co"># save object?</span></span>
<span id="cb1461-9"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1461-9"></a>fn &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/%s/Robjects/%s_sce_nz_postDeconv%s_dsi_%s.Rds&quot;</span>,</span>
<span id="cb1461-10"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1461-10"></a><span class="co">#fn &lt;- sprintf(&quot;%s/%s/Robjects/%s_sce_nz_postDeconv%s_dsi2_%s.Rds&quot;,</span></span>
<span id="cb1461-11"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1461-11"></a>              projDir,</span>
<span id="cb1461-12"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1461-12"></a>              outDirBit,</span>
<span id="cb1461-13"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1461-13"></a>              setName,</span>
<span id="cb1461-14"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1461-14"></a>              setSuf,</span>
<span id="cb1461-15"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1461-15"></a>              splSetToGet2) <span class="co"># &#39;dsi&#39; for data set integration</span></span>
<span id="cb1461-16"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1461-16"></a><span class="kw">saveRDS</span>(mnn.out, <span class="dt">file=</span>fn)</span>
<span id="cb1461-17"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1461-17"></a><span class="co">#saveRDS(mnn.out2, file=fn)</span></span></code></pre></div>
</div>
<div id="identify-clusters-with-pbmmc-cells" class="section level2">
<h2><span class="header-section-number">18.10</span> Identify clusters with PBMMC cells</h2>
<!-- Mind clustering now comes after data set integration
so maybe have the session in a separate file
or point to the clustering chapter -->
<p>Remember:</p>
<p>Cluster size and cell contribution by sample type, with clusters sorted by size:</p>
<div class="sourceCode" id="cb1462"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1462-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1462-1"></a>mnn.out<span class="op">$</span>source_name &lt;-<span class="st"> </span>uncorrected<span class="op">$</span>source_name <span class="co"># cell order is maintained by scran functions</span></span>
<span id="cb1462-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1462-2"></a>tmpMat &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="st">&quot;clusters&quot;</span>=clusters.mnn, <span class="st">&quot;batch&quot;</span>=mnn.out<span class="op">$</span>source_name)</span>
<span id="cb1462-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1462-3"></a>tmpMatTab &lt;-<span class="st"> </span><span class="kw">table</span>(tmpMat)</span>
<span id="cb1462-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1462-4"></a>sortVecNames &lt;-<span class="st"> </span>tmpMatTab <span class="op">%&gt;%</span><span class="st"> </span>rowSums <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">sort</span>(<span class="dt">decreasing=</span><span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span>names</span>
<span id="cb1462-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1462-5"></a>tmpMat<span class="op">$</span>clusters &lt;-<span class="st"> </span><span class="kw">factor</span>(tmpMat<span class="op">$</span>clusters, <span class="dt">levels=</span>sortVecNames)</span>
<span id="cb1462-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1462-6"></a>tmpMatTab &lt;-<span class="st"> </span><span class="kw">table</span>(tmpMat)</span>
<span id="cb1462-7"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1462-7"></a>tmpMatDf &lt;-<span class="st"> </span>tmpMatTab[sortVecNames,] <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">data.frame</span>()</span>
<span id="cb1462-8"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1462-8"></a>p1 &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data=</span>tmpMatDf, <span class="kw">aes</span>(<span class="dt">x=</span>clusters,<span class="dt">y=</span>Freq, <span class="dt">fill=</span>batch)) <span class="op">+</span></span>
<span id="cb1462-9"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1462-9"></a><span class="st">    </span><span class="kw">theme</span>(<span class="dt">axis.text.x=</span><span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">90</span>, <span class="dt">hjust =</span> <span class="dv">0</span>)) <span class="op">+</span></span>
<span id="cb1462-10"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1462-10"></a><span class="st">    </span><span class="kw">geom_col</span>()</span>
<span id="cb1462-11"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1462-11"></a>p2 &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data=</span>tmpMat, <span class="kw">aes</span>(<span class="dt">x=</span>clusters, <span class="dt">fill=</span>batch)) <span class="op">+</span></span>
<span id="cb1462-12"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1462-12"></a><span class="st">  </span><span class="kw">geom_bar</span>(<span class="dt">position =</span> <span class="st">&quot;fill&quot;</span>) <span class="op">+</span></span>
<span id="cb1462-13"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1462-13"></a><span class="st">    </span><span class="kw">theme</span>(<span class="dt">axis.text.x=</span><span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">90</span>, <span class="dt">hjust =</span> <span class="dv">0</span>)) <span class="op">+</span></span>
<span id="cb1462-14"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1462-14"></a><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> scales<span class="op">::</span>percent)</span></code></pre></div>
<div class="sourceCode" id="cb1463"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1463-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1463-1"></a>gridExtra<span class="op">::</span><span class="kw">grid.arrange</span>(p1, p2)</span></code></pre></div>
<p><img src="dataSetIntegration_PBMMC_ETV6-RUNX1_files/figure-html/unnamed-chunk-92-1.png" width="672" /></p>
<div class="sourceCode" id="cb1464"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1464-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1464-1"></a>tmpMat &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="st">&quot;clusters&quot;</span>=clusters.mnn,</span>
<span id="cb1464-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1464-2"></a>                     <span class="st">&quot;batch&quot;</span>=mnn.out<span class="op">$</span>source_name,</span>
<span id="cb1464-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1464-3"></a>                     <span class="st">&quot;Sample.Name&quot;</span>=mnn.out<span class="op">$</span>batch</span>
<span id="cb1464-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1464-4"></a>                     )</span>
<span id="cb1464-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1464-5"></a>sortVecNames &lt;-<span class="st"> </span><span class="kw">round</span>(tmpMatTab<span class="op">/</span><span class="kw">rowSums</span>(tmpMatTab),<span class="dv">2</span>) <span class="op">%&gt;%</span></span>
<span id="cb1464-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1464-6"></a><span class="st">  </span><span class="kw">as.data.frame</span>() <span class="op">%&gt;%</span></span>
<span id="cb1464-7"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1464-7"></a><span class="st">  </span><span class="kw">filter</span>(batch<span class="op">==</span><span class="st">&quot;PBMMC&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb1464-8"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1464-8"></a><span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(Freq)) <span class="op">%&gt;%</span></span>
<span id="cb1464-9"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1464-9"></a><span class="st">  </span><span class="kw">pull</span>(clusters)</span>
<span id="cb1464-10"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1464-10"></a>tmpMat<span class="op">$</span>clusters &lt;-<span class="st"> </span><span class="kw">factor</span>(tmpMat<span class="op">$</span>clusters, <span class="dt">levels=</span>sortVecNames)</span>
<span id="cb1464-11"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1464-11"></a>tmpMatTab &lt;-<span class="st"> </span><span class="kw">table</span>(<span class="st">&quot;clusters&quot;</span>=tmpMat<span class="op">$</span>clusters, <span class="st">&quot;batch&quot;</span>=tmpMat<span class="op">$</span>batch)</span>
<span id="cb1464-12"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1464-12"></a><span class="co">#tmpMatDf &lt;- tmpMatTab[sortVecNames,] %&gt;% data.frame()</span></span>
<span id="cb1464-13"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1464-13"></a>tmpMatDf &lt;-<span class="st"> </span>tmpMatTab[,] <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">data.frame</span>()</span>
<span id="cb1464-14"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1464-14"></a>p1 &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data=</span>tmpMatDf, <span class="kw">aes</span>(<span class="dt">x=</span>clusters,<span class="dt">y=</span>Freq, <span class="dt">fill=</span>batch)) <span class="op">+</span></span>
<span id="cb1464-15"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1464-15"></a><span class="st">    </span><span class="kw">theme</span>(<span class="dt">axis.text.x=</span><span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">90</span>, <span class="dt">hjust =</span> <span class="dv">0</span>)) <span class="op">+</span></span>
<span id="cb1464-16"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1464-16"></a><span class="st">    </span><span class="kw">geom_col</span>()</span>
<span id="cb1464-17"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1464-17"></a>p2 &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data=</span>tmpMat, <span class="kw">aes</span>(<span class="dt">x=</span>clusters, <span class="dt">fill=</span>batch)) <span class="op">+</span></span>
<span id="cb1464-18"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1464-18"></a><span class="st">  </span><span class="kw">geom_bar</span>(<span class="dt">position =</span> <span class="st">&quot;fill&quot;</span>) <span class="op">+</span></span>
<span id="cb1464-19"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1464-19"></a><span class="st">    </span><span class="kw">theme</span>(<span class="dt">axis.text.x=</span><span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">90</span>, <span class="dt">hjust =</span> <span class="dv">0</span>)) <span class="op">+</span></span>
<span id="cb1464-20"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1464-20"></a><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> scales<span class="op">::</span>percent)</span>
<span id="cb1464-21"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1464-21"></a><span class="co">#gridExtra::grid.arrange(p1, p2)</span></span>
<span id="cb1464-22"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1464-22"></a></span>
<span id="cb1464-23"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1464-23"></a>p3 &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data=</span>tmpMat, <span class="kw">aes</span>(<span class="dt">x=</span>clusters, <span class="dt">fill=</span>Sample.Name)) <span class="op">+</span></span>
<span id="cb1464-24"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1464-24"></a><span class="st">  </span><span class="kw">geom_bar</span>(<span class="dt">position =</span> <span class="st">&quot;fill&quot;</span>) <span class="op">+</span></span>
<span id="cb1464-25"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1464-25"></a><span class="st">    </span><span class="kw">theme</span>(<span class="dt">axis.text.x=</span><span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">90</span>, <span class="dt">hjust =</span> <span class="dv">0</span>)) <span class="op">+</span></span>
<span id="cb1464-26"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1464-26"></a><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> scales<span class="op">::</span>percent)</span>
<span id="cb1464-27"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1464-27"></a>gridExtra<span class="op">::</span><span class="kw">grid.arrange</span>(p1, p2, p3)</span></code></pre></div>
<p><img src="dataSetIntegration_PBMMC_ETV6-RUNX1_files/figure-html/unnamed-chunk-93-1.png" width="672" /></p>
<div class="sourceCode" id="cb1465"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1465-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1465-1"></a>p1 &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data=</span>tmpMatDf, <span class="kw">aes</span>(<span class="dt">x=</span>clusters,<span class="dt">y=</span>Freq, <span class="dt">fill=</span>batch)) <span class="op">+</span></span>
<span id="cb1465-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1465-2"></a><span class="st">    </span><span class="kw">theme</span>(<span class="dt">axis.text.x=</span><span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">90</span>, <span class="dt">hjust =</span> <span class="dv">0</span>)) <span class="op">+</span></span>
<span id="cb1465-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1465-3"></a><span class="st">    </span><span class="kw">geom_col</span>()</span>
<span id="cb1465-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1465-4"></a>p2 &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data=</span>tmpMat, <span class="kw">aes</span>(<span class="dt">x=</span>clusters, <span class="dt">fill=</span>Sample.Name)) <span class="op">+</span></span>
<span id="cb1465-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1465-5"></a><span class="st">  </span><span class="kw">geom_bar</span>(<span class="dt">position =</span> <span class="st">&quot;fill&quot;</span>) <span class="op">+</span></span>
<span id="cb1465-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1465-6"></a><span class="st">    </span><span class="kw">theme</span>(<span class="dt">axis.text.x=</span><span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">90</span>, <span class="dt">hjust =</span> <span class="dv">0</span>)) <span class="op">+</span></span>
<span id="cb1465-7"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1465-7"></a><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> scales<span class="op">::</span>percent)</span>
<span id="cb1465-8"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1465-8"></a>gridExtra<span class="op">::</span><span class="kw">grid.arrange</span>(p1, p2)</span></code></pre></div>
<p><img src="dataSetIntegration_PBMMC_ETV6-RUNX1_files/figure-html/unnamed-chunk-94-1.png" width="672" /></p>
<p>Split by sample type:</p>
<div class="sourceCode" id="cb1466"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1466-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1466-1"></a>tab.mnn &lt;-<span class="st"> </span><span class="kw">table</span>(<span class="dt">Cluster=</span>clusters.mnn,</span>
<span id="cb1466-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1466-2"></a>                 <span class="dt">Batch=</span><span class="kw">as.character</span>(mnn.out<span class="op">$</span>batch))</span>
<span id="cb1466-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1466-3"></a>                 <span class="co">#Batch=as.character(mnn.out$source_name))</span></span>
<span id="cb1466-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1466-4"></a><span class="co">#tab.mnn &lt;- as.data.frame(tab.mnn, stringsAsFactors=FALSE)</span></span>
<span id="cb1466-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1466-5"></a>tab.mnn</span></code></pre></div>
<pre><code>##        Batch
## Cluster GSM3872434 GSM3872435 GSM3872436 GSM3872437 GSM3872442 GSM3872443
##      1           2          0          6          6          4         21
##      2          40         38         14         47         63          9
##      3          87          1          3          3         62         16
##      4          31        273        154         82         64         16
##      5           0          1          7         16          1         30
##      6           0          0          0          0         30         17
##      7           1         15        157         21        183        128
##      8           0          0          3         19          0         22
##      9          88         34         22         73         32          2
##      10          2         10         50         12         13         51
##      11          0          0         12         48          0         66
##      12          1          0          5          7          3         35
##      13          0          0         11         30          0         37
##      14        233        112         36        125          6          2
##      15          2          1         13          4         20         23
##      16          0          2          2          2          4          4
##      17         13         13          5          4          5          5
##      18          0          0          0          1         10         16
##        Batch
## Cluster GSM3872444
##      1           6
##      2          36
##      3          18
##      4          88
##      5           6
##      6          23
##      7         131
##      8           5
##      9          20
##      10         54
##      11          3
##      12         59
##      13          3
##      14          6
##      15         30
##      16          3
##      17          0
##      18          9</code></pre>
<div class="sourceCode" id="cb1468"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1468-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1468-1"></a><span class="co"># Using a large pseudo.count to avoid unnecessarily</span></span>
<span id="cb1468-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1468-2"></a><span class="co"># large variances when the counts are low.</span></span>
<span id="cb1468-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1468-3"></a>norm &lt;-<span class="st"> </span><span class="kw">normalizeCounts</span>(tab.mnn, <span class="dt">pseudo_count=</span><span class="dv">10</span>)</span>
<span id="cb1468-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1468-4"></a></span>
<span id="cb1468-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1468-5"></a>normNoLog &lt;-<span class="st"> </span><span class="kw">normalizeCounts</span>(tab.mnn, <span class="dt">pseudo_count=</span><span class="dv">10</span>, <span class="dt">log=</span><span class="ot">FALSE</span>)</span>
<span id="cb1468-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1468-6"></a></span>
<span id="cb1468-7"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1468-7"></a>sortVecNames &lt;-<span class="st"> </span><span class="kw">rowSums</span>(normNoLog) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">round</span>(<span class="dv">2</span>) <span class="op">%&gt;%</span></span>
<span id="cb1468-8"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1468-8"></a><span class="st">  </span><span class="kw">sort</span>(<span class="dt">decreasing=</span><span class="ot">TRUE</span>) <span class="op">%&gt;%</span></span>
<span id="cb1468-9"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1468-9"></a><span class="st">  </span>names</span>
<span id="cb1468-10"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1468-10"></a></span>
<span id="cb1468-11"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1468-11"></a></span>
<span id="cb1468-12"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1468-12"></a><span class="co">#norm2 &lt;- normNoLog %&gt;% data.frame() %&gt;%</span></span>
<span id="cb1468-13"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1468-13"></a>  <span class="co">#tibble::rownames_to_column(&quot;clusters&quot;) %&gt;%</span></span>
<span id="cb1468-14"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1468-14"></a>  <span class="co">#tidyr::pivot_longer(!clusters, names_to=&quot;Sample.Name&quot;, values_to=&quot;Freq&quot;)</span></span>
<span id="cb1468-15"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1468-15"></a>  </span>
<span id="cb1468-16"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1468-16"></a>norm2 &lt;-<span class="st"> </span>normNoLog <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span></span>
<span id="cb1468-17"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1468-17"></a><span class="st">  </span><span class="kw">rename</span>(<span class="dt">clusters =</span> Cluster) <span class="op">%&gt;%</span></span>
<span id="cb1468-18"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1468-18"></a><span class="st">  </span><span class="kw">rename</span>(<span class="dt">Sample.Name =</span> Batch) </span>
<span id="cb1468-19"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1468-19"></a>  </span>
<span id="cb1468-20"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1468-20"></a>norm2 &lt;-<span class="st"> </span>norm2 <span class="op">%&gt;%</span></span>
<span id="cb1468-21"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1468-21"></a><span class="st">  </span><span class="kw">left_join</span>(<span class="kw">unique</span>(cb_sampleSheet[,<span class="kw">c</span>(<span class="st">&quot;Sample.Name&quot;</span>, <span class="st">&quot;source_name&quot;</span>)]),</span>
<span id="cb1468-22"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1468-22"></a>            <span class="dt">by=</span><span class="st">&quot;Sample.Name&quot;</span>)</span>
<span id="cb1468-23"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1468-23"></a></span>
<span id="cb1468-24"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1468-24"></a>norm2<span class="op">$</span>clusters &lt;-<span class="st"> </span><span class="kw">factor</span>(norm2<span class="op">$</span>clusters, <span class="dt">levels=</span>sortVecNames)</span>
<span id="cb1468-25"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1468-25"></a><span class="co">#norm2 &lt;- norm2 %&gt;% as.data.frame()</span></span>
<span id="cb1468-26"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1468-26"></a></span>
<span id="cb1468-27"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1468-27"></a>p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data=</span>norm2, <span class="kw">aes</span>(<span class="dt">x=</span>clusters,<span class="dt">y=</span>Freq, <span class="dt">fill=</span>source_name)) <span class="op">+</span></span>
<span id="cb1468-28"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1468-28"></a><span class="st">    </span><span class="kw">theme</span>(<span class="dt">axis.text.x=</span><span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">90</span>, <span class="dt">hjust =</span> <span class="dv">0</span>)) <span class="op">+</span></span>
<span id="cb1468-29"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1468-29"></a><span class="st">    </span><span class="kw">geom_col</span>()</span>
<span id="cb1468-30"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1468-30"></a>p</span></code></pre></div>
<p><img src="dataSetIntegration_PBMMC_ETV6-RUNX1_files/figure-html/unnamed-chunk-95-1.png" width="672" /></p>
<div class="sourceCode" id="cb1469"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1469-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1469-1"></a>p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data=</span>norm2, <span class="kw">aes</span>(<span class="dt">x=</span>clusters,<span class="dt">y=</span>Freq, <span class="dt">fill=</span>Sample.Name)) <span class="op">+</span></span>
<span id="cb1469-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1469-2"></a><span class="st">    </span><span class="kw">theme</span>(<span class="dt">axis.text.x=</span><span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">90</span>, <span class="dt">hjust =</span> <span class="dv">0</span>)) <span class="op">+</span></span>
<span id="cb1469-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1469-3"></a><span class="st">    </span><span class="kw">geom_col</span>()</span>
<span id="cb1469-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1469-4"></a>p</span></code></pre></div>
<p><img src="dataSetIntegration_PBMMC_ETV6-RUNX1_files/figure-html/unnamed-chunk-95-2.png" width="672" /></p>
<div class="sourceCode" id="cb1470"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1470-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1470-1"></a>p <span class="op">+</span><span class="st"> </span><span class="kw">facet_wrap</span>(<span class="op">~</span>source_name)</span></code></pre></div>
<p><img src="dataSetIntegration_PBMMC_ETV6-RUNX1_files/figure-html/unnamed-chunk-95-3.png" width="672" /></p>
<p>Summarise by sample type:</p>
<div class="sourceCode" id="cb1471"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1471-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1471-1"></a>tab.mnn &lt;-<span class="st"> </span><span class="kw">table</span>(<span class="dt">Cluster=</span>clusters.mnn, <span class="dt">Batch=</span><span class="kw">as.character</span>(mnn.out<span class="op">$</span>source_name))</span>
<span id="cb1471-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1471-2"></a>tab.mnn</span></code></pre></div>
<pre><code>##        Batch
## Cluster ETV6-RUNX1 PBMMC
##      1          14    31
##      2         139   108
##      3          94    96
##      4         540   168
##      5          24    37
##      6           0    70
##      7         194   442
##      8          22    27
##      9         217    54
##      10         74   118
##      11         60    69
##      12         13    97
##      13         41    40
##      14        506    14
##      15         20    73
##      16          6    11
##      17         35    10
##      18          1    35</code></pre>
<div class="sourceCode" id="cb1473"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1473-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1473-1"></a><span class="co"># Using a large pseudo.count to avoid unnecessarily</span></span>
<span id="cb1473-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1473-2"></a><span class="co"># large variances when the counts are low.</span></span>
<span id="cb1473-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1473-3"></a><span class="co">#norm &lt;- normalizeCounts(tab.mnn, pseudo_count=10)</span></span>
<span id="cb1473-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1473-4"></a></span>
<span id="cb1473-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1473-5"></a>normNoLog &lt;-<span class="st"> </span><span class="kw">normalizeCounts</span>(tab.mnn, <span class="dt">pseudo_count=</span><span class="dv">10</span>, <span class="dt">log=</span><span class="ot">FALSE</span>)</span>
<span id="cb1473-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1473-6"></a>normNoLog &lt;-<span class="st"> </span>normNoLog <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as.data.frame.matrix</span>()</span>
<span id="cb1473-7"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1473-7"></a></span>
<span id="cb1473-8"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1473-8"></a></span>
<span id="cb1473-9"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1473-9"></a><span class="co"># sort by size:</span></span>
<span id="cb1473-10"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1473-10"></a>sortVecNames &lt;-<span class="st"> </span><span class="kw">rowSums</span>(normNoLog) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">round</span>(<span class="dv">2</span>) <span class="op">%&gt;%</span></span>
<span id="cb1473-11"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1473-11"></a><span class="st">  </span><span class="kw">sort</span>(<span class="dt">decreasing=</span><span class="ot">TRUE</span>) <span class="op">%&gt;%</span></span>
<span id="cb1473-12"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1473-12"></a><span class="st">  </span><span class="kw">names</span>()</span>
<span id="cb1473-13"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1473-13"></a></span>
<span id="cb1473-14"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1473-14"></a><span class="co"># sort by PBMMC proportion:</span></span>
<span id="cb1473-15"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1473-15"></a>normNoLog &lt;-<span class="st"> </span>normNoLog <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">sum=</span><span class="kw">rowSums</span>(.))</span>
<span id="cb1473-16"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1473-16"></a>normNoLog &lt;-<span class="st"> </span>normNoLog <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">prop=</span>PBMMC<span class="op">/</span>sum)</span>
<span id="cb1473-17"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1473-17"></a>sortVecNames &lt;-<span class="st"> </span>normNoLog <span class="op">%&gt;%</span></span>
<span id="cb1473-18"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1473-18"></a><span class="st">  </span>tibble<span class="op">::</span><span class="kw">rownames_to_column</span>(<span class="st">&quot;clusters&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1473-19"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1473-19"></a><span class="st">  </span><span class="kw">arrange</span>(prop) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pull</span>(clusters)</span>
<span id="cb1473-20"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1473-20"></a></span>
<span id="cb1473-21"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1473-21"></a>norm2 &lt;-<span class="st"> </span>normNoLog <span class="op">%&gt;%</span></span>
<span id="cb1473-22"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1473-22"></a><span class="st">  </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span></span>
<span id="cb1473-23"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1473-23"></a><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>sum, <span class="op">-</span>prop) <span class="op">%&gt;%</span></span>
<span id="cb1473-24"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1473-24"></a><span class="st">  </span>tibble<span class="op">::</span><span class="kw">rownames_to_column</span>(<span class="st">&quot;clusters&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1473-25"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1473-25"></a><span class="st">  </span>tidyr<span class="op">::</span><span class="kw">pivot_longer</span>(<span class="op">!</span>clusters, <span class="dt">names_to=</span><span class="st">&quot;source_name&quot;</span>, <span class="dt">values_to=</span><span class="st">&quot;Freq&quot;</span>)</span>
<span id="cb1473-26"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1473-26"></a></span>
<span id="cb1473-27"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1473-27"></a>norm2<span class="op">$</span>clusters &lt;-<span class="st"> </span><span class="kw">factor</span>(norm2<span class="op">$</span>clusters, <span class="dt">levels=</span>sortVecNames)</span>
<span id="cb1473-28"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1473-28"></a></span>
<span id="cb1473-29"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1473-29"></a>p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data=</span>norm2, <span class="kw">aes</span>(<span class="dt">x=</span>clusters,<span class="dt">y=</span>Freq, <span class="dt">fill=</span>source_name)) <span class="op">+</span></span>
<span id="cb1473-30"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1473-30"></a><span class="st">    </span><span class="kw">theme</span>(<span class="dt">axis.text.x=</span><span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">90</span>, <span class="dt">hjust =</span> <span class="dv">0</span>)) <span class="op">+</span></span>
<span id="cb1473-31"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1473-31"></a><span class="st">    </span><span class="kw">geom_col</span>()</span>
<span id="cb1473-32"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1473-32"></a>p</span></code></pre></div>
<p><img src="dataSetIntegration_PBMMC_ETV6-RUNX1_files/figure-html/unnamed-chunk-96-1.png" width="672" /></p>
<div class="sourceCode" id="cb1474"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1474-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1474-1"></a>p <span class="op">+</span><span class="st"> </span><span class="kw">facet_wrap</span>(<span class="op">~</span>source_name)</span></code></pre></div>
<p><img src="dataSetIntegration_PBMMC_ETV6-RUNX1_files/figure-html/unnamed-chunk-96-2.png" width="672" /></p>
<p>Have threshold for proportion of PBMMC cells, say 50% and filter cluster with prop higher.</p>
<div class="sourceCode" id="cb1475"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1475-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1475-1"></a>normNoLog<span class="op">$</span>propLt090 &lt;-<span class="st"> </span>normNoLog<span class="op">$</span>prop <span class="op">&lt;</span><span class="st"> </span><span class="fl">0.9</span></span>
<span id="cb1475-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1475-2"></a>normNoLog<span class="op">$</span>propLt080 &lt;-<span class="st"> </span>normNoLog<span class="op">$</span>prop <span class="op">&lt;</span><span class="st"> </span><span class="fl">0.8</span></span>
<span id="cb1475-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1475-3"></a>normNoLog<span class="op">$</span>propLt050 &lt;-<span class="st"> </span>normNoLog<span class="op">$</span>prop <span class="op">&lt;</span><span class="st"> </span><span class="fl">0.5</span></span>
<span id="cb1475-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1475-4"></a></span>
<span id="cb1475-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1475-5"></a></span>
<span id="cb1475-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1475-6"></a>norm2 &lt;-<span class="st"> </span>normNoLog <span class="op">%&gt;%</span></span>
<span id="cb1475-7"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1475-7"></a><span class="st">  </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span></span>
<span id="cb1475-8"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1475-8"></a><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>sum, <span class="op">-</span>prop) <span class="op">%&gt;%</span></span>
<span id="cb1475-9"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1475-9"></a><span class="st">  </span>tibble<span class="op">::</span><span class="kw">rownames_to_column</span>(<span class="st">&quot;clusters&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1475-10"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1475-10"></a><span class="st">  </span><span class="co">#tidyr::pivot_longer(!c(clusters,propLt090), names_to=&quot;source_name&quot;, values_to=&quot;Freq&quot;)</span></span>
<span id="cb1475-11"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1475-11"></a><span class="st">  </span><span class="co">#tidyr::pivot_longer(!c(clusters,propLt090,propLt080), names_to=&quot;source_name&quot;, values_to=&quot;Freq&quot;)</span></span>
<span id="cb1475-12"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1475-12"></a><span class="st">  </span><span class="co">#tidyr::pivot_longer(!c(clusters,propLt090,propLt080,propLt050), names_to=&quot;source_name&quot;, values_to=&quot;Freq&quot;)</span></span>
<span id="cb1475-13"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1475-13"></a><span class="st">  </span>tidyr<span class="op">::</span><span class="kw">pivot_longer</span>(<span class="op">!</span><span class="kw">c</span>(clusters,</span>
<span id="cb1475-14"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1475-14"></a>                         <span class="kw">grep</span>(<span class="st">&quot;propLt&quot;</span>, <span class="kw">colnames</span>(normNoLog), <span class="dt">value=</span><span class="ot">TRUE</span>)</span>
<span id="cb1475-15"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1475-15"></a>                         ),</span>
<span id="cb1475-16"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1475-16"></a>                      <span class="dt">names_to=</span><span class="st">&quot;source_name&quot;</span>,</span>
<span id="cb1475-17"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1475-17"></a>                      <span class="dt">values_to=</span><span class="st">&quot;Freq&quot;</span>)</span>
<span id="cb1475-18"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1475-18"></a></span>
<span id="cb1475-19"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1475-19"></a>norm2<span class="op">$</span>clusters &lt;-<span class="st"> </span><span class="kw">factor</span>(norm2<span class="op">$</span>clusters, <span class="dt">levels=</span>sortVecNames)</span>
<span id="cb1475-20"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1475-20"></a></span>
<span id="cb1475-21"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1475-21"></a>p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data=</span>norm2, <span class="kw">aes</span>(<span class="dt">x=</span>clusters,<span class="dt">y=</span>Freq, <span class="dt">fill=</span>source_name)) <span class="op">+</span></span>
<span id="cb1475-22"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1475-22"></a><span class="st">    </span><span class="kw">theme</span>(<span class="dt">axis.text.x=</span><span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">90</span>, <span class="dt">hjust =</span> <span class="dv">0</span>)) <span class="op">+</span></span>
<span id="cb1475-23"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1475-23"></a><span class="st">    </span><span class="kw">geom_col</span>()</span>
<span id="cb1475-24"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1475-24"></a>p</span></code></pre></div>
<p><img src="dataSetIntegration_PBMMC_ETV6-RUNX1_files/figure-html/unnamed-chunk-97-1.png" width="672" /></p>
<div class="sourceCode" id="cb1476"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1476-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1476-1"></a><span class="co">#p + facet_wrap(~propLt090)</span></span>
<span id="cb1476-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1476-2"></a><span class="co">#p + facet_wrap(~propLt080)</span></span>
<span id="cb1476-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1476-3"></a>p <span class="op">+</span><span class="st"> </span><span class="kw">facet_wrap</span>(<span class="op">~</span>propLt050)</span></code></pre></div>
<p><img src="dataSetIntegration_PBMMC_ETV6-RUNX1_files/figure-html/unnamed-chunk-97-2.png" width="672" /></p>
<p>(OK, but clusters with large number of cells of the non-PBMMC type are also excluded.)</p>
<p>Same as above but with propLt080:</p>
<div class="sourceCode" id="cb1477"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1477-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1477-1"></a>propLtDf &lt;-<span class="st"> </span>norm2 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(clusters,propLt080) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">unique</span>()</span>
<span id="cb1477-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1477-2"></a>propLtDf<span class="op">$</span>cluster &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;c&quot;</span>, propLtDf<span class="op">$</span>clusters)</span>
<span id="cb1477-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1477-3"></a>  </span>
<span id="cb1477-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1477-4"></a><span class="kw">colData</span>(mnn.out) &lt;-<span class="st"> </span><span class="kw">colData</span>(mnn.out) <span class="op">%&gt;%</span></span>
<span id="cb1477-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1477-5"></a><span class="st">  </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span></span>
<span id="cb1477-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1477-6"></a><span class="st">  </span><span class="kw">left_join</span>(propLtDf, <span class="dt">by=</span><span class="st">&quot;cluster&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb1477-7"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1477-7"></a><span class="st">  </span><span class="kw">DataFrame</span>()</span>
<span id="cb1477-8"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1477-8"></a>   </span>
<span id="cb1477-9"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1477-9"></a>genex &lt;-<span class="st"> </span><span class="kw">rownames</span>(demo)[<span class="dv">1</span>]</span>
<span id="cb1477-10"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1477-10"></a>p &lt;-<span class="st"> </span><span class="kw">plotTSNE</span>(mnn.out, <span class="dt">colour_by =</span> genex, <span class="dt">by_exprs_values=</span><span class="st">&quot;reconstructed&quot;</span>)</span>
<span id="cb1477-11"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1477-11"></a>p &lt;-<span class="st"> </span>p <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(</span>
<span id="cb1477-12"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1477-12"></a>            <span class="kw">paste</span>(<span class="st">&quot;cluster&quot;</span>, cluToGet, genex,</span>
<span id="cb1477-13"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1477-13"></a>            <span class="kw">rowData</span>(uncorrected)[genex,<span class="st">&quot;Symbol&quot;</span>])</span>
<span id="cb1477-14"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1477-14"></a>        )</span>
<span id="cb1477-15"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1477-15"></a><span class="kw">print</span>(p)</span></code></pre></div>
<p><img src="dataSetIntegration_PBMMC_ETV6-RUNX1_files/figure-html/unnamed-chunk-98-1.png" width="672" /></p>
<div class="sourceCode" id="cb1478"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1478-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1478-1"></a>p <span class="op">+</span><span class="st"> </span><span class="kw">facet_wrap</span>(<span class="op">~</span>mnn.out<span class="op">$</span>propLt080)</span></code></pre></div>
<p><img src="dataSetIntegration_PBMMC_ETV6-RUNX1_files/figure-html/unnamed-chunk-98-2.png" width="672" /></p>
<p>Same as above but with propLt050</p>
<div class="sourceCode" id="cb1479"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1479-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1479-1"></a>propLtDf &lt;-<span class="st"> </span>norm2 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(clusters,propLt050) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">unique</span>()</span>
<span id="cb1479-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1479-2"></a>propLtDf<span class="op">$</span>cluster &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;c&quot;</span>, propLtDf<span class="op">$</span>clusters)</span>
<span id="cb1479-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1479-3"></a>  </span>
<span id="cb1479-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1479-4"></a><span class="kw">colData</span>(mnn.out) &lt;-<span class="st"> </span><span class="kw">colData</span>(mnn.out) <span class="op">%&gt;%</span></span>
<span id="cb1479-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1479-5"></a><span class="st">  </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span></span>
<span id="cb1479-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1479-6"></a><span class="st">  </span><span class="kw">left_join</span>(propLtDf[,<span class="kw">c</span>(<span class="st">&quot;cluster&quot;</span>,<span class="st">&quot;propLt050&quot;</span>)], <span class="dt">by=</span><span class="st">&quot;cluster&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb1479-7"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1479-7"></a><span class="st">  </span><span class="kw">DataFrame</span>()</span>
<span id="cb1479-8"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1479-8"></a>   </span>
<span id="cb1479-9"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1479-9"></a>genex &lt;-<span class="st"> </span><span class="kw">rownames</span>(demo)[<span class="dv">1</span>]</span>
<span id="cb1479-10"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1479-10"></a>p &lt;-<span class="st"> </span><span class="kw">plotTSNE</span>(mnn.out, <span class="dt">colour_by =</span> genex, <span class="dt">by_exprs_values=</span><span class="st">&quot;reconstructed&quot;</span>)</span>
<span id="cb1479-11"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1479-11"></a>p &lt;-<span class="st"> </span>p <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(</span>
<span id="cb1479-12"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1479-12"></a>            <span class="kw">paste</span>(<span class="st">&quot;cluster&quot;</span>, cluToGet, genex,</span>
<span id="cb1479-13"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1479-13"></a>            <span class="kw">rowData</span>(uncorrected)[genex,<span class="st">&quot;Symbol&quot;</span>])</span>
<span id="cb1479-14"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1479-14"></a>        )</span>
<span id="cb1479-15"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1479-15"></a><span class="kw">print</span>(p)</span></code></pre></div>
<p><img src="dataSetIntegration_PBMMC_ETV6-RUNX1_files/figure-html/unnamed-chunk-99-1.png" width="672" /></p>
<div class="sourceCode" id="cb1480"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1480-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1480-1"></a>p <span class="op">+</span><span class="st"> </span><span class="kw">facet_wrap</span>(<span class="op">~</span>mnn.out<span class="op">$</span>propLt050)</span></code></pre></div>
<p><img src="dataSetIntegration_PBMMC_ETV6-RUNX1_files/figure-html/unnamed-chunk-99-2.png" width="672" /></p>
<div class="sourceCode" id="cb1481"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1481-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1481-1"></a><span class="cf">for</span> (genex <span class="cf">in</span> ensToShow)</span>
<span id="cb1481-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1481-2"></a>{</span>
<span id="cb1481-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1481-3"></a>    p &lt;-<span class="st"> </span><span class="kw">plotTSNE</span>(mnn.out, <span class="dt">colour_by =</span> genex, <span class="dt">by_exprs_values=</span><span class="st">&quot;reconstructed&quot;</span>)</span>
<span id="cb1481-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1481-4"></a>    p &lt;-<span class="st"> </span>p <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(</span>
<span id="cb1481-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1481-5"></a>            <span class="kw">paste</span>(<span class="st">&quot;cluster&quot;</span>, cluToGet, genex,</span>
<span id="cb1481-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1481-6"></a>            <span class="kw">rowData</span>(uncorrected)[genex,<span class="st">&quot;Symbol&quot;</span>])</span>
<span id="cb1481-7"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1481-7"></a>        )</span>
<span id="cb1481-8"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1481-8"></a><span class="kw">print</span>(p <span class="op">+</span><span class="st"> </span><span class="kw">facet_wrap</span>(<span class="op">~</span>mnn.out<span class="op">$</span>propLt050))</span>
<span id="cb1481-9"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1481-9"></a>}</span></code></pre></div>
<p><img src="dataSetIntegration_PBMMC_ETV6-RUNX1_files/figure-html/unnamed-chunk-100-1.png" width="672" /><img src="dataSetIntegration_PBMMC_ETV6-RUNX1_files/figure-html/unnamed-chunk-100-2.png" width="672" /><img src="dataSetIntegration_PBMMC_ETV6-RUNX1_files/figure-html/unnamed-chunk-100-3.png" width="672" /><img src="dataSetIntegration_PBMMC_ETV6-RUNX1_files/figure-html/unnamed-chunk-100-4.png" width="672" /></p>
<!-- large cluster with moderate PBMMC proportion -->
<p>Check for clusters with large number of cancer cells and high proportion of PBMMC cells.</p>
<div class="sourceCode" id="cb1482"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1482-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1482-1"></a><span class="co"># DEV, hardcoded cluster 2</span></span>
<span id="cb1482-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1482-2"></a>normNoLog &lt;-<span class="st"> </span>normNoLog <span class="op">%&gt;%</span><span class="st"> </span>tibble<span class="op">::</span><span class="kw">rownames_to_column</span>(<span class="st">&quot;cluster&quot;</span>)</span>
<span id="cb1482-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1482-3"></a>normNoLog<span class="op">$</span>cluster &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;c&quot;</span>, normNoLog<span class="op">$</span>cluster)</span>
<span id="cb1482-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1482-4"></a>normNoLog <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(sum <span class="op">&gt;</span><span class="st"> </span><span class="dv">1000</span> <span class="op">&amp;</span><span class="st"> </span>prop <span class="op">&gt;</span><span class="st"> </span><span class="fl">0.5</span>) <span class="co"># ok with 3000 cells per sample</span></span>
<span id="cb1482-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1482-5"></a></span>
<span id="cb1482-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1482-6"></a>normNoLog<span class="op">$</span>tmpCluBool &lt;-<span class="st"> </span><span class="kw">ifelse</span>(normNoLog<span class="op">$</span>cluster<span class="op">==</span><span class="st">&quot;c2&quot;</span>, <span class="ot">TRUE</span>, <span class="ot">FALSE</span>)</span>
<span id="cb1482-7"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1482-7"></a></span>
<span id="cb1482-8"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1482-8"></a><span class="kw">colData</span>(mnn.out) &lt;-<span class="st"> </span><span class="kw">colData</span>(mnn.out) <span class="op">%&gt;%</span></span>
<span id="cb1482-9"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1482-9"></a><span class="st">  </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span></span>
<span id="cb1482-10"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1482-10"></a><span class="st">  </span><span class="kw">left_join</span>(normNoLog[<span class="kw">c</span>(<span class="st">&quot;cluster&quot;</span>, <span class="st">&quot;tmpCluBool&quot;</span>)], <span class="dt">by=</span><span class="st">&quot;cluster&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb1482-11"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1482-11"></a><span class="st">  </span><span class="kw">DataFrame</span>()</span>
<span id="cb1482-12"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1482-12"></a></span>
<span id="cb1482-13"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1482-13"></a>demo &lt;-<span class="st"> </span>m.out[[<span class="st">&quot;2&quot;</span>]]</span>
<span id="cb1482-14"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1482-14"></a></span>
<span id="cb1482-15"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1482-15"></a>genex &lt;-<span class="st"> </span><span class="kw">rownames</span>(demo)[<span class="dv">1</span>]</span>
<span id="cb1482-16"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1482-16"></a>p &lt;-<span class="st"> </span><span class="kw">plotTSNE</span>(mnn.out, <span class="dt">colour_by =</span> genex, <span class="dt">by_exprs_values=</span><span class="st">&quot;reconstructed&quot;</span>)</span>
<span id="cb1482-17"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1482-17"></a>p &lt;-<span class="st"> </span>p <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(</span>
<span id="cb1482-18"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1482-18"></a>            <span class="kw">paste</span>(<span class="st">&quot;cluster&quot;</span>, cluToGet, genex,</span>
<span id="cb1482-19"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1482-19"></a>            <span class="kw">rowData</span>(uncorrected)[genex,<span class="st">&quot;Symbol&quot;</span>])</span>
<span id="cb1482-20"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1482-20"></a>        )</span>
<span id="cb1482-21"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1482-21"></a><span class="kw">print</span>(p)</span>
<span id="cb1482-22"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1482-22"></a></span>
<span id="cb1482-23"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1482-23"></a>p <span class="op">+</span><span class="st"> </span><span class="kw">facet_wrap</span>(<span class="op">~</span>mnn.out<span class="op">$</span>tmpCluBool)</span></code></pre></div>
<div class="sourceCode" id="cb1483"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1483-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1483-1"></a><span class="co"># DEV, hardcoded cluster 2</span></span>
<span id="cb1483-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1483-2"></a>genex &lt;-<span class="st"> </span><span class="kw">rownames</span>(demo)[<span class="dv">5</span>]</span>
<span id="cb1483-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1483-3"></a>p &lt;-<span class="st"> </span><span class="kw">plotTSNE</span>(mnn.out, <span class="dt">colour_by =</span> genex, <span class="dt">by_exprs_values=</span><span class="st">&quot;reconstructed&quot;</span>)</span>
<span id="cb1483-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1483-4"></a>p &lt;-<span class="st"> </span>p <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(</span>
<span id="cb1483-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1483-5"></a>            <span class="kw">paste</span>(<span class="st">&quot;cluster&quot;</span>, cluToGet, genex,</span>
<span id="cb1483-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1483-6"></a>            <span class="kw">rowData</span>(uncorrected)[genex,<span class="st">&quot;Symbol&quot;</span>])</span>
<span id="cb1483-7"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1483-7"></a>        )</span>
<span id="cb1483-8"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1483-8"></a><span class="kw">print</span>(p)</span>
<span id="cb1483-9"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1483-9"></a></span>
<span id="cb1483-10"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1483-10"></a>p <span class="op">+</span><span class="st"> </span><span class="kw">facet_wrap</span>(mnn.out<span class="op">$</span>source_name<span class="op">~</span>mnn.out<span class="op">$</span>tmpCluBool)</span></code></pre></div>
<p>Select cluster to keep.</p>
<p>Inclusion criteria:
- proportion of PBMMC cells in cluster is lower than the threshold for the proportion of PBMMC cell in a cluster, eg 50%
- proportion of cancer cells in cluster lower than 10% of cells of that sample type</p>
<div class="sourceCode" id="cb1484"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1484-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1484-1"></a>normNoLog &lt;-<span class="st"> </span>normNoLog <span class="op">%&gt;%</span><span class="st"> </span>tibble<span class="op">::</span><span class="kw">rownames_to_column</span>(<span class="st">&quot;cluster&quot;</span>)</span>
<span id="cb1484-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1484-2"></a>normNoLog<span class="op">$</span>cluster &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;c&quot;</span>, normNoLog<span class="op">$</span>cluster)</span>
<span id="cb1484-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1484-3"></a></span>
<span id="cb1484-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1484-4"></a>otherSplType &lt;-<span class="st"> </span><span class="kw">setdiff</span>(splSetVec, <span class="st">&quot;PBMMC&quot;</span>) <span class="co"># ok for pairs of sample types</span></span>
<span id="cb1484-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1484-5"></a>thdSize &lt;-<span class="st"> </span><span class="kw">sum</span>(normNoLog[,otherSplType])<span class="op">*</span><span class="fl">0.02</span></span>
<span id="cb1484-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1484-6"></a>thdPropPbmmc &lt;-<span class="st"> </span><span class="fl">0.5</span></span>
<span id="cb1484-7"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1484-7"></a></span>
<span id="cb1484-8"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1484-8"></a><span class="co">#propLtDf &lt;- norm2 %&gt;% select(clusters,propLt050) %&gt;% unique()</span></span>
<span id="cb1484-9"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1484-9"></a><span class="co">#propLtDf$cluster &lt;- paste0(&quot;c&quot;, propLtDf$clusters)</span></span>
<span id="cb1484-10"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1484-10"></a></span>
<span id="cb1484-11"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1484-11"></a>propLtDf &lt;-<span class="st"> </span>normNoLog <span class="op">%&gt;%</span></span>
<span id="cb1484-12"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1484-12"></a><span class="st">  </span><span class="kw">filter</span>(prop <span class="op">&lt;</span><span class="st"> </span>thdPropPbmmc <span class="op">|</span><span class="st"> </span><span class="op">!!</span><span class="kw">sym</span>(otherSplType) <span class="op">&gt;</span><span class="st"> </span>thdSize)</span>
<span id="cb1484-13"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1484-13"></a></span>
<span id="cb1484-14"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1484-14"></a>normNoLog &lt;-<span class="st"> </span>normNoLog <span class="op">%&gt;%</span></span>
<span id="cb1484-15"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1484-15"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">tmpCluBool=</span> <span class="kw">ifelse</span>((prop <span class="op">&lt;</span><span class="st"> </span>thdPropPbmmc <span class="op">|</span><span class="st"> </span><span class="op">!!</span><span class="kw">sym</span>(otherSplType) <span class="op">&gt;</span><span class="st"> </span>thdSize), <span class="ot">TRUE</span>, <span class="ot">FALSE</span>))</span>
<span id="cb1484-16"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1484-16"></a></span>
<span id="cb1484-17"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1484-17"></a></span>
<span id="cb1484-18"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1484-18"></a><span class="kw">colData</span>(mnn.out) &lt;-<span class="st"> </span><span class="kw">colData</span>(mnn.out) <span class="op">%&gt;%</span></span>
<span id="cb1484-19"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1484-19"></a><span class="st">  </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span></span>
<span id="cb1484-20"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1484-20"></a><span class="st">  </span><span class="co">#select(-tmpCluBool) %&gt;%</span></span>
<span id="cb1484-21"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1484-21"></a><span class="st">  </span><span class="kw">left_join</span>(normNoLog[,<span class="kw">c</span>(<span class="st">&quot;cluster&quot;</span>, <span class="st">&quot;tmpCluBool&quot;</span>)], <span class="dt">by=</span><span class="st">&quot;cluster&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb1484-22"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1484-22"></a><span class="st">  </span><span class="kw">DataFrame</span>()</span>
<span id="cb1484-23"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1484-23"></a></span>
<span id="cb1484-24"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1484-24"></a></span>
<span id="cb1484-25"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1484-25"></a>norm2 &lt;-<span class="st"> </span>normNoLog <span class="op">%&gt;%</span></span>
<span id="cb1484-26"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1484-26"></a><span class="st">  </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span></span>
<span id="cb1484-27"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1484-27"></a><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>sum, <span class="op">-</span>prop) <span class="op">%&gt;%</span></span>
<span id="cb1484-28"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1484-28"></a><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span><span class="kw">c</span>(<span class="kw">grep</span>(<span class="st">&quot;propOut&quot;</span>, <span class="kw">colnames</span>(normNoLog), <span class="dt">value=</span><span class="ot">TRUE</span>))) <span class="op">%&gt;%</span></span>
<span id="cb1484-29"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1484-29"></a><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span><span class="kw">c</span>(<span class="kw">grep</span>(<span class="st">&quot;propLt&quot;</span>, <span class="kw">colnames</span>(normNoLog), <span class="dt">value=</span><span class="ot">TRUE</span>))) <span class="op">%&gt;%</span></span>
<span id="cb1484-30"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1484-30"></a><span class="st">  </span><span class="co">#tibble::rownames_to_column(&quot;clusters&quot;) %&gt;% </span></span>
<span id="cb1484-31"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1484-31"></a><span class="st">  </span>tidyr<span class="op">::</span><span class="kw">pivot_longer</span>(<span class="op">!</span><span class="kw">c</span>(cluster,</span>
<span id="cb1484-32"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1484-32"></a>                         <span class="kw">grep</span>(<span class="st">&quot;tmpCluBool&quot;</span>, <span class="kw">colnames</span>(normNoLog), <span class="dt">value=</span><span class="ot">TRUE</span>)</span>
<span id="cb1484-33"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1484-33"></a>                         ),</span>
<span id="cb1484-34"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1484-34"></a>                      <span class="dt">names_to=</span><span class="st">&quot;source_name&quot;</span>,</span>
<span id="cb1484-35"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1484-35"></a>                      <span class="dt">values_to=</span><span class="st">&quot;Freq&quot;</span>)</span>
<span id="cb1484-36"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1484-36"></a></span>
<span id="cb1484-37"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1484-37"></a>norm2<span class="op">$</span>cluster &lt;-<span class="st"> </span><span class="kw">factor</span>(norm2<span class="op">$</span>cluster,</span>
<span id="cb1484-38"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1484-38"></a>                        <span class="dt">levels=</span><span class="kw">paste0</span>(<span class="st">&quot;c&quot;</span>, sortVecNames))</span>
<span id="cb1484-39"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1484-39"></a></span>
<span id="cb1484-40"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1484-40"></a>p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data=</span>norm2, <span class="kw">aes</span>(<span class="dt">x=</span>cluster,<span class="dt">y=</span>Freq, <span class="dt">fill=</span>source_name)) <span class="op">+</span></span>
<span id="cb1484-41"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1484-41"></a><span class="st">    </span><span class="kw">theme</span>(<span class="dt">axis.text.x=</span><span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">90</span>, <span class="dt">hjust =</span> <span class="dv">0</span>)) <span class="op">+</span></span>
<span id="cb1484-42"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1484-42"></a><span class="st">    </span><span class="kw">geom_col</span>()</span>
<span id="cb1484-43"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1484-43"></a>p</span></code></pre></div>
<p><img src="dataSetIntegration_PBMMC_ETV6-RUNX1_files/figure-html/unnamed-chunk-103-1.png" width="672" /></p>
<div class="sourceCode" id="cb1485"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1485-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1485-1"></a>p <span class="op">+</span><span class="st"> </span><span class="kw">facet_wrap</span>(norm2<span class="op">$</span>tmpCluBool)</span></code></pre></div>
<p><img src="dataSetIntegration_PBMMC_ETV6-RUNX1_files/figure-html/unnamed-chunk-103-2.png" width="672" /></p>
<div class="sourceCode" id="cb1486"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1486-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1486-1"></a>splSetToGet2 &lt;-<span class="st"> </span><span class="kw">gsub</span>(<span class="st">&quot;,&quot;</span>, <span class="st">&quot;_&quot;</span>, splSetToGet)</span>
<span id="cb1486-2"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1486-2"></a><span class="co"># save object?</span></span>
<span id="cb1486-3"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1486-3"></a>fn &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/%s/Robjects/%s_sce_nz_postDeconv%s_dsi_%s_normNoLog.Rds&quot;</span>,</span>
<span id="cb1486-4"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1486-4"></a>              projDir,</span>
<span id="cb1486-5"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1486-5"></a>              outDirBit,</span>
<span id="cb1486-6"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1486-6"></a>              setName,</span>
<span id="cb1486-7"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1486-7"></a>              setSuf,</span>
<span id="cb1486-8"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1486-8"></a>              splSetToGet2) <span class="co"># &#39;dsi&#39; for data set integration</span></span>
<span id="cb1486-9"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1486-9"></a><span class="kw">saveRDS</span>(normNoLog, <span class="dt">file=</span>fn)</span></code></pre></div>
</div>
<div id="session-information-14" class="section level2">
<h2><span class="header-section-number">18.11</span> Session information</h2>
<div class="sourceCode" id="cb1487"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1487-1"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#cb1487-1"></a><span class="kw">sessionInfo</span>()</span></code></pre></div>
<pre><code>## R version 4.0.3 (2020-10-10)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: CentOS Linux 8
## 
## Matrix products: default
## BLAS:   /opt/R/R-4.0.3/lib64/R/lib/libRblas.so
## LAPACK: /opt/R/R-4.0.3/lib64/R/lib/libRlapack.so
## 
## locale:
##  [1] LC_CTYPE=en_GB.UTF-8       LC_NUMERIC=C              
##  [3] LC_TIME=en_GB.UTF-8        LC_COLLATE=en_GB.UTF-8    
##  [5] LC_MONETARY=en_GB.UTF-8    LC_MESSAGES=en_GB.UTF-8   
##  [7] LC_PAPER=en_GB.UTF-8       LC_NAME=C                 
##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            
## [11] LC_MEASUREMENT=en_GB.UTF-8 LC_IDENTIFICATION=C       
## 
## attached base packages:
## [1] parallel  stats4    stats     graphics  grDevices utils     datasets 
## [8] methods   base     
## 
## other attached packages:
##  [1] BiocSingular_1.6.0          Cairo_1.5-12.2             
##  [3] clustree_0.4.3              ggraph_2.0.5               
##  [5] pheatmap_1.0.12             dplyr_1.0.5                
##  [7] bluster_1.0.0               batchelor_1.6.3            
##  [9] scran_1.18.7                scater_1.18.6              
## [11] SingleCellExperiment_1.12.0 SummarizedExperiment_1.20.0
## [13] Biobase_2.50.0              GenomicRanges_1.42.0       
## [15] GenomeInfoDb_1.26.7         IRanges_2.24.1             
## [17] S4Vectors_0.28.1            BiocGenerics_0.36.1        
## [19] MatrixGenerics_1.2.1        matrixStats_0.58.0         
## [21] ggplot2_3.3.3               knitr_1.32                 
## 
## loaded via a namespace (and not attached):
##  [1] bitops_1.0-7              RColorBrewer_1.1-2       
##  [3] backports_1.2.1           tools_4.0.3              
##  [5] bslib_0.2.4               utf8_1.2.1               
##  [7] R6_2.5.0                  irlba_2.3.3              
##  [9] ResidualMatrix_1.0.0      vipor_0.4.5              
## [11] uwot_0.1.10               DBI_1.1.1                
## [13] colorspace_2.0-0          withr_2.4.2              
## [15] tidyselect_1.1.1          gridExtra_2.3            
## [17] compiler_4.0.3            BiocNeighbors_1.8.2      
## [19] DelayedArray_0.16.3       labeling_0.4.2           
## [21] bookdown_0.22             sass_0.3.1               
## [23] checkmate_2.0.0           scales_1.1.1             
## [25] stringr_1.4.0             digest_0.6.27            
## [27] rmarkdown_2.7             XVector_0.30.0           
## [29] pkgconfig_2.0.3           htmltools_0.5.1.1        
## [31] sparseMatrixStats_1.2.1   highr_0.9                
## [33] limma_3.46.0              rlang_0.4.10             
## [35] FNN_1.1.3                 DelayedMatrixStats_1.12.3
## [37] farver_2.1.0              jquerylib_0.1.3          
## [39] generics_0.1.0            jsonlite_1.7.2           
## [41] BiocParallel_1.24.1       RCurl_1.98-1.3           
## [43] magrittr_2.0.1            GenomeInfoDbData_1.2.4   
## [45] scuttle_1.0.4             Matrix_1.3-2             
## [47] Rcpp_1.0.6                ggbeeswarm_0.6.0         
## [49] munsell_0.5.0             fansi_0.4.2              
## [51] viridis_0.6.0             lifecycle_1.0.0          
## [53] stringi_1.5.3             yaml_2.2.1               
## [55] edgeR_3.32.1              MASS_7.3-54              
## [57] zlibbioc_1.36.0           Rtsne_0.15               
## [59] grid_4.0.3                ggrepel_0.9.1            
## [61] dqrng_0.3.0               crayon_1.4.1             
## [63] lattice_0.20-44           cowplot_1.1.1            
## [65] graphlayouts_0.7.1        beachmat_2.6.4           
## [67] locfit_1.5-9.4            pillar_1.6.0             
## [69] igraph_1.2.6              codetools_0.2-18         
## [71] glue_1.4.2                evaluate_0.14            
## [73] tweenr_1.0.2              vctrs_0.3.7              
## [75] polyclip_1.10-0           gtable_0.3.0             
## [77] purrr_0.3.4               tidyr_1.1.3              
## [79] assertthat_0.2.1          ggforce_0.3.3            
## [81] xfun_0.22                 rsvd_1.0.5               
## [83] tidygraph_1.2.0           RSpectra_0.16-0          
## [85] viridisLite_0.4.0         tibble_3.1.1             
## [87] beeswarm_0.3.1            statmod_1.4.35           
## [89] ellipsis_0.3.2</code></pre>

<!--
  setSuf: "_5hCellPerSpl"
-->
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="DataIntegrationPretTop.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="dataSetIntegration-allSetsTop.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/rstudio/bookdown-demo/edit/master/dataSetIntegration_PBMMC_ETV6-RUNX1.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["KmWiC.pdf", "KmWiC.epub"],
"toc": {
"collapse": "subsection",
"scroll_highlight": true
},
"code_folding": "hide"
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
