<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 4 Quality Control | CRUK Bioinformatics Summer School 2020 - single-cell RNA-seq analysis</title>
  <meta name="description" content="A report for all analyses (bookdown::gitbook)." />
  <meta name="generator" content="bookdown 0.21 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 4 Quality Control | CRUK Bioinformatics Summer School 2020 - single-cell RNA-seq analysis" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="A report for all analyses (bookdown::gitbook)." />
  <meta name="github-repo" content="rstudio/bookdown-demo" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 4 Quality Control | CRUK Bioinformatics Summer School 2020 - single-cell RNA-seq analysis" />
  
  <meta name="twitter:description" content="A report for all analyses (bookdown::gitbook)." />
  

<meta name="author" content="Stephane Ballereau, Zeynep Kalender Atak" />


<meta name="date" content="2021-04-28" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="AliFeatCountTop.html"/>
<link rel="next" href="PreProcTop.html"/>
<script src="libs/jquery-3.5.1/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script>
<script src="libs/htmlwidgets-1.5.3/htmlwidgets.js"></script>
<link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet" />
<script src="libs/datatables-binding-0.18/datatables.js"></script>
<link href="libs/dt-core-1.10.20/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="libs/dt-core-1.10.20/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="libs/dt-core-1.10.20/js/jquery.dataTables.min.js"></script>
<link href="libs/crosstalk-1.1.1/css/crosstalk.css" rel="stylesheet" />
<script src="libs/crosstalk-1.1.1/js/crosstalk.min.js"></script>
<link href="libs/nouislider-7.0.10/jquery.nouislider.min.css" rel="stylesheet" />
<script src="libs/nouislider-7.0.10/jquery.nouislider.min.js"></script>
<link href="libs/selectize-0.12.0/selectize.bootstrap3.css" rel="stylesheet" />
<script src="libs/selectize-0.12.0/selectize.min.js"></script>

<script>
/* ========================================================================
 * Bootstrap: transition.js v3.3.7
 * http://getbootstrap.com/javascript/#transitions
 * ========================================================================
 * Copyright 2011-2016 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 * ======================================================================== */


+function ($) {
  'use strict';

  // CSS TRANSITION SUPPORT (Shoutout: http://www.modernizr.com/)
  // ============================================================

  function transitionEnd() {
    var el = document.createElement('bootstrap')

    var transEndEventNames = {
      WebkitTransition : 'webkitTransitionEnd',
      MozTransition    : 'transitionend',
      OTransition      : 'oTransitionEnd otransitionend',
      transition       : 'transitionend'
    }

    for (var name in transEndEventNames) {
      if (el.style[name] !== undefined) {
        return { end: transEndEventNames[name] }
      }
    }

    return false // explicit for ie8 (  ._.)
  }

  // http://blog.alexmaccaw.com/css-transitions
  $.fn.emulateTransitionEnd = function (duration) {
    var called = false
    var $el = this
    $(this).one('bsTransitionEnd', function () { called = true })
    var callback = function () { if (!called) $($el).trigger($.support.transition.end) }
    setTimeout(callback, duration)
    return this
  }

  $(function () {
    $.support.transition = transitionEnd()

    if (!$.support.transition) return

    $.event.special.bsTransitionEnd = {
      bindType: $.support.transition.end,
      delegateType: $.support.transition.end,
      handle: function (e) {
        if ($(e.target).is(this)) return e.handleObj.handler.apply(this, arguments)
      }
    }
  })

}(jQuery);
</script>
<script>
/* ========================================================================
 * Bootstrap: collapse.js v3.3.7
 * http://getbootstrap.com/javascript/#collapse
 * ========================================================================
 * Copyright 2011-2016 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 * ======================================================================== */

/* jshint latedef: false */

+function ($) {
  'use strict';

  // COLLAPSE PUBLIC CLASS DEFINITION
  // ================================

  var Collapse = function (element, options) {
    this.$element      = $(element)
    this.options       = $.extend({}, Collapse.DEFAULTS, options)
    this.$trigger      = $('[data-toggle="collapse"][href="#' + element.id + '"],' +
                           '[data-toggle="collapse"][data-target="#' + element.id + '"]')
    this.transitioning = null

    if (this.options.parent) {
      this.$parent = this.getParent()
    } else {
      this.addAriaAndCollapsedClass(this.$element, this.$trigger)
    }

    if (this.options.toggle) this.toggle()
  }

  Collapse.VERSION  = '3.3.7'

  Collapse.TRANSITION_DURATION = 350

  Collapse.DEFAULTS = {
    toggle: true
  }

  Collapse.prototype.dimension = function () {
    var hasWidth = this.$element.hasClass('width')
    return hasWidth ? 'width' : 'height'
  }

  Collapse.prototype.show = function () {
    if (this.transitioning || this.$element.hasClass('in')) return

    var activesData
    var actives = this.$parent && this.$parent.children('.panel').children('.in, .collapsing')

    if (actives && actives.length) {
      activesData = actives.data('bs.collapse')
      if (activesData && activesData.transitioning) return
    }

    var startEvent = $.Event('show.bs.collapse')
    this.$element.trigger(startEvent)
    if (startEvent.isDefaultPrevented()) return

    if (actives && actives.length) {
      Plugin.call(actives, 'hide')
      activesData || actives.data('bs.collapse', null)
    }

    var dimension = this.dimension()

    this.$element
      .removeClass('collapse')
      .addClass('collapsing')[dimension](0)
      .attr('aria-expanded', true)

    this.$trigger
      .removeClass('collapsed')
      .attr('aria-expanded', true)

    this.transitioning = 1

    var complete = function () {
      this.$element
        .removeClass('collapsing')
        .addClass('collapse in')[dimension]('')
      this.transitioning = 0
      this.$element
        .trigger('shown.bs.collapse')
    }

    if (!$.support.transition) return complete.call(this)

    var scrollSize = $.camelCase(['scroll', dimension].join('-'))

    this.$element
      .one('bsTransitionEnd', $.proxy(complete, this))
      .emulateTransitionEnd(Collapse.TRANSITION_DURATION)[dimension](this.$element[0][scrollSize])
  }

  Collapse.prototype.hide = function () {
    if (this.transitioning || !this.$element.hasClass('in')) return

    var startEvent = $.Event('hide.bs.collapse')
    this.$element.trigger(startEvent)
    if (startEvent.isDefaultPrevented()) return

    var dimension = this.dimension()

    this.$element[dimension](this.$element[dimension]())[0].offsetHeight

    this.$element
      .addClass('collapsing')
      .removeClass('collapse in')
      .attr('aria-expanded', false)

    this.$trigger
      .addClass('collapsed')
      .attr('aria-expanded', false)

    this.transitioning = 1

    var complete = function () {
      this.transitioning = 0
      this.$element
        .removeClass('collapsing')
        .addClass('collapse')
        .trigger('hidden.bs.collapse')
    }

    if (!$.support.transition) return complete.call(this)

    this.$element
      [dimension](0)
      .one('bsTransitionEnd', $.proxy(complete, this))
      .emulateTransitionEnd(Collapse.TRANSITION_DURATION)
  }

  Collapse.prototype.toggle = function () {
    this[this.$element.hasClass('in') ? 'hide' : 'show']()
  }

  Collapse.prototype.getParent = function () {
    return $(this.options.parent)
      .find('[data-toggle="collapse"][data-parent="' + this.options.parent + '"]')
      .each($.proxy(function (i, element) {
        var $element = $(element)
        this.addAriaAndCollapsedClass(getTargetFromTrigger($element), $element)
      }, this))
      .end()
  }

  Collapse.prototype.addAriaAndCollapsedClass = function ($element, $trigger) {
    var isOpen = $element.hasClass('in')

    $element.attr('aria-expanded', isOpen)
    $trigger
      .toggleClass('collapsed', !isOpen)
      .attr('aria-expanded', isOpen)
  }

  function getTargetFromTrigger($trigger) {
    var href
    var target = $trigger.attr('data-target')
      || (href = $trigger.attr('href')) && href.replace(/.*(?=#[^\s]+$)/, '') // strip for ie7

    return $(target)
  }


  // COLLAPSE PLUGIN DEFINITION
  // ==========================

  function Plugin(option) {
    return this.each(function () {
      var $this   = $(this)
      var data    = $this.data('bs.collapse')
      var options = $.extend({}, Collapse.DEFAULTS, $this.data(), typeof option == 'object' && option)

      if (!data && options.toggle && /show|hide/.test(option)) options.toggle = false
      if (!data) $this.data('bs.collapse', (data = new Collapse(this, options)))
      if (typeof option == 'string') data[option]()
    })
  }

  var old = $.fn.collapse

  $.fn.collapse             = Plugin
  $.fn.collapse.Constructor = Collapse


  // COLLAPSE NO CONFLICT
  // ====================

  $.fn.collapse.noConflict = function () {
    $.fn.collapse = old
    return this
  }


  // COLLAPSE DATA-API
  // =================

  $(document).on('click.bs.collapse.data-api', '[data-toggle="collapse"]', function (e) {
    var $this   = $(this)

    if (!$this.attr('data-target')) e.preventDefault()

    var $target = getTargetFromTrigger($this)
    var data    = $target.data('bs.collapse')
    var option  = data ? 'toggle' : $this.data()

    Plugin.call($target, option)
  })

}(jQuery);
</script>
<script>
window.initializeCodeFolding = function(show) {

  // handlers for show-all and hide all
  $("#rmd-show-all-code").click(function() {
    $('div.r-code-collapse').each(function() {
      $(this).collapse('show');
    });
  });
  $("#rmd-hide-all-code").click(function() {
    $('div.r-code-collapse').each(function() {
      $(this).collapse('hide');
    });
  });

  // index for unique code element ids
  var currentIndex = 1;

  // select all R code blocks
  var rCodeBlocks = $('pre.sourceCode, pre.r, pre.python, pre.bash, pre.sql, pre.cpp, pre.stan');
  rCodeBlocks.each(function() {

    // create a collapsable div to wrap the code in
    var div = $('<div class="collapse r-code-collapse"></div>');
    if (show)
      div.addClass('in');
    var id = 'rcode-643E0F36' + currentIndex++;
    div.attr('id', id);
    $(this).before(div);
    $(this).detach().appendTo(div);

    // add a show code button right above
    var showCodeText = $('<span>' + (show ? 'Hide' : 'Code') + '</span>');
    var showCodeButton = $('<button type="button" class="btn btn-default btn-xs code-folding-btn pull-right"></button>');
    showCodeButton.append(showCodeText);
    showCodeButton
        .attr('data-toggle', 'collapse')
        .attr('data-target', '#' + id)
        .attr('aria-expanded', show)
        .attr('aria-controls', id);

    var buttonRow = $('<div class="row"></div>');
    var buttonCol = $('<div class="col-md-12"></div>');

    buttonCol.append(showCodeButton);
    buttonRow.append(buttonCol);

    div.before(buttonRow);

    // update state of button on show/hide
    div.on('hidden.bs.collapse', function () {
      showCodeText.text('Code');
    });
    div.on('show.bs.collapse', function () {
      showCodeText.text('Hide');
    });
  });

}
</script>
<script>
/* ========================================================================
 * Bootstrap: dropdown.js v3.3.7
 * http://getbootstrap.com/javascript/#dropdowns
 * ========================================================================
 * Copyright 2011-2016 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 * ======================================================================== */


+function ($) {
  'use strict';

  // DROPDOWN CLASS DEFINITION
  // =========================

  var backdrop = '.dropdown-backdrop'
  var toggle   = '[data-toggle="dropdown"]'
  var Dropdown = function (element) {
    $(element).on('click.bs.dropdown', this.toggle)
  }

  Dropdown.VERSION = '3.3.7'

  function getParent($this) {
    var selector = $this.attr('data-target')

    if (!selector) {
      selector = $this.attr('href')
      selector = selector && /#[A-Za-z]/.test(selector) && selector.replace(/.*(?=#[^\s]*$)/, '') // strip for ie7
    }

    var $parent = selector && $(selector)

    return $parent && $parent.length ? $parent : $this.parent()
  }

  function clearMenus(e) {
    if (e && e.which === 3) return
    $(backdrop).remove()
    $(toggle).each(function () {
      var $this         = $(this)
      var $parent       = getParent($this)
      var relatedTarget = { relatedTarget: this }

      if (!$parent.hasClass('open')) return

      if (e && e.type == 'click' && /input|textarea/i.test(e.target.tagName) && $.contains($parent[0], e.target)) return

      $parent.trigger(e = $.Event('hide.bs.dropdown', relatedTarget))

      if (e.isDefaultPrevented()) return

      $this.attr('aria-expanded', 'false')
      $parent.removeClass('open').trigger($.Event('hidden.bs.dropdown', relatedTarget))
    })
  }

  Dropdown.prototype.toggle = function (e) {
    var $this = $(this)

    if ($this.is('.disabled, :disabled')) return

    var $parent  = getParent($this)
    var isActive = $parent.hasClass('open')

    clearMenus()

    if (!isActive) {
      if ('ontouchstart' in document.documentElement && !$parent.closest('.navbar-nav').length) {
        // if mobile we use a backdrop because click events don't delegate
        $(document.createElement('div'))
          .addClass('dropdown-backdrop')
          .insertAfter($(this))
          .on('click', clearMenus)
      }

      var relatedTarget = { relatedTarget: this }
      $parent.trigger(e = $.Event('show.bs.dropdown', relatedTarget))

      if (e.isDefaultPrevented()) return

      $this
        .trigger('focus')
        .attr('aria-expanded', 'true')

      $parent
        .toggleClass('open')
        .trigger($.Event('shown.bs.dropdown', relatedTarget))
    }

    return false
  }

  Dropdown.prototype.keydown = function (e) {
    if (!/(38|40|27|32)/.test(e.which) || /input|textarea/i.test(e.target.tagName)) return

    var $this = $(this)

    e.preventDefault()
    e.stopPropagation()

    if ($this.is('.disabled, :disabled')) return

    var $parent  = getParent($this)
    var isActive = $parent.hasClass('open')

    if (!isActive && e.which != 27 || isActive && e.which == 27) {
      if (e.which == 27) $parent.find(toggle).trigger('focus')
      return $this.trigger('click')
    }

    var desc = ' li:not(.disabled):visible a'
    var $items = $parent.find('.dropdown-menu' + desc)

    if (!$items.length) return

    var index = $items.index(e.target)

    if (e.which == 38 && index > 0)                 index--         // up
    if (e.which == 40 && index < $items.length - 1) index++         // down
    if (!~index)                                    index = 0

    $items.eq(index).trigger('focus')
  }


  // DROPDOWN PLUGIN DEFINITION
  // ==========================

  function Plugin(option) {
    return this.each(function () {
      var $this = $(this)
      var data  = $this.data('bs.dropdown')

      if (!data) $this.data('bs.dropdown', (data = new Dropdown(this)))
      if (typeof option == 'string') data[option].call($this)
    })
  }

  var old = $.fn.dropdown

  $.fn.dropdown             = Plugin
  $.fn.dropdown.Constructor = Dropdown


  // DROPDOWN NO CONFLICT
  // ====================

  $.fn.dropdown.noConflict = function () {
    $.fn.dropdown = old
    return this
  }


  // APPLY TO STANDARD DROPDOWN ELEMENTS
  // ===================================

  $(document)
    .on('click.bs.dropdown.data-api', clearMenus)
    .on('click.bs.dropdown.data-api', '.dropdown form', function (e) { e.stopPropagation() })
    .on('click.bs.dropdown.data-api', toggle, Dropdown.prototype.toggle)
    .on('keydown.bs.dropdown.data-api', toggle, Dropdown.prototype.keydown)
    .on('keydown.bs.dropdown.data-api', '.dropdown-menu', Dropdown.prototype.keydown)

}(jQuery);
</script>
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
.row { display: flex; }
.collapse { display: none; }
.in { display:block }
.pull-right > .dropdown-menu {
    right: 0;
    left: auto;
}
.open > .dropdown-menu {
    display: block;
}
.dropdown-menu {
    position: absolute;
    top: 100%;
    left: 0;
    z-index: 1000;
    display: none;
    float: left;
    min-width: 160px;
    padding: 5px 0;
    margin: 2px 0 0;
    font-size: 14px;
    text-align: left;
    list-style: none;
    background-color: #fff;
    -webkit-background-clip: padding-box;
    background-clip: padding-box;
    border: 1px solid #ccc;
    border: 1px solid rgba(0,0,0,.15);
    border-radius: 4px;
    -webkit-box-shadow: 0 6px 12px rgba(0,0,0,.175);
    box-shadow: 0 6px 12px rgba(0,0,0,.175);
}
</style>
<script>
$(document).ready(function () {
  window.initializeCodeFolding("show" === "hide");
});
</script>


<script>
document.write('<div class="btn-group pull-right" style="position: absolute; top: 20%; right: 2%; z-index: 200"><button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true" data-_extension-text-contrast=""><span>Code</span> <span class="caret"></span></button><ul class="dropdown-menu" style="min-width: 50px;"><li><a id="rmd-show-all-code" href="#">Show All Code</a></li><li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li></ul></div>')
</script>


<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">CRUK Functional Genomics Summer School 2020</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Preamble</a><ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#the-study"><i class="fa fa-check"></i><b>1.1</b> The study</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#the-plan"><i class="fa fa-check"></i><b>1.2</b> The plan</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#the-analyses"><i class="fa fa-check"></i><b>1.3</b> The analyses</a></li>
<li class="chapter" data-level="1.4" data-path="index.html"><a href="index.html#overall-summary"><i class="fa fa-check"></i><b>1.4</b> Overall summary</a></li>
<li class="chapter" data-level="1.5" data-path="index.html"><a href="index.html#conclusion"><i class="fa fa-check"></i><b>1.5</b> Conclusion</a></li>
<li class="chapter" data-level="1.6" data-path="index.html"><a href="index.html#abbreviations"><i class="fa fa-check"></i><b>1.6</b> Abbreviations</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="SeqQualTop.html"><a href="SeqQualTop.html"><i class="fa fa-check"></i><b>2</b> Sequence Quality</a><ul>
<li class="chapter" data-level="2.1" data-path="SeqQualTop.html"><a href="SeqQualTop.html#introduction"><i class="fa fa-check"></i><b>2.1</b> Introduction</a></li>
<li class="chapter" data-level="2.2" data-path="SeqQualTop.html"><a href="SeqQualTop.html#caronbourque2020---fastqc"><i class="fa fa-check"></i><b>2.2</b> CaronBourque2020 - fastqc</a></li>
<li class="chapter" data-level="2.3" data-path="SeqQualTop.html"><a href="SeqQualTop.html#caronbourque2020---multiqc"><i class="fa fa-check"></i><b>2.3</b> CaronBourque2020 - MultiQC</a><ul>
<li class="chapter" data-level="2.3.1" data-path="SeqQualTop.html"><a href="SeqQualTop.html#sample-index-i1"><i class="fa fa-check"></i><b>2.3.1</b> sample index: I1</a></li>
<li class="chapter" data-level="2.3.2" data-path="SeqQualTop.html"><a href="SeqQualTop.html#cell-barcode-umi-r1"><i class="fa fa-check"></i><b>2.3.2</b> cell barcode + UMI: R1</a></li>
<li class="chapter" data-level="2.3.3" data-path="SeqQualTop.html"><a href="SeqQualTop.html#insert-r2"><i class="fa fa-check"></i><b>2.3.3</b> insert: R2</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="SeqQualTop.html"><a href="SeqQualTop.html#hca-adult-bmmc---fastqc"><i class="fa fa-check"></i><b>2.4</b> HCA adult BMMC - fastqc</a></li>
<li class="chapter" data-level="2.5" data-path="SeqQualTop.html"><a href="SeqQualTop.html#hca-adult-bmmc---multiqc"><i class="fa fa-check"></i><b>2.5</b> HCA adult BMMC - MultiQC</a><ul>
<li class="chapter" data-level="2.5.1" data-path="SeqQualTop.html"><a href="SeqQualTop.html#sample-index-i1-1"><i class="fa fa-check"></i><b>2.5.1</b> sample index: I1</a></li>
<li class="chapter" data-level="2.5.2" data-path="SeqQualTop.html"><a href="SeqQualTop.html#cell-barcode-umi-r1-1"><i class="fa fa-check"></i><b>2.5.2</b> cell barcode + UMI: R1</a></li>
<li class="chapter" data-level="2.5.3" data-path="SeqQualTop.html"><a href="SeqQualTop.html#insert-r2-1"><i class="fa fa-check"></i><b>2.5.3</b> insert: R2</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="AliFeatCountTop.html"><a href="AliFeatCountTop.html"><i class="fa fa-check"></i><b>3</b> Alignment and feature counting</a><ul>
<li class="chapter" data-level="3.1" data-path="AliFeatCountTop.html"><a href="AliFeatCountTop.html#introduction-1"><i class="fa fa-check"></i><b>3.1</b> Introduction</a></li>
<li class="chapter" data-level="3.2" data-path="AliFeatCountTop.html"><a href="AliFeatCountTop.html#x-cellranger-pipeline-in-brief"><i class="fa fa-check"></i><b>3.2</b> 10X cellranger pipeline in brief</a></li>
<li class="chapter" data-level="3.3" data-path="AliFeatCountTop.html"><a href="AliFeatCountTop.html#sample-sheet"><i class="fa fa-check"></i><b>3.3</b> sample sheet</a></li>
<li class="chapter" data-level="3.4" data-path="AliFeatCountTop.html"><a href="AliFeatCountTop.html#x-cellranger-reports-for-caronbourque2020"><i class="fa fa-check"></i><b>3.4</b> 10X cellranger reports for CaronBourque2020</a></li>
<li class="chapter" data-level="3.5" data-path="AliFeatCountTop.html"><a href="AliFeatCountTop.html#x-cellranger-reports-for-hcas-adult-bmmcs"><i class="fa fa-check"></i><b>3.5</b> 10X cellranger reports for HCA’s adult BMMCs</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html"><i class="fa fa-check"></i><b>4</b> Quality Control</a><ul>
<li class="chapter" data-level="4.1" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#introduction-2"><i class="fa fa-check"></i><b>4.1</b> Introduction</a></li>
<li class="chapter" data-level="4.2" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#load-packages"><i class="fa fa-check"></i><b>4.2</b> Load packages</a></li>
<li class="chapter" data-level="4.3" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#sample-sheet-1"><i class="fa fa-check"></i><b>4.3</b> Sample sheet</a></li>
<li class="chapter" data-level="4.4" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#data-representation"><i class="fa fa-check"></i><b>4.4</b> Data representation</a></li>
<li class="chapter" data-level="4.5" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#example"><i class="fa fa-check"></i><b>4.5</b> Example</a></li>
<li class="chapter" data-level="4.6" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#mapping-qc"><i class="fa fa-check"></i><b>4.6</b> Mapping QC</a><ul>
<li class="chapter" data-level="4.6.1" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#gene-body-coverage"><i class="fa fa-check"></i><b>4.6.1</b> Gene body coverage</a></li>
<li class="chapter" data-level="4.6.2" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#amplification-rate"><i class="fa fa-check"></i><b>4.6.2</b> Amplification rate</a></li>
</ul></li>
<li class="chapter" data-level="4.7" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#cell-calling-for-droplet-data"><i class="fa fa-check"></i><b>4.7</b> Cell calling for droplet data</a><ul>
<li class="chapter" data-level="4.7.1" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#mixture-model"><i class="fa fa-check"></i><b>4.7.1</b> Mixture model</a></li>
<li class="chapter" data-level="4.7.2" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#barcode-rank-plot"><i class="fa fa-check"></i><b>4.7.2</b> Barcode rank plot</a></li>
<li class="chapter" data-level="4.7.3" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#inflection-point"><i class="fa fa-check"></i><b>4.7.3</b> Inflection point</a></li>
<li class="chapter" data-level="4.7.4" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#cellranger-v1-and-v2"><i class="fa fa-check"></i><b>4.7.4</b> Cellranger v1 and v2</a></li>
<li class="chapter" data-level="4.7.5" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#dropletutils-and-emptydrops"><i class="fa fa-check"></i><b>4.7.5</b> DropletUtils and EmptyDrops</a></li>
</ul></li>
<li class="chapter" data-level="4.8" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#load-filtered-matrices"><i class="fa fa-check"></i><b>4.8</b> Load filtered matrices</a></li>
<li class="chapter" data-level="4.9" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#properties-of-scrna-seq-data"><i class="fa fa-check"></i><b>4.9</b> Properties of scRNA-seq data</a></li>
<li class="chapter" data-level="4.10" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#quality-control"><i class="fa fa-check"></i><b>4.10</b> Quality control</a><ul>
<li class="chapter" data-level="4.10.1" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#qc-metric-distribution"><i class="fa fa-check"></i><b>4.10.1</b> QC metric distribution</a></li>
</ul></li>
<li class="chapter" data-level="4.11" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#identification-of-low-quality-cells-with-adaptive-thresholds"><i class="fa fa-check"></i><b>4.11</b> Identification of low-quality cells with adaptive thresholds</a><ul>
<li class="chapter" data-level="4.11.1" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#library-size"><i class="fa fa-check"></i><b>4.11.1</b> Library size</a></li>
<li class="chapter" data-level="4.11.2" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#number-of-genes"><i class="fa fa-check"></i><b>4.11.2</b> Number of genes</a></li>
<li class="chapter" data-level="4.11.3" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#mitochondrial-content"><i class="fa fa-check"></i><b>4.11.3</b> Mitochondrial content</a></li>
<li class="chapter" data-level="4.11.4" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#summary"><i class="fa fa-check"></i><b>4.11.4</b> Summary</a></li>
<li class="chapter" data-level="4.11.5" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#all-steps-at-once"><i class="fa fa-check"></i><b>4.11.5</b> All steps at once</a></li>
<li class="chapter" data-level="4.11.6" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#assumptions"><i class="fa fa-check"></i><b>4.11.6</b> Assumptions</a></li>
</ul></li>
<li class="chapter" data-level="4.12" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#experimental-factors"><i class="fa fa-check"></i><b>4.12</b> Experimental factors</a><ul>
<li class="chapter" data-level="4.12.1" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#identify-poor-quality-batches"><i class="fa fa-check"></i><b>4.12.1</b> Identify poor-quality batches</a><ul>
<li class="chapter" data-level="4.12.1.1" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#number-of-genes-detected"><i class="fa fa-check"></i><b>4.12.1.1</b> Number of genes detected</a><ul>
<li class="chapter" data-level="4.12.1.1.1" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#mitochondrial-content-1"><i class="fa fa-check"></i><b>4.12.1.1.1</b> Mitochondrial content</a></li>
</ul></li>
<li class="chapter" data-level="4.12.1.2" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#samples-to-check"><i class="fa fa-check"></i><b>4.12.1.2</b> Samples to check</a></li>
</ul></li>
<li class="chapter" data-level="4.12.2" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#qc-metrics-space"><i class="fa fa-check"></i><b>4.12.2</b> QC metrics space</a></li>
<li class="chapter" data-level="4.12.3" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#qc-pca"><i class="fa fa-check"></i><b>4.12.3</b> QC PCA</a></li>
<li class="chapter" data-level="4.12.4" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#other-diagnostic-plots"><i class="fa fa-check"></i><b>4.12.4</b> Other diagnostic plots</a></li>
<li class="chapter" data-level="4.12.5" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#filter-low-quality-cells-out"><i class="fa fa-check"></i><b>4.12.5</b> Filter low-quality cells out</a></li>
</ul></li>
<li class="chapter" data-level="4.13" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#novelty"><i class="fa fa-check"></i><b>4.13</b> Novelty</a></li>
<li class="chapter" data-level="4.14" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#qc-based-on-sparsity"><i class="fa fa-check"></i><b>4.14</b> QC based on sparsity</a><ul>
<li class="chapter" data-level="4.14.1" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#remove-genes-that-are-not-expressed-at-all"><i class="fa fa-check"></i><b>4.14.1</b> Remove genes that are not expressed at all</a></li>
<li class="chapter" data-level="4.14.2" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#sparsity-plots"><i class="fa fa-check"></i><b>4.14.2</b> Sparsity plots</a></li>
<li class="chapter" data-level="4.14.3" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#filters"><i class="fa fa-check"></i><b>4.14.3</b> Filters</a></li>
<li class="chapter" data-level="4.14.4" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#separate-caron-and-hca-batches"><i class="fa fa-check"></i><b>4.14.4</b> Separate Caron and Hca batches</a></li>
<li class="chapter" data-level="4.14.5" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#caron-only"><i class="fa fa-check"></i><b>4.14.5</b> Caron only</a></li>
<li class="chapter" data-level="4.14.6" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#hca-only"><i class="fa fa-check"></i><b>4.14.6</b> Hca only</a></li>
</ul></li>
<li class="chapter" data-level="4.15" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#subsample-hca-set"><i class="fa fa-check"></i><b>4.15</b> Subsample Hca set</a></li>
<li class="chapter" data-level="4.16" data-path="PreProcAllCellsTop.html"><a href="PreProcAllCellsTop.html#session-information"><i class="fa fa-check"></i><b>4.16</b> Session information</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="PreProcTop.html"><a href="PreProcTop.html"><i class="fa fa-check"></i><b>5</b> Quality Control</a><ul>
<li class="chapter" data-level="5.1" data-path="PreProcTop.html"><a href="PreProcTop.html#introduction-3"><i class="fa fa-check"></i><b>5.1</b> Introduction</a></li>
<li class="chapter" data-level="5.2" data-path="PreProcTop.html"><a href="PreProcTop.html#load-packages-1"><i class="fa fa-check"></i><b>5.2</b> Load packages</a></li>
<li class="chapter" data-level="5.3" data-path="PreProcTop.html"><a href="PreProcTop.html#sample-sheet-2"><i class="fa fa-check"></i><b>5.3</b> Sample sheet</a></li>
<li class="chapter" data-level="5.4" data-path="PreProcTop.html"><a href="PreProcTop.html#data-representation-1"><i class="fa fa-check"></i><b>5.4</b> Data representation</a></li>
<li class="chapter" data-level="5.5" data-path="PreProcTop.html"><a href="PreProcTop.html#example-1"><i class="fa fa-check"></i><b>5.5</b> Example</a></li>
<li class="chapter" data-level="5.6" data-path="PreProcTop.html"><a href="PreProcTop.html#mapping-qc-1"><i class="fa fa-check"></i><b>5.6</b> Mapping QC</a><ul>
<li class="chapter" data-level="5.6.1" data-path="PreProcTop.html"><a href="PreProcTop.html#gene-body-coverage-1"><i class="fa fa-check"></i><b>5.6.1</b> Gene body coverage</a></li>
<li class="chapter" data-level="5.6.2" data-path="PreProcTop.html"><a href="PreProcTop.html#amplification-rate-1"><i class="fa fa-check"></i><b>5.6.2</b> Amplification rate</a></li>
</ul></li>
<li class="chapter" data-level="5.7" data-path="PreProcTop.html"><a href="PreProcTop.html#cell-calling-for-droplet-data-1"><i class="fa fa-check"></i><b>5.7</b> Cell calling for droplet data</a><ul>
<li class="chapter" data-level="5.7.1" data-path="PreProcTop.html"><a href="PreProcTop.html#mixture-model-1"><i class="fa fa-check"></i><b>5.7.1</b> Mixture model</a></li>
<li class="chapter" data-level="5.7.2" data-path="PreProcTop.html"><a href="PreProcTop.html#barcode-rank-plot-1"><i class="fa fa-check"></i><b>5.7.2</b> Barcode rank plot</a></li>
<li class="chapter" data-level="5.7.3" data-path="PreProcTop.html"><a href="PreProcTop.html#inflection-point-1"><i class="fa fa-check"></i><b>5.7.3</b> Inflection point</a></li>
<li class="chapter" data-level="5.7.4" data-path="PreProcTop.html"><a href="PreProcTop.html#cellranger-v1-and-v2-1"><i class="fa fa-check"></i><b>5.7.4</b> Cellranger v1 and v2</a></li>
<li class="chapter" data-level="5.7.5" data-path="PreProcTop.html"><a href="PreProcTop.html#dropletutils-and-emptydrops-1"><i class="fa fa-check"></i><b>5.7.5</b> DropletUtils and EmptyDrops</a></li>
</ul></li>
<li class="chapter" data-level="5.8" data-path="PreProcTop.html"><a href="PreProcTop.html#load-filtered-matrices-1"><i class="fa fa-check"></i><b>5.8</b> Load filtered matrices</a></li>
<li class="chapter" data-level="5.9" data-path="PreProcTop.html"><a href="PreProcTop.html#properties-of-scrna-seq-data-1"><i class="fa fa-check"></i><b>5.9</b> Properties of scRNA-seq data</a></li>
<li class="chapter" data-level="5.10" data-path="PreProcTop.html"><a href="PreProcTop.html#quality-control-1"><i class="fa fa-check"></i><b>5.10</b> Quality control</a><ul>
<li class="chapter" data-level="5.10.1" data-path="PreProcTop.html"><a href="PreProcTop.html#qc-metric-distribution-1"><i class="fa fa-check"></i><b>5.10.1</b> QC metric distribution</a></li>
</ul></li>
<li class="chapter" data-level="5.11" data-path="PreProcTop.html"><a href="PreProcTop.html#identification-of-low-quality-cells-with-adaptive-thresholds-1"><i class="fa fa-check"></i><b>5.11</b> Identification of low-quality cells with adaptive thresholds</a><ul>
<li class="chapter" data-level="5.11.1" data-path="PreProcTop.html"><a href="PreProcTop.html#library-size-1"><i class="fa fa-check"></i><b>5.11.1</b> Library size</a></li>
<li class="chapter" data-level="5.11.2" data-path="PreProcTop.html"><a href="PreProcTop.html#number-of-genes-1"><i class="fa fa-check"></i><b>5.11.2</b> Number of genes</a></li>
<li class="chapter" data-level="5.11.3" data-path="PreProcTop.html"><a href="PreProcTop.html#mitochondrial-content-2"><i class="fa fa-check"></i><b>5.11.3</b> Mitochondrial content</a></li>
<li class="chapter" data-level="5.11.4" data-path="PreProcTop.html"><a href="PreProcTop.html#summary-1"><i class="fa fa-check"></i><b>5.11.4</b> Summary</a></li>
<li class="chapter" data-level="5.11.5" data-path="PreProcTop.html"><a href="PreProcTop.html#all-steps-at-once-1"><i class="fa fa-check"></i><b>5.11.5</b> All steps at once</a></li>
<li class="chapter" data-level="5.11.6" data-path="PreProcTop.html"><a href="PreProcTop.html#assumptions-1"><i class="fa fa-check"></i><b>5.11.6</b> Assumptions</a></li>
</ul></li>
<li class="chapter" data-level="5.12" data-path="PreProcTop.html"><a href="PreProcTop.html#experimental-factors-1"><i class="fa fa-check"></i><b>5.12</b> Experimental factors</a><ul>
<li class="chapter" data-level="5.12.1" data-path="PreProcTop.html"><a href="PreProcTop.html#identify-poor-quality-batches-1"><i class="fa fa-check"></i><b>5.12.1</b> Identify poor-quality batches</a><ul>
<li class="chapter" data-level="5.12.1.1" data-path="PreProcTop.html"><a href="PreProcTop.html#number-of-genes-detected-1"><i class="fa fa-check"></i><b>5.12.1.1</b> Number of genes detected</a><ul>
<li class="chapter" data-level="5.12.1.1.1" data-path="PreProcTop.html"><a href="PreProcTop.html#mitochondrial-content-3"><i class="fa fa-check"></i><b>5.12.1.1.1</b> Mitochondrial content</a></li>
</ul></li>
<li class="chapter" data-level="5.12.1.2" data-path="PreProcTop.html"><a href="PreProcTop.html#samples-to-check-1"><i class="fa fa-check"></i><b>5.12.1.2</b> Samples to check</a></li>
</ul></li>
<li class="chapter" data-level="5.12.2" data-path="PreProcTop.html"><a href="PreProcTop.html#qc-metrics-space-1"><i class="fa fa-check"></i><b>5.12.2</b> QC metrics space</a></li>
<li class="chapter" data-level="5.12.3" data-path="PreProcTop.html"><a href="PreProcTop.html#qc-pca-1"><i class="fa fa-check"></i><b>5.12.3</b> QC PCA</a></li>
<li class="chapter" data-level="5.12.4" data-path="PreProcTop.html"><a href="PreProcTop.html#other-diagnostic-plots-1"><i class="fa fa-check"></i><b>5.12.4</b> Other diagnostic plots</a></li>
<li class="chapter" data-level="5.12.5" data-path="PreProcTop.html"><a href="PreProcTop.html#filter-low-quality-cells-out-1"><i class="fa fa-check"></i><b>5.12.5</b> Filter low-quality cells out</a></li>
</ul></li>
<li class="chapter" data-level="5.13" data-path="PreProcTop.html"><a href="PreProcTop.html#novelty-1"><i class="fa fa-check"></i><b>5.13</b> Novelty</a></li>
<li class="chapter" data-level="5.14" data-path="PreProcTop.html"><a href="PreProcTop.html#qc-based-on-sparsity-1"><i class="fa fa-check"></i><b>5.14</b> QC based on sparsity</a><ul>
<li class="chapter" data-level="5.14.1" data-path="PreProcTop.html"><a href="PreProcTop.html#remove-genes-that-are-not-expressed-at-all-1"><i class="fa fa-check"></i><b>5.14.1</b> Remove genes that are not expressed at all</a></li>
<li class="chapter" data-level="5.14.2" data-path="PreProcTop.html"><a href="PreProcTop.html#sparsity-plots-1"><i class="fa fa-check"></i><b>5.14.2</b> Sparsity plots</a></li>
<li class="chapter" data-level="5.14.3" data-path="PreProcTop.html"><a href="PreProcTop.html#filters-1"><i class="fa fa-check"></i><b>5.14.3</b> Filters</a></li>
<li class="chapter" data-level="5.14.4" data-path="PreProcTop.html"><a href="PreProcTop.html#separate-caron-and-hca-batches-1"><i class="fa fa-check"></i><b>5.14.4</b> Separate Caron and Hca batches</a></li>
<li class="chapter" data-level="5.14.5" data-path="PreProcTop.html"><a href="PreProcTop.html#caron-only-1"><i class="fa fa-check"></i><b>5.14.5</b> Caron only</a></li>
<li class="chapter" data-level="5.14.6" data-path="PreProcTop.html"><a href="PreProcTop.html#hca-only-1"><i class="fa fa-check"></i><b>5.14.6</b> Hca only</a></li>
</ul></li>
<li class="chapter" data-level="5.15" data-path="PreProcTop.html"><a href="PreProcTop.html#session-information-1"><i class="fa fa-check"></i><b>5.15</b> Session information</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="NormalisationAllCellsTop.html"><a href="NormalisationAllCellsTop.html"><i class="fa fa-check"></i><b>6</b> Normalisation</a><ul>
<li class="chapter" data-level="6.1" data-path="NormalisationAllCellsTop.html"><a href="NormalisationAllCellsTop.html#caron"><i class="fa fa-check"></i><b>6.1</b> Caron</a><ul>
<li class="chapter" data-level="6.1.1" data-path="NormalisationAllCellsTop.html"><a href="NormalisationAllCellsTop.html#library-size-normalization"><i class="fa fa-check"></i><b>6.1.1</b> Library size normalization</a></li>
<li class="chapter" data-level="6.1.2" data-path="NormalisationAllCellsTop.html"><a href="NormalisationAllCellsTop.html#deconvolution"><i class="fa fa-check"></i><b>6.1.2</b> Deconvolution</a></li>
<li class="chapter" data-level="6.1.3" data-path="NormalisationAllCellsTop.html"><a href="NormalisationAllCellsTop.html#compute-size-factors"><i class="fa fa-check"></i><b>6.1.3</b> Compute size factors</a><ul>
<li class="chapter" data-level="6.1.3.1" data-path="NormalisationAllCellsTop.html"><a href="NormalisationAllCellsTop.html#apply-size-factors"><i class="fa fa-check"></i><b>6.1.3.1</b> Apply size factors</a></li>
<li class="chapter" data-level="6.1.3.2" data-path="NormalisationAllCellsTop.html"><a href="NormalisationAllCellsTop.html#save-object"><i class="fa fa-check"></i><b>6.1.3.2</b> Save object</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="NormalisationAllCellsTop.html"><a href="NormalisationAllCellsTop.html#hca"><i class="fa fa-check"></i><b>6.2</b> Hca</a><ul>
<li class="chapter" data-level="6.2.1" data-path="NormalisationAllCellsTop.html"><a href="NormalisationAllCellsTop.html#library-size-normalization-1"><i class="fa fa-check"></i><b>6.2.1</b> Library size normalization</a></li>
<li class="chapter" data-level="6.2.2" data-path="NormalisationAllCellsTop.html"><a href="NormalisationAllCellsTop.html#deconvolution-1"><i class="fa fa-check"></i><b>6.2.2</b> Deconvolution</a></li>
<li class="chapter" data-level="6.2.3" data-path="NormalisationAllCellsTop.html"><a href="NormalisationAllCellsTop.html#compute-size-factors-1"><i class="fa fa-check"></i><b>6.2.3</b> Compute size factors</a><ul>
<li class="chapter" data-level="6.2.3.1" data-path="NormalisationAllCellsTop.html"><a href="NormalisationAllCellsTop.html#apply-size-factors-1"><i class="fa fa-check"></i><b>6.2.3.1</b> Apply size factors</a></li>
<li class="chapter" data-level="6.2.3.2" data-path="NormalisationAllCellsTop.html"><a href="NormalisationAllCellsTop.html#save-object-1"><i class="fa fa-check"></i><b>6.2.3.2</b> Save object</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="NormalisationAllCellsTop.html"><a href="NormalisationAllCellsTop.html#sctransform"><i class="fa fa-check"></i><b>6.3</b> SCTransform</a><ul>
<li class="chapter" data-level="6.3.1" data-path="NormalisationAllCellsTop.html"><a href="NormalisationAllCellsTop.html#caron-1"><i class="fa fa-check"></i><b>6.3.1</b> Caron</a></li>
<li class="chapter" data-level="6.3.2" data-path="NormalisationAllCellsTop.html"><a href="NormalisationAllCellsTop.html#hca-1"><i class="fa fa-check"></i><b>6.3.2</b> Hca</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="NormalisationAllCellsTop.html"><a href="NormalisationAllCellsTop.html#session-information-2"><i class="fa fa-check"></i><b>6.4</b> Session information</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="normalisation-caron-set.html"><a href="normalisation-caron-set.html"><i class="fa fa-check"></i><b>7</b> Normalisation - Caron set</a><ul>
<li class="chapter" data-level="7.1" data-path="normalisation-caron-set.html"><a href="normalisation-caron-set.html#scaling-normalization"><i class="fa fa-check"></i><b>7.1</b> Scaling normalization</a><ul>
<li class="chapter" data-level="7.1.1" data-path="normalisation-caron-set.html"><a href="normalisation-caron-set.html#cpm"><i class="fa fa-check"></i><b>7.1.1</b> CPM</a></li>
<li class="chapter" data-level="7.1.2" data-path="normalisation-caron-set.html"><a href="normalisation-caron-set.html#deseqs-size-factor"><i class="fa fa-check"></i><b>7.1.2</b> DESeq’s size factor</a></li>
<li class="chapter" data-level="7.1.3" data-path="normalisation-caron-set.html"><a href="normalisation-caron-set.html#weighted-trimmed-mean-of-m-values"><i class="fa fa-check"></i><b>7.1.3</b> Weighted Trimmed mean of M-values</a></li>
<li class="chapter" data-level="7.1.4" data-path="normalisation-caron-set.html"><a href="normalisation-caron-set.html#library-size-normalization-2"><i class="fa fa-check"></i><b>7.1.4</b> Library size normalization</a></li>
<li class="chapter" data-level="7.1.5" data-path="normalisation-caron-set.html"><a href="normalisation-caron-set.html#deconvolution-2"><i class="fa fa-check"></i><b>7.1.5</b> Deconvolution</a><ul>
<li class="chapter" data-level="7.1.5.1" data-path="normalisation-caron-set.html"><a href="normalisation-caron-set.html#cluster-cells"><i class="fa fa-check"></i><b>7.1.5.1</b> Cluster cells</a></li>
<li class="chapter" data-level="7.1.5.2" data-path="normalisation-caron-set.html"><a href="normalisation-caron-set.html#compute-size-factors-2"><i class="fa fa-check"></i><b>7.1.5.2</b> Compute size factors</a></li>
<li class="chapter" data-level="7.1.5.3" data-path="normalisation-caron-set.html"><a href="normalisation-caron-set.html#apply-size-factors-2"><i class="fa fa-check"></i><b>7.1.5.3</b> Apply size factors</a></li>
<li class="chapter" data-level="7.1.5.4" data-path="normalisation-caron-set.html"><a href="normalisation-caron-set.html#save-object-2"><i class="fa fa-check"></i><b>7.1.5.4</b> Save object</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="normalisation-caron-set.html"><a href="normalisation-caron-set.html#sctransform-1"><i class="fa fa-check"></i><b>7.2</b> SCTransform</a><ul>
<li class="chapter" data-level="7.2.1" data-path="normalisation-caron-set.html"><a href="normalisation-caron-set.html#inspect-data"><i class="fa fa-check"></i><b>7.2.1</b> Inspect data</a></li>
<li class="chapter" data-level="7.2.2" data-path="normalisation-caron-set.html"><a href="normalisation-caron-set.html#transformation"><i class="fa fa-check"></i><b>7.2.2</b> Transformation</a></li>
<li class="chapter" data-level="7.2.3" data-path="normalisation-caron-set.html"><a href="normalisation-caron-set.html#save-sce-object"><i class="fa fa-check"></i><b>7.2.3</b> Save SCE object</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="normalisation-caron-set.html"><a href="normalisation-caron-set.html#visualisation"><i class="fa fa-check"></i><b>7.3</b> Visualisation</a><ul>
<li class="chapter" data-level="7.3.1" data-path="normalisation-caron-set.html"><a href="normalisation-caron-set.html#log-raw-counts"><i class="fa fa-check"></i><b>7.3.1</b> log raw counts</a></li>
<li class="chapter" data-level="7.3.2" data-path="normalisation-caron-set.html"><a href="normalisation-caron-set.html#log-cpm"><i class="fa fa-check"></i><b>7.3.2</b> log CPM</a></li>
<li class="chapter" data-level="7.3.3" data-path="normalisation-caron-set.html"><a href="normalisation-caron-set.html#scran"><i class="fa fa-check"></i><b>7.3.3</b> scran</a></li>
<li class="chapter" data-level="7.3.4" data-path="normalisation-caron-set.html"><a href="normalisation-caron-set.html#sctransform-2"><i class="fa fa-check"></i><b>7.3.4</b> SCTransform</a></li>
</ul></li>
<li class="chapter" data-level="7.4" data-path="normalisation-caron-set.html"><a href="normalisation-caron-set.html#session-information-3"><i class="fa fa-check"></i><b>7.4</b> Session information</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="NormalisationGSM3872434Top.html"><a href="NormalisationGSM3872434Top.html"><i class="fa fa-check"></i><b>8</b> Normalisation - GSM3872434 set</a><ul>
<li class="chapter" data-level="8.1" data-path="NormalisationGSM3872434Top.html"><a href="NormalisationGSM3872434Top.html#scaling-normalization-1"><i class="fa fa-check"></i><b>8.1</b> Scaling normalization</a><ul>
<li class="chapter" data-level="8.1.1" data-path="NormalisationGSM3872434Top.html"><a href="NormalisationGSM3872434Top.html#cpm-1"><i class="fa fa-check"></i><b>8.1.1</b> CPM</a></li>
<li class="chapter" data-level="8.1.2" data-path="NormalisationGSM3872434Top.html"><a href="NormalisationGSM3872434Top.html#deseqs-size-factor-1"><i class="fa fa-check"></i><b>8.1.2</b> DESeq’s size factor</a></li>
<li class="chapter" data-level="8.1.3" data-path="NormalisationGSM3872434Top.html"><a href="NormalisationGSM3872434Top.html#weighted-trimmed-mean-of-m-values-1"><i class="fa fa-check"></i><b>8.1.3</b> Weighted Trimmed mean of M-values</a></li>
<li class="chapter" data-level="8.1.4" data-path="NormalisationGSM3872434Top.html"><a href="NormalisationGSM3872434Top.html#library-size-factor-distribution"><i class="fa fa-check"></i><b>8.1.4</b> Library size factor distribution</a></li>
<li class="chapter" data-level="8.1.5" data-path="NormalisationGSM3872434Top.html"><a href="NormalisationGSM3872434Top.html#deconvolution-3"><i class="fa fa-check"></i><b>8.1.5</b> Deconvolution</a><ul>
<li class="chapter" data-level="8.1.5.1" data-path="NormalisationGSM3872434Top.html"><a href="NormalisationGSM3872434Top.html#cluster-cells-1"><i class="fa fa-check"></i><b>8.1.5.1</b> Cluster cells</a></li>
<li class="chapter" data-level="8.1.5.2" data-path="NormalisationGSM3872434Top.html"><a href="NormalisationGSM3872434Top.html#compute-size-factors-3"><i class="fa fa-check"></i><b>8.1.5.2</b> Compute size factors</a></li>
<li class="chapter" data-level="8.1.5.3" data-path="NormalisationGSM3872434Top.html"><a href="NormalisationGSM3872434Top.html#apply-size-factors-3"><i class="fa fa-check"></i><b>8.1.5.3</b> Apply size factors</a></li>
<li class="chapter" data-level="8.1.5.4" data-path="NormalisationGSM3872434Top.html"><a href="NormalisationGSM3872434Top.html#save-object-3"><i class="fa fa-check"></i><b>8.1.5.4</b> Save object</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="NormalisationGSM3872434Top.html"><a href="NormalisationGSM3872434Top.html#sctransform-3"><i class="fa fa-check"></i><b>8.2</b> SCTransform</a><ul>
<li class="chapter" data-level="8.2.1" data-path="NormalisationGSM3872434Top.html"><a href="NormalisationGSM3872434Top.html#inspect-data-1"><i class="fa fa-check"></i><b>8.2.1</b> Inspect data</a></li>
<li class="chapter" data-level="8.2.2" data-path="NormalisationGSM3872434Top.html"><a href="NormalisationGSM3872434Top.html#transformation-1"><i class="fa fa-check"></i><b>8.2.2</b> Transformation</a></li>
<li class="chapter" data-level="8.2.3" data-path="NormalisationGSM3872434Top.html"><a href="NormalisationGSM3872434Top.html#save-sce-object-1"><i class="fa fa-check"></i><b>8.2.3</b> Save SCE object</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="NormalisationGSM3872434Top.html"><a href="NormalisationGSM3872434Top.html#visualisation-1"><i class="fa fa-check"></i><b>8.3</b> Visualisation</a><ul>
<li class="chapter" data-level="8.3.1" data-path="NormalisationGSM3872434Top.html"><a href="NormalisationGSM3872434Top.html#log-raw-counts-1"><i class="fa fa-check"></i><b>8.3.1</b> log raw counts</a></li>
<li class="chapter" data-level="8.3.2" data-path="NormalisationGSM3872434Top.html"><a href="NormalisationGSM3872434Top.html#log-cpm-1"><i class="fa fa-check"></i><b>8.3.2</b> log CPM</a></li>
<li class="chapter" data-level="8.3.3" data-path="NormalisationGSM3872434Top.html"><a href="NormalisationGSM3872434Top.html#scran-1"><i class="fa fa-check"></i><b>8.3.3</b> scran</a></li>
<li class="chapter" data-level="8.3.4" data-path="NormalisationGSM3872434Top.html"><a href="NormalisationGSM3872434Top.html#sctransform-4"><i class="fa fa-check"></i><b>8.3.4</b> SCTransform</a></li>
</ul></li>
<li class="chapter" data-level="8.4" data-path="NormalisationGSM3872434Top.html"><a href="NormalisationGSM3872434Top.html#session-information-4"><i class="fa fa-check"></i><b>8.4</b> Session information</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="dimRedForVizTop.html"><a href="dimRedForVizTop.html"><i class="fa fa-check"></i><b>9</b> Dimensionality reduction for visualisation</a><ul>
<li class="chapter" data-level="9.1" data-path="dimRedForVizTop.html"><a href="dimRedForVizTop.html#principal-component-analysis"><i class="fa fa-check"></i><b>9.1</b> Principal Component Analysis</a><ul>
<li class="chapter" data-level="9.1.1" data-path="dimRedForVizTop.html"><a href="dimRedForVizTop.html#description"><i class="fa fa-check"></i><b>9.1.1</b> Description</a></li>
<li class="chapter" data-level="9.1.2" data-path="dimRedForVizTop.html"><a href="dimRedForVizTop.html#example-2"><i class="fa fa-check"></i><b>9.1.2</b> Example</a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="dimRedForVizTop.html"><a href="dimRedForVizTop.html#load-packages-2"><i class="fa fa-check"></i><b>9.2</b> Load packages</a></li>
<li class="chapter" data-level="9.3" data-path="dimRedForVizTop.html"><a href="dimRedForVizTop.html#load-data"><i class="fa fa-check"></i><b>9.3</b> Load data</a></li>
<li class="chapter" data-level="9.4" data-path="dimRedForVizTop.html"><a href="dimRedForVizTop.html#pca"><i class="fa fa-check"></i><b>9.4</b> PCA</a><ul>
<li class="chapter" data-level="9.4.1" data-path="dimRedForVizTop.html"><a href="dimRedForVizTop.html#correlation-between-pcs-and-the-total-number-of-features-detected"><i class="fa fa-check"></i><b>9.4.1</b> Correlation between PCs and the total number of features detected</a></li>
</ul></li>
<li class="chapter" data-level="9.5" data-path="dimRedForVizTop.html"><a href="dimRedForVizTop.html#t-sne-t-distributed-stochastic-neighbor-embedding"><i class="fa fa-check"></i><b>9.5</b> t-SNE: t-Distributed Stochastic Neighbor Embedding</a><ul>
<li class="chapter" data-level="9.5.1" data-path="dimRedForVizTop.html"><a href="dimRedForVizTop.html#perplexity"><i class="fa fa-check"></i><b>9.5.1</b> Perplexity</a></li>
<li class="chapter" data-level="9.5.2" data-path="dimRedForVizTop.html"><a href="dimRedForVizTop.html#stochasticity"><i class="fa fa-check"></i><b>9.5.2</b> Stochasticity</a></li>
</ul></li>
<li class="chapter" data-level="9.6" data-path="dimRedForVizTop.html"><a href="dimRedForVizTop.html#umap"><i class="fa fa-check"></i><b>9.6</b> UMAP</a></li>
<li class="chapter" data-level="9.7" data-path="dimRedForVizTop.html"><a href="dimRedForVizTop.html#session-information-5"><i class="fa fa-check"></i><b>9.7</b> Session information</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="identifying-confounding-factors-caron-set.html"><a href="identifying-confounding-factors-caron-set.html"><i class="fa fa-check"></i><b>10</b> Identifying confounding factors - Caron set</a><ul>
<li class="chapter" data-level="10.1" data-path="identifying-confounding-factors-caron-set.html"><a href="identifying-confounding-factors-caron-set.html#load-object"><i class="fa fa-check"></i><b>10.1</b> Load object</a></li>
<li class="chapter" data-level="10.2" data-path="identifying-confounding-factors-caron-set.html"><a href="identifying-confounding-factors-caron-set.html#pca-1"><i class="fa fa-check"></i><b>10.2</b> PCA</a></li>
<li class="chapter" data-level="10.3" data-path="identifying-confounding-factors-caron-set.html"><a href="identifying-confounding-factors-caron-set.html#normalised-counts"><i class="fa fa-check"></i><b>10.3</b> Normalised counts</a></li>
<li class="chapter" data-level="10.4" data-path="identifying-confounding-factors-caron-set.html"><a href="identifying-confounding-factors-caron-set.html#session-information-6"><i class="fa fa-check"></i><b>10.4</b> Session information</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="featSelecTop.html"><a href="featSelecTop.html"><i class="fa fa-check"></i><b>11</b> Feature selection</a><ul>
<li class="chapter" data-level="11.1" data-path="featSelecTop.html"><a href="featSelecTop.html#load-data-1"><i class="fa fa-check"></i><b>11.1</b> Load data</a></li>
<li class="chapter" data-level="11.2" data-path="featSelecTop.html"><a href="featSelecTop.html#feature-selection-with-scran"><i class="fa fa-check"></i><b>11.2</b> Feature selection with scran</a><ul>
<li class="chapter" data-level="11.2.1" data-path="featSelecTop.html"><a href="featSelecTop.html#modelling-and-removing-technical-noise"><i class="fa fa-check"></i><b>11.2.1</b> Modelling and removing technical noise</a></li>
<li class="chapter" data-level="11.2.2" data-path="featSelecTop.html"><a href="featSelecTop.html#choosing-some-hvgs"><i class="fa fa-check"></i><b>11.2.2</b> Choosing some HVGs</a></li>
</ul></li>
<li class="chapter" data-level="11.3" data-path="featSelecTop.html"><a href="featSelecTop.html#session-information-7"><i class="fa fa-check"></i><b>11.3</b> Session information</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="batch-correction-gsm3872442-set.html"><a href="batch-correction-gsm3872442-set.html"><i class="fa fa-check"></i><b>12</b> batch correction - GSM3872442 set</a><ul>
<li class="chapter" data-level="12.1" data-path="batch-correction-gsm3872442-set.html"><a href="batch-correction-gsm3872442-set.html#prepare-data"><i class="fa fa-check"></i><b>12.1</b> Prepare data</a></li>
<li class="chapter" data-level="12.2" data-path="batch-correction-gsm3872442-set.html"><a href="batch-correction-gsm3872442-set.html#normalise-each-separately-and-re-pool"><i class="fa fa-check"></i><b>12.2</b> Normalise each separately and re-pool</a></li>
<li class="chapter" data-level="12.3" data-path="batch-correction-gsm3872442-set.html"><a href="batch-correction-gsm3872442-set.html#normalise-batches-together"><i class="fa fa-check"></i><b>12.3</b> Normalise batches together</a></li>
<li class="chapter" data-level="12.4" data-path="batch-correction-gsm3872442-set.html"><a href="batch-correction-gsm3872442-set.html#batch-correction"><i class="fa fa-check"></i><b>12.4</b> Batch correction</a><ul>
<li class="chapter" data-level="12.4.1" data-path="batch-correction-gsm3872442-set.html"><a href="batch-correction-gsm3872442-set.html#gaussian-normal-linear-models"><i class="fa fa-check"></i><b>12.4.1</b> Gaussian (normal) linear models</a></li>
</ul></li>
<li class="chapter" data-level="12.5" data-path="batch-correction-gsm3872442-set.html"><a href="batch-correction-gsm3872442-set.html#sctransform-5"><i class="fa fa-check"></i><b>12.5</b> SCTransform</a><ul>
<li class="chapter" data-level="12.5.1" data-path="batch-correction-gsm3872442-set.html"><a href="batch-correction-gsm3872442-set.html#batch-only"><i class="fa fa-check"></i><b>12.5.1</b> Batch only</a></li>
<li class="chapter" data-level="12.5.2" data-path="batch-correction-gsm3872442-set.html"><a href="batch-correction-gsm3872442-set.html#both-library-size-and-batch"><i class="fa fa-check"></i><b>12.5.2</b> Both library size and batch</a></li>
</ul></li>
<li class="chapter" data-level="12.6" data-path="batch-correction-gsm3872442-set.html"><a href="batch-correction-gsm3872442-set.html#mnncorrect"><i class="fa fa-check"></i><b>12.6</b> mnnCorrect</a><ul>
<li class="chapter" data-level="12.6.1" data-path="batch-correction-gsm3872442-set.html"><a href="batch-correction-gsm3872442-set.html#check-presence-of-batch-effect"><i class="fa fa-check"></i><b>12.6.1</b> Check presence of batch effect</a></li>
<li class="chapter" data-level="12.6.2" data-path="batch-correction-gsm3872442-set.html"><a href="batch-correction-gsm3872442-set.html#correct-batch-effect-with-mnncorrect"><i class="fa fa-check"></i><b>12.6.2</b> Correct batch effect with mnnCorrect</a></li>
</ul></li>
<li class="chapter" data-level="12.7" data-path="batch-correction-gsm3872442-set.html"><a href="batch-correction-gsm3872442-set.html#fastmnn"><i class="fa fa-check"></i><b>12.7</b> fastMNN</a></li>
<li class="chapter" data-level="12.8" data-path="batch-correction-gsm3872442-set.html"><a href="batch-correction-gsm3872442-set.html#harmony"><i class="fa fa-check"></i><b>12.8</b> Harmony</a></li>
<li class="chapter" data-level="12.9" data-path="batch-correction-gsm3872442-set.html"><a href="batch-correction-gsm3872442-set.html#session-information-8"><i class="fa fa-check"></i><b>12.9</b> Session information</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="dimensionality-reduction-for-analysis.html"><a href="dimensionality-reduction-for-analysis.html"><i class="fa fa-check"></i><b>13</b> Dimensionality reduction for analysis</a><ul>
<li class="chapter" data-level="13.1" data-path="dimensionality-reduction-for-analysis.html"><a href="dimensionality-reduction-for-analysis.html#load-data-2"><i class="fa fa-check"></i><b>13.1</b> Load data</a></li>
<li class="chapter" data-level="13.2" data-path="dimensionality-reduction-for-analysis.html"><a href="dimensionality-reduction-for-analysis.html#denoising-expression-values-using-pca"><i class="fa fa-check"></i><b>13.2</b> Denoising expression values using PCA</a></li>
<li class="chapter" data-level="13.3" data-path="dimensionality-reduction-for-analysis.html"><a href="dimensionality-reduction-for-analysis.html#visualise-expression-patterns-of-some-hvgs"><i class="fa fa-check"></i><b>13.3</b> Visualise expression patterns of some HVGs</a></li>
<li class="chapter" data-level="13.4" data-path="dimensionality-reduction-for-analysis.html"><a href="dimensionality-reduction-for-analysis.html#session-information-9"><i class="fa fa-check"></i><b>13.4</b> Session information</a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="DataIntegrationPbmmcTop.html"><a href="DataIntegrationPbmmcTop.html"><i class="fa fa-check"></i><b>14</b> Data integration</a><ul>
<li class="chapter" data-level="14.1" data-path="DataIntegrationPbmmcTop.html"><a href="DataIntegrationPbmmcTop.html#abbreviations-1"><i class="fa fa-check"></i><b>14.1</b> Abbreviations</a></li>
<li class="chapter" data-level="14.2" data-path="DataIntegrationPbmmcTop.html"><a href="DataIntegrationPbmmcTop.html#motivation"><i class="fa fa-check"></i><b>14.2</b> Motivation</a></li>
<li class="chapter" data-level="14.3" data-path="DataIntegrationPbmmcTop.html"><a href="DataIntegrationPbmmcTop.html#loading-the-data"><i class="fa fa-check"></i><b>14.3</b> Loading the data</a></li>
<li class="chapter" data-level="14.4" data-path="DataIntegrationPbmmcTop.html"><a href="DataIntegrationPbmmcTop.html#diagnosing-batch-effects"><i class="fa fa-check"></i><b>14.4</b> Diagnosing batch effects</a></li>
<li class="chapter" data-level="14.5" data-path="DataIntegrationPbmmcTop.html"><a href="DataIntegrationPbmmcTop.html#linear-regression"><i class="fa fa-check"></i><b>14.5</b> Linear regression</a></li>
<li class="chapter" data-level="14.6" data-path="DataIntegrationPbmmcTop.html"><a href="DataIntegrationPbmmcTop.html#performing-mnn-correction"><i class="fa fa-check"></i><b>14.6</b> Performing MNN correction</a><ul>
<li class="chapter" data-level="14.6.1" data-path="DataIntegrationPbmmcTop.html"><a href="DataIntegrationPbmmcTop.html#algorithm-overview"><i class="fa fa-check"></i><b>14.6.1</b> Algorithm overview</a></li>
<li class="chapter" data-level="14.6.2" data-path="DataIntegrationPbmmcTop.html"><a href="DataIntegrationPbmmcTop.html#application-to-the-data"><i class="fa fa-check"></i><b>14.6.2</b> Application to the data</a></li>
<li class="chapter" data-level="14.6.3" data-path="DataIntegrationPbmmcTop.html"><a href="DataIntegrationPbmmcTop.html#correction-diagnostics"><i class="fa fa-check"></i><b>14.6.3</b> Correction diagnostics</a></li>
</ul></li>
<li class="chapter" data-level="14.7" data-path="DataIntegrationPbmmcTop.html"><a href="DataIntegrationPbmmcTop.html#preserving-biological-heterogeneity"><i class="fa fa-check"></i><b>14.7</b> Preserving biological heterogeneity</a><ul>
<li class="chapter" data-level="14.7.1" data-path="DataIntegrationPbmmcTop.html"><a href="DataIntegrationPbmmcTop.html#comparison-to-within-batch-clusters"><i class="fa fa-check"></i><b>14.7.1</b> Comparison to within-batch clusters</a></li>
<li class="chapter" data-level="14.7.2" data-path="DataIntegrationPbmmcTop.html"><a href="DataIntegrationPbmmcTop.html#encouraging-consistency-with-marker-genes"><i class="fa fa-check"></i><b>14.7.2</b> Encouraging consistency with marker genes</a></li>
</ul></li>
<li class="chapter" data-level="14.8" data-path="DataIntegrationPbmmcTop.html"><a href="DataIntegrationPbmmcTop.html#session-information-10"><i class="fa fa-check"></i><b>14.8</b> Session information</a></li>
</ul></li>
<li class="chapter" data-level="15" data-path="dataSetIntegration-ETV6-RUNX1Top.html"><a href="dataSetIntegration-ETV6-RUNX1Top.html"><i class="fa fa-check"></i><b>15</b> Data integration</a><ul>
<li class="chapter" data-level="15.1" data-path="dataSetIntegration-ETV6-RUNX1Top.html"><a href="dataSetIntegration-ETV6-RUNX1Top.html#abbreviations-2"><i class="fa fa-check"></i><b>15.1</b> Abbreviations</a></li>
<li class="chapter" data-level="15.2" data-path="dataSetIntegration-ETV6-RUNX1Top.html"><a href="dataSetIntegration-ETV6-RUNX1Top.html#motivation-1"><i class="fa fa-check"></i><b>15.2</b> Motivation</a></li>
<li class="chapter" data-level="15.3" data-path="dataSetIntegration-ETV6-RUNX1Top.html"><a href="dataSetIntegration-ETV6-RUNX1Top.html#load-data-3"><i class="fa fa-check"></i><b>15.3</b> Load data</a></li>
<li class="chapter" data-level="15.4" data-path="dataSetIntegration-ETV6-RUNX1Top.html"><a href="dataSetIntegration-ETV6-RUNX1Top.html#loading-the-data-1"><i class="fa fa-check"></i><b>15.4</b> Loading the data</a></li>
<li class="chapter" data-level="15.5" data-path="dataSetIntegration-ETV6-RUNX1Top.html"><a href="dataSetIntegration-ETV6-RUNX1Top.html#diagnosing-batch-effects-1"><i class="fa fa-check"></i><b>15.5</b> Diagnosing batch effects</a></li>
<li class="chapter" data-level="15.6" data-path="dataSetIntegration-ETV6-RUNX1Top.html"><a href="dataSetIntegration-ETV6-RUNX1Top.html#linear-regression-1"><i class="fa fa-check"></i><b>15.6</b> Linear regression</a></li>
<li class="chapter" data-level="15.7" data-path="dataSetIntegration-ETV6-RUNX1Top.html"><a href="dataSetIntegration-ETV6-RUNX1Top.html#performing-mnn-correction-1"><i class="fa fa-check"></i><b>15.7</b> Performing MNN correction</a><ul>
<li class="chapter" data-level="15.7.1" data-path="dataSetIntegration-ETV6-RUNX1Top.html"><a href="dataSetIntegration-ETV6-RUNX1Top.html#algorithm-overview-1"><i class="fa fa-check"></i><b>15.7.1</b> Algorithm overview</a></li>
<li class="chapter" data-level="15.7.2" data-path="dataSetIntegration-ETV6-RUNX1Top.html"><a href="dataSetIntegration-ETV6-RUNX1Top.html#application-to-the-data-1"><i class="fa fa-check"></i><b>15.7.2</b> Application to the data</a></li>
</ul></li>
<li class="chapter" data-level="15.8" data-path="dataSetIntegration-ETV6-RUNX1Top.html"><a href="dataSetIntegration-ETV6-RUNX1Top.html#correction-diagnostics-1"><i class="fa fa-check"></i><b>15.8</b> Correction diagnostics</a><ul>
<li class="chapter" data-level="15.8.1" data-path="dataSetIntegration-ETV6-RUNX1Top.html"><a href="dataSetIntegration-ETV6-RUNX1Top.html#mixing-between-batches"><i class="fa fa-check"></i><b>15.8.1</b> Mixing between batches</a></li>
<li class="chapter" data-level="15.8.2" data-path="dataSetIntegration-ETV6-RUNX1Top.html"><a href="dataSetIntegration-ETV6-RUNX1Top.html#preserving-biological-heterogeneity-1"><i class="fa fa-check"></i><b>15.8.2</b> Preserving biological heterogeneity</a><ul>
<li class="chapter" data-level="15.8.2.1" data-path="dataSetIntegration-ETV6-RUNX1Top.html"><a href="dataSetIntegration-ETV6-RUNX1Top.html#comparison-between-within-batch-clusters-and-across-batch-clusters-obtained-after-mnn-correction"><i class="fa fa-check"></i><b>15.8.2.1</b> Comparison between within-batch clusters and across-batch clusters obtained after MNN correction</a></li>
<li class="chapter" data-level="15.8.2.2" data-path="dataSetIntegration-ETV6-RUNX1Top.html"><a href="dataSetIntegration-ETV6-RUNX1Top.html#coassignment-probabilities"><i class="fa fa-check"></i><b>15.8.2.2</b> Coassignment probabilities</a></li>
<li class="chapter" data-level="15.8.2.3" data-path="dataSetIntegration-ETV6-RUNX1Top.html"><a href="dataSetIntegration-ETV6-RUNX1Top.html#rand-index"><i class="fa fa-check"></i><b>15.8.2.3</b> Rand index</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="15.9" data-path="dataSetIntegration-ETV6-RUNX1Top.html"><a href="dataSetIntegration-ETV6-RUNX1Top.html#encouraging-consistency-with-marker-genes-1"><i class="fa fa-check"></i><b>15.9</b> Encouraging consistency with marker genes</a></li>
</ul></li>
<li class="chapter" data-level="16" data-path="dataSetIntegration-HHDTop.html"><a href="dataSetIntegration-HHDTop.html"><i class="fa fa-check"></i><b>16</b> Data integration</a><ul>
<li class="chapter" data-level="16.1" data-path="dataSetIntegration-HHDTop.html"><a href="dataSetIntegration-HHDTop.html#abbreviations-3"><i class="fa fa-check"></i><b>16.1</b> Abbreviations</a></li>
<li class="chapter" data-level="16.2" data-path="dataSetIntegration-HHDTop.html"><a href="dataSetIntegration-HHDTop.html#motivation-2"><i class="fa fa-check"></i><b>16.2</b> Motivation</a></li>
<li class="chapter" data-level="16.3" data-path="dataSetIntegration-HHDTop.html"><a href="dataSetIntegration-HHDTop.html#load-data-4"><i class="fa fa-check"></i><b>16.3</b> Load data</a></li>
<li class="chapter" data-level="16.4" data-path="dataSetIntegration-HHDTop.html"><a href="dataSetIntegration-HHDTop.html#loading-the-data-2"><i class="fa fa-check"></i><b>16.4</b> Loading the data</a></li>
<li class="chapter" data-level="16.5" data-path="dataSetIntegration-HHDTop.html"><a href="dataSetIntegration-HHDTop.html#diagnosing-batch-effects-2"><i class="fa fa-check"></i><b>16.5</b> Diagnosing batch effects</a></li>
<li class="chapter" data-level="16.6" data-path="dataSetIntegration-HHDTop.html"><a href="dataSetIntegration-HHDTop.html#linear-regression-2"><i class="fa fa-check"></i><b>16.6</b> Linear regression</a></li>
<li class="chapter" data-level="16.7" data-path="dataSetIntegration-HHDTop.html"><a href="dataSetIntegration-HHDTop.html#performing-mnn-correction-2"><i class="fa fa-check"></i><b>16.7</b> Performing MNN correction</a><ul>
<li class="chapter" data-level="16.7.1" data-path="dataSetIntegration-HHDTop.html"><a href="dataSetIntegration-HHDTop.html#algorithm-overview-2"><i class="fa fa-check"></i><b>16.7.1</b> Algorithm overview</a></li>
<li class="chapter" data-level="16.7.2" data-path="dataSetIntegration-HHDTop.html"><a href="dataSetIntegration-HHDTop.html#application-to-the-data-2"><i class="fa fa-check"></i><b>16.7.2</b> Application to the data</a></li>
</ul></li>
<li class="chapter" data-level="16.8" data-path="dataSetIntegration-HHDTop.html"><a href="dataSetIntegration-HHDTop.html#correction-diagnostics-2"><i class="fa fa-check"></i><b>16.8</b> Correction diagnostics</a><ul>
<li class="chapter" data-level="16.8.1" data-path="dataSetIntegration-HHDTop.html"><a href="dataSetIntegration-HHDTop.html#mixing-between-batches-1"><i class="fa fa-check"></i><b>16.8.1</b> Mixing between batches</a></li>
<li class="chapter" data-level="16.8.2" data-path="dataSetIntegration-HHDTop.html"><a href="dataSetIntegration-HHDTop.html#preserving-biological-heterogeneity-2"><i class="fa fa-check"></i><b>16.8.2</b> Preserving biological heterogeneity</a><ul>
<li class="chapter" data-level="16.8.2.1" data-path="dataSetIntegration-HHDTop.html"><a href="dataSetIntegration-HHDTop.html#comparison-between-within-batch-clusters-and-across-batch-clusters-obtained-after-mnn-correction-1"><i class="fa fa-check"></i><b>16.8.2.1</b> Comparison between within-batch clusters and across-batch clusters obtained after MNN correction</a></li>
<li class="chapter" data-level="16.8.2.2" data-path="dataSetIntegration-HHDTop.html"><a href="dataSetIntegration-HHDTop.html#coassignment-probabilities-1"><i class="fa fa-check"></i><b>16.8.2.2</b> Coassignment probabilities</a></li>
<li class="chapter" data-level="16.8.2.3" data-path="dataSetIntegration-HHDTop.html"><a href="dataSetIntegration-HHDTop.html#rand-index-1"><i class="fa fa-check"></i><b>16.8.2.3</b> Rand index</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="16.9" data-path="dataSetIntegration-HHDTop.html"><a href="dataSetIntegration-HHDTop.html#encouraging-consistency-with-marker-genes-2"><i class="fa fa-check"></i><b>16.9</b> Encouraging consistency with marker genes</a></li>
</ul></li>
<li class="chapter" data-level="17" data-path="data-integration.html"><a href="data-integration.html"><i class="fa fa-check"></i><b>17</b> Data integration</a><ul>
<li class="chapter" data-level="17.1" data-path="data-integration.html"><a href="data-integration.html#abbreviations-4"><i class="fa fa-check"></i><b>17.1</b> Abbreviations</a></li>
<li class="chapter" data-level="17.2" data-path="data-integration.html"><a href="data-integration.html#motivation-3"><i class="fa fa-check"></i><b>17.2</b> Motivation</a></li>
<li class="chapter" data-level="17.3" data-path="data-integration.html"><a href="data-integration.html#load-data-5"><i class="fa fa-check"></i><b>17.3</b> Load data</a></li>
<li class="chapter" data-level="17.4" data-path="data-integration.html"><a href="data-integration.html#loading-the-data-3"><i class="fa fa-check"></i><b>17.4</b> Loading the data</a></li>
<li class="chapter" data-level="17.5" data-path="data-integration.html"><a href="data-integration.html#diagnosing-batch-effects-3"><i class="fa fa-check"></i><b>17.5</b> Diagnosing batch effects</a></li>
<li class="chapter" data-level="17.6" data-path="data-integration.html"><a href="data-integration.html#linear-regression-3"><i class="fa fa-check"></i><b>17.6</b> Linear regression</a></li>
<li class="chapter" data-level="17.7" data-path="data-integration.html"><a href="data-integration.html#performing-mnn-correction-3"><i class="fa fa-check"></i><b>17.7</b> Performing MNN correction</a><ul>
<li class="chapter" data-level="17.7.1" data-path="data-integration.html"><a href="data-integration.html#algorithm-overview-3"><i class="fa fa-check"></i><b>17.7.1</b> Algorithm overview</a></li>
<li class="chapter" data-level="17.7.2" data-path="data-integration.html"><a href="data-integration.html#application-to-the-data-3"><i class="fa fa-check"></i><b>17.7.2</b> Application to the data</a></li>
</ul></li>
<li class="chapter" data-level="17.8" data-path="data-integration.html"><a href="data-integration.html#correction-diagnostics-3"><i class="fa fa-check"></i><b>17.8</b> Correction diagnostics</a><ul>
<li class="chapter" data-level="17.8.1" data-path="data-integration.html"><a href="data-integration.html#mixing-between-batches-2"><i class="fa fa-check"></i><b>17.8.1</b> Mixing between batches</a></li>
<li class="chapter" data-level="17.8.2" data-path="data-integration.html"><a href="data-integration.html#preserving-biological-heterogeneity-3"><i class="fa fa-check"></i><b>17.8.2</b> Preserving biological heterogeneity</a><ul>
<li class="chapter" data-level="17.8.2.1" data-path="data-integration.html"><a href="data-integration.html#comparison-between-within-batch-clusters-and-across-batch-clusters-obtained-after-mnn-correction-2"><i class="fa fa-check"></i><b>17.8.2.1</b> Comparison between within-batch clusters and across-batch clusters obtained after MNN correction</a></li>
<li class="chapter" data-level="17.8.2.2" data-path="data-integration.html"><a href="data-integration.html#coassignment-probabilities-2"><i class="fa fa-check"></i><b>17.8.2.2</b> Coassignment probabilities</a></li>
<li class="chapter" data-level="17.8.2.3" data-path="data-integration.html"><a href="data-integration.html#rand-index-2"><i class="fa fa-check"></i><b>17.8.2.3</b> Rand index</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="17.9" data-path="data-integration.html"><a href="data-integration.html#encouraging-consistency-with-marker-genes-3"><i class="fa fa-check"></i><b>17.9</b> Encouraging consistency with marker genes</a></li>
</ul></li>
<li class="chapter" data-level="18" data-path="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html"><i class="fa fa-check"></i><b>18</b> Data integration</a><ul>
<li class="chapter" data-level="18.1" data-path="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#abbreviations-5"><i class="fa fa-check"></i><b>18.1</b> Abbreviations</a></li>
<li class="chapter" data-level="18.2" data-path="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#motivation-4"><i class="fa fa-check"></i><b>18.2</b> Motivation</a></li>
<li class="chapter" data-level="18.3" data-path="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#load-data-6"><i class="fa fa-check"></i><b>18.3</b> Load data</a></li>
<li class="chapter" data-level="18.4" data-path="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#loading-the-data-4"><i class="fa fa-check"></i><b>18.4</b> Loading the data</a></li>
<li class="chapter" data-level="18.5" data-path="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#diagnosing-batch-effects-4"><i class="fa fa-check"></i><b>18.5</b> Diagnosing batch effects</a></li>
<li class="chapter" data-level="18.6" data-path="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#linear-regression-4"><i class="fa fa-check"></i><b>18.6</b> Linear regression</a></li>
<li class="chapter" data-level="18.7" data-path="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#performing-mnn-correction-4"><i class="fa fa-check"></i><b>18.7</b> Performing MNN correction</a><ul>
<li class="chapter" data-level="18.7.1" data-path="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#algorithm-overview-4"><i class="fa fa-check"></i><b>18.7.1</b> Algorithm overview</a></li>
<li class="chapter" data-level="18.7.2" data-path="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#application-to-the-data-4"><i class="fa fa-check"></i><b>18.7.2</b> Application to the data</a></li>
</ul></li>
<li class="chapter" data-level="18.8" data-path="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#correction-diagnostics-4"><i class="fa fa-check"></i><b>18.8</b> Correction diagnostics</a><ul>
<li class="chapter" data-level="18.8.1" data-path="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#mixing-between-batches-3"><i class="fa fa-check"></i><b>18.8.1</b> Mixing between batches</a></li>
<li class="chapter" data-level="18.8.2" data-path="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#preserving-biological-heterogeneity-4"><i class="fa fa-check"></i><b>18.8.2</b> Preserving biological heterogeneity</a><ul>
<li class="chapter" data-level="18.8.2.1" data-path="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#comparison-between-within-batch-clusters-and-across-batch-clusters-obtained-after-mnn-correction-3"><i class="fa fa-check"></i><b>18.8.2.1</b> Comparison between within-batch clusters and across-batch clusters obtained after MNN correction</a></li>
<li class="chapter" data-level="18.8.2.2" data-path="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#coassignment-probabilities-3"><i class="fa fa-check"></i><b>18.8.2.2</b> Coassignment probabilities</a></li>
<li class="chapter" data-level="18.8.2.3" data-path="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#rand-index-3"><i class="fa fa-check"></i><b>18.8.2.3</b> Rand index</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="18.9" data-path="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#encouraging-consistency-with-marker-genes-4"><i class="fa fa-check"></i><b>18.9</b> Encouraging consistency with marker genes</a></li>
<li class="chapter" data-level="18.10" data-path="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html"><a href="dataSetIntegration-PBMMC-ETV6-RUNX1Top.html#identify-clusters-with-pbmmc-cells"><i class="fa fa-check"></i><b>18.10</b> Identify clusters with PBMMC cells</a></li>
</ul></li>
<li class="chapter" data-level="19" data-path="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html"><a href="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html"><i class="fa fa-check"></i><b>19</b> Clustering with ‘’PBMMC,ETV6-RUNX1’’ and ’_5hCellPerSpl’ {#clustering’PBMMC_ETV6-RUNX1__5hCellPerSpl’Top}</a><ul>
<li class="chapter" data-level="19.1" data-path="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html"><a href="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html#load-data-7"><i class="fa fa-check"></i><b>19.1</b> Load data</a></li>
<li class="chapter" data-level="19.2" data-path="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html"><a href="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html#clustering-cells-into-putative-subpopulations"><i class="fa fa-check"></i><b>19.2</b> Clustering cells into putative subpopulations</a><ul>
<li class="chapter" data-level="19.2.1" data-path="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html"><a href="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html#defining-cell-clusters-from-expression-data"><i class="fa fa-check"></i><b>19.2.1</b> Defining cell clusters from expression data</a><ul>
<li class="chapter" data-level="19.2.1.1" data-path="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html"><a href="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html#hierarchical-clustering"><i class="fa fa-check"></i><b>19.2.1.1</b> Hierarchical clustering</a><ul>
<li class="chapter" data-level="19.2.1.1.1" data-path="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html"><a href="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html#clustering"><i class="fa fa-check"></i><b>19.2.1.1.1</b> Clustering</a></li>
<li class="chapter" data-level="19.2.1.1.2" data-path="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html"><a href="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html#separatedness"><i class="fa fa-check"></i><b>19.2.1.1.2</b> Separatedness</a></li>
</ul></li>
<li class="chapter" data-level="19.2.1.2" data-path="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html"><a href="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html#k-means"><i class="fa fa-check"></i><b>19.2.1.2</b> k-means</a><ul>
<li class="chapter" data-level="19.2.1.2.1" data-path="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html"><a href="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html#description-1"><i class="fa fa-check"></i><b>19.2.1.2.1</b> Description</a></li>
<li class="chapter" data-level="19.2.1.2.2" data-path="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html"><a href="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html#example-3"><i class="fa fa-check"></i><b>19.2.1.2.2</b> Example</a></li>
<li class="chapter" data-level="19.2.1.2.3" data-path="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html"><a href="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html#within-cluster-sum-of-squares"><i class="fa fa-check"></i><b>19.2.1.2.3</b> Within-cluster sum-of-squares</a></li>
<li class="chapter" data-level="19.2.1.2.4" data-path="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html"><a href="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html#silhouette"><i class="fa fa-check"></i><b>19.2.1.2.4</b> Silhouette</a></li>
<li class="chapter" data-level="19.2.1.2.5" data-path="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html"><a href="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html#gap-statistic"><i class="fa fa-check"></i><b>19.2.1.2.5</b> Gap statistic</a></li>
<li class="chapter" data-level="19.2.1.2.6" data-path="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html"><a href="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html#multi-metric"><i class="fa fa-check"></i><b>19.2.1.2.6</b> Multi-metric</a></li>
</ul></li>
<li class="chapter" data-level="19.2.1.3" data-path="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html"><a href="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html#graph-based-clustering"><i class="fa fa-check"></i><b>19.2.1.3</b> Graph-based clustering</a><ul>
<li class="chapter" data-level="19.2.1.3.1" data-path="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html"><a href="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html#modularity"><i class="fa fa-check"></i><b>19.2.1.3.1</b> Modularity</a></li>
<li class="chapter" data-level="19.2.1.3.2" data-path="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html"><a href="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html#community-detection-via-short-random-walks-walktrap"><i class="fa fa-check"></i><b>19.2.1.3.2</b> Community detection via short random walks: ‘walktrap’</a></li>
<li class="chapter" data-level="19.2.1.3.3" data-path="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html"><a href="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html#community-detection-with-the-louvain-method"><i class="fa fa-check"></i><b>19.2.1.3.3</b> Community detection with the ‘Louvain’ method</a></li>
<li class="chapter" data-level="19.2.1.3.4" data-path="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html"><a href="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html#community-detection-with-the-leiden-method"><i class="fa fa-check"></i><b>19.2.1.3.4</b> Community detection with the ‘Leiden’ method</a></li>
<li class="chapter" data-level="19.2.1.3.5" data-path="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html"><a href="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html#choose-the-number-of-clusters"><i class="fa fa-check"></i><b>19.2.1.3.5</b> Choose the number of clusters</a></li>
</ul></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="19.3" data-path="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html"><a href="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html#comparing-two-sets-of-clusters"><i class="fa fa-check"></i><b>19.3</b> Comparing two sets of clusters</a></li>
<li class="chapter" data-level="19.4" data-path="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html"><a href="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html#expression-of-known-marker-genes"><i class="fa fa-check"></i><b>19.4</b> Expression of known marker genes</a></li>
<li class="chapter" data-level="19.5" data-path="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html"><a href="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html#save-data"><i class="fa fa-check"></i><b>19.5</b> Save data</a></li>
<li class="chapter" data-level="19.6" data-path="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html"><a href="clustering-with-pbmmcetv6-runx1-and-5hcellperspl-clusteringpbmmc-etv6-runx1-5hcellperspltop.html#session-information-11"><i class="fa fa-check"></i><b>19.6</b> Session information</a></li>
</ul></li>
<li class="chapter" data-level="20" data-path="cluster-marker-genes.html"><a href="cluster-marker-genes.html"><i class="fa fa-check"></i><b>20</b> Cluster marker genes</a><ul>
<li class="chapter" data-level="20.1" data-path="cluster-marker-genes.html"><a href="cluster-marker-genes.html#learning-objectives"><i class="fa fa-check"></i><b>20.1</b> Learning objectives</a></li>
<li class="chapter" data-level="20.2" data-path="cluster-marker-genes.html"><a href="cluster-marker-genes.html#load-data-8"><i class="fa fa-check"></i><b>20.2</b> Load data</a></li>
<li class="chapter" data-level="20.3" data-path="cluster-marker-genes.html"><a href="cluster-marker-genes.html#detecting-genes-differentially-expressed-between-clusters"><i class="fa fa-check"></i><b>20.3</b> Detecting genes differentially expressed between clusters</a><ul>
<li class="chapter" data-level="20.3.1" data-path="cluster-marker-genes.html"><a href="cluster-marker-genes.html#differential-expression-analysis"><i class="fa fa-check"></i><b>20.3.1</b> Differential expression analysis</a></li>
<li class="chapter" data-level="20.3.2" data-path="cluster-marker-genes.html"><a href="cluster-marker-genes.html#heatmap"><i class="fa fa-check"></i><b>20.3.2</b> Heatmap</a></li>
</ul></li>
<li class="chapter" data-level="20.4" data-path="cluster-marker-genes.html"><a href="cluster-marker-genes.html#using-the-log-fold-change"><i class="fa fa-check"></i><b>20.4</b> Using the log-fold change</a></li>
<li class="chapter" data-level="20.5" data-path="cluster-marker-genes.html"><a href="cluster-marker-genes.html#finding-cluster-specific-markers"><i class="fa fa-check"></i><b>20.5</b> Finding cluster-specific markers</a></li>
<li class="chapter" data-level="20.6" data-path="cluster-marker-genes.html"><a href="cluster-marker-genes.html#using-the-wilcoxon-rank-sum-test"><i class="fa fa-check"></i><b>20.6</b> Using the Wilcoxon rank sum test</a></li>
<li class="chapter" data-level="20.7" data-path="cluster-marker-genes.html"><a href="cluster-marker-genes.html#using-a-binomial-test"><i class="fa fa-check"></i><b>20.7</b> Using a binomial test</a></li>
<li class="chapter" data-level="20.8" data-path="cluster-marker-genes.html"><a href="cluster-marker-genes.html#combining-multiple-marker-statistics"><i class="fa fa-check"></i><b>20.8</b> Combining multiple marker statistics</a></li>
<li class="chapter" data-level="20.9" data-path="cluster-marker-genes.html"><a href="cluster-marker-genes.html#invalidity-of-p-values"><i class="fa fa-check"></i><b>20.9</b> Invalidity of p-values</a><ul>
<li class="chapter" data-level="20.9.1" data-path="cluster-marker-genes.html"><a href="cluster-marker-genes.html#from-data-snooping"><i class="fa fa-check"></i><b>20.9.1</b> 11.5.1 From data snooping</a></li>
<li class="chapter" data-level="20.9.2" data-path="cluster-marker-genes.html"><a href="cluster-marker-genes.html#nature-of-replication"><i class="fa fa-check"></i><b>20.9.2</b> Nature of replication</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="21" data-path="cellCyclePhasesTop.html"><a href="cellCyclePhasesTop.html"><i class="fa fa-check"></i><b>21</b> Cell cycle assignment</a><ul>
<li class="chapter" data-level="21.1" data-path="cellCyclePhasesTop.html"><a href="cellCyclePhasesTop.html#load-data-9"><i class="fa fa-check"></i><b>21.1</b> Load data</a></li>
<li class="chapter" data-level="21.2" data-path="cellCyclePhasesTop.html"><a href="cellCyclePhasesTop.html#motivation-5"><i class="fa fa-check"></i><b>21.2</b> Motivation</a></li>
<li class="chapter" data-level="21.3" data-path="cellCyclePhasesTop.html"><a href="cellCyclePhasesTop.html#using-the-cyclins"><i class="fa fa-check"></i><b>21.3</b> Using the cyclins</a></li>
<li class="chapter" data-level="21.4" data-path="cellCyclePhasesTop.html"><a href="cellCyclePhasesTop.html#using-the-cyclone-classifier"><i class="fa fa-check"></i><b>21.4</b> Using the cyclone() classifier</a></li>
<li class="chapter" data-level="21.5" data-path="cellCyclePhasesTop.html"><a href="cellCyclePhasesTop.html#regressing-out-cell-cycle-phase"><i class="fa fa-check"></i><b>21.5</b> Regressing out cell cycle phase</a></li>
</ul></li>
<li class="chapter" data-level="22" data-path="differential-expression-and-abundance-between-conditions.html"><a href="differential-expression-and-abundance-between-conditions.html"><i class="fa fa-check"></i><b>22</b> Differential expression and abundance between conditions</a><ul>
<li class="chapter" data-level="22.1" data-path="differential-expression-and-abundance-between-conditions.html"><a href="differential-expression-and-abundance-between-conditions.html#motivation-6"><i class="fa fa-check"></i><b>22.1</b> Motivation</a></li>
<li class="chapter" data-level="22.2" data-path="differential-expression-and-abundance-between-conditions.html"><a href="differential-expression-and-abundance-between-conditions.html#setting-up-the-data"><i class="fa fa-check"></i><b>22.2</b> Setting up the data</a></li>
<li class="chapter" data-level="22.3" data-path="differential-expression-and-abundance-between-conditions.html"><a href="differential-expression-and-abundance-between-conditions.html#differential-expression-between-conditions"><i class="fa fa-check"></i><b>22.3</b> Differential expression between conditions</a><ul>
<li class="chapter" data-level="22.3.1" data-path="differential-expression-and-abundance-between-conditions.html"><a href="differential-expression-and-abundance-between-conditions.html#creating-pseudo-bulk-samples"><i class="fa fa-check"></i><b>22.3.1</b> Creating pseudo-bulk samples</a></li>
<li class="chapter" data-level="22.3.2" data-path="differential-expression-and-abundance-between-conditions.html"><a href="differential-expression-and-abundance-between-conditions.html#performing-the-de-analysis"><i class="fa fa-check"></i><b>22.3.2</b> Performing the DE analysis</a><ul>
<li class="chapter" data-level="22.3.2.1" data-path="differential-expression-and-abundance-between-conditions.html"><a href="differential-expression-and-abundance-between-conditions.html#introduction-4"><i class="fa fa-check"></i><b>22.3.2.1</b> Introduction</a></li>
<li class="chapter" data-level="22.3.2.2" data-path="differential-expression-and-abundance-between-conditions.html"><a href="differential-expression-and-abundance-between-conditions.html#pre-processing"><i class="fa fa-check"></i><b>22.3.2.2</b> Pre-processing</a></li>
<li class="chapter" data-level="22.3.2.3" data-path="differential-expression-and-abundance-between-conditions.html"><a href="differential-expression-and-abundance-between-conditions.html#statistical-modelling"><i class="fa fa-check"></i><b>22.3.2.3</b> Statistical modelling</a></li>
<li class="chapter" data-level="22.3.2.4" data-path="differential-expression-and-abundance-between-conditions.html"><a href="differential-expression-and-abundance-between-conditions.html#differential-expression-for-each-cluster"><i class="fa fa-check"></i><b>22.3.2.4</b> Differential expression for each cluster</a><ul>
<li class="chapter" data-level="22.3.2.4.1" data-path="differential-expression-and-abundance-between-conditions.html"><a href="differential-expression-and-abundance-between-conditions.html#number-of-degs-by-cluster-and-direction"><i class="fa fa-check"></i><b>22.3.2.4.1</b> Number of DEGs by cluster and direction</a></li>
<li class="chapter" data-level="22.3.2.4.2" data-path="differential-expression-and-abundance-between-conditions.html"><a href="differential-expression-and-abundance-between-conditions.html#list-of-degs"><i class="fa fa-check"></i><b>22.3.2.4.2</b> List of DEGs</a></li>
<li class="chapter" data-level="22.3.2.4.3" data-path="differential-expression-and-abundance-between-conditions.html"><a href="differential-expression-and-abundance-between-conditions.html#number-of-clusters-skipped"><i class="fa fa-check"></i><b>22.3.2.4.3</b> Number of clusters skipped</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="22.3.3" data-path="differential-expression-and-abundance-between-conditions.html"><a href="differential-expression-and-abundance-between-conditions.html#putting-it-all-together"><i class="fa fa-check"></i><b>22.3.3</b> Putting it all together</a></li>
</ul></li>
<li class="chapter" data-level="22.4" data-path="differential-expression-and-abundance-between-conditions.html"><a href="differential-expression-and-abundance-between-conditions.html#differential-abundance-between-conditions"><i class="fa fa-check"></i><b>22.4</b> Differential abundance between conditions</a><ul>
<li class="chapter" data-level="22.4.1" data-path="differential-expression-and-abundance-between-conditions.html"><a href="differential-expression-and-abundance-between-conditions.html#overview"><i class="fa fa-check"></i><b>22.4.1</b> Overview</a></li>
<li class="chapter" data-level="22.4.2" data-path="differential-expression-and-abundance-between-conditions.html"><a href="differential-expression-and-abundance-between-conditions.html#handling-composition-effects"><i class="fa fa-check"></i><b>22.4.2</b> Handling composition effects</a><ul>
<li class="chapter" data-level="22.4.2.1" data-path="differential-expression-and-abundance-between-conditions.html"><a href="differential-expression-and-abundance-between-conditions.html#background"><i class="fa fa-check"></i><b>22.4.2.1</b> Background</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="22.5" data-path="differential-expression-and-abundance-between-conditions.html"><a href="differential-expression-and-abundance-between-conditions.html#session-information-12"><i class="fa fa-check"></i><b>22.5</b> Session information</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">CRUK Bioinformatics Summer School 2020 - single-cell RNA-seq analysis</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="PreProcAllCellsTop" class="section level1">
<h1><span class="header-section-number">Chapter 4</span> Quality Control</h1>
<div id="introduction-2" class="section level2">
<h2><span class="header-section-number">4.1</span> Introduction</h2>
<!--
OSCA chapter 6 Quality Control
-->
<p>We will use two sets of Bone Marrow Mononuclear Cells (BMMC):</p>
<ul>
<li>‘CaronBourque2020’: pediatric samples</li>
<li>‘Hca’: HCA Census of Immune Cells for adult BMMCs</li>
</ul>
<p>Fastq files were retrieved from publicly available archive (SRA and HCA).</p>
<p>Sequencing quality was assessed and visualised using fastQC and MultiQC.</p>
<p>Reads were aligned against GRCh38 and features counted using cellranger (v3.1.0).</p>
<p>We will now check the quality of the data further:</p>
<ul>
<li>mapping quality and amplification rate</li>
<li>cell counts</li>
<li>distribution of keys quality metrics</li>
</ul>
<p>We will then:</p>
<ul>
<li>filter genes with very low expression</li>
<li>identify low-quality cells</li>
<li>filter and/or mark low quality cells</li>
</ul>
<!-- TODO:
- add references and/or links
- add code used to fetch the data or point to script or have chapter for retrieval+QC and for cellranger
-->
</div>
<div id="load-packages" class="section level2">
<h2><span class="header-section-number">4.2</span> Load packages</h2>
<ul>
<li>SingleCellExperiment - to store the data</li>
<li>Matrix - to deal with sparse and/or large matrices</li>
<li>DropletUtils - utilities for the analysis of droplet-based, inc. cell counting</li>
<li>scater - QC</li>
<li>scran - normalisation</li>
<li>igraph - graphs <!-- for clusterisation, to check --></li>
<li>biomaRt - for gene annotation</li>
<li>ggplot2 - for plotting</li>
<li>irlba - for faster PCA</li>
</ul>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="PreProcAllCellsTop.html#cb26-1"></a><span class="co">#projDir &lt;- &quot;/home/ubuntu/Course_Materials/scRNAseq&quot;</span></span>
<span id="cb26-2"><a href="PreProcAllCellsTop.html#cb26-2"></a>projDir &lt;-<span class="st"> </span>params<span class="op">$</span>projDir</span>
<span id="cb26-3"><a href="PreProcAllCellsTop.html#cb26-3"></a>dirRel &lt;-<span class="st"> </span>params<span class="op">$</span>dirRel</span>
<span id="cb26-4"><a href="PreProcAllCellsTop.html#cb26-4"></a>outDirBit &lt;-<span class="st"> </span>params<span class="op">$</span>outDirBit</span>
<span id="cb26-5"><a href="PreProcAllCellsTop.html#cb26-5"></a>setSuf &lt;-<span class="st"> </span>params<span class="op">$</span>setSuf</span>
<span id="cb26-6"><a href="PreProcAllCellsTop.html#cb26-6"></a></span>
<span id="cb26-7"><a href="PreProcAllCellsTop.html#cb26-7"></a><span class="co"># with merge-knit</span></span>
<span id="cb26-8"><a href="PreProcAllCellsTop.html#cb26-8"></a><span class="co"># params are read once only.</span></span>
<span id="cb26-9"><a href="PreProcAllCellsTop.html#cb26-9"></a><span class="co"># but we need to change one param value: dirRel</span></span>
<span id="cb26-10"><a href="PreProcAllCellsTop.html#cb26-10"></a><span class="co"># 3 solutions:</span></span>
<span id="cb26-11"><a href="PreProcAllCellsTop.html#cb26-11"></a><span class="co"># - unlock bindings to edit the global value</span></span>
<span id="cb26-12"><a href="PreProcAllCellsTop.html#cb26-12"></a><span class="co"># - copy params to edit and use the local copy</span></span>
<span id="cb26-13"><a href="PreProcAllCellsTop.html#cb26-13"></a><span class="co"># - simply set dirRel, based on type of merging if need be.</span></span>
<span id="cb26-14"><a href="PreProcAllCellsTop.html#cb26-14"></a></span>
<span id="cb26-15"><a href="PreProcAllCellsTop.html#cb26-15"></a><span class="co"># unlock binding</span></span>
<span id="cb26-16"><a href="PreProcAllCellsTop.html#cb26-16"></a><span class="co"># (but should remember to set back to init value if need be)</span></span>
<span id="cb26-17"><a href="PreProcAllCellsTop.html#cb26-17"></a><span class="co">#bindingIsLocked(&quot;params&quot;, env = .GlobalEnv)</span></span>
<span id="cb26-18"><a href="PreProcAllCellsTop.html#cb26-18"></a><span class="co">#unlockBinding(&quot;params&quot;, env = .GlobalEnv)</span></span>
<span id="cb26-19"><a href="PreProcAllCellsTop.html#cb26-19"></a><span class="co">#params$stuff &lt;- &#39;toto&#39;</span></span>
<span id="cb26-20"><a href="PreProcAllCellsTop.html#cb26-20"></a></span>
<span id="cb26-21"><a href="PreProcAllCellsTop.html#cb26-21"></a><span class="co"># OR:</span></span>
<span id="cb26-22"><a href="PreProcAllCellsTop.html#cb26-22"></a></span>
<span id="cb26-23"><a href="PreProcAllCellsTop.html#cb26-23"></a><span class="co"># global_params &lt;- params; # if merge-knit</span></span>
<span id="cb26-24"><a href="PreProcAllCellsTop.html#cb26-24"></a><span class="co"># have local copy of params to edit and use here</span></span>
<span id="cb26-25"><a href="PreProcAllCellsTop.html#cb26-25"></a><span class="co">#local_params &lt;- params; # if merge-knit</span></span>
<span id="cb26-26"><a href="PreProcAllCellsTop.html#cb26-26"></a><span class="co">#local_params$stuff &lt;- &#39;toto&#39;</span></span>
<span id="cb26-27"><a href="PreProcAllCellsTop.html#cb26-27"></a></span>
<span id="cb26-28"><a href="PreProcAllCellsTop.html#cb26-28"></a><span class="co"># OR:</span></span>
<span id="cb26-29"><a href="PreProcAllCellsTop.html#cb26-29"></a></span>
<span id="cb26-30"><a href="PreProcAllCellsTop.html#cb26-30"></a><span class="co"># if merge-knit, edit params.</span></span>
<span id="cb26-31"><a href="PreProcAllCellsTop.html#cb26-31"></a><span class="cf">if</span>(params<span class="op">$</span>bookType <span class="op">==</span><span class="st"> &quot;mk&quot;</span>){</span>
<span id="cb26-32"><a href="PreProcAllCellsTop.html#cb26-32"></a>    setName &lt;-<span class="st"> &quot;caron&quot;</span></span>
<span id="cb26-33"><a href="PreProcAllCellsTop.html#cb26-33"></a>    setSuf &lt;-<span class="st"> &quot;_allCells&quot;</span></span>
<span id="cb26-34"><a href="PreProcAllCellsTop.html#cb26-34"></a>    dirRel &lt;-<span class="st"> &quot;..&quot;</span></span>
<span id="cb26-35"><a href="PreProcAllCellsTop.html#cb26-35"></a>}</span>
<span id="cb26-36"><a href="PreProcAllCellsTop.html#cb26-36"></a></span>
<span id="cb26-37"><a href="PreProcAllCellsTop.html#cb26-37"></a><span class="co"># other variables:</span></span>
<span id="cb26-38"><a href="PreProcAllCellsTop.html#cb26-38"></a>wrkDir &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/CaronBourque2020/grch38300&quot;</span>, projDir) </span>
<span id="cb26-39"><a href="PreProcAllCellsTop.html#cb26-39"></a>qcPlotDirBit &lt;-<span class="st"> &quot;Plots/Qc&quot;</span></span>
<span id="cb26-40"><a href="PreProcAllCellsTop.html#cb26-40"></a>poolBool &lt;-<span class="st"> </span><span class="ot">TRUE</span> <span class="co"># FALSE # whether to read each sample in and pool them and write object to file, or just load that file.</span></span>
<span id="cb26-41"><a href="PreProcAllCellsTop.html#cb26-41"></a>biomartBool &lt;-<span class="st"> </span><span class="ot">FALSE</span> <span class="co"># biomaRt sometimes fails, do it once, write to file and use that copy.</span></span>
<span id="cb26-42"><a href="PreProcAllCellsTop.html#cb26-42"></a>addQcBool &lt;-<span class="st"> </span><span class="ot">TRUE</span> <span class="co"># FALSE</span></span>
<span id="cb26-43"><a href="PreProcAllCellsTop.html#cb26-43"></a>runAll &lt;-<span class="st"> </span><span class="ot">FALSE</span> <span class="co"># TRUE</span></span>
<span id="cb26-44"><a href="PreProcAllCellsTop.html#cb26-44"></a></span>
<span id="cb26-45"><a href="PreProcAllCellsTop.html#cb26-45"></a><span class="kw">dir.create</span>(<span class="kw">sprintf</span>(<span class="st">&quot;%s/%s/%s&quot;</span>, projDir, outDirBit, qcPlotDirBit),</span>
<span id="cb26-46"><a href="PreProcAllCellsTop.html#cb26-46"></a>           <span class="dt">showWarnings =</span> <span class="ot">FALSE</span>,</span>
<span id="cb26-47"><a href="PreProcAllCellsTop.html#cb26-47"></a>           <span class="dt">recursive =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
</div>
<div id="sample-sheet-1" class="section level2">
<h2><span class="header-section-number">4.3</span> Sample sheet</h2>
<p>We will load both the Caron and Hca data sets.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="PreProcAllCellsTop.html#cb27-1"></a><span class="co"># CaronBourque2020</span></span>
<span id="cb27-2"><a href="PreProcAllCellsTop.html#cb27-2"></a>cb_sampleSheetFn &lt;-<span class="st"> </span><span class="kw">file.path</span>(projDir, <span class="st">&quot;Data/CaronBourque2020/SraRunTable.txt&quot;</span>)</span>
<span id="cb27-3"><a href="PreProcAllCellsTop.html#cb27-3"></a><span class="co"># Human Cell Atlas</span></span>
<span id="cb27-4"><a href="PreProcAllCellsTop.html#cb27-4"></a>hca_sampleSheetFn &lt;-<span class="st"> </span><span class="kw">file.path</span>(projDir, <span class="st">&quot;Data/Hca/accList_Hca.txt&quot;</span>)</span>
<span id="cb27-5"><a href="PreProcAllCellsTop.html#cb27-5"></a></span>
<span id="cb27-6"><a href="PreProcAllCellsTop.html#cb27-6"></a><span class="co"># read sample sheet in:</span></span>
<span id="cb27-7"><a href="PreProcAllCellsTop.html#cb27-7"></a>splShtColToKeep &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Run&quot;</span>, <span class="st">&quot;Sample.Name&quot;</span>, <span class="st">&quot;source_name&quot;</span>)</span>
<span id="cb27-8"><a href="PreProcAllCellsTop.html#cb27-8"></a></span>
<span id="cb27-9"><a href="PreProcAllCellsTop.html#cb27-9"></a>cb_sampleSheet &lt;-<span class="st"> </span><span class="kw">read.table</span>(cb_sampleSheetFn, <span class="dt">header=</span>T, <span class="dt">sep=</span><span class="st">&quot;,&quot;</span>)</span>
<span id="cb27-10"><a href="PreProcAllCellsTop.html#cb27-10"></a>hca_sampleSheet &lt;-<span class="st"> </span><span class="kw">read.table</span>(hca_sampleSheetFn, <span class="dt">header=</span>F, <span class="dt">sep=</span><span class="st">&quot;,&quot;</span>)</span>
<span id="cb27-11"><a href="PreProcAllCellsTop.html#cb27-11"></a><span class="kw">colnames</span>(hca_sampleSheet) &lt;-<span class="st"> &quot;Sample.Name&quot;</span></span>
<span id="cb27-12"><a href="PreProcAllCellsTop.html#cb27-12"></a>hca_sampleSheet<span class="op">$</span>Run &lt;-<span class="st"> </span>hca_sampleSheet<span class="op">$</span>Sample.Name</span>
<span id="cb27-13"><a href="PreProcAllCellsTop.html#cb27-13"></a>hca_sampleSheet<span class="op">$</span>source_name &lt;-<span class="st"> &quot;ABMMC&quot;</span> <span class="co"># adult BMMC</span></span>
<span id="cb27-14"><a href="PreProcAllCellsTop.html#cb27-14"></a></span>
<span id="cb27-15"><a href="PreProcAllCellsTop.html#cb27-15"></a>sampleSheet &lt;-<span class="st"> </span><span class="kw">rbind</span>(cb_sampleSheet[,splShtColToKeep], hca_sampleSheet[,splShtColToKeep])</span>
<span id="cb27-16"><a href="PreProcAllCellsTop.html#cb27-16"></a></span>
<span id="cb27-17"><a href="PreProcAllCellsTop.html#cb27-17"></a>sampleSheet <span class="op">%&gt;%</span></span>
<span id="cb27-18"><a href="PreProcAllCellsTop.html#cb27-18"></a><span class="st">    </span><span class="kw">as.data.frame</span>() <span class="op">%&gt;%</span></span>
<span id="cb27-19"><a href="PreProcAllCellsTop.html#cb27-19"></a><span class="st">    </span><span class="kw">datatable</span>(<span class="dt">rownames =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<div id="htmlwidget-7fd326274df4c814e89c" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-7fd326274df4c814e89c">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20"],["SRR9264343","SRR9264344","SRR9264345","SRR9264346","SRR9264347","SRR9264348","SRR9264349","SRR9264350","SRR9264351","SRR9264352","SRR9264353","SRR9264354","MantonBM1","MantonBM2","MantonBM3","MantonBM4","MantonBM5","MantonBM6","MantonBM7","MantonBM8"],["GSM3872434","GSM3872435","GSM3872436","GSM3872437","GSM3872438","GSM3872439","GSM3872440","GSM3872441","GSM3872442","GSM3872442","GSM3872443","GSM3872444","MantonBM1","MantonBM2","MantonBM3","MantonBM4","MantonBM5","MantonBM6","MantonBM7","MantonBM8"],["ETV6-RUNX1","ETV6-RUNX1","ETV6-RUNX1","ETV6-RUNX1","HHD","HHD","PRE-T","PRE-T","PBMMC","PBMMC","PBMMC","PBMMC","ABMMC","ABMMC","ABMMC","ABMMC","ABMMC","ABMMC","ABMMC","ABMMC"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>Run<\/th>\n      <th>Sample.Name<\/th>\n      <th>source_name<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"order":[],"autoWidth":false,"orderClasses":false,"columnDefs":[{"orderable":false,"targets":0}]}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="data-representation" class="section level2">
<h2><span class="header-section-number">4.4</span> Data representation</h2>
<p>We will use a <a href="https://bioconductor.org/packages/SingleCellExperiment/">SingleCellExperiment</a> object that is described <a href="https://www.nature.com/articles/s41592-019-0654-x">here</a> and stores various data types:</p>
<ul>
<li>the count matrix</li>
<li>feature (gene) annotation</li>
<li>droplet annotation</li>
<li>outcome of downstream analysis such as dimensionality reduction</li>
</ul>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="PreProcAllCellsTop.html#cb28-1"></a>tmpFn &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/Images/tenxLibStructureV3.png&quot;</span>, <span class="st">&quot;..&quot;</span>)</span>
<span id="cb28-2"><a href="PreProcAllCellsTop.html#cb28-2"></a>knitr<span class="op">::</span><span class="kw">include_graphics</span>(tmpFn, <span class="dt">auto_pdf =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<p><img src="../Images/tenxLibStructureV3.png" width="80%" /></p>
</div>
<div id="example" class="section level2">
<h2><span class="header-section-number">4.5</span> Example</h2>
<p>We will load the data for the first sample in the sample sheet: SRR9264343.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="PreProcAllCellsTop.html#cb29-1"></a>i &lt;-<span class="st"> </span><span class="dv">1</span></span>
<span id="cb29-2"><a href="PreProcAllCellsTop.html#cb29-2"></a>sample.path &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/%s/%s/outs/raw_feature_bc_matrix/&quot;</span>,</span>
<span id="cb29-3"><a href="PreProcAllCellsTop.html#cb29-3"></a>              wrkDir,</span>
<span id="cb29-4"><a href="PreProcAllCellsTop.html#cb29-4"></a>              sampleSheet[i,<span class="st">&quot;Run&quot;</span>],</span>
<span id="cb29-5"><a href="PreProcAllCellsTop.html#cb29-5"></a>              sampleSheet[i,<span class="st">&quot;Run&quot;</span>])</span>
<span id="cb29-6"><a href="PreProcAllCellsTop.html#cb29-6"></a>sce.raw &lt;-<span class="st"> </span><span class="kw">read10xCounts</span>(sample.path, <span class="dt">col.names=</span><span class="ot">TRUE</span>)</span>
<span id="cb29-7"><a href="PreProcAllCellsTop.html#cb29-7"></a>sce.raw</span></code></pre></div>
<pre><code>## class: SingleCellExperiment 
## dim: 33538 737280 
## metadata(1): Samples
## assays(1): counts
## rownames(33538): ENSG00000243485 ENSG00000237613 ... ENSG00000277475
##   ENSG00000268674
## rowData names(3): ID Symbol Type
## colnames(737280): AAACCTGAGAAACCAT-1 AAACCTGAGAAACCGC-1 ...
##   TTTGTCATCTTTAGTC-1 TTTGTCATCTTTCCTC-1
## colData names(2): Sample Barcode
## reducedDimNames(0):
## altExpNames(0):</code></pre>
<p>We can access these different types of data with various functions.</p>
<p>Number of genes and droplets in the count matrix:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="PreProcAllCellsTop.html#cb31-1"></a><span class="kw">dim</span>(<span class="kw">counts</span>(sce.raw))</span></code></pre></div>
<pre><code>## [1]  33538 737280</code></pre>
<p>Features, with rowData():</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="PreProcAllCellsTop.html#cb33-1"></a><span class="kw">head</span>(<span class="kw">rowData</span>(sce.raw))</span></code></pre></div>
<pre><code>## DataFrame with 6 rows and 3 columns
##                              ID      Symbol            Type
##                     &lt;character&gt; &lt;character&gt;     &lt;character&gt;
## ENSG00000243485 ENSG00000243485 MIR1302-2HG Gene Expression
## ENSG00000237613 ENSG00000237613     FAM138A Gene Expression
## ENSG00000186092 ENSG00000186092       OR4F5 Gene Expression
## ENSG00000238009 ENSG00000238009  AL627309.1 Gene Expression
## ENSG00000239945 ENSG00000239945  AL627309.3 Gene Expression
## ENSG00000239906 ENSG00000239906  AL627309.2 Gene Expression</code></pre>
<p>Samples, with colData():</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="PreProcAllCellsTop.html#cb35-1"></a><span class="kw">head</span>(<span class="kw">colData</span>(sce.raw))</span></code></pre></div>
<pre><code>## DataFrame with 6 rows and 2 columns
##                                    Sample            Barcode
##                               &lt;character&gt;        &lt;character&gt;
## AAACCTGAGAAACCAT-1 /ssd/personal/baller.. AAACCTGAGAAACCAT-1
## AAACCTGAGAAACCGC-1 /ssd/personal/baller.. AAACCTGAGAAACCGC-1
## AAACCTGAGAAACCTA-1 /ssd/personal/baller.. AAACCTGAGAAACCTA-1
## AAACCTGAGAAACGAG-1 /ssd/personal/baller.. AAACCTGAGAAACGAG-1
## AAACCTGAGAAACGCC-1 /ssd/personal/baller.. AAACCTGAGAAACGCC-1
## AAACCTGAGAAAGTGG-1 /ssd/personal/baller.. AAACCTGAGAAAGTGG-1</code></pre>
<p>Single-cell RNA-seq data compared to bulk RNA-seq is sparse, especially with droplet-based methods such as 10X, mostly because:</p>
<ul>
<li>a given cell does not express each gene</li>
<li>the library preparation does not capture all transcript the cell does express</li>
<li>the sequencing depth per cell is far lower</li>
</ul>
<p>Counts, with counts(). Given the large number of droplets in a sample, count matrices can be large. They are however very sparse and can be stored in a ‘sparse matrix’ that only stores non-zero values, for example a ‘dgCMatrix’ object (‘DelayedArray’ class).</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="PreProcAllCellsTop.html#cb37-1"></a><span class="kw">counts</span>(sce.raw) &lt;-<span class="st"> </span><span class="kw">as</span>(<span class="kw">counts</span>(sce.raw), <span class="st">&quot;dgCMatrix&quot;</span>)</span>
<span id="cb37-2"><a href="PreProcAllCellsTop.html#cb37-2"></a><span class="co">#class(counts(sce.raw))</span></span>
<span id="cb37-3"><a href="PreProcAllCellsTop.html#cb37-3"></a><span class="kw">counts</span>(sce.raw)[<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">10</span>]</span></code></pre></div>
<pre><code>## 10 x 10 sparse Matrix of class &quot;dgCMatrix&quot;
##                                    
## ENSG00000243485 . . . . . . . . . .
## ENSG00000237613 . . . . . . . . . .
## ENSG00000186092 . . . . . . . . . .
## ENSG00000238009 . . . . . . . . . .
## ENSG00000239945 . . . . . . . . . .
## ENSG00000239906 . . . . . . . . . .
## ENSG00000241599 . . . . . . . . . .
## ENSG00000236601 . . . . . . . . . .
## ENSG00000284733 . . . . . . . . . .
## ENSG00000235146 . . . . . . . . . .</code></pre>
</div>
<div id="mapping-qc" class="section level2">
<h2><span class="header-section-number">4.6</span> Mapping QC</h2>
<div id="gene-body-coverage" class="section level3">
<h3><span class="header-section-number">4.6.1</span> Gene body coverage</h3>
<p>The plot below show the average coverage (y-axis) along the body of genes (x-axis).</p>
<!-- In /ssd/personal/baller01/20200511_FernandesM_ME_crukBiSs2020/AnaWiSce/Ana1/ScriptsMkWiC: -->
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="PreProcAllCellsTop.html#cb39-1"></a>tmpFn &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/Images/1_AAACCTGAGACTTTCG-1.rseqcGeneBodyCovCheck.txt.geneBodyCoverage.curves.png&quot;</span>, <span class="st">&quot;..&quot;</span>)</span>
<span id="cb39-2"><a href="PreProcAllCellsTop.html#cb39-2"></a>knitr<span class="op">::</span><span class="kw">include_graphics</span>(tmpFn, <span class="dt">auto_pdf =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<p><img src="../Images/1_AAACCTGAGACTTTCG-1.rseqcGeneBodyCovCheck.txt.geneBodyCoverage.curves.png" width="80%" /></p>
</div>
<div id="amplification-rate" class="section level3">
<h3><span class="header-section-number">4.6.2</span> Amplification rate</h3>
<p>We will use the information stored in the ‘molecule info’ file to count the number of UMI and reads for each gene in each cell.</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="PreProcAllCellsTop.html#cb40-1"></a><span class="co">##mol.info.file &lt;- sprintf(&quot;%s/%s/%s/outs/molecule_info.h5&quot;, wrkDir, sampleSheet[i,&quot;Run&quot;], sampleSheet[i,&quot;Run&quot;])</span></span>
<span id="cb40-2"><a href="PreProcAllCellsTop.html#cb40-2"></a><span class="co">##mol.info &lt;- read10xMolInfo(mol.info.file)</span></span>
<span id="cb40-3"><a href="PreProcAllCellsTop.html#cb40-3"></a><span class="co"># or mol.info object if issue with H5Fopen</span></span>
<span id="cb40-4"><a href="PreProcAllCellsTop.html#cb40-4"></a>mol.info.file &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/%s/%s/outs/molecule_info_h5.Rds&quot;</span>, wrkDir, sampleSheet[i,<span class="st">&quot;Run&quot;</span>], sampleSheet[i,<span class="st">&quot;Run&quot;</span>])</span>
<span id="cb40-5"><a href="PreProcAllCellsTop.html#cb40-5"></a>mol.info &lt;-<span class="st"> </span><span class="kw">readRDS</span>(mol.info.file)</span></code></pre></div>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="PreProcAllCellsTop.html#cb41-1"></a><span class="co"># slow</span></span>
<span id="cb41-2"><a href="PreProcAllCellsTop.html#cb41-2"></a></span>
<span id="cb41-3"><a href="PreProcAllCellsTop.html#cb41-3"></a><span class="co"># &#39;data&#39; slot:</span></span>
<span id="cb41-4"><a href="PreProcAllCellsTop.html#cb41-4"></a>mol.info<span class="op">$</span>data</span></code></pre></div>
<pre><code>## DataFrame with 18544666 rows and 5 columns
##                      cell       umi gem_group      gene     reads
##               &lt;character&gt; &lt;integer&gt; &lt;integer&gt; &lt;integer&gt; &lt;integer&gt;
## 1        AAACCTGAGAAACCTA    467082         1      3287         1
## 2        AAACCTGAGAAACCTA    205888         1      3446         1
## 3        AAACCTGAGAAACCTA    866252         1      3896         3
## 4        AAACCTGAGAAACCTA    796027         1      3969         1
## 5        AAACCTGAGAAACCTA    542561         1      5008         1
## ...                   ...       ...       ...       ...       ...
## 18544662 TTTGTCATCTTTAGTC    927060         1     23634         1
## 18544663 TTTGTCATCTTTAGTC    975865         1     27143         1
## 18544664 TTTGTCATCTTTAGTC    364964         1     27467         4
## 18544665 TTTGTCATCTTTAGTC    152570         1     30125         7
## 18544666 TTTGTCATCTTTAGTC    383230         1     30283         5</code></pre>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="PreProcAllCellsTop.html#cb43-1"></a><span class="co"># &#39;genes&#39; slot</span></span>
<span id="cb43-2"><a href="PreProcAllCellsTop.html#cb43-2"></a><span class="kw">head</span>(mol.info<span class="op">$</span>genes)</span></code></pre></div>
<pre><code>## [1] &quot;ENSG00000243485&quot; &quot;ENSG00000237613&quot; &quot;ENSG00000186092&quot; &quot;ENSG00000238009&quot;
## [5] &quot;ENSG00000239945&quot; &quot;ENSG00000239906&quot;</code></pre>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="PreProcAllCellsTop.html#cb45-1"></a><span class="co"># for each cell and gene, count UMIs</span></span>
<span id="cb45-2"><a href="PreProcAllCellsTop.html#cb45-2"></a><span class="co"># slow, but needs running, at least once</span></span>
<span id="cb45-3"><a href="PreProcAllCellsTop.html#cb45-3"></a><span class="co"># so write it to file to load later if need be.</span></span>
<span id="cb45-4"><a href="PreProcAllCellsTop.html#cb45-4"></a>tmpFn &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/%s/Robjects/sce_preProc_ampDf1.Rds&quot;</span>, projDir, outDirBit)</span>
<span id="cb45-5"><a href="PreProcAllCellsTop.html#cb45-5"></a><span class="cf">if</span>(<span class="op">!</span><span class="kw">file.exists</span>(tmpFn))</span>
<span id="cb45-6"><a href="PreProcAllCellsTop.html#cb45-6"></a>{</span>
<span id="cb45-7"><a href="PreProcAllCellsTop.html#cb45-7"></a>  ampDf &lt;-<span class="st"> </span>mol.info<span class="op">$</span>data <span class="op">%&gt;%</span></span>
<span id="cb45-8"><a href="PreProcAllCellsTop.html#cb45-8"></a><span class="st">    </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span></span>
<span id="cb45-9"><a href="PreProcAllCellsTop.html#cb45-9"></a><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">umi =</span> <span class="kw">as.character</span>(umi)) <span class="op">%&gt;%</span></span>
<span id="cb45-10"><a href="PreProcAllCellsTop.html#cb45-10"></a><span class="st">    </span><span class="kw">group_by</span>(cell, gene) <span class="op">%&gt;%</span></span>
<span id="cb45-11"><a href="PreProcAllCellsTop.html#cb45-11"></a><span class="st">    </span><span class="kw">summarise</span>(<span class="dt">nUmis =</span> <span class="kw">n</span>(),</span>
<span id="cb45-12"><a href="PreProcAllCellsTop.html#cb45-12"></a>          <span class="dt">totReads=</span><span class="kw">sum</span>(reads)) <span class="op">%&gt;%</span></span>
<span id="cb45-13"><a href="PreProcAllCellsTop.html#cb45-13"></a><span class="st">        </span><span class="kw">data.frame</span>()</span>
<span id="cb45-14"><a href="PreProcAllCellsTop.html#cb45-14"></a></span>
<span id="cb45-15"><a href="PreProcAllCellsTop.html#cb45-15"></a>    <span class="co"># Write object to file</span></span>
<span id="cb45-16"><a href="PreProcAllCellsTop.html#cb45-16"></a>    <span class="kw">saveRDS</span>(ampDf, tmpFn)</span>
<span id="cb45-17"><a href="PreProcAllCellsTop.html#cb45-17"></a>} <span class="cf">else</span> {</span>
<span id="cb45-18"><a href="PreProcAllCellsTop.html#cb45-18"></a>    ampDf &lt;-<span class="st"> </span><span class="kw">readRDS</span>(tmpFn)</span>
<span id="cb45-19"><a href="PreProcAllCellsTop.html#cb45-19"></a>}</span>
<span id="cb45-20"><a href="PreProcAllCellsTop.html#cb45-20"></a><span class="kw">rm</span>(tmpFn)</span>
<span id="cb45-21"><a href="PreProcAllCellsTop.html#cb45-21"></a></span>
<span id="cb45-22"><a href="PreProcAllCellsTop.html#cb45-22"></a><span class="co"># distribution of totReads</span></span>
<span id="cb45-23"><a href="PreProcAllCellsTop.html#cb45-23"></a><span class="kw">summary</span>(ampDf<span class="op">$</span>totReads)</span></code></pre></div>
<pre><code>##     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
##     1.00     2.00     6.00    15.23    12.00 79275.00</code></pre>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="PreProcAllCellsTop.html#cb47-1"></a><span class="co"># distribution of nUmis</span></span>
<span id="cb47-2"><a href="PreProcAllCellsTop.html#cb47-2"></a><span class="kw">summary</span>(ampDf<span class="op">$</span>nUmis)</span></code></pre></div>
<pre><code>##     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
##    1.000    1.000    1.000    2.377    1.000 7137.000</code></pre>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="PreProcAllCellsTop.html#cb49-1"></a><span class="co"># too slow</span></span>
<span id="cb49-2"><a href="PreProcAllCellsTop.html#cb49-2"></a>sp &lt;-<span class="st"> </span><span class="kw">ggplot</span>(ampDf, <span class="kw">aes</span>(<span class="dt">x=</span>nUmis, <span class="dt">y=</span>totReads)) <span class="op">+</span></span>
<span id="cb49-3"><a href="PreProcAllCellsTop.html#cb49-3"></a><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span></span>
<span id="cb49-4"><a href="PreProcAllCellsTop.html#cb49-4"></a><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">trans=</span><span class="st">&#39;log2&#39;</span>) <span class="op">+</span></span>
<span id="cb49-5"><a href="PreProcAllCellsTop.html#cb49-5"></a><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">trans=</span><span class="st">&#39;log2&#39;</span>)</span>
<span id="cb49-6"><a href="PreProcAllCellsTop.html#cb49-6"></a>sp</span>
<span id="cb49-7"><a href="PreProcAllCellsTop.html#cb49-7"></a><span class="co">#ggMarginal(sp)</span></span></code></pre></div>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="PreProcAllCellsTop.html#cb50-1"></a>sp2 &lt;-<span class="st"> </span><span class="kw">ggplot</span>(ampDf, <span class="kw">aes</span>(<span class="dt">x=</span>nUmis, <span class="dt">y=</span>totReads)) <span class="op">+</span></span>
<span id="cb50-2"><a href="PreProcAllCellsTop.html#cb50-2"></a><span class="st">  </span><span class="kw">geom_bin2d</span>(<span class="dt">bins =</span> <span class="dv">50</span>) <span class="op">+</span></span>
<span id="cb50-3"><a href="PreProcAllCellsTop.html#cb50-3"></a><span class="st">  </span><span class="kw">scale_fill_continuous</span>(<span class="dt">type =</span> <span class="st">&quot;viridis&quot;</span>) <span class="op">+</span></span>
<span id="cb50-4"><a href="PreProcAllCellsTop.html#cb50-4"></a><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">trans=</span><span class="st">&#39;log10&#39;</span>) <span class="op">+</span></span>
<span id="cb50-5"><a href="PreProcAllCellsTop.html#cb50-5"></a><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">trans=</span><span class="st">&#39;log10&#39;</span>) <span class="op">+</span></span>
<span id="cb50-6"><a href="PreProcAllCellsTop.html#cb50-6"></a><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;totReads vs nUmis&quot;</span>) <span class="op">+</span></span>
<span id="cb50-7"><a href="PreProcAllCellsTop.html#cb50-7"></a><span class="st">  </span><span class="kw">theme_bw</span>()</span>
<span id="cb50-8"><a href="PreProcAllCellsTop.html#cb50-8"></a></span>
<span id="cb50-9"><a href="PreProcAllCellsTop.html#cb50-9"></a>sp2</span></code></pre></div>
<p><img src="MkWiC_files/figure-html/ampDf_bin2d_allCells-1.png" width="672" /></p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="PreProcAllCellsTop.html#cb51-1"></a><span class="kw">gc</span>(<span class="dt">verbose=</span><span class="ot">FALSE</span>)</span></code></pre></div>
<pre><code>##             used  (Mb) gc trigger   (Mb)  max used   (Mb)
## Ncells   9016602 481.6   16305644  870.9  10352348  552.9
## Vcells 106811173 815.0  336016856 2563.7 336016856 2563.7</code></pre>
</div>
</div>
<div id="cell-calling-for-droplet-data" class="section level2">
<h2><span class="header-section-number">4.7</span> Cell calling for droplet data</h2>
<p>For a given sample, amongst the tens of thousands of droplets used in the assay, some will contain a cell while many others will not. The presence of RNA in a droplet will show with non-zero UMI count. This is however not sufficient to infer that the droplet does contain a cell. Indeed, after sample preparation, some cell debris including RNA will still float in the mix. This ambient RNA is unwillignly captured during library preparation and sequenced.</p>
<p>Cellranger generates a count matrix that includes all droplets analysed in the assay. We will now load this ‘raw matrix’ for one sample and draw the distribution of UMI counts.</p>
<p>Distribution of UMI counts:</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="PreProcAllCellsTop.html#cb53-1"></a>libSizeDf &lt;-<span class="st"> </span>mol.info<span class="op">$</span>data <span class="op">%&gt;%</span></span>
<span id="cb53-2"><a href="PreProcAllCellsTop.html#cb53-2"></a><span class="st">  </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span></span>
<span id="cb53-3"><a href="PreProcAllCellsTop.html#cb53-3"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">umi =</span> <span class="kw">as.character</span>(umi)) <span class="op">%&gt;%</span></span>
<span id="cb53-4"><a href="PreProcAllCellsTop.html#cb53-4"></a><span class="st">  </span><span class="kw">group_by</span>(cell) <span class="op">%&gt;%</span></span>
<span id="cb53-5"><a href="PreProcAllCellsTop.html#cb53-5"></a><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">nUmis =</span> <span class="kw">n</span>(), <span class="dt">totReads=</span><span class="kw">sum</span>(reads)) <span class="op">%&gt;%</span></span>
<span id="cb53-6"><a href="PreProcAllCellsTop.html#cb53-6"></a><span class="st">  </span><span class="kw">data.frame</span>()</span>
<span id="cb53-7"><a href="PreProcAllCellsTop.html#cb53-7"></a><span class="kw">rm</span>(mol.info)</span>
<span id="cb53-8"><a href="PreProcAllCellsTop.html#cb53-8"></a><span class="kw">gc</span>()</span></code></pre></div>
<pre><code>##            used  (Mb) gc trigger   (Mb)  max used   (Mb)
## Ncells  9024917 482.0   16305644  870.9  16305644  870.9
## Vcells 51521023 393.1  268813485 2050.9 336016856 2563.7</code></pre>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="PreProcAllCellsTop.html#cb55-1"></a><span class="kw">ggplot</span>(libSizeDf, <span class="kw">aes</span>(<span class="dt">x=</span><span class="kw">log10</span>(nUmis))) <span class="op">+</span><span class="st"> </span><span class="kw">geom_histogram</span>(<span class="dt">bins =</span> <span class="dv">50</span>)</span></code></pre></div>
<p><img src="MkWiC_files/figure-html/nUmis_hist_allCells-1.png" width="672" /></p>
<p>Library size varies widely, both amongst empty droplets and droplets carrying cells, mostly due to:</p>
<ul>
<li>variation in droplet size,</li>
<li>amplification efficiency,</li>
<li>sequencing</li>
</ul>
<p>Most cell counting methods try to identify the library size that best distinguishes empty from cell-carrying droplets.</p>
<div id="mixture-model" class="section level3">
<h3><span class="header-section-number">4.7.1</span> Mixture model</h3>
<p>This method by default fits a mixture of two normal distributions to the logged library sizes:</p>
<ul>
<li>one with a small mean for empty droplets</li>
<li>the other with a higher mean for cell-carrying droplets</li>
</ul>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="PreProcAllCellsTop.html#cb56-1"></a><span class="kw">set.seed</span>(<span class="dv">100</span>)</span>
<span id="cb56-2"><a href="PreProcAllCellsTop.html#cb56-2"></a><span class="co"># get package</span></span>
<span id="cb56-3"><a href="PreProcAllCellsTop.html#cb56-3"></a><span class="kw">library</span>(<span class="st">&quot;mixtools&quot;</span>)</span>
<span id="cb56-4"><a href="PreProcAllCellsTop.html#cb56-4"></a><span class="co"># have library sizes on a log10 scale</span></span>
<span id="cb56-5"><a href="PreProcAllCellsTop.html#cb56-5"></a>log10_lib_size &lt;-<span class="st"> </span><span class="kw">log10</span>(libSizeDf<span class="op">$</span>nUmis)</span>
<span id="cb56-6"><a href="PreProcAllCellsTop.html#cb56-6"></a><span class="co"># fit mixture</span></span>
<span id="cb56-7"><a href="PreProcAllCellsTop.html#cb56-7"></a>mix &lt;-<span class="st"> </span><span class="kw">normalmixEM</span>(log10_lib_size,</span>
<span id="cb56-8"><a href="PreProcAllCellsTop.html#cb56-8"></a>           <span class="dt">mu=</span><span class="kw">c</span>(<span class="kw">log10</span>(<span class="dv">10</span>), <span class="kw">log10</span>(<span class="dv">100</span>), <span class="kw">log10</span>(<span class="dv">10000</span>)),</span>
<span id="cb56-9"><a href="PreProcAllCellsTop.html#cb56-9"></a>                   <span class="dt">maxrestarts=</span><span class="dv">50</span>, <span class="dt">epsilon =</span> <span class="fl">1e-03</span>)</span></code></pre></div>
<pre><code>## One of the variances is going to zero;  trying new starting values.
## One of the variances is going to zero;  trying new starting values.
## One of the variances is going to zero;  trying new starting values.
## One of the variances is going to zero;  trying new starting values.
## One of the variances is going to zero;  trying new starting values.
## One of the variances is going to zero;  trying new starting values.
## One of the variances is going to zero;  trying new starting values.
## One of the variances is going to zero;  trying new starting values.
## One of the variances is going to zero;  trying new starting values.
## One of the variances is going to zero;  trying new starting values.
## One of the variances is going to zero;  trying new starting values.
## One of the variances is going to zero;  trying new starting values.
## One of the variances is going to zero;  trying new starting values.
## One of the variances is going to zero;  trying new starting values.
## One of the variances is going to zero;  trying new starting values.
## One of the variances is going to zero;  trying new starting values.
## One of the variances is going to zero;  trying new starting values.
## One of the variances is going to zero;  trying new starting values.
## One of the variances is going to zero;  trying new starting values.
## One of the variances is going to zero;  trying new starting values.
## One of the variances is going to zero;  trying new starting values.
## number of iterations= 64</code></pre>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="PreProcAllCellsTop.html#cb58-1"></a><span class="co"># plot</span></span>
<span id="cb58-2"><a href="PreProcAllCellsTop.html#cb58-2"></a>p1 &lt;-<span class="st"> </span><span class="kw">dnorm</span>(log10_lib_size, <span class="dt">mean=</span>mix<span class="op">$</span>mu[<span class="dv">1</span>], <span class="dt">sd=</span>mix<span class="op">$</span>sigma[<span class="dv">1</span>])</span>
<span id="cb58-3"><a href="PreProcAllCellsTop.html#cb58-3"></a>p2 &lt;-<span class="st"> </span><span class="kw">dnorm</span>(log10_lib_size, <span class="dt">mean=</span>mix<span class="op">$</span>mu[<span class="dv">2</span>], <span class="dt">sd=</span>mix<span class="op">$</span>sigma[<span class="dv">2</span>])</span>
<span id="cb58-4"><a href="PreProcAllCellsTop.html#cb58-4"></a>p3 &lt;-<span class="st"> </span><span class="kw">dnorm</span>(log10_lib_size, <span class="dt">mean=</span>mix<span class="op">$</span>mu[<span class="dv">3</span>], <span class="dt">sd=</span>mix<span class="op">$</span>sigma[<span class="dv">3</span>])</span>
<span id="cb58-5"><a href="PreProcAllCellsTop.html#cb58-5"></a>pList &lt;-<span class="st"> </span><span class="kw">list</span>(p1, p2, p3)</span>
<span id="cb58-6"><a href="PreProcAllCellsTop.html#cb58-6"></a></span>
<span id="cb58-7"><a href="PreProcAllCellsTop.html#cb58-7"></a><span class="cf">if</span> (mix<span class="op">$</span>mu[<span class="dv">1</span>] <span class="op">&lt;</span><span class="st"> </span>mix<span class="op">$</span>mu[<span class="dv">2</span>]) {</span>
<span id="cb58-8"><a href="PreProcAllCellsTop.html#cb58-8"></a>    split &lt;-<span class="st"> </span><span class="kw">min</span>(log10_lib_size[p1 <span class="op">&lt;</span><span class="st"> </span>p2])</span>
<span id="cb58-9"><a href="PreProcAllCellsTop.html#cb58-9"></a>} <span class="cf">else</span> {</span>
<span id="cb58-10"><a href="PreProcAllCellsTop.html#cb58-10"></a>    split &lt;-<span class="st"> </span><span class="kw">min</span>(log10_lib_size[p2 <span class="op">&lt;</span><span class="st"> </span>p1])</span>
<span id="cb58-11"><a href="PreProcAllCellsTop.html#cb58-11"></a>}</span>
<span id="cb58-12"><a href="PreProcAllCellsTop.html#cb58-12"></a></span>
<span id="cb58-13"><a href="PreProcAllCellsTop.html#cb58-13"></a><span class="co"># find densities with the higest means:</span></span>
<span id="cb58-14"><a href="PreProcAllCellsTop.html#cb58-14"></a>i1 &lt;-<span class="st"> </span><span class="kw">which</span>(<span class="kw">order</span>(mix<span class="op">$</span>mu)<span class="op">==</span><span class="dv">2</span>)</span>
<span id="cb58-15"><a href="PreProcAllCellsTop.html#cb58-15"></a>i2 &lt;-<span class="st"> </span><span class="kw">which</span>(<span class="kw">order</span>(mix<span class="op">$</span>mu)<span class="op">==</span><span class="dv">3</span>)</span>
<span id="cb58-16"><a href="PreProcAllCellsTop.html#cb58-16"></a></span>
<span id="cb58-17"><a href="PreProcAllCellsTop.html#cb58-17"></a><span class="co"># find intersection:</span></span>
<span id="cb58-18"><a href="PreProcAllCellsTop.html#cb58-18"></a>dd0 &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">log10_lib_size=</span>log10_lib_size,</span>
<span id="cb58-19"><a href="PreProcAllCellsTop.html#cb58-19"></a>                 <span class="co">#p1, p2, p3) </span></span>
<span id="cb58-20"><a href="PreProcAllCellsTop.html#cb58-20"></a>                 <span class="dt">pA=</span>pList[[i1]],</span>
<span id="cb58-21"><a href="PreProcAllCellsTop.html#cb58-21"></a>                 <span class="dt">pB=</span>pList[[i2]]) </span>
<span id="cb58-22"><a href="PreProcAllCellsTop.html#cb58-22"></a></span>
<span id="cb58-23"><a href="PreProcAllCellsTop.html#cb58-23"></a>split &lt;-<span class="st"> </span>dd0 <span class="op">%&gt;%</span></span>
<span id="cb58-24"><a href="PreProcAllCellsTop.html#cb58-24"></a><span class="st">    </span><span class="kw">filter</span>(pA <span class="op">&lt;</span><span class="st"> </span>pB <span class="op">&amp;</span><span class="st"> </span>mix<span class="op">$</span>mu[i1] <span class="op">&lt;</span><span class="st"> </span>log10_lib_size) <span class="op">%&gt;%</span></span>
<span id="cb58-25"><a href="PreProcAllCellsTop.html#cb58-25"></a><span class="st">    </span><span class="kw">arrange</span>(log10_lib_size) <span class="op">%&gt;%</span></span>
<span id="cb58-26"><a href="PreProcAllCellsTop.html#cb58-26"></a><span class="st">    </span><span class="kw">head</span>(<span class="dt">n=</span><span class="dv">1</span>) <span class="op">%&gt;%</span></span>
<span id="cb58-27"><a href="PreProcAllCellsTop.html#cb58-27"></a><span class="st">    </span><span class="kw">pull</span>(log10_lib_size)</span>
<span id="cb58-28"><a href="PreProcAllCellsTop.html#cb58-28"></a><span class="co"># show split on plot:</span></span>
<span id="cb58-29"><a href="PreProcAllCellsTop.html#cb58-29"></a><span class="kw">plot</span>(mix, <span class="dt">which=</span><span class="dv">2</span>, <span class="dt">xlab2=</span><span class="st">&quot;log10(mol per cell)&quot;</span>)</span>
<span id="cb58-30"><a href="PreProcAllCellsTop.html#cb58-30"></a><span class="co"># get density for each distribution:</span></span>
<span id="cb58-31"><a href="PreProcAllCellsTop.html#cb58-31"></a><span class="co">#log10_lib_size &lt;- log10(libSizeDf$nUmis)</span></span>
<span id="cb58-32"><a href="PreProcAllCellsTop.html#cb58-32"></a><span class="kw">abline</span>(<span class="dt">v=</span>split, <span class="dt">lwd=</span><span class="dv">2</span>)</span></code></pre></div>
<p><img src="MkWiC_files/figure-html/cellCall_mixtools_allCells-1.png" width="672" /></p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="PreProcAllCellsTop.html#cb59-1"></a>dd &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">log10_lib_size=</span>log10_lib_size,</span>
<span id="cb59-2"><a href="PreProcAllCellsTop.html#cb59-2"></a>                 p1, p2, p3) <span class="op">%&gt;%</span></span>
<span id="cb59-3"><a href="PreProcAllCellsTop.html#cb59-3"></a><span class="st">  </span><span class="kw">arrange</span>(log10_lib_size) <span class="op">%&gt;%</span></span>
<span id="cb59-4"><a href="PreProcAllCellsTop.html#cb59-4"></a><span class="st">  </span>tidyr<span class="op">::</span><span class="kw">pivot_longer</span>(<span class="op">!</span>log10_lib_size, <span class="dt">names_to =</span> <span class="st">&quot;curve&quot;</span>, <span class="dt">values_to =</span> <span class="st">&quot;density&quot;</span>)</span>
<span id="cb59-5"><a href="PreProcAllCellsTop.html#cb59-5"></a><span class="kw">head</span>(dd)</span>
<span id="cb59-6"><a href="PreProcAllCellsTop.html#cb59-6"></a><span class="kw">ggplot</span>(dd, <span class="kw">aes</span>(<span class="dt">x=</span>log10_lib_size, <span class="dt">y=</span>density, <span class="dt">col=</span>curve)) <span class="op">+</span></span>
<span id="cb59-7"><a href="PreProcAllCellsTop.html#cb59-7"></a><span class="st">         </span><span class="kw">geom_line</span>()</span></code></pre></div>
</div>
<div id="barcode-rank-plot" class="section level3">
<h3><span class="header-section-number">4.7.2</span> Barcode rank plot</h3>
<p>The barcode rank plot shows the library sizes against their rank in decreasing order,
for the first 10000 droplets only.</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="PreProcAllCellsTop.html#cb60-1"></a>barcode_rank &lt;-<span class="st"> </span><span class="kw">rank</span>(<span class="op">-</span>libSizeDf<span class="op">$</span>nUmis)</span>
<span id="cb60-2"><a href="PreProcAllCellsTop.html#cb60-2"></a><span class="kw">plot</span>(barcode_rank, libSizeDf<span class="op">$</span>nUmis, <span class="dt">xlim=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">10000</span>), <span class="dt">ylab=</span><span class="st">&quot;library size&quot;</span>)</span></code></pre></div>
<p><img src="MkWiC_files/figure-html/cellCall_barcodeRankPlot_initScale_allCells-1.png" width="672" /></p>
<p>Given the exponential shape of the curve above, library sizes can be shown on the log10 scale:</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="PreProcAllCellsTop.html#cb61-1"></a><span class="kw">plot</span>(barcode_rank, log10_lib_size, <span class="dt">xlim=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">10000</span>))</span></code></pre></div>
<p><img src="MkWiC_files/figure-html/cellCall_barcodeRankPlot_logScale_allCells-1.png" width="672" /></p>
<p>The plot above shows that the majority of droplets have fewer than 100 UMIs, e.g. droplets with rank greater than 4000. We will redraw the plot to focus on droplets with lower ranks, by using the log10 scale for the x-axis.</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb62-1"><a href="PreProcAllCellsTop.html#cb62-1"></a><span class="kw">plot</span>(<span class="kw">log10</span>(barcode_rank), log10_lib_size, <span class="dt">xlim=</span><span class="kw">log10</span>(<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">10000</span>)))</span></code></pre></div>
<p><img src="MkWiC_files/figure-html/cellCall_barcodeRankPlot_logScale2_allCells-1.png" width="672" /></p>
<p>The point on the curve where it drops sharply may be used as the split point. Before that point library sizes are high, because droplets carry a cell. After that point, library sizes are far smaller because droplets do not carry a cell, only ambient RNA (… or do they?).</p>
<p>Here, we could ‘visually’ approximate the number of cells to 2500. There are however more robust and convenient methods.</p>
</div>
<div id="inflection-point" class="section level3">
<h3><span class="header-section-number">4.7.3</span> Inflection point</h3>
<p>We could also compute the inflection point of the curve.</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="PreProcAllCellsTop.html#cb63-1"></a>o &lt;-<span class="st"> </span><span class="kw">order</span>(barcode_rank)</span>
<span id="cb63-2"><a href="PreProcAllCellsTop.html#cb63-2"></a>log10_lib_size &lt;-<span class="st"> </span>log10_lib_size[o]</span>
<span id="cb63-3"><a href="PreProcAllCellsTop.html#cb63-3"></a>barcode_rank &lt;-<span class="st"> </span>barcode_rank[o]</span>
<span id="cb63-4"><a href="PreProcAllCellsTop.html#cb63-4"></a></span>
<span id="cb63-5"><a href="PreProcAllCellsTop.html#cb63-5"></a>rawdiff &lt;-<span class="st"> </span><span class="kw">diff</span>(log10_lib_size)<span class="op">/</span><span class="kw">diff</span>(barcode_rank)</span>
<span id="cb63-6"><a href="PreProcAllCellsTop.html#cb63-6"></a>inflection &lt;-<span class="st"> </span><span class="kw">which</span>(rawdiff <span class="op">==</span><span class="st"> </span><span class="kw">min</span>(rawdiff[<span class="dv">100</span><span class="op">:</span><span class="kw">length</span>(rawdiff)], <span class="dt">na.rm=</span><span class="ot">TRUE</span>))</span>
<span id="cb63-7"><a href="PreProcAllCellsTop.html#cb63-7"></a></span>
<span id="cb63-8"><a href="PreProcAllCellsTop.html#cb63-8"></a><span class="kw">plot</span>(<span class="dt">x=</span><span class="kw">log10</span>(barcode_rank),</span>
<span id="cb63-9"><a href="PreProcAllCellsTop.html#cb63-9"></a>     <span class="dt">y=</span>log10_lib_size,</span>
<span id="cb63-10"><a href="PreProcAllCellsTop.html#cb63-10"></a>     <span class="dt">xlim=</span><span class="kw">log10</span>(<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">10000</span>)))</span>
<span id="cb63-11"><a href="PreProcAllCellsTop.html#cb63-11"></a><span class="kw">abline</span>(<span class="dt">v=</span><span class="kw">log10</span>(inflection), <span class="dt">col=</span><span class="st">&quot;red&quot;</span>, <span class="dt">lwd=</span><span class="dv">2</span>)</span></code></pre></div>
<p><img src="MkWiC_files/figure-html/cellCall_inflex_allCells-1.png" width="672" /></p>
<p>The inflection is at 3279 UMIs (3.5157414 on the log10 scale).
2306 droplets have at least these many UMIs and would thus contain one cell (or more).</p>
</div>
<div id="cellranger-v1-and-v2" class="section level3">
<h3><span class="header-section-number">4.7.4</span> Cellranger v1 and v2</h3>
<p>Given an expected number of cells, cellranger used to assume a ~10-fold range of library sizes for real cells and estimate this range (cellranger (v1 and v2). The threshold was defined as the 99th quantile of the library size, divided by 10.</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb64-1"><a href="PreProcAllCellsTop.html#cb64-1"></a><span class="co"># approximate number of cells expected:</span></span>
<span id="cb64-2"><a href="PreProcAllCellsTop.html#cb64-2"></a>n_cells &lt;-<span class="st"> </span><span class="dv">2500</span></span>
<span id="cb64-3"><a href="PreProcAllCellsTop.html#cb64-3"></a><span class="co"># CellRanger</span></span>
<span id="cb64-4"><a href="PreProcAllCellsTop.html#cb64-4"></a>totals &lt;-<span class="st"> </span><span class="kw">sort</span>(libSizeDf<span class="op">$</span>nUmis, <span class="dt">decreasing =</span> <span class="ot">TRUE</span>)</span>
<span id="cb64-5"><a href="PreProcAllCellsTop.html#cb64-5"></a><span class="co"># 99th percentile of top n_cells divided by 10</span></span>
<span id="cb64-6"><a href="PreProcAllCellsTop.html#cb64-6"></a>thresh =<span class="st"> </span>totals[<span class="kw">round</span>(<span class="fl">0.01</span><span class="op">*</span>n_cells)]<span class="op">/</span><span class="dv">10</span></span>
<span id="cb64-7"><a href="PreProcAllCellsTop.html#cb64-7"></a><span class="kw">plot</span>(<span class="dt">x=</span><span class="kw">log10</span>(<span class="kw">seq</span>(<span class="dv">1</span>,<span class="dv">10000</span>)),</span>
<span id="cb64-8"><a href="PreProcAllCellsTop.html#cb64-8"></a>     <span class="dt">y=</span><span class="kw">log10</span>(totals)[<span class="dv">1</span><span class="op">:</span><span class="dv">10000</span>]</span>
<span id="cb64-9"><a href="PreProcAllCellsTop.html#cb64-9"></a>     )</span>
<span id="cb64-10"><a href="PreProcAllCellsTop.html#cb64-10"></a><span class="kw">abline</span>(<span class="dt">h=</span><span class="kw">log10</span>(thresh), <span class="dt">col=</span><span class="st">&quot;red&quot;</span>, <span class="dt">lwd=</span><span class="dv">2</span>)</span></code></pre></div>
<p><img src="MkWiC_files/figure-html/cellCall_cellrangerV1n2_allCells-1.png" width="672" /></p>
<p>The threshold is at 1452 UMIs and 2773 cells are detected.</p>
</div>
<div id="dropletutils-and-emptydrops" class="section level3">
<h3><span class="header-section-number">4.7.5</span> DropletUtils and EmptyDrops</h3>
<p>The <code>DropletUtils</code> package offers utilities to analyse droplet-based data, including cell counting using the library size as seen above. These simple approaches may exclude droplets with small or quiet cells with low RNA content. The <code>emptyDrops</code> method calls cells by first computing the expression profile for droplets with RNA content so low they almost certainly do not contain any cell: the ‘background’ or ‘ambient’ profile. The method then tests each non-background droplet for significant difference in expression profile.</p>
<p>Let’s first check the knee and inflection methods.</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="PreProcAllCellsTop.html#cb65-1"></a>br.out &lt;-<span class="st"> </span><span class="kw">barcodeRanks</span>(<span class="kw">counts</span>(sce.raw))</span>
<span id="cb65-2"><a href="PreProcAllCellsTop.html#cb65-2"></a><span class="kw">plot</span>(br.out<span class="op">$</span>rank, br.out<span class="op">$</span>total, <span class="dt">log=</span><span class="st">&quot;xy&quot;</span>, <span class="dt">xlab=</span><span class="st">&quot;Rank&quot;</span>, <span class="dt">ylab=</span><span class="st">&quot;Total UMI count&quot;</span>)</span>
<span id="cb65-3"><a href="PreProcAllCellsTop.html#cb65-3"></a>o &lt;-<span class="st"> </span><span class="kw">order</span>(br.out<span class="op">$</span>rank)</span>
<span id="cb65-4"><a href="PreProcAllCellsTop.html#cb65-4"></a><span class="kw">lines</span>(br.out<span class="op">$</span>rank[o], br.out<span class="op">$</span>fitted[o], <span class="dt">col=</span><span class="st">&quot;red&quot;</span>)</span>
<span id="cb65-5"><a href="PreProcAllCellsTop.html#cb65-5"></a></span>
<span id="cb65-6"><a href="PreProcAllCellsTop.html#cb65-6"></a><span class="kw">abline</span>(<span class="dt">h=</span><span class="kw">metadata</span>(br.out)<span class="op">$</span>knee, <span class="dt">col=</span><span class="st">&quot;dodgerblue&quot;</span>, <span class="dt">lty=</span><span class="dv">2</span>)</span>
<span id="cb65-7"><a href="PreProcAllCellsTop.html#cb65-7"></a><span class="kw">abline</span>(<span class="dt">h=</span><span class="kw">metadata</span>(br.out)<span class="op">$</span>inflection, <span class="dt">col=</span><span class="st">&quot;forestgreen&quot;</span>, <span class="dt">lty=</span><span class="dv">2</span>)</span>
<span id="cb65-8"><a href="PreProcAllCellsTop.html#cb65-8"></a><span class="kw">legend</span>(<span class="st">&quot;bottomleft&quot;</span>, <span class="dt">lty=</span><span class="dv">2</span>, <span class="dt">col=</span><span class="kw">c</span>(<span class="st">&quot;dodgerblue&quot;</span>, <span class="st">&quot;forestgreen&quot;</span>), </span>
<span id="cb65-9"><a href="PreProcAllCellsTop.html#cb65-9"></a>    <span class="dt">legend=</span><span class="kw">c</span>(<span class="st">&quot;knee&quot;</span>, <span class="st">&quot;inflection&quot;</span>))</span></code></pre></div>
<p><img src="MkWiC_files/figure-html/cellCall_dropletUtils_allCells-1.png" width="672" /></p>
<p>Testing for empty droplets.</p>
<p>We will call cells with a false discovery rate (FDR) of 0.1% so that at most 1 in 1000 droplets called may be empty.</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="PreProcAllCellsTop.html#cb66-1"></a><span class="co"># a bit slow</span></span>
<span id="cb66-2"><a href="PreProcAllCellsTop.html#cb66-2"></a><span class="co"># significance is computed by simulation so we set a seed for reproducibility</span></span>
<span id="cb66-3"><a href="PreProcAllCellsTop.html#cb66-3"></a><span class="kw">set.seed</span>(<span class="dv">100</span>)</span>
<span id="cb66-4"><a href="PreProcAllCellsTop.html#cb66-4"></a><span class="co"># run analysis:</span></span>
<span id="cb66-5"><a href="PreProcAllCellsTop.html#cb66-5"></a>e.out &lt;-<span class="st"> </span><span class="kw">emptyDrops</span>(<span class="kw">counts</span>(sce.raw))</span>
<span id="cb66-6"><a href="PreProcAllCellsTop.html#cb66-6"></a>e.out</span></code></pre></div>
<pre><code>## DataFrame with 737280 rows and 5 columns
##                        Total   LogProb    PValue   Limited       FDR
##                    &lt;integer&gt; &lt;numeric&gt; &lt;numeric&gt; &lt;logical&gt; &lt;numeric&gt;
## AAACCTGAGAAACCAT-1         0        NA        NA        NA        NA
## AAACCTGAGAAACCGC-1         0        NA        NA        NA        NA
## AAACCTGAGAAACCTA-1        31        NA        NA        NA        NA
## AAACCTGAGAAACGAG-1         0        NA        NA        NA        NA
## AAACCTGAGAAACGCC-1         0        NA        NA        NA        NA
## ...                      ...       ...       ...       ...       ...
## TTTGTCATCTTTACAC-1         0        NA        NA        NA        NA
## TTTGTCATCTTTACGT-1         1        NA        NA        NA        NA
## TTTGTCATCTTTAGGG-1         0        NA        NA        NA        NA
## TTTGTCATCTTTAGTC-1        26        NA        NA        NA        NA
## TTTGTCATCTTTCCTC-1         0        NA        NA        NA        NA</code></pre>
<p>NAs are assigned to droplets used to compute the ambient profile.</p>
<p>Get numbers of droplets in each class defined by FDR and the cut-off used:</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb68-1"><a href="PreProcAllCellsTop.html#cb68-1"></a><span class="kw">summary</span>(e.out<span class="op">$</span>FDR <span class="op">&lt;=</span><span class="st"> </span><span class="fl">0.001</span>)</span></code></pre></div>
<pre><code>##    Mode   FALSE    TRUE    NA&#39;s 
## logical     487    3075  733718</code></pre>
<p>The test significance is computed by permutation. For each droplet tested, the number of permutations may limit the value of the p-value. This information is available in the ‘Limited’ column. If ‘Limited’ is ‘TRUE’ for any non-significant droplet, the number of permutations was too low, should be increased and the analysis re-run.</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="PreProcAllCellsTop.html#cb70-1"></a>comment=<span class="st">&quot;emptyDrops() uses Monte Carlo simulations to compute p-values for the multinomial sampling transcripts from the ambient pool. The number of Monte Carlo iterations determines the lower bound for the p-values (Phipson and Smyth 2010). The Limited field in the output indicates whether or not the computed p-value for a particular barcode is bounded by the number of iterations. If any non-significant barcodes are TRUE for Limited, we may need to increase the number of iterations. A larger number of iterations will result in a lower p-value for these barcodes, which may allow them to be detected after correcting for multiple testing.&quot;</span></span>
<span id="cb70-2"><a href="PreProcAllCellsTop.html#cb70-2"></a></span>
<span id="cb70-3"><a href="PreProcAllCellsTop.html#cb70-3"></a><span class="kw">table</span>(<span class="dt">Sig=</span>e.out<span class="op">$</span>FDR <span class="op">&lt;=</span><span class="st"> </span><span class="fl">0.001</span>, <span class="dt">Limited=</span>e.out<span class="op">$</span>Limited)</span></code></pre></div>
<pre><code>##        Limited
## Sig     FALSE TRUE
##   FALSE   487    0
##   TRUE     76 2999</code></pre>
<p>Let’s check that the background comprises only empty droplets. If the droplets used to define the background profile are indeed empty, testing them should result in a flat distribution of p-values. Let’s test the ‘ambient’ droplets and draw the p-value distribution.</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb72-1"><a href="PreProcAllCellsTop.html#cb72-1"></a>commment=<span class="st">&quot;As mentioned above, emptyDrops() assumes that barcodes with low total UMI counts are empty droplets. Thus, the null hypothesis should be true for all of these barcodes. We can check whether the hypothesis testing procedure holds its size by examining the distribution of p-values for low-total barcodes with test.ambient=TRUE. Ideally, the distribution should be close to uniform (Figure 6.6). Large peaks near zero indicate that barcodes with total counts below lower are not all ambient in origin. This can be resolved by decreasing lower further to ensure that barcodes corresponding to droplets with very small cells are not used to estimate the ambient profile.&quot;</span></span>
<span id="cb72-2"><a href="PreProcAllCellsTop.html#cb72-2"></a></span>
<span id="cb72-3"><a href="PreProcAllCellsTop.html#cb72-3"></a><span class="kw">set.seed</span>(<span class="dv">100</span>)</span>
<span id="cb72-4"><a href="PreProcAllCellsTop.html#cb72-4"></a>limit &lt;-<span class="st"> </span><span class="dv">100</span>   </span>
<span id="cb72-5"><a href="PreProcAllCellsTop.html#cb72-5"></a>all.out &lt;-<span class="st"> </span><span class="kw">emptyDrops</span>(<span class="kw">counts</span>(sce.raw), <span class="dt">lower=</span>limit, <span class="dt">test.ambient=</span><span class="ot">TRUE</span>)</span>
<span id="cb72-6"><a href="PreProcAllCellsTop.html#cb72-6"></a><span class="kw">hist</span>(all.out<span class="op">$</span>PValue[all.out<span class="op">$</span>Total <span class="op">&lt;=</span><span class="st"> </span>limit <span class="op">&amp;</span><span class="st"> </span>all.out<span class="op">$</span>Total <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>],</span>
<span id="cb72-7"><a href="PreProcAllCellsTop.html#cb72-7"></a>    <span class="dt">xlab=</span><span class="st">&quot;P-value&quot;</span>, <span class="dt">main=</span><span class="st">&quot;&quot;</span>, <span class="dt">col=</span><span class="st">&quot;grey80&quot;</span>) </span></code></pre></div>
<p><img src="MkWiC_files/figure-html/cellCall_emptyDrops_sigEmpty_allCells-1.png" width="672" /></p>
<p>The distribution of p-values looks uniform with no large peak for small values: no cell in these droplets.</p>
<p>To evaluate the outcome of the analysis, we will plot the strength of the evidence against library size.</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="PreProcAllCellsTop.html#cb73-1"></a>is.cell &lt;-<span class="st"> </span>e.out<span class="op">$</span>FDR <span class="op">&lt;=</span><span class="st"> </span><span class="fl">0.001</span></span></code></pre></div>
<p>Number of cells detected: 3075.</p>
<p>The plot plot shows the strength of the evidence against the library size.
Each point is a droplet coloured:</p>
<ul>
<li>in black if without cell,</li>
<li>in red if with a cell (or more)</li>
<li>in green if with a cell (or more) as defined with <code>emptyDrops</code> but not the inflection method.</li>
</ul>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb74-1"><a href="PreProcAllCellsTop.html#cb74-1"></a><span class="co"># colour:</span></span>
<span id="cb74-2"><a href="PreProcAllCellsTop.html#cb74-2"></a>cellColour &lt;-<span class="st"> </span><span class="kw">ifelse</span>(is.cell, <span class="st">&quot;red&quot;</span>, <span class="st">&quot;black&quot;</span>) <span class="co"># rep(&quot;black&quot;, nrow((e.out)))</span></span>
<span id="cb74-3"><a href="PreProcAllCellsTop.html#cb74-3"></a><span class="co"># boolean for presence of cells as defined by the inflection method</span></span>
<span id="cb74-4"><a href="PreProcAllCellsTop.html#cb74-4"></a>tmpBoolInflex &lt;-<span class="st"> </span>e.out<span class="op">$</span>Total <span class="op">&gt;</span><span class="st"> </span><span class="kw">metadata</span>(br.out)<span class="op">$</span>inflection</span>
<span id="cb74-5"><a href="PreProcAllCellsTop.html#cb74-5"></a><span class="co"># boolean for presence of cells as defined by the emptyDrops method</span></span>
<span id="cb74-6"><a href="PreProcAllCellsTop.html#cb74-6"></a>tmpBoolSmall &lt;-<span class="st"> </span>e.out<span class="op">$</span>FDR <span class="op">&lt;=</span><span class="st"> </span><span class="fl">0.001</span></span>
<span id="cb74-7"><a href="PreProcAllCellsTop.html#cb74-7"></a>tmpBoolRecov &lt;-<span class="st"> </span><span class="op">!</span>tmpBoolInflex <span class="op">&amp;</span><span class="st"> </span>tmpBoolSmall</span>
<span id="cb74-8"><a href="PreProcAllCellsTop.html#cb74-8"></a>cellColour[tmpBoolRecov] &lt;-<span class="st"> &quot;green&quot;</span> <span class="co"># &#39;recovered&#39; cells</span></span>
<span id="cb74-9"><a href="PreProcAllCellsTop.html#cb74-9"></a></span>
<span id="cb74-10"><a href="PreProcAllCellsTop.html#cb74-10"></a><span class="co"># plot strength of significance vs library size</span></span>
<span id="cb74-11"><a href="PreProcAllCellsTop.html#cb74-11"></a><span class="kw">plot</span>(<span class="kw">log10</span>(e.out<span class="op">$</span>Total),</span>
<span id="cb74-12"><a href="PreProcAllCellsTop.html#cb74-12"></a>     <span class="op">-</span>e.out<span class="op">$</span>LogProb,</span>
<span id="cb74-13"><a href="PreProcAllCellsTop.html#cb74-13"></a>     <span class="dt">col=</span>cellColour,</span>
<span id="cb74-14"><a href="PreProcAllCellsTop.html#cb74-14"></a>     <span class="dt">xlim=</span><span class="kw">c</span>(<span class="dv">2</span>,<span class="kw">max</span>(<span class="kw">log10</span>(e.out<span class="op">$</span>Total))),</span>
<span id="cb74-15"><a href="PreProcAllCellsTop.html#cb74-15"></a>     <span class="dt">xlab=</span><span class="st">&quot;Total UMI count&quot;</span>,</span>
<span id="cb74-16"><a href="PreProcAllCellsTop.html#cb74-16"></a>     <span class="dt">ylab=</span><span class="st">&quot;-Log Probability&quot;</span>)</span>
<span id="cb74-17"><a href="PreProcAllCellsTop.html#cb74-17"></a></span>
<span id="cb74-18"><a href="PreProcAllCellsTop.html#cb74-18"></a><span class="co"># add point to show &#39;recovered&#39; cell on top</span></span>
<span id="cb74-19"><a href="PreProcAllCellsTop.html#cb74-19"></a><span class="kw">points</span>(<span class="kw">log10</span>(e.out<span class="op">$</span>Total)[tmpBoolRecov],</span>
<span id="cb74-20"><a href="PreProcAllCellsTop.html#cb74-20"></a>       <span class="op">-</span>e.out<span class="op">$</span>LogProb[tmpBoolRecov],</span>
<span id="cb74-21"><a href="PreProcAllCellsTop.html#cb74-21"></a>       <span class="dt">pch=</span><span class="dv">16</span>,</span>
<span id="cb74-22"><a href="PreProcAllCellsTop.html#cb74-22"></a>       <span class="dt">col=</span><span class="st">&quot;green&quot;</span>)</span></code></pre></div>
<p><img src="MkWiC_files/figure-html/cellCall_emptyDrops_diagPlot_allCells-1.png" width="672" /></p>
<p>Let’s filter out empty droplets.</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="PreProcAllCellsTop.html#cb75-1"></a>comment=<span class="st">&quot;Once we are satisfied with the performance of emptyDrops(), we subset our SingleCellExperiment object to retain only the detected cells. Discerning readers will notice the use of which(), which conveniently removes the NAs prior to the subsetting.&quot;</span></span>
<span id="cb75-2"><a href="PreProcAllCellsTop.html#cb75-2"></a></span>
<span id="cb75-3"><a href="PreProcAllCellsTop.html#cb75-3"></a>sce.ed &lt;-<span class="st"> </span>sce.raw[,<span class="kw">which</span>(e.out<span class="op">$</span>FDR <span class="op">&lt;=</span><span class="st"> </span><span class="fl">0.001</span>)] <span class="co"># ed for empty droplet</span></span>
<span id="cb75-4"><a href="PreProcAllCellsTop.html#cb75-4"></a><span class="kw">rm</span>(sce.raw);</span>
<span id="cb75-5"><a href="PreProcAllCellsTop.html#cb75-5"></a><span class="kw">gc</span>();</span></code></pre></div>
<pre><code>##            used  (Mb) gc trigger   (Mb)  max used   (Mb)
## Ncells  9065272 484.2   16305644  870.9  16305644  870.9
## Vcells 59369154 453.0  215050788 1640.8 336016856 2563.7</code></pre>
<p>And check the new SCE object:</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb77-1"><a href="PreProcAllCellsTop.html#cb77-1"></a>sce.ed</span></code></pre></div>
<pre><code>## class: SingleCellExperiment 
## dim: 33538 3075 
## metadata(1): Samples
## assays(1): counts
## rownames(33538): ENSG00000243485 ENSG00000237613 ... ENSG00000277475
##   ENSG00000268674
## rowData names(3): ID Symbol Type
## colnames(3075): AAACCTGAGACTTTCG-1 AAACCTGGTCTTCAAG-1 ...
##   TTTGTCACAGGCTCAC-1 TTTGTCAGTTCGGCAC-1
## colData names(2): Sample Barcode
## reducedDimNames(0):
## altExpNames(0):</code></pre>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb79-1"><a href="PreProcAllCellsTop.html#cb79-1"></a><span class="kw">rm</span>(sce.ed)</span></code></pre></div>
<p>Cell calling in cellranger v3 uses a method similar to emptyDrops() and a ‘filtered matrix’ is generated that only keeps droplets deemed to contain a cell. We will load these filtered matrices now.</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb80-1"><a href="PreProcAllCellsTop.html#cb80-1"></a>text=<span class="st">&quot;emptyDrops() already removes cells with very low library sizes or (by association) low numbers of expressed genes. Thus, further filtering on these metrics is not strictly necessary. It may still be desirable to filter on both of these metrics to remove non-empty droplets containing cell fragments or stripped nuclei that were not caught by the mitochondrial filter. However, this should be weighed against the risk of losing genuine cell types as discussed in Section 6.3.2.2.&quot;</span></span></code></pre></div>
</div>
</div>
<div id="load-filtered-matrices" class="section level2">
<h2><span class="header-section-number">4.8</span> Load filtered matrices</h2>
<p>Each sample was analysed with cellranger separately. We load filtered matrices one sample at a time, showing for each the name and number of features and cells.</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb81-1"><a href="PreProcAllCellsTop.html#cb81-1"></a><span class="co"># a bit slow</span></span>
<span id="cb81-2"><a href="PreProcAllCellsTop.html#cb81-2"></a><span class="co"># load data:</span></span>
<span id="cb81-3"><a href="PreProcAllCellsTop.html#cb81-3"></a>sce.list &lt;-<span class="st"> </span><span class="kw">vector</span>(<span class="st">&quot;list&quot;</span>, <span class="dt">length =</span> <span class="kw">nrow</span>(sampleSheet))</span>
<span id="cb81-4"><a href="PreProcAllCellsTop.html#cb81-4"></a></span>
<span id="cb81-5"><a href="PreProcAllCellsTop.html#cb81-5"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(sampleSheet))</span>
<span id="cb81-6"><a href="PreProcAllCellsTop.html#cb81-6"></a>{</span>
<span id="cb81-7"><a href="PreProcAllCellsTop.html#cb81-7"></a>    <span class="kw">print</span>(<span class="kw">sprintf</span>(<span class="st">&quot;&#39;Run&#39; %s, &#39;Sample.Name&#39; %s&quot;</span>, sampleSheet[i,<span class="st">&quot;Run&quot;</span>], sampleSheet[i,<span class="st">&quot;Sample.Name&quot;</span>]))</span>
<span id="cb81-8"><a href="PreProcAllCellsTop.html#cb81-8"></a>    sample.path &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/%s/%s/outs/filtered_feature_bc_matrix/&quot;</span>,</span>
<span id="cb81-9"><a href="PreProcAllCellsTop.html#cb81-9"></a>                           <span class="kw">sprintf</span>(<span class="st">&quot;%s/%s/grch38300&quot;</span>,</span>
<span id="cb81-10"><a href="PreProcAllCellsTop.html#cb81-10"></a>                                   projDir,</span>
<span id="cb81-11"><a href="PreProcAllCellsTop.html#cb81-11"></a>                                   <span class="kw">ifelse</span>(sampleSheet[i,<span class="st">&quot;source_name&quot;</span>] <span class="op">==</span><span class="st"> &quot;ABMMC&quot;</span>,</span>
<span id="cb81-12"><a href="PreProcAllCellsTop.html#cb81-12"></a>                                          <span class="st">&quot;Hca&quot;</span>,</span>
<span id="cb81-13"><a href="PreProcAllCellsTop.html#cb81-13"></a>                                          <span class="st">&quot;CaronBourque2020&quot;</span>)),</span>
<span id="cb81-14"><a href="PreProcAllCellsTop.html#cb81-14"></a>                           sampleSheet[i,<span class="st">&quot;Run&quot;</span>],</span>
<span id="cb81-15"><a href="PreProcAllCellsTop.html#cb81-15"></a>                           sampleSheet[i,<span class="st">&quot;Run&quot;</span>])</span>
<span id="cb81-16"><a href="PreProcAllCellsTop.html#cb81-16"></a>    sce.list[[i]] &lt;-<span class="st"> </span><span class="kw">read10xCounts</span>(sample.path)</span>
<span id="cb81-17"><a href="PreProcAllCellsTop.html#cb81-17"></a>    <span class="kw">print</span>(<span class="kw">dim</span>(sce.list[[i]]))</span>
<span id="cb81-18"><a href="PreProcAllCellsTop.html#cb81-18"></a>}</span></code></pre></div>
<pre><code>## [1] &quot;&#39;Run&#39; SRR9264343, &#39;Sample.Name&#39; GSM3872434&quot;
## [1] 33538  3088
## [1] &quot;&#39;Run&#39; SRR9264344, &#39;Sample.Name&#39; GSM3872435&quot;
## [1] 33538  6678
## [1] &quot;&#39;Run&#39; SRR9264345, &#39;Sample.Name&#39; GSM3872436&quot;
## [1] 33538  5054
## [1] &quot;&#39;Run&#39; SRR9264346, &#39;Sample.Name&#39; GSM3872437&quot;
## [1] 33538  6096
## [1] &quot;&#39;Run&#39; SRR9264347, &#39;Sample.Name&#39; GSM3872438&quot;
## [1] 33538  5442
## [1] &quot;&#39;Run&#39; SRR9264348, &#39;Sample.Name&#39; GSM3872439&quot;
## [1] 33538  5502
## [1] &quot;&#39;Run&#39; SRR9264349, &#39;Sample.Name&#39; GSM3872440&quot;
## [1] 33538  4126
## [1] &quot;&#39;Run&#39; SRR9264350, &#39;Sample.Name&#39; GSM3872441&quot;
## [1] 33538  3741
## [1] &quot;&#39;Run&#39; SRR9264351, &#39;Sample.Name&#39; GSM3872442&quot;
## [1] 33538   978
## [1] &quot;&#39;Run&#39; SRR9264352, &#39;Sample.Name&#39; GSM3872442&quot;
## [1] 33538  1150
## [1] &quot;&#39;Run&#39; SRR9264353, &#39;Sample.Name&#39; GSM3872443&quot;
## [1] 33538  4964
## [1] &quot;&#39;Run&#39; SRR9264354, &#39;Sample.Name&#39; GSM3872444&quot;
## [1] 33538  4255
## [1] &quot;&#39;Run&#39; MantonBM1, &#39;Sample.Name&#39; MantonBM1&quot;
## [1] 33538 23283
## [1] &quot;&#39;Run&#39; MantonBM2, &#39;Sample.Name&#39; MantonBM2&quot;
## [1] 33538 25055
## [1] &quot;&#39;Run&#39; MantonBM3, &#39;Sample.Name&#39; MantonBM3&quot;
## [1] 33538 24548
## [1] &quot;&#39;Run&#39; MantonBM4, &#39;Sample.Name&#39; MantonBM4&quot;
## [1] 33538 26478
## [1] &quot;&#39;Run&#39; MantonBM5, &#39;Sample.Name&#39; MantonBM5&quot;
## [1] 33538 26383
## [1] &quot;&#39;Run&#39; MantonBM6, &#39;Sample.Name&#39; MantonBM6&quot;
## [1] 33538 22801
## [1] &quot;&#39;Run&#39; MantonBM7, &#39;Sample.Name&#39; MantonBM7&quot;
## [1] 33538 24372
## [1] &quot;&#39;Run&#39; MantonBM8, &#39;Sample.Name&#39; MantonBM8&quot;
## [1] 33538 24860</code></pre>
<p>Let’s combine all 20 samples into a single object.</p>
<p>We first check the feature lists are identical.</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb83-1"><a href="PreProcAllCellsTop.html#cb83-1"></a><span class="co"># check row names are the same</span></span>
<span id="cb83-2"><a href="PreProcAllCellsTop.html#cb83-2"></a><span class="co"># compare to that for the first sample</span></span>
<span id="cb83-3"><a href="PreProcAllCellsTop.html#cb83-3"></a></span>
<span id="cb83-4"><a href="PreProcAllCellsTop.html#cb83-4"></a>rowNames1 &lt;-<span class="st"> </span><span class="kw">rownames</span>(sce.list[[<span class="dv">1</span>]])</span>
<span id="cb83-5"><a href="PreProcAllCellsTop.html#cb83-5"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="op">:</span><span class="kw">nrow</span>(sampleSheet))</span>
<span id="cb83-6"><a href="PreProcAllCellsTop.html#cb83-6"></a>{</span>
<span id="cb83-7"><a href="PreProcAllCellsTop.html#cb83-7"></a>    <span class="kw">print</span>(<span class="kw">identical</span>(rowNames1, <span class="kw">rownames</span>(sce.list[[i]])))</span>
<span id="cb83-8"><a href="PreProcAllCellsTop.html#cb83-8"></a>}</span></code></pre></div>
<pre><code>## [1] TRUE
## [1] TRUE
## [1] TRUE
## [1] TRUE
## [1] TRUE
## [1] TRUE
## [1] TRUE
## [1] TRUE
## [1] TRUE
## [1] TRUE
## [1] TRUE
## [1] TRUE
## [1] TRUE
## [1] TRUE
## [1] TRUE
## [1] TRUE
## [1] TRUE
## [1] TRUE
## [1] TRUE</code></pre>
<p>A cell barcode comprises the actual sequence and a ‘group ID’, e.g. AAACCTGAGAAACCAT-1. The latter helps distinguish cells that share the same sequence but come from different samples. As each sample was analysed separately, the group ID is set to 1 in all data sets. To pool these data sets we first need to change group IDs so cell barcodes are unique across all samples. We will use the position of the sample in the sample sheet.</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb85-1"><a href="PreProcAllCellsTop.html#cb85-1"></a>sce &lt;-<span class="st"> </span>sce.list[[<span class="dv">1</span>]]</span>
<span id="cb85-2"><a href="PreProcAllCellsTop.html#cb85-2"></a><span class="kw">colData</span>(sce)<span class="op">$</span>Barcode &lt;-<span class="st"> </span><span class="kw">gsub</span>(<span class="st">&quot;([0-9])$&quot;</span>, <span class="dv">1</span>, <span class="kw">colData</span>(sce)<span class="op">$</span>Barcode)</span>
<span id="cb85-3"><a href="PreProcAllCellsTop.html#cb85-3"></a><span class="kw">print</span>(<span class="kw">head</span>(<span class="kw">colData</span>(sce)<span class="op">$</span>Barcode))</span></code></pre></div>
<pre><code>## [1] &quot;AAACCTGAGACTTTCG-1&quot; &quot;AAACCTGGTCTTCAAG-1&quot; &quot;AAACCTGGTGCAACTT-1&quot;
## [4] &quot;AAACCTGGTGTTGAGG-1&quot; &quot;AAACCTGTCCCAAGTA-1&quot; &quot;AAACCTGTCGAATGCT-1&quot;</code></pre>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb87-1"><a href="PreProcAllCellsTop.html#cb87-1"></a><span class="kw">print</span>(<span class="kw">tail</span>(<span class="kw">colData</span>(sce)<span class="op">$</span>Barcode))</span></code></pre></div>
<pre><code>## [1] &quot;TTTGGTTTCCGAAGAG-1&quot; &quot;TTTGGTTTCTTTAGGG-1&quot; &quot;TTTGTCAAGAAACGAG-1&quot;
## [4] &quot;TTTGTCAAGGACGAAA-1&quot; &quot;TTTGTCACAGGCTCAC-1&quot; &quot;TTTGTCAGTTCGGCAC-1&quot;</code></pre>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb89-1"><a href="PreProcAllCellsTop.html#cb89-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="op">:</span><span class="kw">nrow</span>(sampleSheet))</span>
<span id="cb89-2"><a href="PreProcAllCellsTop.html#cb89-2"></a>{</span>
<span id="cb89-3"><a href="PreProcAllCellsTop.html#cb89-3"></a>    sce.tmp &lt;-<span class="st"> </span>sce.list[[i]]</span>
<span id="cb89-4"><a href="PreProcAllCellsTop.html#cb89-4"></a>    <span class="kw">colData</span>(sce.tmp)<span class="op">$</span>Barcode &lt;-<span class="st"> </span><span class="kw">gsub</span>(<span class="st">&quot;([0-9])$&quot;</span>, i, <span class="kw">colData</span>(sce.tmp)<span class="op">$</span>Barcode)</span>
<span id="cb89-5"><a href="PreProcAllCellsTop.html#cb89-5"></a>    sce &lt;-<span class="st"> </span><span class="kw">cbind</span>(sce, sce.tmp)</span>
<span id="cb89-6"><a href="PreProcAllCellsTop.html#cb89-6"></a>    <span class="co">#print(head(colData(sce)$Barcode))</span></span>
<span id="cb89-7"><a href="PreProcAllCellsTop.html#cb89-7"></a>    <span class="kw">print</span>(<span class="kw">tail</span>(<span class="kw">colData</span>(sce)<span class="op">$</span>Barcode, <span class="dv">2</span>))</span>
<span id="cb89-8"><a href="PreProcAllCellsTop.html#cb89-8"></a>}</span></code></pre></div>
<pre><code>## [1] &quot;TTTGTCATCTTAACCT-2&quot; &quot;TTTGTCATCTTCTGGC-2&quot;
## [1] &quot;TTTGTCATCCGCGGTA-3&quot; &quot;TTTGTCATCCGGGTGT-3&quot;
## [1] &quot;TTTGTCATCACTCTTA-4&quot; &quot;TTTGTCATCTATCCCG-4&quot;
## [1] &quot;TTTGTCAGTTCCCTTG-5&quot; &quot;TTTGTCATCGACGGAA-5&quot;
## [1] &quot;TTTGTCATCCTTTCGG-6&quot; &quot;TTTGTCATCTATGTGG-6&quot;
## [1] &quot;TTTGTCAGTCATTAGC-7&quot; &quot;TTTGTCAGTTGTGGCC-7&quot;
## [1] &quot;TTTGTCATCTACCAGA-8&quot; &quot;TTTGTCATCTGCAGTA-8&quot;
## [1] &quot;TTTGGTTGTGCATCTA-9&quot; &quot;TTTGTCACAGCTCGAC-9&quot;
## [1] &quot;TTTGTCAGTAAATGTG-10&quot; &quot;TTTGTCAGTACAAGTA-10&quot;
## [1] &quot;TTTGTCATCACCCTCA-11&quot; &quot;TTTGTCATCTTCATGT-11&quot;
## [1] &quot;TTTGTCATCAGTTGAC-12&quot; &quot;TTTGTCATCTCGTTTA-12&quot;
## [1] &quot;TTTGTCATCTTTACAC-13&quot; &quot;TTTGTCATCTTTCCTC-13&quot;
## [1] &quot;TTTGTCATCGACGGAA-14&quot; &quot;TTTGTCATCGCCTGAG-14&quot;
## [1] &quot;TTTGTCATCTTGTACT-15&quot; &quot;TTTGTCATCTTTAGGG-15&quot;
## [1] &quot;TTTGTCATCGGATGGA-16&quot; &quot;TTTGTCATCGTGGACC-16&quot;
## [1] &quot;TTTGTCATCTGCGGCA-17&quot; &quot;TTTGTCATCTGCGTAA-17&quot;
## [1] &quot;TTTGTCATCTAACTGG-18&quot; &quot;TTTGTCATCTGCGGCA-18&quot;
## [1] &quot;TTTGTCATCTGGGCCA-19&quot; &quot;TTTGTCATCTTGTATC-19&quot;
## [1] &quot;TTTGTCATCTTGAGAC-20&quot; &quot;TTTGTCATCTTGTATC-20&quot;</code></pre>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb91-1"><a href="PreProcAllCellsTop.html#cb91-1"></a><span class="kw">rm</span>(sce.list)</span></code></pre></div>
<p>We now add the sample sheet information to the object metadata.</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb92-1"><a href="PreProcAllCellsTop.html#cb92-1"></a>colDataOrig &lt;-<span class="st"> </span><span class="kw">colData</span>(sce)</span>
<span id="cb92-2"><a href="PreProcAllCellsTop.html#cb92-2"></a></span>
<span id="cb92-3"><a href="PreProcAllCellsTop.html#cb92-3"></a><span class="co"># split path:</span></span>
<span id="cb92-4"><a href="PreProcAllCellsTop.html#cb92-4"></a>tmpList &lt;-<span class="st"> </span><span class="kw">strsplit</span>(colDataOrig<span class="op">$</span>Sample, <span class="dt">split=</span><span class="st">&quot;/&quot;</span>)</span>
<span id="cb92-5"><a href="PreProcAllCellsTop.html#cb92-5"></a><span class="co"># get Run ID, to use to match sample in the meta data and sample sheet objects:</span></span>
<span id="cb92-6"><a href="PreProcAllCellsTop.html#cb92-6"></a>tmpVec &lt;-<span class="st"> </span><span class="kw">unlist</span>(<span class="kw">lapply</span>(tmpList, <span class="cf">function</span>(x){x[<span class="dv">9</span>]}))</span>
<span id="cb92-7"><a href="PreProcAllCellsTop.html#cb92-7"></a><span class="kw">colData</span>(sce)<span class="op">$</span>Run &lt;-<span class="st"> </span>tmpVec</span>
<span id="cb92-8"><a href="PreProcAllCellsTop.html#cb92-8"></a><span class="co"># merge:</span></span>
<span id="cb92-9"><a href="PreProcAllCellsTop.html#cb92-9"></a><span class="kw">colData</span>(sce) &lt;-<span class="st"> </span><span class="kw">colData</span>(sce) <span class="op">%&gt;%</span></span>
<span id="cb92-10"><a href="PreProcAllCellsTop.html#cb92-10"></a><span class="st">    </span>data.frame <span class="op">%&gt;%</span></span>
<span id="cb92-11"><a href="PreProcAllCellsTop.html#cb92-11"></a><span class="st">    </span><span class="kw">left_join</span>(sampleSheet[,splShtColToKeep], <span class="st">&quot;Run&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb92-12"><a href="PreProcAllCellsTop.html#cb92-12"></a><span class="st">    </span><span class="kw">relocate</span>() <span class="op">%&gt;%</span></span>
<span id="cb92-13"><a href="PreProcAllCellsTop.html#cb92-13"></a><span class="st">    </span>DataFrame</span></code></pre></div>
<p>Let’s save the object for future reference.</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb93-1"><a href="PreProcAllCellsTop.html#cb93-1"></a><span class="co"># Write object to file</span></span>
<span id="cb93-2"><a href="PreProcAllCellsTop.html#cb93-2"></a>tmpFn &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/%s/Robjects/sce_postPool%s.Rds&quot;</span>,</span>
<span id="cb93-3"><a href="PreProcAllCellsTop.html#cb93-3"></a>         projDir, outDirBit, setSuf)</span>
<span id="cb93-4"><a href="PreProcAllCellsTop.html#cb93-4"></a><span class="kw">saveRDS</span>(sce, tmpFn)</span></code></pre></div>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb94-1"><a href="PreProcAllCellsTop.html#cb94-1"></a><span class="co"># Read object in:</span></span>
<span id="cb94-2"><a href="PreProcAllCellsTop.html#cb94-2"></a>tmpFn &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/%s/Robjects/sce_postPool%s.Rds&quot;</span>,</span>
<span id="cb94-3"><a href="PreProcAllCellsTop.html#cb94-3"></a>         projDir, outDirBit, setSuf)</span>
<span id="cb94-4"><a href="PreProcAllCellsTop.html#cb94-4"></a>sce &lt;-<span class="st"> </span><span class="kw">readRDS</span>(tmpFn)</span></code></pre></div>
</div>
<div id="properties-of-scrna-seq-data" class="section level2">
<h2><span class="header-section-number">4.9</span> Properties of scRNA-seq data</h2>
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb95-1"><a href="PreProcAllCellsTop.html#cb95-1"></a><span class="co"># a bit slow</span></span>
<span id="cb95-2"><a href="PreProcAllCellsTop.html#cb95-2"></a></span>
<span id="cb95-3"><a href="PreProcAllCellsTop.html#cb95-3"></a><span class="co"># </span><span class="al">TODO</span><span class="co"> first remove emtpy droplets the mol.info data</span></span>
<span id="cb95-4"><a href="PreProcAllCellsTop.html#cb95-4"></a>mol.info<span class="op">$</span>data</span>
<span id="cb95-5"><a href="PreProcAllCellsTop.html#cb95-5"></a><span class="kw">head</span>(mol.info<span class="op">$</span>genes)</span>
<span id="cb95-6"><a href="PreProcAllCellsTop.html#cb95-6"></a></span>
<span id="cb95-7"><a href="PreProcAllCellsTop.html#cb95-7"></a>dd &lt;-<span class="st"> </span>mol.info<span class="op">$</span>data <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">data.frame</span>()</span>
<span id="cb95-8"><a href="PreProcAllCellsTop.html#cb95-8"></a>dd<span class="op">$</span>umi &lt;-<span class="st"> </span><span class="kw">as.character</span>(dd<span class="op">$</span>umi)</span>
<span id="cb95-9"><a href="PreProcAllCellsTop.html#cb95-9"></a></span>
<span id="cb95-10"><a href="PreProcAllCellsTop.html#cb95-10"></a>tmpFn &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/%s/Robjects/sce_preProc_ampDf2.Rds&quot;</span>, projDir, outDirBit)</span>
<span id="cb95-11"><a href="PreProcAllCellsTop.html#cb95-11"></a><span class="cf">if</span>(<span class="ot">FALSE</span>) <span class="co"># slow</span></span>
<span id="cb95-12"><a href="PreProcAllCellsTop.html#cb95-12"></a>{</span>
<span id="cb95-13"><a href="PreProcAllCellsTop.html#cb95-13"></a>    ampDf &lt;-<span class="st"> </span>dd <span class="op">%&gt;%</span></span>
<span id="cb95-14"><a href="PreProcAllCellsTop.html#cb95-14"></a><span class="st">        </span><span class="kw">filter</span>(<span class="kw">paste</span>(cell,gem_group, <span class="dt">sep=</span><span class="st">&quot;-&quot;</span>) <span class="op">%in%</span><span class="st"> </span>sce<span class="op">$</span>Barcode) <span class="op">%&gt;%</span></span>
<span id="cb95-15"><a href="PreProcAllCellsTop.html#cb95-15"></a><span class="st">        </span><span class="kw">group_by</span>(cell, gene) <span class="op">%&gt;%</span></span>
<span id="cb95-16"><a href="PreProcAllCellsTop.html#cb95-16"></a><span class="st">        </span><span class="kw">summarise</span>(<span class="dt">nUmis =</span> <span class="kw">n</span>(), <span class="dt">totReads=</span><span class="kw">sum</span>(reads)) <span class="op">%&gt;%</span></span>
<span id="cb95-17"><a href="PreProcAllCellsTop.html#cb95-17"></a><span class="st">        </span><span class="kw">data.frame</span>()</span>
<span id="cb95-18"><a href="PreProcAllCellsTop.html#cb95-18"></a>    <span class="co"># Write object to file</span></span>
<span id="cb95-19"><a href="PreProcAllCellsTop.html#cb95-19"></a>    <span class="kw">saveRDS</span>(ampDf, tmpFn)</span>
<span id="cb95-20"><a href="PreProcAllCellsTop.html#cb95-20"></a>} <span class="cf">else</span> {</span>
<span id="cb95-21"><a href="PreProcAllCellsTop.html#cb95-21"></a>    ampDf &lt;-<span class="st"> </span><span class="kw">readRDS</span>(tmpFn)</span>
<span id="cb95-22"><a href="PreProcAllCellsTop.html#cb95-22"></a>}</span>
<span id="cb95-23"><a href="PreProcAllCellsTop.html#cb95-23"></a><span class="kw">rm</span>(tmpFn)</span>
<span id="cb95-24"><a href="PreProcAllCellsTop.html#cb95-24"></a></span>
<span id="cb95-25"><a href="PreProcAllCellsTop.html#cb95-25"></a><span class="co">#summary(ampDf$nUmis)</span></span>
<span id="cb95-26"><a href="PreProcAllCellsTop.html#cb95-26"></a><span class="co">#summary(ampDf$totReads)</span></span>
<span id="cb95-27"><a href="PreProcAllCellsTop.html#cb95-27"></a></span>
<span id="cb95-28"><a href="PreProcAllCellsTop.html#cb95-28"></a><span class="kw">hist</span>(<span class="kw">log2</span>(ampDf<span class="op">$</span>nUmis), <span class="dt">n=</span><span class="dv">100</span>)</span>
<span id="cb95-29"><a href="PreProcAllCellsTop.html#cb95-29"></a><span class="kw">hist</span>(<span class="kw">log2</span>(ampDf<span class="op">$</span>totReads), <span class="dt">n=</span><span class="dv">100</span>)</span></code></pre></div>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb96-1"><a href="PreProcAllCellsTop.html#cb96-1"></a>sp2 &lt;-<span class="st"> </span><span class="kw">ggplot</span>(ampDf, <span class="kw">aes</span>(<span class="dt">x=</span>nUmis, <span class="dt">y=</span>totReads)) <span class="op">+</span></span>
<span id="cb96-2"><a href="PreProcAllCellsTop.html#cb96-2"></a><span class="st">  </span><span class="kw">geom_bin2d</span>(<span class="dt">bins =</span> <span class="dv">50</span>) <span class="op">+</span></span>
<span id="cb96-3"><a href="PreProcAllCellsTop.html#cb96-3"></a><span class="st">  </span><span class="kw">scale_fill_continuous</span>(<span class="dt">type =</span> <span class="st">&quot;viridis&quot;</span>) <span class="op">+</span></span>
<span id="cb96-4"><a href="PreProcAllCellsTop.html#cb96-4"></a><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">trans=</span><span class="st">&#39;log2&#39;</span>) <span class="op">+</span></span>
<span id="cb96-5"><a href="PreProcAllCellsTop.html#cb96-5"></a><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">trans=</span><span class="st">&#39;log2&#39;</span>) <span class="op">+</span></span>
<span id="cb96-6"><a href="PreProcAllCellsTop.html#cb96-6"></a><span class="st">  </span><span class="kw">theme_bw</span>()</span>
<span id="cb96-7"><a href="PreProcAllCellsTop.html#cb96-7"></a></span>
<span id="cb96-8"><a href="PreProcAllCellsTop.html#cb96-8"></a>sp2</span>
<span id="cb96-9"><a href="PreProcAllCellsTop.html#cb96-9"></a></span>
<span id="cb96-10"><a href="PreProcAllCellsTop.html#cb96-10"></a><span class="co">#rm(mol.info)</span></span>
<span id="cb96-11"><a href="PreProcAllCellsTop.html#cb96-11"></a><span class="kw">rm</span>(ampDf)</span>
<span id="cb96-12"><a href="PreProcAllCellsTop.html#cb96-12"></a><span class="kw">gc</span>()</span></code></pre></div>
<p>The number and identity of genes detected in a cell vary across cells: the total number of genes detected across all cells is far larger than the number of genes per cell.</p>
<p>Total number of genes detected across cells:</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb97-1"><a href="PreProcAllCellsTop.html#cb97-1"></a><span class="co"># for each gene, compute total number of UMIs across all cells,</span></span>
<span id="cb97-2"><a href="PreProcAllCellsTop.html#cb97-2"></a><span class="co"># then counts genes with at least one UMI:</span></span>
<span id="cb97-3"><a href="PreProcAllCellsTop.html#cb97-3"></a>countsRowSums &lt;-<span class="st"> </span><span class="kw">rowSums</span>(<span class="kw">counts</span>(sce))</span>
<span id="cb97-4"><a href="PreProcAllCellsTop.html#cb97-4"></a><span class="kw">sum</span>(countsRowSums <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>)</span></code></pre></div>
<pre><code>## [1] 27795</code></pre>
<p>Summary of the distribution of the number of genes detected per cell:</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb99-1"><a href="PreProcAllCellsTop.html#cb99-1"></a><span class="co"># for each cell count number of genes with at least 1 UMI</span></span>
<span id="cb99-2"><a href="PreProcAllCellsTop.html#cb99-2"></a><span class="co"># then compute distribution moments:</span></span>
<span id="cb99-3"><a href="PreProcAllCellsTop.html#cb99-3"></a><span class="kw">summary</span>(<span class="kw">colSums</span>(<span class="kw">counts</span>(sce) <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>))</span></code></pre></div>
<pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##      26     724     873    1173    1262    8077</code></pre>
<p>Now let’s plot for each gene, the total number of UMIs and the proportion of cells that express it.
Lowly expressed genes tend to be detected in a large proportion of cells.
The higher the overall expression the lower the proportion of cells.</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb101-1"><a href="PreProcAllCellsTop.html#cb101-1"></a><span class="co"># very slow; many points</span></span>
<span id="cb101-2"><a href="PreProcAllCellsTop.html#cb101-2"></a><span class="co"># skip in DEV, </span><span class="al">TODO</span><span class="co">: write plot to file and embed that.</span></span>
<span id="cb101-3"><a href="PreProcAllCellsTop.html#cb101-3"></a><span class="co"># x-axis: total number of UMIs for the gene across all cells</span></span>
<span id="cb101-4"><a href="PreProcAllCellsTop.html#cb101-4"></a><span class="co"># y-axis: fraction of cells expressing the gene</span></span>
<span id="cb101-5"><a href="PreProcAllCellsTop.html#cb101-5"></a>tmpFn &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/%s/%s/corelLibSizePropCellExpress%s.png&quot;</span>,</span>
<span id="cb101-6"><a href="PreProcAllCellsTop.html#cb101-6"></a>         projDir, outDirBit, qcPlotDirBit, setSuf)</span>
<span id="cb101-7"><a href="PreProcAllCellsTop.html#cb101-7"></a><span class="kw">png</span>(tmpFn)</span>
<span id="cb101-8"><a href="PreProcAllCellsTop.html#cb101-8"></a><span class="kw">plot</span>(</span>
<span id="cb101-9"><a href="PreProcAllCellsTop.html#cb101-9"></a>     <span class="co"># x-axis: nb UMI per gene across all cells</span></span>
<span id="cb101-10"><a href="PreProcAllCellsTop.html#cb101-10"></a>     countsRowSums,</span>
<span id="cb101-11"><a href="PreProcAllCellsTop.html#cb101-11"></a>     <span class="co"># y-axis: proportion of cells that do express the cell</span></span>
<span id="cb101-12"><a href="PreProcAllCellsTop.html#cb101-12"></a>     <span class="kw">rowMeans</span>(<span class="kw">counts</span>(sce) <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>),</span>
<span id="cb101-13"><a href="PreProcAllCellsTop.html#cb101-13"></a>     <span class="dt">log =</span> <span class="st">&quot;x&quot;</span>,</span>
<span id="cb101-14"><a href="PreProcAllCellsTop.html#cb101-14"></a>     <span class="dt">xlab=</span><span class="st">&quot;total number of UMIs&quot;</span>,</span>
<span id="cb101-15"><a href="PreProcAllCellsTop.html#cb101-15"></a>     <span class="dt">ylab=</span><span class="st">&quot;proportion of cells expressing the gene&quot;</span></span>
<span id="cb101-16"><a href="PreProcAllCellsTop.html#cb101-16"></a>)</span>
<span id="cb101-17"><a href="PreProcAllCellsTop.html#cb101-17"></a><span class="kw">dev.off</span>()</span></code></pre></div>
<div class="sourceCode" id="cb102"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb102-1"><a href="PreProcAllCellsTop.html#cb102-1"></a>dd &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="st">&quot;countsRowSums&quot;</span> =<span class="st"> </span>countsRowSums,</span>
<span id="cb102-2"><a href="PreProcAllCellsTop.html#cb102-2"></a>                 <span class="st">&quot;propCellsExpr&quot;</span> =<span class="st"> </span><span class="kw">rowMeans</span>(<span class="kw">counts</span>(sce) <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>))</span>
<span id="cb102-3"><a href="PreProcAllCellsTop.html#cb102-3"></a><span class="kw">head</span>(dd)</span></code></pre></div>
<pre><code>##                 countsRowSums propCellsExpr
## ENSG00000243485             3  1.205526e-05
## ENSG00000237613             0  0.000000e+00
## ENSG00000186092             0  0.000000e+00
## ENSG00000238009           203  8.157393e-04
## ENSG00000239945             5  2.009210e-05
## ENSG00000239906             0  0.000000e+00</code></pre>
<div class="sourceCode" id="cb104"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb104-1"><a href="PreProcAllCellsTop.html#cb104-1"></a>sp &lt;-<span class="st"> </span><span class="kw">ggplot</span>(dd, <span class="kw">aes</span>(<span class="dt">x=</span>countsRowSums, <span class="dt">y=</span>propCellsExpr)) <span class="op">+</span></span>
<span id="cb104-2"><a href="PreProcAllCellsTop.html#cb104-2"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">alpha=</span><span class="fl">0.3</span>) <span class="op">+</span></span>
<span id="cb104-3"><a href="PreProcAllCellsTop.html#cb104-3"></a><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">trans=</span><span class="st">&#39;log10&#39;</span>) <span class="op">+</span></span>
<span id="cb104-4"><a href="PreProcAllCellsTop.html#cb104-4"></a><span class="st">  </span><span class="kw">geom_density_2d</span>() <span class="op">+</span></span>
<span id="cb104-5"><a href="PreProcAllCellsTop.html#cb104-5"></a><span class="st">  </span><span class="kw">xlab</span>(<span class="st">&quot;total number of UMIs&quot;</span>) <span class="op">+</span></span>
<span id="cb104-6"><a href="PreProcAllCellsTop.html#cb104-6"></a><span class="st">  </span><span class="kw">ylab</span>(<span class="st">&quot;proportion of cells expressing the gene&quot;</span>)</span>
<span id="cb104-7"><a href="PreProcAllCellsTop.html#cb104-7"></a>sp</span>
<span id="cb104-8"><a href="PreProcAllCellsTop.html#cb104-8"></a>ggExtra<span class="op">::</span><span class="kw">ggMarginal</span>(sp)</span></code></pre></div>
<p><img src="MkWiC_files/figure-html/corelLibSizePropCellExpress_write_allCells_2-1.png" width="672" /></p>
<div class="sourceCode" id="cb105"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb105-1"><a href="PreProcAllCellsTop.html#cb105-1"></a>tmpFn &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/%s/%s/corelLibSizePropCellExpress%s_2.png&quot;</span>,</span>
<span id="cb105-2"><a href="PreProcAllCellsTop.html#cb105-2"></a>         projDir, outDirBit, qcPlotDirBit, setSuf)</span>
<span id="cb105-3"><a href="PreProcAllCellsTop.html#cb105-3"></a>tmpFn</span></code></pre></div>
<pre><code>## [1] &quot;/ssd/personal/baller01/20200511_FernandesM_ME_crukBiSs2020/AnaWiSce/Ana1/Plots/Qc/corelLibSizePropCellExpress_allCells_2.png&quot;</code></pre>
<div class="sourceCode" id="cb107"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb107-1"><a href="PreProcAllCellsTop.html#cb107-1"></a><span class="co">#ggsave(ggExtra::ggMarginal(sp), file=tmpFn)</span></span>
<span id="cb107-2"><a href="PreProcAllCellsTop.html#cb107-2"></a><span class="kw">rm</span>(tmpFn)</span></code></pre></div>
<div class="sourceCode" id="cb108"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb108-1"><a href="PreProcAllCellsTop.html#cb108-1"></a><span class="kw">getwd</span>()</span>
<span id="cb108-2"><a href="PreProcAllCellsTop.html#cb108-2"></a>tmpFn &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/%s/corelLibSizePropCellExpress%s_2.png&quot;</span>,</span>
<span id="cb108-3"><a href="PreProcAllCellsTop.html#cb108-3"></a>                 dirRel, qcPlotDirBit, setSuf)</span>
<span id="cb108-4"><a href="PreProcAllCellsTop.html#cb108-4"></a>knitr<span class="op">::</span><span class="kw">include_graphics</span>(tmpFn, <span class="dt">auto_pdf =</span> <span class="ot">TRUE</span>)</span>
<span id="cb108-5"><a href="PreProcAllCellsTop.html#cb108-5"></a><span class="kw">rm</span>(tmpFn)</span></code></pre></div>
<!-- 1000 cells only to speed plotting -->
<p>Count genes that are not ‘expressed’ (detected):</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb109-1"><a href="PreProcAllCellsTop.html#cb109-1"></a>not.expressed &lt;-<span class="st"> </span><span class="kw">rowSums</span>(<span class="kw">counts</span>(sce)) <span class="op">==</span><span class="st"> </span><span class="dv">0</span></span>
<span id="cb109-2"><a href="PreProcAllCellsTop.html#cb109-2"></a><span class="kw">table</span>(not.expressed)</span></code></pre></div>
<pre><code>## not.expressed
## FALSE  TRUE 
## 27795  5743</code></pre>
<p>Plot the percentage of counts per gene and show genes with the highest UMI counts:</p>
<div class="sourceCode" id="cb111"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb111-1"><a href="PreProcAllCellsTop.html#cb111-1"></a><span class="co">#Compute the relative expression of each gene per cell</span></span>
<span id="cb111-2"><a href="PreProcAllCellsTop.html#cb111-2"></a><span class="co"># a bit slow</span></span>
<span id="cb111-3"><a href="PreProcAllCellsTop.html#cb111-3"></a>rel_expression &lt;-<span class="st"> </span><span class="kw">t</span>( <span class="kw">t</span>(<span class="kw">counts</span>(sce)) <span class="op">/</span><span class="st"> </span>Matrix<span class="op">::</span><span class="kw">colSums</span>(<span class="kw">counts</span>(sce))) <span class="op">*</span><span class="st"> </span><span class="dv">100</span></span>
<span id="cb111-4"><a href="PreProcAllCellsTop.html#cb111-4"></a><span class="kw">rownames</span>(rel_expression) &lt;-<span class="st"> </span><span class="kw">rowData</span>(sce)<span class="op">$</span>Symbol</span>
<span id="cb111-5"><a href="PreProcAllCellsTop.html#cb111-5"></a>most_expressed &lt;-<span class="st"> </span><span class="kw">sort</span>(Matrix<span class="op">::</span><span class="kw">rowSums</span>( rel_expression ),T)[<span class="dv">20</span><span class="op">:</span><span class="dv">1</span>] <span class="op">/</span><span class="st"> </span><span class="kw">ncol</span>(sce)</span>
<span id="cb111-6"><a href="PreProcAllCellsTop.html#cb111-6"></a></span>
<span id="cb111-7"><a href="PreProcAllCellsTop.html#cb111-7"></a><span class="kw">boxplot</span>( <span class="kw">as.matrix</span>(<span class="kw">t</span>(rel_expression[<span class="kw">names</span>(most_expressed),])),</span>
<span id="cb111-8"><a href="PreProcAllCellsTop.html#cb111-8"></a>    <span class="dt">cex=</span>.<span class="dv">1</span>,</span>
<span id="cb111-9"><a href="PreProcAllCellsTop.html#cb111-9"></a>    <span class="dt">las=</span><span class="dv">1</span>,</span>
<span id="cb111-10"><a href="PreProcAllCellsTop.html#cb111-10"></a>    <span class="dt">xlab=</span><span class="st">&quot;% total count per cell&quot;</span>,</span>
<span id="cb111-11"><a href="PreProcAllCellsTop.html#cb111-11"></a>    <span class="dt">col=</span>scales<span class="op">::</span><span class="kw">hue_pal</span>()(<span class="dv">20</span>)[<span class="dv">20</span><span class="op">:</span><span class="dv">1</span>],</span>
<span id="cb111-12"><a href="PreProcAllCellsTop.html#cb111-12"></a>    <span class="dt">horizontal=</span><span class="ot">TRUE</span>)</span></code></pre></div>
<p><img src="MkWiC_files/figure-html/relExpress_boxplot_allCells-1.png" width="672" /></p>
<p>Mind that we have combined two data sets here. It may be interesting to count non-expressed genes in each set separately.</p>
</div>
<div id="quality-control" class="section level2">
<h2><span class="header-section-number">4.10</span> Quality control</h2>
<!-- https://osca.bioconductor.org/quality-control.html -->
<p>Cell calling performed above does not inform on the quality of the library in each of the droplets kept. Poor-quality cells, or rather droplets, may be caused by cell damage during dissociation or failed library preparation. They usually have low UMI counts, few genes detected and/or high mitochondrial content. The presence may affect normalisation, assessment of cell population heterogeneity, clustering and trajectory:</p>
<ul>
<li>Normalisation: Contaminating genes, ‘the ambient RNA’, are detected at low levels in all libraires. In low quality libraries with low RNA content, scaling will increase counts for these genes more than for better-quality cells, resulting in their apparent upregulation in these cells and increased variance overall.</li>
<li>Cell population heterogeneity: variance estimation and dimensionality reduction with PCA where the first principal component will be correlated with library size, rather than biology.</li>
<li>Clustering and trajectory: higher mitochondrial and/or nuclear RNA content may cause low-quality cells to cluster separately or form states or trajectories between distinct cell types.</li>
</ul>
<p>We will now exclude lowly expressed features and identify low-quality cells using the following metrics mostly:</p>
<ul>
<li>library size, i.e. the total number of UMIs per cell</li>
<li>number of features detected per cell</li>
<li>mitochondrial content, i.e. the proportion of UMIs that map to mitochondrial genes, with higher values consistent with leakage from the cytoplasm of RNA, but not mitochodria</li>
</ul>
<p>We will first annotate genes, to know which lie in the mitochondrial genome, then use <a href="https://bioconductor.org/packages/3.11/bioc/html/scater.html">scater</a>’s <code>addPerCellQC()</code> to compute various metrics.</p>
<p>Annotate genes with biomaRt.</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb112-1"><a href="PreProcAllCellsTop.html#cb112-1"></a><span class="co"># retrieve the feature information</span></span>
<span id="cb112-2"><a href="PreProcAllCellsTop.html#cb112-2"></a>gene.info &lt;-<span class="st"> </span><span class="kw">rowData</span>(sce)</span>
<span id="cb112-3"><a href="PreProcAllCellsTop.html#cb112-3"></a></span>
<span id="cb112-4"><a href="PreProcAllCellsTop.html#cb112-4"></a><span class="co"># setup the biomaRt connection to Ensembl using the correct species genome (hsapiens_gene_ensembl)</span></span>
<span id="cb112-5"><a href="PreProcAllCellsTop.html#cb112-5"></a>ensembl &lt;-<span class="st"> </span><span class="kw">useEnsembl</span>(<span class="dt">biomart=</span><span class="st">&#39;ensembl&#39;</span>,</span>
<span id="cb112-6"><a href="PreProcAllCellsTop.html#cb112-6"></a>                      <span class="dt">dataset=</span><span class="st">&#39;hsapiens_gene_ensembl&#39;</span>,</span>
<span id="cb112-7"><a href="PreProcAllCellsTop.html#cb112-7"></a>                      <span class="co">#mirror = &quot;www&quot;)</span></span>
<span id="cb112-8"><a href="PreProcAllCellsTop.html#cb112-8"></a>                      <span class="co">#mirror = &quot;useast&quot;)</span></span>
<span id="cb112-9"><a href="PreProcAllCellsTop.html#cb112-9"></a>                      <span class="dt">mirror =</span> <span class="st">&quot;uswest&quot;</span>)</span>
<span id="cb112-10"><a href="PreProcAllCellsTop.html#cb112-10"></a>                      <span class="co">#mirror = &quot;asia&quot;)</span></span>
<span id="cb112-11"><a href="PreProcAllCellsTop.html#cb112-11"></a></span>
<span id="cb112-12"><a href="PreProcAllCellsTop.html#cb112-12"></a>ensembl =<span class="st"> </span><span class="kw">useMart</span>(<span class="dt">biomart=</span><span class="st">&quot;ENSEMBL_MART_ENSEMBL&quot;</span>,</span>
<span id="cb112-13"><a href="PreProcAllCellsTop.html#cb112-13"></a>                  <span class="dt">dataset=</span><span class="st">&quot;hsapiens_gene_ensembl&quot;</span>, </span>
<span id="cb112-14"><a href="PreProcAllCellsTop.html#cb112-14"></a>                  <span class="dt">host=</span><span class="st">&quot;uswest.ensembl.org&quot;</span>,</span>
<span id="cb112-15"><a href="PreProcAllCellsTop.html#cb112-15"></a>                  <span class="dt">ensemblRedirect =</span> <span class="ot">FALSE</span>)</span>
<span id="cb112-16"><a href="PreProcAllCellsTop.html#cb112-16"></a></span>
<span id="cb112-17"><a href="PreProcAllCellsTop.html#cb112-17"></a></span>
<span id="cb112-18"><a href="PreProcAllCellsTop.html#cb112-18"></a><span class="co"># retrieve the attributes of interest from biomaRt using the Ensembl gene ID as the key</span></span>
<span id="cb112-19"><a href="PreProcAllCellsTop.html#cb112-19"></a><span class="co"># beware that this will only retrieve information for matching IDs</span></span>
<span id="cb112-20"><a href="PreProcAllCellsTop.html#cb112-20"></a>gene_symbol &lt;-<span class="st"> </span><span class="kw">getBM</span>(<span class="dt">attributes=</span><span class="kw">c</span>(<span class="st">&#39;ensembl_gene_id&#39;</span>,</span>
<span id="cb112-21"><a href="PreProcAllCellsTop.html#cb112-21"></a>                                  <span class="st">&#39;external_gene_name&#39;</span>,</span>
<span id="cb112-22"><a href="PreProcAllCellsTop.html#cb112-22"></a>                                  <span class="st">&#39;chromosome_name&#39;</span>,</span>
<span id="cb112-23"><a href="PreProcAllCellsTop.html#cb112-23"></a>                                  <span class="st">&#39;start_position&#39;</span>,</span>
<span id="cb112-24"><a href="PreProcAllCellsTop.html#cb112-24"></a>                                  <span class="st">&#39;end_position&#39;</span>,</span>
<span id="cb112-25"><a href="PreProcAllCellsTop.html#cb112-25"></a>                                  <span class="st">&#39;strand&#39;</span>),</span>
<span id="cb112-26"><a href="PreProcAllCellsTop.html#cb112-26"></a>                     <span class="dt">filters=</span><span class="st">&#39;ensembl_gene_id&#39;</span>,</span>
<span id="cb112-27"><a href="PreProcAllCellsTop.html#cb112-27"></a>             <span class="dt">mart=</span>ensembl,</span>
<span id="cb112-28"><a href="PreProcAllCellsTop.html#cb112-28"></a>                     <span class="dt">values=</span>gene.info[, <span class="dv">1</span>])</span>
<span id="cb112-29"><a href="PreProcAllCellsTop.html#cb112-29"></a></span>
<span id="cb112-30"><a href="PreProcAllCellsTop.html#cb112-30"></a><span class="co"># create a new data frame of the feature information</span></span>
<span id="cb112-31"><a href="PreProcAllCellsTop.html#cb112-31"></a>gene.merge &lt;-<span class="st"> </span><span class="kw">merge</span>(gene_symbol, gene.info, <span class="dt">by.x=</span><span class="kw">c</span>(<span class="st">&#39;ensembl_gene_id&#39;</span>), <span class="dt">by.y=</span><span class="kw">c</span>(<span class="st">&#39;ID&#39;</span>), <span class="dt">all.y=</span><span class="ot">TRUE</span>)</span>
<span id="cb112-32"><a href="PreProcAllCellsTop.html#cb112-32"></a><span class="kw">rownames</span>(gene.merge) &lt;-<span class="st"> </span>gene.merge<span class="op">$</span>ensembl_gene_id</span>
<span id="cb112-33"><a href="PreProcAllCellsTop.html#cb112-33"></a></span>
<span id="cb112-34"><a href="PreProcAllCellsTop.html#cb112-34"></a><span class="co"># set the order for the same as the original gene information</span></span>
<span id="cb112-35"><a href="PreProcAllCellsTop.html#cb112-35"></a>gene.merge &lt;-<span class="st"> </span>gene.merge[gene.info[, <span class="dv">1</span>], ]</span>
<span id="cb112-36"><a href="PreProcAllCellsTop.html#cb112-36"></a></span>
<span id="cb112-37"><a href="PreProcAllCellsTop.html#cb112-37"></a><span class="co"># reset the rowdata on the SCE object to contain all of this information</span></span>
<span id="cb112-38"><a href="PreProcAllCellsTop.html#cb112-38"></a><span class="kw">rowData</span>(sce) &lt;-<span class="st"> </span>gene.merge</span></code></pre></div>
<div class="sourceCode" id="cb113"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb113-1"><a href="PreProcAllCellsTop.html#cb113-1"></a><span class="co"># slow</span></span>
<span id="cb113-2"><a href="PreProcAllCellsTop.html#cb113-2"></a><span class="co"># Write object to file</span></span>
<span id="cb113-3"><a href="PreProcAllCellsTop.html#cb113-3"></a>tmpFn &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/%s/Robjects/sce_postBiomart%s.Rds&quot;</span>,</span>
<span id="cb113-4"><a href="PreProcAllCellsTop.html#cb113-4"></a>         projDir, outDirBit, setSuf)</span>
<span id="cb113-5"><a href="PreProcAllCellsTop.html#cb113-5"></a><span class="kw">saveRDS</span>(sce, tmpFn)</span></code></pre></div>
<div class="sourceCode" id="cb114"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb114-1"><a href="PreProcAllCellsTop.html#cb114-1"></a><span class="co"># Read object in:</span></span>
<span id="cb114-2"><a href="PreProcAllCellsTop.html#cb114-2"></a>tmpFn &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/%s/Robjects/sce_postBiomart%s.Rds&quot;</span>,</span>
<span id="cb114-3"><a href="PreProcAllCellsTop.html#cb114-3"></a>         projDir, outDirBit, setSuf)</span>
<span id="cb114-4"><a href="PreProcAllCellsTop.html#cb114-4"></a>sce &lt;-<span class="st"> </span><span class="kw">readRDS</span>(tmpFn)</span></code></pre></div>
<div class="sourceCode" id="cb115"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb115-1"><a href="PreProcAllCellsTop.html#cb115-1"></a><span class="kw">table</span>(<span class="kw">rowData</span>(sce)<span class="op">$</span>chromosome_name)</span></code></pre></div>
<pre><code>## 
##          1         10         11         12         13         14         15 
##       3127       1221       1910       1748        662       1380       1121 
##         16         17         18         19          2         20         21 
##       1518       1880        654       1989       2263        889        499 
##         22          3          4          5          6          7          8 
##        831       1704       1345       1646       1616       1526       1303 
##          9 GL000009.2 GL000194.1 GL000195.1 GL000205.2 GL000213.1 GL000218.1 
##       1211          1          2          2          1          1          1 
## GL000219.1 KI270711.1 KI270713.1 KI270721.1 KI270726.1 KI270727.1 KI270728.1 
##          1          1          2          1          2          4          6 
## KI270731.1 KI270734.1         MT          X          Y 
##          1          3         13       1067         97</code></pre>
<div class="sourceCode" id="cb117"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb117-1"><a href="PreProcAllCellsTop.html#cb117-1"></a>is.mito &lt;-<span class="st"> </span><span class="kw">which</span>(<span class="kw">rowData</span>(sce)<span class="op">$</span>chromosome_name<span class="op">==</span><span class="st">&quot;MT&quot;</span>)</span></code></pre></div>
<p>Calculate and store QC metrics for genes with addPerFeatureQC() and for cells with addPerCellQC().</p>
<div class="sourceCode" id="cb118"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb118-1"><a href="PreProcAllCellsTop.html#cb118-1"></a><span class="co"># long</span></span>
<span id="cb118-2"><a href="PreProcAllCellsTop.html#cb118-2"></a><span class="co"># for genes</span></span>
<span id="cb118-3"><a href="PreProcAllCellsTop.html#cb118-3"></a>sce &lt;-<span class="st"> </span><span class="kw">addPerFeatureQC</span>(sce)</span>
<span id="cb118-4"><a href="PreProcAllCellsTop.html#cb118-4"></a><span class="kw">head</span>(<span class="kw">rowData</span>(sce)) <span class="op">%&gt;%</span></span>
<span id="cb118-5"><a href="PreProcAllCellsTop.html#cb118-5"></a><span class="st">    </span><span class="kw">as.data.frame</span>() <span class="op">%&gt;%</span></span>
<span id="cb118-6"><a href="PreProcAllCellsTop.html#cb118-6"></a><span class="st">    </span><span class="kw">datatable</span>(<span class="dt">rownames =</span> <span class="ot">FALSE</span>) <span class="co"># ENS ID</span></span></code></pre></div>
<div id="htmlwidget-7b5a67458dc91a4f2735" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-7b5a67458dc91a4f2735">{"x":{"filter":"none","data":[["ENSG00000243485","ENSG00000237613","ENSG00000186092","ENSG00000238009","ENSG00000239945","ENSG00000239906"],["MIR1302-2HG","FAM138A","OR4F5","AL627309.1","AL627309.3","AL627309.2"],["1","1","1","1","1","1"],[29554,34554,65419,89295,89551,139790],[31109,36081,71585,133723,91105,140339],[1,-1,1,-1,-1,-1],["MIR1302-2HG","FAM138A","OR4F5","AL627309.1","AL627309.3","AL627309.2"],["Gene Expression","Gene Expression","Gene Expression","Gene Expression","Gene Expression","Gene Expression"],[1.20552613178812e-05,0,0,0.000815739349176626,2.00921021964686e-05,0],[0.00120552613178812,0,0,0.0815739349176626,0.00200921021964686,0]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>ensembl_gene_id<\/th>\n      <th>external_gene_name<\/th>\n      <th>chromosome_name<\/th>\n      <th>start_position<\/th>\n      <th>end_position<\/th>\n      <th>strand<\/th>\n      <th>Symbol<\/th>\n      <th>Type<\/th>\n      <th>mean<\/th>\n      <th>detected<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[3,4,5,8,9]}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p>Three columns of interest for cells:</p>
<ul>
<li>‘sum’: total UMI count</li>
<li>‘detected’: number of features (genes) detected</li>
<li>‘subsets_Mito_percent’: percentage of reads mapped to mitochondrial transcripts</li>
</ul>
<div class="sourceCode" id="cb119"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb119-1"><a href="PreProcAllCellsTop.html#cb119-1"></a><span class="co"># for cells</span></span>
<span id="cb119-2"><a href="PreProcAllCellsTop.html#cb119-2"></a>sce &lt;-<span class="st"> </span><span class="kw">addPerCellQC</span>(sce, <span class="dt">subsets=</span><span class="kw">list</span>(<span class="dt">Mito=</span>is.mito))</span>
<span id="cb119-3"><a href="PreProcAllCellsTop.html#cb119-3"></a><span class="kw">head</span>(<span class="kw">colData</span>(sce)) <span class="op">%&gt;%</span></span>
<span id="cb119-4"><a href="PreProcAllCellsTop.html#cb119-4"></a><span class="st">    </span><span class="kw">as.data.frame</span>() <span class="op">%&gt;%</span></span>
<span id="cb119-5"><a href="PreProcAllCellsTop.html#cb119-5"></a><span class="st">    </span><span class="kw">datatable</span>(<span class="dt">rownames =</span> <span class="ot">FALSE</span>)</span></code></pre></div>
<div id="htmlwidget-9ba02e76383226a80c18" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-9ba02e76383226a80c18">{"x":{"filter":"none","data":[["/ssd/personal/baller01/20200511_FernandesM_ME_crukBiSs2020/CaronBourque2020/grch38300/SRR9264343/SRR9264343/outs/filtered_feature_bc_matrix/","/ssd/personal/baller01/20200511_FernandesM_ME_crukBiSs2020/CaronBourque2020/grch38300/SRR9264343/SRR9264343/outs/filtered_feature_bc_matrix/","/ssd/personal/baller01/20200511_FernandesM_ME_crukBiSs2020/CaronBourque2020/grch38300/SRR9264343/SRR9264343/outs/filtered_feature_bc_matrix/","/ssd/personal/baller01/20200511_FernandesM_ME_crukBiSs2020/CaronBourque2020/grch38300/SRR9264343/SRR9264343/outs/filtered_feature_bc_matrix/","/ssd/personal/baller01/20200511_FernandesM_ME_crukBiSs2020/CaronBourque2020/grch38300/SRR9264343/SRR9264343/outs/filtered_feature_bc_matrix/","/ssd/personal/baller01/20200511_FernandesM_ME_crukBiSs2020/CaronBourque2020/grch38300/SRR9264343/SRR9264343/outs/filtered_feature_bc_matrix/"],["AAACCTGAGACTTTCG-1","AAACCTGGTCTTCAAG-1","AAACCTGGTGCAACTT-1","AAACCTGGTGTTGAGG-1","AAACCTGTCCCAAGTA-1","AAACCTGTCGAATGCT-1"],["SRR9264343","SRR9264343","SRR9264343","SRR9264343","SRR9264343","SRR9264343"],["GSM3872434","GSM3872434","GSM3872434","GSM3872434","GSM3872434","GSM3872434"],["ETV6-RUNX1","ETV6-RUNX1","ETV6-RUNX1","ETV6-RUNX1","ETV6-RUNX1","ETV6-RUNX1"],[6462,11706,831,7981,8354,1373],[1996,3079,353,2511,2307,701],[290,567,426,423,519,91],[12,12,11,12,13,11],[4.48777468276076,4.8436699128652,51.2635379061372,5.30008770830723,6.21259276993057,6.62782228696285],[6462,11706,831,7981,8354,1373]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>Sample<\/th>\n      <th>Barcode<\/th>\n      <th>Run<\/th>\n      <th>Sample.Name<\/th>\n      <th>source_name<\/th>\n      <th>sum<\/th>\n      <th>detected<\/th>\n      <th>subsets_Mito_sum<\/th>\n      <th>subsets_Mito_detected<\/th>\n      <th>subsets_Mito_percent<\/th>\n      <th>total<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[5,6,7,8,9,10]}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<div class="sourceCode" id="cb120"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb120-1"><a href="PreProcAllCellsTop.html#cb120-1"></a><span class="co"># Write object to file</span></span>
<span id="cb120-2"><a href="PreProcAllCellsTop.html#cb120-2"></a>tmpFn &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/%s/Robjects/sce_postAddQc%s.Rds&quot;</span>,</span>
<span id="cb120-3"><a href="PreProcAllCellsTop.html#cb120-3"></a>         projDir, outDirBit, setSuf)</span>
<span id="cb120-4"><a href="PreProcAllCellsTop.html#cb120-4"></a><span class="kw">saveRDS</span>(sce, tmpFn)</span></code></pre></div>
<div class="sourceCode" id="cb121"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb121-1"><a href="PreProcAllCellsTop.html#cb121-1"></a><span class="co"># Read object in:</span></span>
<span id="cb121-2"><a href="PreProcAllCellsTop.html#cb121-2"></a>tmpFn &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/%s/Robjects/sce_postAddQc%s.Rds&quot;</span>,</span>
<span id="cb121-3"><a href="PreProcAllCellsTop.html#cb121-3"></a>         projDir, outDirBit, setSuf)</span>
<span id="cb121-4"><a href="PreProcAllCellsTop.html#cb121-4"></a>sce &lt;-<span class="st"> </span><span class="kw">readRDS</span>(tmpFn)</span></code></pre></div>
<div id="qc-metric-distribution" class="section level3">
<h3><span class="header-section-number">4.10.1</span> QC metric distribution</h3>
<p>Overall:</p>
<div class="sourceCode" id="cb122"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb122-1"><a href="PreProcAllCellsTop.html#cb122-1"></a><span class="kw">par</span>(<span class="dt">mfrow=</span><span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb122-2"><a href="PreProcAllCellsTop.html#cb122-2"></a><span class="kw">hist</span>(<span class="kw">log10</span>(sce<span class="op">$</span>sum), <span class="dt">breaks=</span><span class="dv">20</span>, <span class="dt">col=</span><span class="st">&quot;grey80&quot;</span>, <span class="dt">xlab=</span><span class="st">&quot;Log-total UMI count&quot;</span>, <span class="dt">main=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb122-3"><a href="PreProcAllCellsTop.html#cb122-3"></a><span class="kw">hist</span>(sce<span class="op">$</span>subsets_Mito_percent, <span class="dt">breaks=</span><span class="dv">20</span>, <span class="dt">col=</span><span class="st">&quot;grey80&quot;</span>, <span class="dt">xlab=</span><span class="st">&quot;Proportion of reads in mitochondrial genes&quot;</span>, <span class="dt">main=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb122-4"><a href="PreProcAllCellsTop.html#cb122-4"></a><span class="kw">abline</span>(<span class="dt">v=</span><span class="dv">20</span>, <span class="dt">lty=</span><span class="dv">2</span>, <span class="dt">col=</span><span class="st">&#39;purple&#39;</span>)</span></code></pre></div>
<p><img src="MkWiC_files/figure-html/qc_metricDistrib_twoHist_allCells-1.png" width="672" /></p>
<p>Per sample group:</p>
<div class="sourceCode" id="cb123"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb123-1"><a href="PreProcAllCellsTop.html#cb123-1"></a>sce<span class="op">$</span>source_name &lt;-<span class="st"> </span><span class="kw">factor</span>(sce<span class="op">$</span>source_name)</span>
<span id="cb123-2"><a href="PreProcAllCellsTop.html#cb123-2"></a>sce<span class="op">$</span>block &lt;-<span class="st"> </span>sce<span class="op">$</span>source_name</span>
<span id="cb123-3"><a href="PreProcAllCellsTop.html#cb123-3"></a>sce<span class="op">$</span>setName &lt;-<span class="st"> </span><span class="kw">ifelse</span>(<span class="kw">grepl</span>(<span class="st">&quot;ABMMC&quot;</span>, sce<span class="op">$</span>source_name), <span class="st">&quot;Hca&quot;</span>, <span class="st">&quot;Caron&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb124"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb124-1"><a href="PreProcAllCellsTop.html#cb124-1"></a><span class="co"># ok, but little gain in splitting by Caron and Hca,</span></span>
<span id="cb124-2"><a href="PreProcAllCellsTop.html#cb124-2"></a><span class="co"># better set levels to have PBMMC last and use ggplot with colours.</span></span>
<span id="cb124-3"><a href="PreProcAllCellsTop.html#cb124-3"></a>tmpFn &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/%s/%s/qc_metricDistrib_plotColData2%s.png&quot;</span>,</span>
<span id="cb124-4"><a href="PreProcAllCellsTop.html#cb124-4"></a>        projDir, outDirBit, qcPlotDirBit, setSuf)</span>
<span id="cb124-5"><a href="PreProcAllCellsTop.html#cb124-5"></a><span class="kw">png</span>(tmpFn)</span>
<span id="cb124-6"><a href="PreProcAllCellsTop.html#cb124-6"></a><span class="co"># violin plots</span></span>
<span id="cb124-7"><a href="PreProcAllCellsTop.html#cb124-7"></a>gridExtra<span class="op">::</span><span class="kw">grid.arrange</span>(</span>
<span id="cb124-8"><a href="PreProcAllCellsTop.html#cb124-8"></a>    <span class="kw">plotColData</span>(sce, <span class="dt">x=</span><span class="st">&quot;block&quot;</span>, <span class="dt">y=</span><span class="st">&quot;sum&quot;</span>,</span>
<span id="cb124-9"><a href="PreProcAllCellsTop.html#cb124-9"></a>        <span class="dt">other_fields=</span><span class="st">&quot;setName&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="co">#facet_wrap(~setName) + </span></span>
<span id="cb124-10"><a href="PreProcAllCellsTop.html#cb124-10"></a><span class="st">        </span><span class="kw">scale_y_log10</span>() <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(<span class="st">&quot;Total count&quot;</span>),</span>
<span id="cb124-11"><a href="PreProcAllCellsTop.html#cb124-11"></a>    <span class="kw">plotColData</span>(sce, <span class="dt">x=</span><span class="st">&quot;block&quot;</span>, <span class="dt">y=</span><span class="st">&quot;detected&quot;</span>, </span>
<span id="cb124-12"><a href="PreProcAllCellsTop.html#cb124-12"></a>        <span class="dt">other_fields=</span><span class="st">&quot;setName&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="co">#facet_wrap(~setName) + </span></span>
<span id="cb124-13"><a href="PreProcAllCellsTop.html#cb124-13"></a><span class="st">        </span><span class="kw">scale_y_log10</span>() <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(<span class="st">&quot;Detected features&quot;</span>),</span>
<span id="cb124-14"><a href="PreProcAllCellsTop.html#cb124-14"></a>    <span class="kw">plotColData</span>(sce, <span class="dt">x=</span><span class="st">&quot;block&quot;</span>, <span class="dt">y=</span><span class="st">&quot;subsets_Mito_percent&quot;</span>, </span>
<span id="cb124-15"><a href="PreProcAllCellsTop.html#cb124-15"></a>        <span class="dt">other_fields=</span><span class="st">&quot;setName&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="co"># facet_wrap(~setName) +</span></span>
<span id="cb124-16"><a href="PreProcAllCellsTop.html#cb124-16"></a><span class="st">        </span><span class="kw">ggtitle</span>(<span class="st">&quot;Mito percent&quot;</span>),</span>
<span id="cb124-17"><a href="PreProcAllCellsTop.html#cb124-17"></a>    <span class="dt">ncol=</span><span class="dv">1</span></span>
<span id="cb124-18"><a href="PreProcAllCellsTop.html#cb124-18"></a>)</span>
<span id="cb124-19"><a href="PreProcAllCellsTop.html#cb124-19"></a><span class="kw">dev.off</span>()</span></code></pre></div>
<div class="sourceCode" id="cb125"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb125-1"><a href="PreProcAllCellsTop.html#cb125-1"></a><span class="co"># eval=FALSE: see chunks below for each of the metrics separately</span></span>
<span id="cb125-2"><a href="PreProcAllCellsTop.html#cb125-2"></a>tmpFn &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/%s/%s/qc_metricDistrib_plotColData2%s.png&quot;</span>,</span>
<span id="cb125-3"><a href="PreProcAllCellsTop.html#cb125-3"></a>         projDir, outDirBit, qcPlotDirBit, setSuf)</span>
<span id="cb125-4"><a href="PreProcAllCellsTop.html#cb125-4"></a>knitr<span class="op">::</span><span class="kw">include_graphics</span>(tmpFn, <span class="dt">auto_pdf =</span> <span class="ot">TRUE</span>)</span>
<span id="cb125-5"><a href="PreProcAllCellsTop.html#cb125-5"></a><span class="kw">rm</span>(tmpFn)</span></code></pre></div>
<p>Library size (‘Total count’):</p>
<div class="sourceCode" id="cb126"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb126-1"><a href="PreProcAllCellsTop.html#cb126-1"></a>    <span class="kw">plotColData</span>(sce, <span class="dt">x=</span><span class="st">&quot;block&quot;</span>, <span class="dt">y=</span><span class="st">&quot;sum&quot;</span>,</span>
<span id="cb126-2"><a href="PreProcAllCellsTop.html#cb126-2"></a>        <span class="dt">other_fields=</span><span class="st">&quot;setName&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="co">#facet_wrap(~setName) + </span></span>
<span id="cb126-3"><a href="PreProcAllCellsTop.html#cb126-3"></a><span class="st">        </span><span class="kw">scale_y_log10</span>() <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(<span class="st">&quot;Total count&quot;</span>)</span></code></pre></div>
<p><img src="MkWiC_files/figure-html/plotColData_libSize_AllCells-1.png" width="672" /></p>
<p>Number of genes (‘detected’):</p>
<div class="sourceCode" id="cb127"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb127-1"><a href="PreProcAllCellsTop.html#cb127-1"></a>    <span class="kw">plotColData</span>(sce, <span class="dt">x=</span><span class="st">&quot;block&quot;</span>, <span class="dt">y=</span><span class="st">&quot;detected&quot;</span>, </span>
<span id="cb127-2"><a href="PreProcAllCellsTop.html#cb127-2"></a>        <span class="dt">other_fields=</span><span class="st">&quot;setName&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="co">#facet_wrap(~setName) + </span></span>
<span id="cb127-3"><a href="PreProcAllCellsTop.html#cb127-3"></a><span class="st">        </span><span class="kw">scale_y_log10</span>() <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(<span class="st">&quot;Detected features&quot;</span>)</span></code></pre></div>
<p><img src="MkWiC_files/figure-html/plotColData_nbGenes_AllCells-1.png" width="672" /></p>
<p>Mitochondrial content (‘subsets_Mito_percent’):</p>
<div class="sourceCode" id="cb128"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb128-1"><a href="PreProcAllCellsTop.html#cb128-1"></a>    <span class="kw">plotColData</span>(sce, <span class="dt">x=</span><span class="st">&quot;block&quot;</span>, <span class="dt">y=</span><span class="st">&quot;subsets_Mito_percent&quot;</span>, </span>
<span id="cb128-2"><a href="PreProcAllCellsTop.html#cb128-2"></a>        <span class="dt">other_fields=</span><span class="st">&quot;setName&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="co"># facet_wrap(~setName) +</span></span>
<span id="cb128-3"><a href="PreProcAllCellsTop.html#cb128-3"></a><span class="st">        </span><span class="kw">ggtitle</span>(<span class="st">&quot;Mito percent&quot;</span>)</span></code></pre></div>
<p><img src="MkWiC_files/figure-html/plotColData_mitoContent_AllCells-1.png" width="672" /></p>
<p>Correlation between the number of genes detected and library size (‘detected’ against ‘sum’):</p>
<div class="sourceCode" id="cb129"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb129-1"><a href="PreProcAllCellsTop.html#cb129-1"></a>sp &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="kw">data.frame</span>(<span class="kw">colData</span>(sce)),</span>
<span id="cb129-2"><a href="PreProcAllCellsTop.html#cb129-2"></a>         <span class="kw">aes</span>(<span class="dt">x=</span>sum,</span>
<span id="cb129-3"><a href="PreProcAllCellsTop.html#cb129-3"></a>         <span class="dt">y=</span>detected,</span>
<span id="cb129-4"><a href="PreProcAllCellsTop.html#cb129-4"></a>         <span class="dt">col=</span>source_name)) <span class="op">+</span></span>
<span id="cb129-5"><a href="PreProcAllCellsTop.html#cb129-5"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">alpha=</span><span class="fl">0.3</span>)</span>
<span id="cb129-6"><a href="PreProcAllCellsTop.html#cb129-6"></a>sp <span class="op">+</span><span class="st"> </span><span class="kw">facet_wrap</span>(<span class="op">~</span>source_name)</span></code></pre></div>
<p><img src="MkWiC_files/figure-html/scatter_detected_vs_sum_colBy_sourceName_allCells-1.png" width="672" /></p>
<p>Correlation between the mitochondrial content and library size (‘subsets_Mito_percent’ against ‘sum’):</p>
<div class="sourceCode" id="cb130"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb130-1"><a href="PreProcAllCellsTop.html#cb130-1"></a>sp &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="kw">data.frame</span>(<span class="kw">colData</span>(sce)), <span class="kw">aes</span>(<span class="dt">x=</span>sum, <span class="dt">y=</span>detected, <span class="dt">col=</span>subsets_Mito_percent)) <span class="op">+</span></span>
<span id="cb130-2"><a href="PreProcAllCellsTop.html#cb130-2"></a><span class="st">  </span><span class="kw">geom_point</span>()</span>
<span id="cb130-3"><a href="PreProcAllCellsTop.html#cb130-3"></a>sp <span class="op">+</span><span class="st"> </span><span class="kw">facet_wrap</span>(<span class="op">~</span>source_name)</span></code></pre></div>
<p><img src="MkWiC_files/figure-html/scatter_detected_vs_sum_colBy_mitoContent_allCells-1.png" width="672" /></p>
</div>
</div>
<div id="identification-of-low-quality-cells-with-adaptive-thresholds" class="section level2">
<h2><span class="header-section-number">4.11</span> Identification of low-quality cells with adaptive thresholds</h2>
<p>One can use hard threshold for the library size, number of genes detected and mitochondrial content. These will however vary across runs. It may therefore be preferable to rely on outlier detection to identify cells that markedly differ from most cells.</p>
<p>We saw above that the distribution of the QC metrics is close to Normal. Hence, we can detect outlier using the median and the median absolute deviation (MAD) from the median (not the mean and the standard deviation that both are sensitive to outliers).</p>
<p>For a given metric, an outlier value is one that lies over some number of MADs away from the median. A cell will be excluded if it is an outlier in the part of the range to avoid, for example low gene counts, or high mitochondrial content. For a normal distribution, a threshold defined with a distance of 3 MADs from the median retains about 99% of values.</p>
<div id="library-size" class="section level3">
<h3><span class="header-section-number">4.11.1</span> Library size</h3>
<p>For the library size we use the log scale to avoid negative values for lower part of the distribution.</p>
<div class="sourceCode" id="cb131"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb131-1"><a href="PreProcAllCellsTop.html#cb131-1"></a>qc.lib2 &lt;-<span class="st"> </span><span class="kw">isOutlier</span>(sce<span class="op">$</span>sum, <span class="dt">log=</span><span class="ot">TRUE</span>, <span class="dt">type=</span><span class="st">&quot;lower&quot;</span>)</span>
<span id="cb131-2"><a href="PreProcAllCellsTop.html#cb131-2"></a><span class="kw">table</span>(qc.lib2)</span></code></pre></div>
<pre><code>## qc.lib2
##  FALSE   TRUE 
## 245250   3604</code></pre>
<p>Threshold values:</p>
<div class="sourceCode" id="cb133"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb133-1"><a href="PreProcAllCellsTop.html#cb133-1"></a><span class="kw">attr</span>(qc.lib2, <span class="st">&quot;thresholds&quot;</span>)</span></code></pre></div>
<pre><code>##    lower   higher 
## 920.8674      Inf</code></pre>
</div>
<div id="number-of-genes" class="section level3">
<h3><span class="header-section-number">4.11.2</span> Number of genes</h3>
<p>For the number of genes detected we also use the log scale to avoid negative values for lower part of the distribution.</p>
<div class="sourceCode" id="cb135"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb135-1"><a href="PreProcAllCellsTop.html#cb135-1"></a>qc.nexprs2 &lt;-<span class="st"> </span><span class="kw">isOutlier</span>(sce<span class="op">$</span>detected, <span class="dt">log=</span><span class="ot">TRUE</span>, <span class="dt">type=</span><span class="st">&quot;lower&quot;</span>)</span>
<span id="cb135-2"><a href="PreProcAllCellsTop.html#cb135-2"></a><span class="kw">table</span>(qc.nexprs2)</span></code></pre></div>
<pre><code>## qc.nexprs2
##  FALSE   TRUE 
## 246349   2505</code></pre>
<p>Threshold values:</p>
<div class="sourceCode" id="cb137"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb137-1"><a href="PreProcAllCellsTop.html#cb137-1"></a><span class="kw">attr</span>(qc.nexprs2, <span class="st">&quot;thresholds&quot;</span>)</span></code></pre></div>
<pre><code>##    lower   higher 
## 302.3803      Inf</code></pre>
</div>
<div id="mitochondrial-content" class="section level3">
<h3><span class="header-section-number">4.11.3</span> Mitochondrial content</h3>
<p>For the mitochondrial content the exclusion zone is in the higher part of the distribution.</p>
<div class="sourceCode" id="cb139"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb139-1"><a href="PreProcAllCellsTop.html#cb139-1"></a>qc.mito2 &lt;-<span class="st"> </span><span class="kw">isOutlier</span>(sce<span class="op">$</span>subsets_Mito_percent, <span class="dt">type=</span><span class="st">&quot;higher&quot;</span>)</span>
<span id="cb139-2"><a href="PreProcAllCellsTop.html#cb139-2"></a><span class="kw">table</span>(qc.mito2)</span></code></pre></div>
<pre><code>## qc.mito2
##  FALSE   TRUE 
## 237080  11774</code></pre>
<p>Threshold values:</p>
<div class="sourceCode" id="cb141"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb141-1"><a href="PreProcAllCellsTop.html#cb141-1"></a><span class="kw">attr</span>(qc.mito2, <span class="st">&quot;thresholds&quot;</span>)</span></code></pre></div>
<pre><code>##    lower   higher 
##     -Inf 7.613065</code></pre>
</div>
<div id="summary" class="section level3">
<h3><span class="header-section-number">4.11.4</span> Summary</h3>
<div class="sourceCode" id="cb143"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb143-1"><a href="PreProcAllCellsTop.html#cb143-1"></a>discard2 &lt;-<span class="st"> </span>qc.lib2 <span class="op">|</span><span class="st"> </span>qc.nexprs2 <span class="op">|</span><span class="st"> </span>qc.mito2</span>
<span id="cb143-2"><a href="PreProcAllCellsTop.html#cb143-2"></a></span>
<span id="cb143-3"><a href="PreProcAllCellsTop.html#cb143-3"></a><span class="co"># Summarize the number of cells removed for each reason.</span></span>
<span id="cb143-4"><a href="PreProcAllCellsTop.html#cb143-4"></a><span class="kw">DataFrame</span>(<span class="dt">LibSize=</span><span class="kw">sum</span>(qc.lib2),</span>
<span id="cb143-5"><a href="PreProcAllCellsTop.html#cb143-5"></a>      <span class="dt">NExprs=</span><span class="kw">sum</span>(qc.nexprs2),</span>
<span id="cb143-6"><a href="PreProcAllCellsTop.html#cb143-6"></a>      <span class="dt">MitoProp=</span><span class="kw">sum</span>(qc.mito2),</span>
<span id="cb143-7"><a href="PreProcAllCellsTop.html#cb143-7"></a>      <span class="dt">Total=</span><span class="kw">sum</span>(discard2))</span></code></pre></div>
<pre><code>## DataFrame with 1 row and 4 columns
##     LibSize    NExprs  MitoProp     Total
##   &lt;integer&gt; &lt;integer&gt; &lt;integer&gt; &lt;integer&gt;
## 1      3604      2505     11774     15386</code></pre>
</div>
<div id="all-steps-at-once" class="section level3">
<h3><span class="header-section-number">4.11.5</span> All steps at once</h3>
<p>The steps above may be run at once with quickPerCellQC():</p>
<div class="sourceCode" id="cb145"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb145-1"><a href="PreProcAllCellsTop.html#cb145-1"></a>reasons &lt;-<span class="st"> </span><span class="kw">quickPerCellQC</span>(<span class="kw">colData</span>(sce),</span>
<span id="cb145-2"><a href="PreProcAllCellsTop.html#cb145-2"></a>              <span class="dt">percent_subsets=</span><span class="kw">c</span>(<span class="st">&quot;subsets_Mito_percent&quot;</span>))</span>
<span id="cb145-3"><a href="PreProcAllCellsTop.html#cb145-3"></a><span class="kw">colSums</span>(<span class="kw">as.matrix</span>(reasons)) <span class="op">%&gt;%</span></span>
<span id="cb145-4"><a href="PreProcAllCellsTop.html#cb145-4"></a><span class="st">  </span><span class="kw">as.data.frame</span>() <span class="op">%&gt;%</span></span>
<span id="cb145-5"><a href="PreProcAllCellsTop.html#cb145-5"></a><span class="st">    </span><span class="kw">datatable</span>(<span class="dt">rownames =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<div id="htmlwidget-53b01761ae6152879f47" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-53b01761ae6152879f47">{"x":{"filter":"none","data":[["low_lib_size","low_n_features","high_subsets_Mito_percent","discard"],[3604,2505,11774,15386]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>.<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":1},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="assumptions" class="section level3">
<h3><span class="header-section-number">4.11.6</span> Assumptions</h3>
<p>Data quality depends on the tissue analysed, some being difficult to dissociate, e.g. brain, so that one level of QC stringency will not fit all data sets.</p>
<p>Filtering based on QC metrics as done here assumes that these QC metrics are not correlated with biology. This may not necessarily be true in highly heterogenous data sets where some cell types represented by good-quality cells may have low RNA content or high mitochondrial content.</p>
</div>
</div>
<div id="experimental-factors" class="section level2">
<h2><span class="header-section-number">4.12</span> Experimental factors</h2>
<p>The two data sets analysed here may have been obtained in experiments with different settings, such as cell preparation or sequencing depth. Such differences between these two batches would affect the adaptive thresholds discussed above. We will now perform QC in each batch separately.</p>
<p>We will use the quickPerCellQC() ‘batch’ option.</p>
<div class="sourceCode" id="cb146"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb146-1"><a href="PreProcAllCellsTop.html#cb146-1"></a>batch.reasons &lt;-<span class="st"> </span><span class="kw">quickPerCellQC</span>(<span class="kw">colData</span>(sce), <span class="dt">percent_subsets=</span><span class="kw">c</span>(<span class="st">&quot;subsets_Mito_percent&quot;</span>), <span class="dt">batch=</span>sce<span class="op">$</span>setName)</span>
<span id="cb146-2"><a href="PreProcAllCellsTop.html#cb146-2"></a><span class="kw">colSums</span>(<span class="kw">as.matrix</span>(batch.reasons))</span></code></pre></div>
<pre><code>##              low_lib_size            low_n_features high_subsets_Mito_percent 
##                         0                      1034                     11046 
##                   discard 
##                     12014</code></pre>
<div class="sourceCode" id="cb148"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb148-1"><a href="PreProcAllCellsTop.html#cb148-1"></a>sce<span class="op">$</span>discard &lt;-<span class="st"> </span>batch.reasons<span class="op">$</span>discard</span></code></pre></div>
<p>Fewer cells are discarded, in particular because of small library size and low gene number.</p>
<p>But the differences are deeper as the two sets only partially overlap:</p>
<div class="sourceCode" id="cb149"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb149-1"><a href="PreProcAllCellsTop.html#cb149-1"></a><span class="kw">table</span>(reasons<span class="op">$</span>discard, batch.reasons<span class="op">$</span>discard)</span></code></pre></div>
<pre><code>##        
##          FALSE   TRUE
##   FALSE 231781   1687
##   TRUE    5059  10327</code></pre>
<div class="sourceCode" id="cb151"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb151-1"><a href="PreProcAllCellsTop.html#cb151-1"></a><span class="co"># see chunks below for each of the metric separately</span></span>
<span id="cb151-2"><a href="PreProcAllCellsTop.html#cb151-2"></a>tmpFn &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/%s/%s/qc_metricDistrib_plotColDataBatch%s.png&quot;</span>,</span>
<span id="cb151-3"><a href="PreProcAllCellsTop.html#cb151-3"></a>         projDir, outDirBit, qcPlotDirBit, setSuf)</span>
<span id="cb151-4"><a href="PreProcAllCellsTop.html#cb151-4"></a><span class="kw">png</span>(tmpFn)</span>
<span id="cb151-5"><a href="PreProcAllCellsTop.html#cb151-5"></a>gridExtra<span class="op">::</span><span class="kw">grid.arrange</span>(</span>
<span id="cb151-6"><a href="PreProcAllCellsTop.html#cb151-6"></a>    <span class="kw">plotColData</span>(sce, <span class="dt">x=</span><span class="st">&quot;block&quot;</span>, <span class="dt">y=</span><span class="st">&quot;sum&quot;</span>, <span class="dt">colour_by=</span><span class="st">&quot;discard&quot;</span>,</span>
<span id="cb151-7"><a href="PreProcAllCellsTop.html#cb151-7"></a>        <span class="dt">other_fields=</span><span class="st">&quot;setName&quot;</span>) <span class="op">+</span></span>
<span id="cb151-8"><a href="PreProcAllCellsTop.html#cb151-8"></a><span class="st">    </span><span class="co">#facet_wrap(~setName) + </span></span>
<span id="cb151-9"><a href="PreProcAllCellsTop.html#cb151-9"></a><span class="st">        </span><span class="kw">scale_y_log10</span>() <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(<span class="st">&quot;Total count&quot;</span>),</span>
<span id="cb151-10"><a href="PreProcAllCellsTop.html#cb151-10"></a>    <span class="kw">plotColData</span>(sce, <span class="dt">x=</span><span class="st">&quot;block&quot;</span>, <span class="dt">y=</span><span class="st">&quot;detected&quot;</span>, <span class="dt">colour_by=</span><span class="st">&quot;discard&quot;</span>, </span>
<span id="cb151-11"><a href="PreProcAllCellsTop.html#cb151-11"></a>        <span class="dt">other_fields=</span><span class="st">&quot;setName&quot;</span>) <span class="op">+</span></span>
<span id="cb151-12"><a href="PreProcAllCellsTop.html#cb151-12"></a><span class="st">    </span><span class="co">#facet_wrap(~setName) + </span></span>
<span id="cb151-13"><a href="PreProcAllCellsTop.html#cb151-13"></a><span class="st">        </span><span class="kw">scale_y_log10</span>() <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(<span class="st">&quot;Detected features&quot;</span>),</span>
<span id="cb151-14"><a href="PreProcAllCellsTop.html#cb151-14"></a>    <span class="kw">plotColData</span>(sce, <span class="dt">x=</span><span class="st">&quot;block&quot;</span>, <span class="dt">y=</span><span class="st">&quot;subsets_Mito_percent&quot;</span>, </span>
<span id="cb151-15"><a href="PreProcAllCellsTop.html#cb151-15"></a>        <span class="dt">colour_by=</span><span class="st">&quot;discard&quot;</span>, <span class="dt">other_fields=</span><span class="st">&quot;setName&quot;</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb151-16"><a href="PreProcAllCellsTop.html#cb151-16"></a><span class="st">        </span><span class="co">#facet_wrap(~setName) +</span></span>
<span id="cb151-17"><a href="PreProcAllCellsTop.html#cb151-17"></a><span class="st">    </span><span class="kw">ggtitle</span>(<span class="st">&quot;Mito percent&quot;</span>),</span>
<span id="cb151-18"><a href="PreProcAllCellsTop.html#cb151-18"></a>    <span class="dt">ncol=</span><span class="dv">1</span></span>
<span id="cb151-19"><a href="PreProcAllCellsTop.html#cb151-19"></a>)</span>
<span id="cb151-20"><a href="PreProcAllCellsTop.html#cb151-20"></a><span class="kw">dev.off</span>()</span></code></pre></div>
<div class="sourceCode" id="cb152"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb152-1"><a href="PreProcAllCellsTop.html#cb152-1"></a><span class="co"># eval=FALSE; see chunks below for each of the metric separately</span></span>
<span id="cb152-2"><a href="PreProcAllCellsTop.html#cb152-2"></a>tmpFn &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/%s/qc_metricDistrib_plotColDataBatch%s.png&quot;</span>,</span>
<span id="cb152-3"><a href="PreProcAllCellsTop.html#cb152-3"></a>                 dirRel, qcPlotDirBit, setSuf)</span>
<span id="cb152-4"><a href="PreProcAllCellsTop.html#cb152-4"></a>knitr<span class="op">::</span><span class="kw">include_graphics</span>(tmpFn, <span class="dt">auto_pdf =</span> <span class="ot">TRUE</span>)</span>
<span id="cb152-5"><a href="PreProcAllCellsTop.html#cb152-5"></a><span class="kw">rm</span>(tmpFn)</span></code></pre></div>
<p>Library size:</p>
<div class="sourceCode" id="cb153"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb153-1"><a href="PreProcAllCellsTop.html#cb153-1"></a><span class="kw">plotColData</span>(sce, <span class="dt">x=</span><span class="st">&quot;block&quot;</span>, <span class="dt">y=</span><span class="st">&quot;sum&quot;</span>, <span class="dt">colour_by=</span><span class="st">&quot;discard&quot;</span>,</span>
<span id="cb153-2"><a href="PreProcAllCellsTop.html#cb153-2"></a>        <span class="dt">other_fields=</span><span class="st">&quot;setName&quot;</span>) <span class="op">+</span></span>
<span id="cb153-3"><a href="PreProcAllCellsTop.html#cb153-3"></a><span class="st">    </span><span class="co">#facet_wrap(~setName) + </span></span>
<span id="cb153-4"><a href="PreProcAllCellsTop.html#cb153-4"></a><span class="st">        </span><span class="kw">scale_y_log10</span>() <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(<span class="st">&quot;Total count&quot;</span>)</span></code></pre></div>
<p><img src="MkWiC_files/figure-html/plotColData_libSize_colBy_discard_allCells-1.png" width="672" /></p>
<p>Number of genes detected:</p>
<div class="sourceCode" id="cb154"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb154-1"><a href="PreProcAllCellsTop.html#cb154-1"></a>    <span class="kw">plotColData</span>(sce, <span class="dt">x=</span><span class="st">&quot;block&quot;</span>, <span class="dt">y=</span><span class="st">&quot;detected&quot;</span>, <span class="dt">colour_by=</span><span class="st">&quot;discard&quot;</span>, </span>
<span id="cb154-2"><a href="PreProcAllCellsTop.html#cb154-2"></a>        <span class="dt">other_fields=</span><span class="st">&quot;setName&quot;</span>) <span class="op">+</span></span>
<span id="cb154-3"><a href="PreProcAllCellsTop.html#cb154-3"></a><span class="st">    </span><span class="co">#facet_wrap(~setName) + </span></span>
<span id="cb154-4"><a href="PreProcAllCellsTop.html#cb154-4"></a><span class="st">        </span><span class="kw">scale_y_log10</span>() <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(<span class="st">&quot;Detected features&quot;</span>)</span></code></pre></div>
<p><img src="MkWiC_files/figure-html/plotColData_nbGenes_colBy_discard_allCells-1.png" width="672" /></p>
<div class="sourceCode" id="cb155"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb155-1"><a href="PreProcAllCellsTop.html#cb155-1"></a><span class="kw">plotColData</span>(sce, <span class="dt">x=</span><span class="st">&quot;block&quot;</span>, <span class="dt">y=</span><span class="st">&quot;detected&quot;</span>, <span class="dt">colour_by=</span><span class="st">&quot;discard&quot;</span>, </span>
<span id="cb155-2"><a href="PreProcAllCellsTop.html#cb155-2"></a>        <span class="dt">other_fields=</span><span class="st">&quot;setName&quot;</span>) <span class="op">+</span></span>
<span id="cb155-3"><a href="PreProcAllCellsTop.html#cb155-3"></a><span class="st">          </span><span class="kw">facet_wrap</span>(<span class="op">~</span>colour_by) <span class="op">+</span><span class="st"> </span></span>
<span id="cb155-4"><a href="PreProcAllCellsTop.html#cb155-4"></a><span class="st">        </span><span class="kw">scale_y_log10</span>() <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(<span class="st">&quot;Detected features&quot;</span>)</span></code></pre></div>
<p><img src="MkWiC_files/figure-html/plotColData_nbGenes_colBy_discard_facetBy_discard_allCells-1.png" width="672" /></p>
<p>Mitochondrial content:</p>
<div class="sourceCode" id="cb156"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb156-1"><a href="PreProcAllCellsTop.html#cb156-1"></a>    <span class="kw">plotColData</span>(sce, <span class="dt">x=</span><span class="st">&quot;block&quot;</span>, <span class="dt">y=</span><span class="st">&quot;subsets_Mito_percent&quot;</span>, </span>
<span id="cb156-2"><a href="PreProcAllCellsTop.html#cb156-2"></a>        <span class="dt">colour_by=</span><span class="st">&quot;discard&quot;</span>, <span class="dt">other_fields=</span><span class="st">&quot;setName&quot;</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb156-3"><a href="PreProcAllCellsTop.html#cb156-3"></a><span class="st">        </span><span class="co">#facet_wrap(~setName) +</span></span>
<span id="cb156-4"><a href="PreProcAllCellsTop.html#cb156-4"></a><span class="st">    </span><span class="kw">ggtitle</span>(<span class="st">&quot;Mito percent&quot;</span>)</span></code></pre></div>
<p><img src="MkWiC_files/figure-html/plotColData_mitoContent_colBy_discard_AllCells-1.png" width="672" /></p>
<div class="sourceCode" id="cb157"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb157-1"><a href="PreProcAllCellsTop.html#cb157-1"></a>sp &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="kw">data.frame</span>(<span class="kw">colData</span>(sce)),</span>
<span id="cb157-2"><a href="PreProcAllCellsTop.html#cb157-2"></a>             <span class="kw">aes</span>(<span class="dt">x=</span>detected, <span class="dt">y=</span>subsets_Mito_percent, <span class="dt">col=</span>discard)) <span class="op">+</span></span>
<span id="cb157-3"><a href="PreProcAllCellsTop.html#cb157-3"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">size =</span> <span class="fl">0.05</span>, <span class="dt">alpha =</span> <span class="fl">0.2</span>) <span class="op">+</span></span>
<span id="cb157-4"><a href="PreProcAllCellsTop.html#cb157-4"></a><span class="st">  </span><span class="kw">geom_density_2d</span>(<span class="dt">size =</span> <span class="fl">0.5</span>, <span class="dt">colour =</span> <span class="st">&quot;blue&quot;</span>) <span class="op">+</span></span>
<span id="cb157-5"><a href="PreProcAllCellsTop.html#cb157-5"></a><span class="st">  </span><span class="kw">guides</span>(<span class="dt">colour =</span> <span class="kw">guide_legend</span>(<span class="dt">override.aes =</span> <span class="kw">list</span>(<span class="dt">size=</span><span class="dv">1</span>, <span class="dt">alpha=</span><span class="dv">1</span>))) <span class="op">+</span></span>
<span id="cb157-6"><a href="PreProcAllCellsTop.html#cb157-6"></a><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position=</span><span class="st">&quot;bottom&quot;</span>)</span>
<span id="cb157-7"><a href="PreProcAllCellsTop.html#cb157-7"></a></span>
<span id="cb157-8"><a href="PreProcAllCellsTop.html#cb157-8"></a><span class="co">#sp</span></span>
<span id="cb157-9"><a href="PreProcAllCellsTop.html#cb157-9"></a>ggExtra<span class="op">::</span><span class="kw">ggMarginal</span>(sp)</span></code></pre></div>
<p><img src="MkWiC_files/figure-html/scatter_mitoContent_vs_detected_colBy_discard_AllCells-1.png" width="672" /></p>
<div class="sourceCode" id="cb158"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb158-1"><a href="PreProcAllCellsTop.html#cb158-1"></a>sp &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="kw">data.frame</span>(<span class="kw">colData</span>(sce)), <span class="kw">aes</span>(<span class="dt">x=</span>detected, <span class="dt">y=</span>subsets_Mito_percent, <span class="dt">col=</span>discard)) <span class="op">+</span></span>
<span id="cb158-2"><a href="PreProcAllCellsTop.html#cb158-2"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">size =</span> <span class="fl">0.05</span>, <span class="dt">alpha =</span> <span class="fl">0.2</span>)</span>
<span id="cb158-3"><a href="PreProcAllCellsTop.html#cb158-3"></a>sp <span class="op">+</span><span class="st"> </span><span class="kw">facet_wrap</span>(<span class="op">~</span>source_name)</span></code></pre></div>
<p><img src="MkWiC_files/figure-html/scatter_detected_vs_mitoContent_colBy_discard_allCells-1.png" width="672" /></p>
<div class="sourceCode" id="cb159"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb159-1"><a href="PreProcAllCellsTop.html#cb159-1"></a>sp &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="kw">data.frame</span>(<span class="kw">colData</span>(sce)), <span class="kw">aes</span>(<span class="dt">x=</span>detected, <span class="dt">y=</span>subsets_Mito_percent)) <span class="op">+</span></span>
<span id="cb159-2"><a href="PreProcAllCellsTop.html#cb159-2"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">size =</span> <span class="fl">0.05</span>, <span class="dt">alpha =</span> <span class="fl">0.0</span>)</span>
<span id="cb159-3"><a href="PreProcAllCellsTop.html#cb159-3"></a>sp <span class="op">+</span><span class="st"> </span></span>
<span id="cb159-4"><a href="PreProcAllCellsTop.html#cb159-4"></a><span class="st">  </span><span class="co">#geom_density_2d_filled(alpha = 0.5) +</span></span>
<span id="cb159-5"><a href="PreProcAllCellsTop.html#cb159-5"></a><span class="st">  </span><span class="kw">geom_density_2d</span>(<span class="dt">size =</span> <span class="fl">0.5</span>, <span class="dt">colour =</span> <span class="st">&quot;black&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb160"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb160-1"><a href="PreProcAllCellsTop.html#cb160-1"></a>sp &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="kw">data.frame</span>(<span class="kw">colData</span>(sce)), <span class="kw">aes</span>(<span class="dt">x=</span>detected, <span class="dt">y=</span>subsets_Mito_percent)) <span class="op">+</span></span>
<span id="cb160-2"><a href="PreProcAllCellsTop.html#cb160-2"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">size =</span> <span class="fl">0.05</span>, <span class="dt">alpha =</span> <span class="fl">0.2</span>) <span class="op">+</span></span>
<span id="cb160-3"><a href="PreProcAllCellsTop.html#cb160-3"></a><span class="st">  </span><span class="kw">geom_density_2d</span>(<span class="dt">size =</span> <span class="fl">0.5</span>, <span class="dt">colour =</span> <span class="st">&quot;blue&quot;</span>)</span>
<span id="cb160-4"><a href="PreProcAllCellsTop.html#cb160-4"></a>ggExtra<span class="op">::</span><span class="kw">ggMarginal</span>(sp)</span></code></pre></div>
<p><img src="MkWiC_files/figure-html/scatter_detected_vs_mitoContent_allCells_2-1.png" width="672" /></p>
<div id="identify-poor-quality-batches" class="section level3">
<h3><span class="header-section-number">4.12.1</span> Identify poor-quality batches</h3>
<p>We will now consider the ‘sample’ batch to illustrate how to identify batches with overall low quality or different from other batches. Let’s compare thresholds across sample groups.</p>
<div id="number-of-genes-detected" class="section level4">
<h4><span class="header-section-number">4.12.1.1</span> Number of genes detected</h4>
<div class="sourceCode" id="cb161"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb161-1"><a href="PreProcAllCellsTop.html#cb161-1"></a><span class="co"># compute</span></span>
<span id="cb161-2"><a href="PreProcAllCellsTop.html#cb161-2"></a>discard.nexprs &lt;-<span class="st"> </span><span class="kw">isOutlier</span>(sce<span class="op">$</span>detected, <span class="dt">log=</span><span class="ot">TRUE</span>, <span class="dt">type=</span><span class="st">&quot;lower&quot;</span>, <span class="dt">batch=</span>sce<span class="op">$</span>Sample.Name)</span>
<span id="cb161-3"><a href="PreProcAllCellsTop.html#cb161-3"></a>nexprs.thresholds &lt;-<span class="st"> </span><span class="kw">attr</span>(discard.nexprs, <span class="st">&quot;thresholds&quot;</span>)[<span class="st">&quot;lower&quot;</span>,]</span>
<span id="cb161-4"><a href="PreProcAllCellsTop.html#cb161-4"></a>nexprs.thresholds <span class="op">%&gt;%</span></span>
<span id="cb161-5"><a href="PreProcAllCellsTop.html#cb161-5"></a><span class="st">  </span><span class="kw">round</span>(<span class="dv">0</span>) <span class="op">%&gt;%</span></span>
<span id="cb161-6"><a href="PreProcAllCellsTop.html#cb161-6"></a><span class="st">  </span><span class="kw">as.data.frame</span>() <span class="op">%&gt;%</span></span>
<span id="cb161-7"><a href="PreProcAllCellsTop.html#cb161-7"></a><span class="st">    </span><span class="kw">datatable</span>(<span class="dt">rownames =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<div id="htmlwidget-3903793be15155975db6" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-3903793be15155975db6">{"x":{"filter":"none","data":[["GSM3872434","GSM3872435","GSM3872436","GSM3872437","GSM3872438","GSM3872439","GSM3872440","GSM3872441","GSM3872442","GSM3872443","GSM3872444","MantonBM1","MantonBM2","MantonBM3","MantonBM4","MantonBM5","MantonBM6","MantonBM7","MantonBM8"],[607,336,328,141,157,572,196,264,71,132,237,435,412,394,314,239,466,371,342]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>.<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":1},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p>Without block:</p>
<div class="sourceCode" id="cb162"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb162-1"><a href="PreProcAllCellsTop.html#cb162-1"></a><span class="co"># plots - without blocking</span></span>
<span id="cb162-2"><a href="PreProcAllCellsTop.html#cb162-2"></a>discard.nexprs.woBlock &lt;-<span class="st"> </span><span class="kw">isOutlier</span>(sce<span class="op">$</span>detected, <span class="dt">log=</span><span class="ot">TRUE</span>, <span class="dt">type=</span><span class="st">&quot;lower&quot;</span>)</span>
<span id="cb162-3"><a href="PreProcAllCellsTop.html#cb162-3"></a>without.blocking &lt;-<span class="st"> </span><span class="kw">plotColData</span>(sce, <span class="dt">x=</span><span class="st">&quot;Sample.Name&quot;</span>, <span class="dt">y=</span><span class="st">&quot;detected&quot;</span>,</span>
<span id="cb162-4"><a href="PreProcAllCellsTop.html#cb162-4"></a>    <span class="dt">colour_by=</span><span class="kw">I</span>(discard.nexprs.woBlock))</span>
<span id="cb162-5"><a href="PreProcAllCellsTop.html#cb162-5"></a></span>
<span id="cb162-6"><a href="PreProcAllCellsTop.html#cb162-6"></a>without.blocking <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">axis.text.x =</span> <span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">90</span>, <span class="dt">hjust =</span> <span class="dv">1</span>))</span></code></pre></div>
<p><img src="MkWiC_files/figure-html/plotColData_nbGenes_woBlocking_allCells-1.png" width="672" /></p>
<p>With block:</p>
<div class="sourceCode" id="cb163"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb163-1"><a href="PreProcAllCellsTop.html#cb163-1"></a><span class="co"># plots - with blocking</span></span>
<span id="cb163-2"><a href="PreProcAllCellsTop.html#cb163-2"></a>with.blocking &lt;-<span class="st"> </span><span class="kw">plotColData</span>(sce, <span class="dt">x=</span><span class="st">&quot;Sample.Name&quot;</span>, <span class="dt">y=</span><span class="st">&quot;detected&quot;</span>,</span>
<span id="cb163-3"><a href="PreProcAllCellsTop.html#cb163-3"></a>    <span class="dt">colour_by=</span><span class="kw">I</span>(discard.nexprs))</span>
<span id="cb163-4"><a href="PreProcAllCellsTop.html#cb163-4"></a>with.blocking <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">axis.text.x =</span> <span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">90</span>, <span class="dt">hjust =</span> <span class="dv">1</span>))</span></code></pre></div>
<p><img src="MkWiC_files/figure-html/plotColData_nbGenes_wiBlocking_allCells-1.png" width="672" /></p>
<div id="mitochondrial-content-1" class="section level5">
<h5><span class="header-section-number">4.12.1.1.1</span> Mitochondrial content</h5>
<div class="sourceCode" id="cb164"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb164-1"><a href="PreProcAllCellsTop.html#cb164-1"></a>discard.mito &lt;-<span class="st"> </span><span class="kw">isOutlier</span>(sce<span class="op">$</span>subsets_Mito_percent, <span class="dt">type=</span><span class="st">&quot;higher&quot;</span>, <span class="dt">batch=</span>sce<span class="op">$</span>Sample.Name)</span>
<span id="cb164-2"><a href="PreProcAllCellsTop.html#cb164-2"></a>mito.thresholds &lt;-<span class="st"> </span><span class="kw">attr</span>(discard.mito, <span class="st">&quot;thresholds&quot;</span>)[<span class="st">&quot;higher&quot;</span>,]</span>
<span id="cb164-3"><a href="PreProcAllCellsTop.html#cb164-3"></a>mito.thresholds <span class="op">%&gt;%</span></span>
<span id="cb164-4"><a href="PreProcAllCellsTop.html#cb164-4"></a><span class="st">  </span><span class="kw">round</span>(<span class="dv">0</span>) <span class="op">%&gt;%</span></span>
<span id="cb164-5"><a href="PreProcAllCellsTop.html#cb164-5"></a><span class="st">  </span><span class="kw">as.data.frame</span>() <span class="op">%&gt;%</span></span>
<span id="cb164-6"><a href="PreProcAllCellsTop.html#cb164-6"></a><span class="st">    </span><span class="kw">datatable</span>(<span class="dt">rownames =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<div id="htmlwidget-6cfc0dad5f6e708f7a59" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-6cfc0dad5f6e708f7a59">{"x":{"filter":"none","data":[["GSM3872434","GSM3872435","GSM3872436","GSM3872437","GSM3872438","GSM3872439","GSM3872440","GSM3872441","GSM3872442","GSM3872443","GSM3872444","MantonBM1","MantonBM2","MantonBM3","MantonBM4","MantonBM5","MantonBM6","MantonBM7","MantonBM8"],[13,9,7,13,17,7,8,8,8,13,9,8,7,7,8,7,7,7,7]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>.<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":1},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p>Without block:</p>
<div class="sourceCode" id="cb165"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb165-1"><a href="PreProcAllCellsTop.html#cb165-1"></a><span class="co"># plots - without blocking</span></span>
<span id="cb165-2"><a href="PreProcAllCellsTop.html#cb165-2"></a>discard.mito.woBlock &lt;-<span class="st"> </span><span class="kw">isOutlier</span>(sce<span class="op">$</span>subsets_Mito_percent, <span class="dt">type=</span><span class="st">&quot;higher&quot;</span>)</span>
<span id="cb165-3"><a href="PreProcAllCellsTop.html#cb165-3"></a>without.blocking &lt;-<span class="st"> </span><span class="kw">plotColData</span>(sce, <span class="dt">x=</span><span class="st">&quot;Sample.Name&quot;</span>, <span class="dt">y=</span><span class="st">&quot;subsets_Mito_percent&quot;</span>,</span>
<span id="cb165-4"><a href="PreProcAllCellsTop.html#cb165-4"></a>    <span class="dt">colour_by=</span><span class="kw">I</span>(discard.mito.woBlock))</span>
<span id="cb165-5"><a href="PreProcAllCellsTop.html#cb165-5"></a>without.blocking <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">axis.text.x =</span> <span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">90</span>, <span class="dt">hjust =</span> <span class="dv">1</span>))</span></code></pre></div>
<p><img src="MkWiC_files/figure-html/plotColData_mitoContent_woBlocking_allCells-1.png" width="672" /></p>
<p>With block:</p>
<div class="sourceCode" id="cb166"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb166-1"><a href="PreProcAllCellsTop.html#cb166-1"></a><span class="co"># plots - with blocking</span></span>
<span id="cb166-2"><a href="PreProcAllCellsTop.html#cb166-2"></a>with.blocking &lt;-<span class="st"> </span><span class="kw">plotColData</span>(sce, <span class="dt">x=</span><span class="st">&quot;Sample.Name&quot;</span>, <span class="dt">y=</span><span class="st">&quot;subsets_Mito_percent&quot;</span>,</span>
<span id="cb166-3"><a href="PreProcAllCellsTop.html#cb166-3"></a>    <span class="dt">colour_by=</span><span class="kw">I</span>(discard.mito))</span>
<span id="cb166-4"><a href="PreProcAllCellsTop.html#cb166-4"></a>with.blocking <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">axis.text.x =</span> <span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">90</span>, <span class="dt">hjust =</span> <span class="dv">1</span>))</span></code></pre></div>
<p><img src="MkWiC_files/figure-html/plotColData_mitoContent_wiBlocking_allCells-1.png" width="672" /></p>
</div>
</div>
<div id="samples-to-check" class="section level4">
<h4><span class="header-section-number">4.12.1.2</span> Samples to check</h4>
<p>Names of samples with a ‘low’ threshold for the number of genes detected:</p>
<div class="sourceCode" id="cb167"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb167-1"><a href="PreProcAllCellsTop.html#cb167-1"></a><span class="co"># names</span></span>
<span id="cb167-2"><a href="PreProcAllCellsTop.html#cb167-2"></a><span class="kw">names</span>(nexprs.thresholds)[<span class="kw">isOutlier</span>(nexprs.thresholds, <span class="dt">type=</span><span class="st">&quot;lower&quot;</span>)]</span></code></pre></div>
<pre><code>## character(0)</code></pre>
<p>Names of samples with a ‘high’ threshold for mitocondrial content:</p>
<div class="sourceCode" id="cb169"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb169-1"><a href="PreProcAllCellsTop.html#cb169-1"></a><span class="co"># names</span></span>
<span id="cb169-2"><a href="PreProcAllCellsTop.html#cb169-2"></a><span class="kw">names</span>(mito.thresholds)[<span class="kw">isOutlier</span>(mito.thresholds, <span class="dt">type=</span><span class="st">&quot;higher&quot;</span>)]</span></code></pre></div>
<pre><code>## [1] &quot;GSM3872434&quot; &quot;GSM3872437&quot; &quot;GSM3872438&quot; &quot;GSM3872443&quot;</code></pre>
</div>
</div>
<div id="qc-metrics-space" class="section level3">
<h3><span class="header-section-number">4.12.2</span> QC metrics space</h3>
<p>A similar approach exists to identify outliers using a set of metrics together. We will the same QC metrics as above:</p>
<div class="sourceCode" id="cb171"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb171-1"><a href="PreProcAllCellsTop.html#cb171-1"></a><span class="co"># slow</span></span>
<span id="cb171-2"><a href="PreProcAllCellsTop.html#cb171-2"></a>stats &lt;-<span class="st"> </span><span class="kw">cbind</span>(<span class="kw">log10</span>(sce<span class="op">$</span>sum),</span>
<span id="cb171-3"><a href="PreProcAllCellsTop.html#cb171-3"></a>           <span class="kw">log10</span>(sce<span class="op">$</span>detected),</span>
<span id="cb171-4"><a href="PreProcAllCellsTop.html#cb171-4"></a>           sce<span class="op">$</span>subsets_Mito_percent)</span>
<span id="cb171-5"><a href="PreProcAllCellsTop.html#cb171-5"></a></span>
<span id="cb171-6"><a href="PreProcAllCellsTop.html#cb171-6"></a><span class="kw">library</span>(robustbase)</span>
<span id="cb171-7"><a href="PreProcAllCellsTop.html#cb171-7"></a>outlying &lt;-<span class="st"> </span><span class="kw">adjOutlyingness</span>(stats, <span class="dt">only.outlyingness =</span> <span class="ot">TRUE</span>)</span>
<span id="cb171-8"><a href="PreProcAllCellsTop.html#cb171-8"></a>multi.outlier &lt;-<span class="st"> </span><span class="kw">isOutlier</span>(outlying, <span class="dt">type =</span> <span class="st">&quot;higher&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb172"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb172-1"><a href="PreProcAllCellsTop.html#cb172-1"></a><span class="kw">summary</span>(multi.outlier)</span></code></pre></div>
<pre><code>##    Mode   FALSE    TRUE 
## logical  232401   16453</code></pre>
<p>Compare with previous filtering:</p>
<div class="sourceCode" id="cb174"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb174-1"><a href="PreProcAllCellsTop.html#cb174-1"></a><span class="kw">table</span>(sce<span class="op">$</span>discard, multi.outlier)</span></code></pre></div>
<pre><code>##        multi.outlier
##          FALSE   TRUE
##   FALSE 226413  10427
##   TRUE    5988   6026</code></pre>
</div>
<div id="qc-pca" class="section level3">
<h3><span class="header-section-number">4.12.3</span> QC PCA</h3>
<p>One can also perform a principal components analysis (PCA) on cells, based on the column metadata in a SingleCellExperiment object. Here we will only use the library size, the number of genes detected (which is correlated with library size) and the mitochondrial content.</p>
<div class="sourceCode" id="cb176"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb176-1"><a href="PreProcAllCellsTop.html#cb176-1"></a>sce &lt;-<span class="st"> </span><span class="kw">runColDataPCA</span>(sce, <span class="dt">variables=</span><span class="kw">list</span>(</span>
<span id="cb176-2"><a href="PreProcAllCellsTop.html#cb176-2"></a>    <span class="st">&quot;sum&quot;</span>, <span class="st">&quot;detected&quot;</span>, <span class="st">&quot;subsets_Mito_percent&quot;</span>),</span>
<span id="cb176-3"><a href="PreProcAllCellsTop.html#cb176-3"></a>    <span class="dt">outliers=</span><span class="ot">TRUE</span>)</span>
<span id="cb176-4"><a href="PreProcAllCellsTop.html#cb176-4"></a></span>
<span id="cb176-5"><a href="PreProcAllCellsTop.html#cb176-5"></a><span class="co">#reducedDimNames(sce)</span></span>
<span id="cb176-6"><a href="PreProcAllCellsTop.html#cb176-6"></a><span class="co">#head(reducedDim(sce))</span></span>
<span id="cb176-7"><a href="PreProcAllCellsTop.html#cb176-7"></a><span class="co">#head(colData(sce))</span></span>
<span id="cb176-8"><a href="PreProcAllCellsTop.html#cb176-8"></a></span>
<span id="cb176-9"><a href="PreProcAllCellsTop.html#cb176-9"></a><span class="co">#p &lt;- plotReducedDim(sce, dimred=&quot;PCA_coldata&quot;, colour_by = &quot;Sample.Name&quot;)</span></span>
<span id="cb176-10"><a href="PreProcAllCellsTop.html#cb176-10"></a>p &lt;-<span class="st"> </span><span class="kw">plotReducedDim</span>(sce, <span class="dt">dimred=</span><span class="st">&quot;PCA_coldata&quot;</span>, <span class="dt">colour_by =</span> <span class="st">&quot;outlier&quot;</span>)</span>
<span id="cb176-11"><a href="PreProcAllCellsTop.html#cb176-11"></a>p <span class="op">+</span><span class="st"> </span><span class="kw">facet_wrap</span>(<span class="op">~</span>sce<span class="op">$</span>discard)</span></code></pre></div>
<p><img src="MkWiC_files/figure-html/PCA_coldata_colBy_outlier_allCells-1.png" width="672" /></p>
<p>Compare with previous filtering:</p>
<ul>
<li><code>discard</code> and <code>runColDataPCA</code>’s <code>outlier</code>:</li>
</ul>
<div class="sourceCode" id="cb177"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb177-1"><a href="PreProcAllCellsTop.html#cb177-1"></a><span class="kw">table</span>(sce<span class="op">$</span>discard, sce<span class="op">$</span>outlier)</span></code></pre></div>
<pre><code>##        
##          FALSE   TRUE
##   FALSE 227999   8841
##   TRUE    5611   6403</code></pre>
<ul>
<li><code>adjOutlyingness</code>’ <code>multi.outlier</code> and <code>runColDataPCA</code>’s <code>outlier</code>:</li>
</ul>
<div class="sourceCode" id="cb179"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb179-1"><a href="PreProcAllCellsTop.html#cb179-1"></a><span class="kw">table</span>(multi.outlier, sce<span class="op">$</span>outlier)</span></code></pre></div>
<pre><code>##              
## multi.outlier  FALSE   TRUE
##         FALSE 226248   6153
##         TRUE    7362   9091</code></pre>
</div>
<div id="other-diagnostic-plots" class="section level3">
<h3><span class="header-section-number">4.12.4</span> Other diagnostic plots</h3>
<p>Mitochondrial content against library size:</p>
<div class="sourceCode" id="cb181"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb181-1"><a href="PreProcAllCellsTop.html#cb181-1"></a><span class="kw">plotColData</span>(sce, <span class="dt">x=</span><span class="st">&quot;sum&quot;</span>, <span class="dt">y=</span><span class="st">&quot;subsets_Mito_percent&quot;</span>, <span class="dt">colour_by=</span><span class="st">&quot;discard&quot;</span>)</span></code></pre></div>
<p><img src="MkWiC_files/figure-html/plotColData_mitoContent_vs_sum_colBy_discard_AllCells-1.png" width="672" /></p>
<div class="sourceCode" id="cb182"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb182-1"><a href="PreProcAllCellsTop.html#cb182-1"></a>sp &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="kw">data.frame</span>(<span class="kw">colData</span>(sce)),</span>
<span id="cb182-2"><a href="PreProcAllCellsTop.html#cb182-2"></a>             <span class="kw">aes</span>(<span class="dt">x=</span>sum, <span class="dt">y=</span>subsets_Mito_percent, <span class="dt">col=</span>discard)) <span class="op">+</span></span>
<span id="cb182-3"><a href="PreProcAllCellsTop.html#cb182-3"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">size =</span> <span class="fl">0.05</span>, <span class="dt">alpha =</span> <span class="fl">0.7</span>) <span class="op">+</span></span>
<span id="cb182-4"><a href="PreProcAllCellsTop.html#cb182-4"></a><span class="st">  </span><span class="kw">geom_density_2d</span>(<span class="dt">size =</span> <span class="fl">0.5</span>, <span class="dt">colour =</span> <span class="st">&quot;blue&quot;</span>) <span class="op">+</span></span>
<span id="cb182-5"><a href="PreProcAllCellsTop.html#cb182-5"></a><span class="st">  </span><span class="kw">guides</span>(<span class="dt">colour =</span> <span class="kw">guide_legend</span>(<span class="dt">override.aes =</span> <span class="kw">list</span>(<span class="dt">size=</span><span class="dv">1</span>, <span class="dt">alpha=</span><span class="dv">1</span>))) <span class="op">+</span></span>
<span id="cb182-6"><a href="PreProcAllCellsTop.html#cb182-6"></a><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position=</span><span class="st">&quot;bottom&quot;</span>)</span>
<span id="cb182-7"><a href="PreProcAllCellsTop.html#cb182-7"></a><span class="co">#sp</span></span>
<span id="cb182-8"><a href="PreProcAllCellsTop.html#cb182-8"></a>ggExtra<span class="op">::</span><span class="kw">ggMarginal</span>(sp)</span></code></pre></div>
<p><img src="MkWiC_files/figure-html/plotColData_mitoContent_vs_sum_colBy_discard_AllCells_2-1.png" width="672" /></p>
<p>Mind distributions:</p>
<div class="sourceCode" id="cb183"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb183-1"><a href="PreProcAllCellsTop.html#cb183-1"></a>sp <span class="op">+</span><span class="st"> </span><span class="kw">facet_wrap</span>(<span class="op">~</span>source_name)</span></code></pre></div>
<p><img src="MkWiC_files/figure-html/plotColData_mitoContent_vs_sum_colBy_discard_AllCells_3-1.png" width="672" /></p>
</div>
<div id="filter-low-quality-cells-out" class="section level3">
<h3><span class="header-section-number">4.12.5</span> Filter low-quality cells out</h3>
<p>We will now exclude poor-quality cells.</p>
<div class="sourceCode" id="cb184"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb184-1"><a href="PreProcAllCellsTop.html#cb184-1"></a>scePreQc &lt;-<span class="st"> </span>sce</span>
<span id="cb184-2"><a href="PreProcAllCellsTop.html#cb184-2"></a>sce &lt;-<span class="st"> </span>scePreQc[,<span class="op">!</span>scePreQc<span class="op">$</span>discard]</span>
<span id="cb184-3"><a href="PreProcAllCellsTop.html#cb184-3"></a>sce</span></code></pre></div>
<pre><code>## class: SingleCellExperiment 
## dim: 33538 236840 
## metadata(20): Samples Samples ... Samples Samples
## assays(1): counts
## rownames(33538): ENSG00000243485 ENSG00000237613 ... ENSG00000277475
##   ENSG00000268674
## rowData names(10): ensembl_gene_id external_gene_name ... mean detected
## colnames: NULL
## colData names(15): Sample Barcode ... discard outlier
## reducedDimNames(1): PCA_coldata
## altExpNames(0):</code></pre>
<p>We also write the R object to file to use later if need be.</p>
<div class="sourceCode" id="cb186"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb186-1"><a href="PreProcAllCellsTop.html#cb186-1"></a><span class="co"># Write object to file</span></span>
<span id="cb186-2"><a href="PreProcAllCellsTop.html#cb186-2"></a>tmpFn &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/%s/Robjects/sce_postQc%s.Rds&quot;</span>,</span>
<span id="cb186-3"><a href="PreProcAllCellsTop.html#cb186-3"></a>         projDir, outDirBit, setSuf)</span>
<span id="cb186-4"><a href="PreProcAllCellsTop.html#cb186-4"></a><span class="kw">saveRDS</span>(sce, tmpFn)</span></code></pre></div>
<div class="sourceCode" id="cb187"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb187-1"><a href="PreProcAllCellsTop.html#cb187-1"></a><span class="co"># Read object in:</span></span>
<span id="cb187-2"><a href="PreProcAllCellsTop.html#cb187-2"></a>tmpFn &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/%s/Robjects/sce_postQc%s.Rds&quot;</span>,</span>
<span id="cb187-3"><a href="PreProcAllCellsTop.html#cb187-3"></a>         projDir, outDirBit, setSuf)</span>
<span id="cb187-4"><a href="PreProcAllCellsTop.html#cb187-4"></a><span class="kw">print</span>(<span class="st">&quot;DEV&quot;</span>); <span class="kw">print</span>(<span class="kw">getwd</span>()); <span class="kw">print</span>(tmpFn)</span></code></pre></div>
<pre><code>## [1] &quot;DEV&quot;</code></pre>
<pre><code>## [1] &quot;/ssd/personal/baller01/20200511_FernandesM_ME_crukBiSs2020/AnaWiSce/Ana1/ScriptsMkWiC&quot;</code></pre>
<pre><code>## [1] &quot;/ssd/personal/baller01/20200511_FernandesM_ME_crukBiSs2020/AnaWiSce/Ana1/Robjects/sce_postQc_allCells.Rds&quot;</code></pre>
<div class="sourceCode" id="cb191"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb191-1"><a href="PreProcAllCellsTop.html#cb191-1"></a><span class="co">#sce &lt;- readRDS(tmpFn)</span></span></code></pre></div>
</div>
</div>
<div id="novelty" class="section level2">
<h2><span class="header-section-number">4.13</span> Novelty</h2>
<p>The number of genes per UMI for each cell informs on the level of sequencing saturation achieved ( <a href="https://hbctraining.github.io/In-depth-NGS-Data-Analysis-Course/sessionIV/lessons/SC_quality_control_analysis.html">hbctraining</a>). For a given cell, as sequencing depth increases each extra UMI is less likely to correspnf to a gene not already detected in that cell. Cells with small library size tend to have higher overall ‘novelty’ i.e. they have not reached saturation for any given gene. Outlier cell may have a library with low complexity. This may suggest the some cell types, e.g. red blood cells. The expected novelty is about 0.8.</p>
<p>Here we see that some PBMMCs have low novelty, ie overall fewer genes were detected for an equivalent number of UMIs in these cells than in others.</p>
<div class="sourceCode" id="cb192"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb192-1"><a href="PreProcAllCellsTop.html#cb192-1"></a>p &lt;-<span class="st"> </span><span class="kw">colData</span>(sce) <span class="op">%&gt;%</span></span>
<span id="cb192-2"><a href="PreProcAllCellsTop.html#cb192-2"></a><span class="st">  </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span></span>
<span id="cb192-3"><a href="PreProcAllCellsTop.html#cb192-3"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x=</span>sum, <span class="dt">y=</span>detected, <span class="dt">color=</span>subsets_Mito_percent)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb192-4"><a href="PreProcAllCellsTop.html#cb192-4"></a><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span><span class="st"> </span></span>
<span id="cb192-5"><a href="PreProcAllCellsTop.html#cb192-5"></a><span class="st">  </span><span class="kw">stat_smooth</span>(<span class="dt">method=</span>lm) <span class="op">+</span></span>
<span id="cb192-6"><a href="PreProcAllCellsTop.html#cb192-6"></a><span class="st">  </span><span class="kw">scale_x_log10</span>() <span class="op">+</span><span class="st"> </span></span>
<span id="cb192-7"><a href="PreProcAllCellsTop.html#cb192-7"></a><span class="st">  </span><span class="kw">scale_y_log10</span>() <span class="op">+</span><span class="st"> </span></span>
<span id="cb192-8"><a href="PreProcAllCellsTop.html#cb192-8"></a><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> <span class="dv">800</span>) <span class="op">+</span></span>
<span id="cb192-9"><a href="PreProcAllCellsTop.html#cb192-9"></a><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>source_name)</span>
<span id="cb192-10"><a href="PreProcAllCellsTop.html#cb192-10"></a>p</span></code></pre></div>
<p><img src="MkWiC_files/figure-html/novelty_scat_allCells-1.png" width="672" /></p>
<div class="sourceCode" id="cb193"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb193-1"><a href="PreProcAllCellsTop.html#cb193-1"></a><span class="co"># write plot to file</span></span>
<span id="cb193-2"><a href="PreProcAllCellsTop.html#cb193-2"></a></span>
<span id="cb193-3"><a href="PreProcAllCellsTop.html#cb193-3"></a>tmpFn &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/%s/%s/novelty_scat%s.png&quot;</span>,</span>
<span id="cb193-4"><a href="PreProcAllCellsTop.html#cb193-4"></a>         projDir, outDirBit, qcPlotDirBit, setSuf)</span>
<span id="cb193-5"><a href="PreProcAllCellsTop.html#cb193-5"></a><span class="kw">print</span>(<span class="st">&quot;DEV&quot;</span>); <span class="kw">print</span>(<span class="kw">getwd</span>()); <span class="kw">print</span>(tmpFn)</span></code></pre></div>
<pre><code>## [1] &quot;DEV&quot;</code></pre>
<pre><code>## [1] &quot;/ssd/personal/baller01/20200511_FernandesM_ME_crukBiSs2020/AnaWiSce/Ana1/ScriptsMkWiC&quot;</code></pre>
<pre><code>## [1] &quot;/ssd/personal/baller01/20200511_FernandesM_ME_crukBiSs2020/AnaWiSce/Ana1/Plots/Qc/novelty_scat_allCells.png&quot;</code></pre>
<div class="sourceCode" id="cb197"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb197-1"><a href="PreProcAllCellsTop.html#cb197-1"></a><span class="co">##ggsave(plot=p, file=tmpFn)</span></span>
<span id="cb197-2"><a href="PreProcAllCellsTop.html#cb197-2"></a></span>
<span id="cb197-3"><a href="PreProcAllCellsTop.html#cb197-3"></a><span class="co"># Novelty</span></span>
<span id="cb197-4"><a href="PreProcAllCellsTop.html#cb197-4"></a><span class="co"># the number of genes per UMI for each cell,</span></span>
<span id="cb197-5"><a href="PreProcAllCellsTop.html#cb197-5"></a><span class="co"># https://hbctraining.github.io/In-depth-NGS-Data-Analysis-Course/sessionIV/lessons/SC_quality_control_analysis.html</span></span>
<span id="cb197-6"><a href="PreProcAllCellsTop.html#cb197-6"></a></span>
<span id="cb197-7"><a href="PreProcAllCellsTop.html#cb197-7"></a><span class="co"># Add number of UMIs per gene for each cell to metadata</span></span>
<span id="cb197-8"><a href="PreProcAllCellsTop.html#cb197-8"></a><span class="kw">colData</span>(sce)<span class="op">$</span>log10GenesPerUMI &lt;-<span class="st"> </span><span class="kw">log10</span>(<span class="kw">colData</span>(sce)<span class="op">$</span>detected) <span class="op">/</span><span class="st"> </span><span class="kw">log10</span>(<span class="kw">colData</span>(sce)<span class="op">$</span>sum)</span></code></pre></div>
<div class="sourceCode" id="cb198"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb198-1"><a href="PreProcAllCellsTop.html#cb198-1"></a><span class="co">#```{r novelty_dens_allCells, cache.lazy = FALSE}</span></span>
<span id="cb198-2"><a href="PreProcAllCellsTop.html#cb198-2"></a><span class="co"># Visualize the overall novelty of the gene expression by visualizing the genes detected per UMI</span></span>
<span id="cb198-3"><a href="PreProcAllCellsTop.html#cb198-3"></a>p &lt;-<span class="st"> </span><span class="kw">colData</span>(sce) <span class="op">%&gt;%</span></span>
<span id="cb198-4"><a href="PreProcAllCellsTop.html#cb198-4"></a><span class="st">    </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span></span>
<span id="cb198-5"><a href="PreProcAllCellsTop.html#cb198-5"></a><span class="st">        </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x=</span>log10GenesPerUMI, <span class="dt">color =</span> source_name, <span class="dt">fill =</span> source_name)) <span class="op">+</span></span>
<span id="cb198-6"><a href="PreProcAllCellsTop.html#cb198-6"></a><span class="st">        </span><span class="kw">geom_density</span>()</span>
<span id="cb198-7"><a href="PreProcAllCellsTop.html#cb198-7"></a>p</span></code></pre></div>
<p><img src="MkWiC_files/figure-html/novelty_dens_allCells-1.png" width="672" /></p>
<div class="sourceCode" id="cb199"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb199-1"><a href="PreProcAllCellsTop.html#cb199-1"></a>tmpFn &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/%s/%s/novelty_dens%s.png&quot;</span>,</span>
<span id="cb199-2"><a href="PreProcAllCellsTop.html#cb199-2"></a>         projDir, outDirBit, qcPlotDirBit, setSuf)</span>
<span id="cb199-3"><a href="PreProcAllCellsTop.html#cb199-3"></a><span class="kw">print</span>(<span class="st">&quot;DEV&quot;</span>); <span class="kw">print</span>(<span class="kw">getwd</span>()); <span class="kw">print</span>(tmpFn)</span></code></pre></div>
<pre><code>## [1] &quot;DEV&quot;</code></pre>
<pre><code>## [1] &quot;/ssd/personal/baller01/20200511_FernandesM_ME_crukBiSs2020/AnaWiSce/Ana1/ScriptsMkWiC&quot;</code></pre>
<pre><code>## [1] &quot;/ssd/personal/baller01/20200511_FernandesM_ME_crukBiSs2020/AnaWiSce/Ana1/Plots/Qc/novelty_dens_allCells.png&quot;</code></pre>
<div class="sourceCode" id="cb203"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb203-1"><a href="PreProcAllCellsTop.html#cb203-1"></a><span class="co">##ggsave(plot=p, file=tmpFn)</span></span></code></pre></div>
<div class="sourceCode" id="cb204"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb204-1"><a href="PreProcAllCellsTop.html#cb204-1"></a><span class="kw">rm</span>(sce)</span></code></pre></div>
</div>
<div id="qc-based-on-sparsity" class="section level2">
<h2><span class="header-section-number">4.14</span> QC based on sparsity</h2>
<p>The approach above identified poor-quality using thresholds on the number of genes detected and mitochondrial content. We will here specifically look at the sparsity of the data, both at the gene and cell levels.</p>
<div id="remove-genes-that-are-not-expressed-at-all" class="section level3">
<h3><span class="header-section-number">4.14.1</span> Remove genes that are not expressed at all</h3>
<p>Genes that are not expressed at all are not informative, so we remove them</p>
<div class="sourceCode" id="cb205"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb205-1"><a href="PreProcAllCellsTop.html#cb205-1"></a>not.expressed &lt;-<span class="st"> </span><span class="kw">rowSums</span>(<span class="kw">counts</span>(scePreQc)) <span class="op">==</span><span class="st"> </span><span class="dv">0</span></span>
<span id="cb205-2"><a href="PreProcAllCellsTop.html#cb205-2"></a></span>
<span id="cb205-3"><a href="PreProcAllCellsTop.html#cb205-3"></a><span class="co"># store the cell-wise information</span></span>
<span id="cb205-4"><a href="PreProcAllCellsTop.html#cb205-4"></a>cols.meta &lt;-<span class="st"> </span><span class="kw">colData</span>(scePreQc)</span>
<span id="cb205-5"><a href="PreProcAllCellsTop.html#cb205-5"></a>rows.meta &lt;-<span class="st"> </span><span class="kw">rowData</span>(scePreQc)</span>
<span id="cb205-6"><a href="PreProcAllCellsTop.html#cb205-6"></a></span>
<span id="cb205-7"><a href="PreProcAllCellsTop.html#cb205-7"></a>nz.counts &lt;-<span class="st"> </span><span class="kw">counts</span>(scePreQc)[<span class="op">!</span>not.expressed, ]</span>
<span id="cb205-8"><a href="PreProcAllCellsTop.html#cb205-8"></a>sce.nz &lt;-<span class="st"> </span><span class="kw">SingleCellExperiment</span>(<span class="kw">list</span>(<span class="dt">counts=</span>nz.counts))</span>
<span id="cb205-9"><a href="PreProcAllCellsTop.html#cb205-9"></a></span>
<span id="cb205-10"><a href="PreProcAllCellsTop.html#cb205-10"></a><span class="co"># reset the column data on the new object</span></span>
<span id="cb205-11"><a href="PreProcAllCellsTop.html#cb205-11"></a><span class="kw">colData</span>(sce.nz) &lt;-<span class="st"> </span>cols.meta</span>
<span id="cb205-12"><a href="PreProcAllCellsTop.html#cb205-12"></a><span class="kw">rowData</span>(sce.nz) &lt;-<span class="st"> </span>rows.meta[<span class="op">!</span>not.expressed, ]</span>
<span id="cb205-13"><a href="PreProcAllCellsTop.html#cb205-13"></a></span>
<span id="cb205-14"><a href="PreProcAllCellsTop.html#cb205-14"></a>sce.nz</span></code></pre></div>
<div class="sourceCode" id="cb206"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb206-1"><a href="PreProcAllCellsTop.html#cb206-1"></a><span class="co"># Write object to file</span></span>
<span id="cb206-2"><a href="PreProcAllCellsTop.html#cb206-2"></a>tmpFn &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/%s/Robjects/sce_nz%s.Rds&quot;</span>,</span>
<span id="cb206-3"><a href="PreProcAllCellsTop.html#cb206-3"></a>         projDir, outDirBit, setSuf)</span>
<span id="cb206-4"><a href="PreProcAllCellsTop.html#cb206-4"></a><span class="kw">saveRDS</span>(sce.nz, tmpFn)</span></code></pre></div>
<div class="sourceCode" id="cb207"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb207-1"><a href="PreProcAllCellsTop.html#cb207-1"></a><span class="co"># Write object to file</span></span>
<span id="cb207-2"><a href="PreProcAllCellsTop.html#cb207-2"></a>tmpFn &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/%s/Robjects/sce_nz%s.Rds&quot;</span>,</span>
<span id="cb207-3"><a href="PreProcAllCellsTop.html#cb207-3"></a>         projDir, outDirBit, setSuf)</span>
<span id="cb207-4"><a href="PreProcAllCellsTop.html#cb207-4"></a>sce.nz &lt;-<span class="st"> </span><span class="kw">readRDS</span>(tmpFn)</span></code></pre></div>
<p>Number of genes 27795.</p>
<p>Number of cells 248854.</p>
</div>
<div id="sparsity-plots" class="section level3">
<h3><span class="header-section-number">4.14.2</span> Sparsity plots</h3>
<p>We will compute:</p>
<ul>
<li>the cell sparsity: for each cell, the proportion of genes that are not detected</li>
<li>the gene sparsity: for each gene, the proportion of cells in which it is not detected</li>
</ul>
<div class="sourceCode" id="cb208"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb208-1"><a href="PreProcAllCellsTop.html#cb208-1"></a><span class="co"># compute - SLOW</span></span>
<span id="cb208-2"><a href="PreProcAllCellsTop.html#cb208-2"></a>cell_sparsity &lt;-<span class="st"> </span><span class="kw">apply</span>(<span class="kw">counts</span>(sce.nz) <span class="op">==</span><span class="st"> </span><span class="dv">0</span>, <span class="dv">2</span>, sum)<span class="op">/</span><span class="kw">nrow</span>(<span class="kw">counts</span>(sce.nz))</span>
<span id="cb208-3"><a href="PreProcAllCellsTop.html#cb208-3"></a>gene_sparsity &lt;-<span class="st"> </span><span class="kw">apply</span>(<span class="kw">counts</span>(sce.nz) <span class="op">==</span><span class="st"> </span><span class="dv">0</span>, <span class="dv">1</span>, sum)<span class="op">/</span><span class="kw">ncol</span>(<span class="kw">counts</span>(sce.nz))</span>
<span id="cb208-4"><a href="PreProcAllCellsTop.html#cb208-4"></a></span>
<span id="cb208-5"><a href="PreProcAllCellsTop.html#cb208-5"></a><span class="kw">colData</span>(sce.nz)<span class="op">$</span>cell_sparsity &lt;-<span class="st"> </span>cell_sparsity</span>
<span id="cb208-6"><a href="PreProcAllCellsTop.html#cb208-6"></a><span class="kw">rowData</span>(sce.nz)<span class="op">$</span>gene_sparsity &lt;-<span class="st"> </span>gene_sparsity</span>
<span id="cb208-7"><a href="PreProcAllCellsTop.html#cb208-7"></a></span>
<span id="cb208-8"><a href="PreProcAllCellsTop.html#cb208-8"></a><span class="co"># write outcome to file for later use</span></span>
<span id="cb208-9"><a href="PreProcAllCellsTop.html#cb208-9"></a>tmpFn &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/%s/Robjects/sce_nz_sparsityCellGene%s.Rds&quot;</span>,</span>
<span id="cb208-10"><a href="PreProcAllCellsTop.html#cb208-10"></a>         projDir, outDirBit, setSuf)</span>
<span id="cb208-11"><a href="PreProcAllCellsTop.html#cb208-11"></a><span class="kw">saveRDS</span>(<span class="kw">list</span>(<span class="st">&quot;colData&quot;</span> =<span class="st"> </span><span class="kw">colData</span>(sce.nz),</span>
<span id="cb208-12"><a href="PreProcAllCellsTop.html#cb208-12"></a>         <span class="st">&quot;rowData&quot;</span> =<span class="st"> </span><span class="kw">rowData</span>(sce.nz)),</span>
<span id="cb208-13"><a href="PreProcAllCellsTop.html#cb208-13"></a>    tmpFn)</span></code></pre></div>
<div class="sourceCode" id="cb209"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb209-1"><a href="PreProcAllCellsTop.html#cb209-1"></a><span class="co"># Read object in:</span></span>
<span id="cb209-2"><a href="PreProcAllCellsTop.html#cb209-2"></a>tmpFn &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/%s/Robjects/sce_nz_sparsityCellGene%s.Rds&quot;</span>,</span>
<span id="cb209-3"><a href="PreProcAllCellsTop.html#cb209-3"></a>         projDir, outDirBit, setSuf)</span>
<span id="cb209-4"><a href="PreProcAllCellsTop.html#cb209-4"></a>tmpList &lt;-<span class="st"> </span><span class="kw">readRDS</span>(tmpFn)</span>
<span id="cb209-5"><a href="PreProcAllCellsTop.html#cb209-5"></a>cell_sparsity &lt;-<span class="st"> </span>tmpList<span class="op">$</span>colData<span class="op">$</span>cell_sparsity</span>
<span id="cb209-6"><a href="PreProcAllCellsTop.html#cb209-6"></a>gene_sparsity &lt;-<span class="st"> </span>tmpList<span class="op">$</span>rowData<span class="op">$</span>gene_sparsity</span></code></pre></div>
<p>We now plot the distribution of these two metrics.</p>
<p>The cell sparsity plot shows that cells have between 85% and 99% 0’s, which is typical.</p>
<p>The gene sparsity plot shows that a large number of genes are almost never detected, which is alo regularly observed.</p>
<div class="sourceCode" id="cb210"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb210-1"><a href="PreProcAllCellsTop.html#cb210-1"></a><span class="co">#```{r sparsity_plot_allCells, eval=runAll}</span></span>
<span id="cb210-2"><a href="PreProcAllCellsTop.html#cb210-2"></a><span class="co"># plot</span></span>
<span id="cb210-3"><a href="PreProcAllCellsTop.html#cb210-3"></a>tmpFn &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/%s/%s/sparsity%s.png&quot;</span>,</span>
<span id="cb210-4"><a href="PreProcAllCellsTop.html#cb210-4"></a>         projDir, outDirBit, qcPlotDirBit, setSuf)</span>
<span id="cb210-5"><a href="PreProcAllCellsTop.html#cb210-5"></a><span class="kw">print</span>(<span class="st">&quot;DEV&quot;</span>); <span class="kw">print</span>(<span class="kw">getwd</span>()); <span class="kw">print</span>(tmpFn)</span></code></pre></div>
<pre><code>## [1] &quot;DEV&quot;</code></pre>
<pre><code>## [1] &quot;/ssd/personal/baller01/20200511_FernandesM_ME_crukBiSs2020/AnaWiSce/Ana1/ScriptsMkWiC&quot;</code></pre>
<pre><code>## [1] &quot;/ssd/personal/baller01/20200511_FernandesM_ME_crukBiSs2020/AnaWiSce/Ana1/Plots/Qc/sparsity_allCells.png&quot;</code></pre>
<div class="sourceCode" id="cb214"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb214-1"><a href="PreProcAllCellsTop.html#cb214-1"></a><span class="co">##png(tmpFn)</span></span>
<span id="cb214-2"><a href="PreProcAllCellsTop.html#cb214-2"></a><span class="co">##par(mfrow=c(1, 2))</span></span>
<span id="cb214-3"><a href="PreProcAllCellsTop.html#cb214-3"></a><span class="co">##hist(cell_sparsity, breaks=50, col=&quot;grey80&quot;, xlab=&quot;Cell sparsity&quot;, main=&quot;&quot;)</span></span>
<span id="cb214-4"><a href="PreProcAllCellsTop.html#cb214-4"></a><span class="co">##hist(gene_sparsity, breaks=50, col=&quot;grey80&quot;, xlab=&quot;Gene sparsity&quot;, main=&quot;&quot;)</span></span>
<span id="cb214-5"><a href="PreProcAllCellsTop.html#cb214-5"></a><span class="co">##abline(v=40, lty=2, col=&#39;purple&#39;)</span></span>
<span id="cb214-6"><a href="PreProcAllCellsTop.html#cb214-6"></a><span class="co">##dev.off()</span></span></code></pre></div>
<div class="sourceCode" id="cb215"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb215-1"><a href="PreProcAllCellsTop.html#cb215-1"></a>tmpFn &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/%s/sparsity%s.png&quot;</span>,</span>
<span id="cb215-2"><a href="PreProcAllCellsTop.html#cb215-2"></a>         dirRel, qcPlotDirBit, setSuf)</span>
<span id="cb215-3"><a href="PreProcAllCellsTop.html#cb215-3"></a>knitr<span class="op">::</span><span class="kw">include_graphics</span>(tmpFn, <span class="dt">auto_pdf =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<p><img src="../Plots/Qc/sparsity_allCells.png" width="80%" /></p>
<div class="sourceCode" id="cb216"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb216-1"><a href="PreProcAllCellsTop.html#cb216-1"></a><span class="kw">rm</span>(tmpFn)</span></code></pre></div>
</div>
<div id="filters" class="section level3">
<h3><span class="header-section-number">4.14.3</span> Filters</h3>
<p>We also remove cells with sparsity higher than 0.99, and/or mitochondrial content higher than 20%.</p>
<p>Genes detected in a few cells only are unlikely to be informative and would hinder normalisation. We will remove genes that are expressed in fewer than 20 cells.</p>
<div class="sourceCode" id="cb217"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb217-1"><a href="PreProcAllCellsTop.html#cb217-1"></a><span class="co"># filter</span></span>
<span id="cb217-2"><a href="PreProcAllCellsTop.html#cb217-2"></a>sparse.cells &lt;-<span class="st"> </span>cell_sparsity <span class="op">&gt;</span><span class="st"> </span><span class="fl">0.99</span></span>
<span id="cb217-3"><a href="PreProcAllCellsTop.html#cb217-3"></a>mito.cells &lt;-<span class="st"> </span>sce.nz<span class="op">$</span>subsets_Mito_percent <span class="op">&gt;</span><span class="st"> </span><span class="dv">20</span></span>
<span id="cb217-4"><a href="PreProcAllCellsTop.html#cb217-4"></a></span>
<span id="cb217-5"><a href="PreProcAllCellsTop.html#cb217-5"></a>min.cells &lt;-<span class="st"> </span><span class="dv">1</span> <span class="op">-</span><span class="st"> </span>(<span class="dv">20</span><span class="op">/</span><span class="kw">length</span>(cell_sparsity))</span>
<span id="cb217-6"><a href="PreProcAllCellsTop.html#cb217-6"></a>sparse.genes &lt;-<span class="st"> </span>gene_sparsity <span class="op">&gt;</span><span class="st"> </span>min.cells</span></code></pre></div>
<p>Number of genes removed:</p>
<div class="sourceCode" id="cb218"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb218-1"><a href="PreProcAllCellsTop.html#cb218-1"></a><span class="kw">table</span>(sparse.genes)</span></code></pre></div>
<pre><code>## sparse.genes
## FALSE  TRUE 
## 21579  6216</code></pre>
<p>Number of cells removed:</p>
<div class="sourceCode" id="cb220"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb220-1"><a href="PreProcAllCellsTop.html#cb220-1"></a><span class="kw">table</span>(sparse.cells, mito.cells)</span></code></pre></div>
<pre><code>##             mito.cells
## sparse.cells  FALSE   TRUE
##        FALSE 244996   1785
##        TRUE    1859    214</code></pre>
<div class="sourceCode" id="cb222"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb222-1"><a href="PreProcAllCellsTop.html#cb222-1"></a><span class="co"># remove cells from the SCE object that are poor quality</span></span>
<span id="cb222-2"><a href="PreProcAllCellsTop.html#cb222-2"></a><span class="co"># remove the sparse genes, then re-set the counts and row data accordingly</span></span>
<span id="cb222-3"><a href="PreProcAllCellsTop.html#cb222-3"></a>cols.meta &lt;-<span class="st"> </span><span class="kw">colData</span>(sce.nz)</span>
<span id="cb222-4"><a href="PreProcAllCellsTop.html#cb222-4"></a>rows.meta &lt;-<span class="st"> </span><span class="kw">rowData</span>(sce.nz)</span>
<span id="cb222-5"><a href="PreProcAllCellsTop.html#cb222-5"></a></span>
<span id="cb222-6"><a href="PreProcAllCellsTop.html#cb222-6"></a>counts.nz &lt;-<span class="st"> </span><span class="kw">counts</span>(sce.nz)[<span class="op">!</span>sparse.genes, <span class="op">!</span>(sparse.cells <span class="op">|</span><span class="st"> </span>mito.cells)]</span>
<span id="cb222-7"><a href="PreProcAllCellsTop.html#cb222-7"></a>sce.nz &lt;-<span class="st"> </span><span class="kw">SingleCellExperiment</span>(<span class="dt">assays=</span><span class="kw">list</span>(<span class="dt">counts=</span>counts.nz))</span>
<span id="cb222-8"><a href="PreProcAllCellsTop.html#cb222-8"></a><span class="kw">colData</span>(sce.nz) &lt;-<span class="st"> </span>cols.meta[<span class="op">!</span>(sparse.cells <span class="op">|</span><span class="st"> </span>mito.cells),]</span>
<span id="cb222-9"><a href="PreProcAllCellsTop.html#cb222-9"></a><span class="kw">rowData</span>(sce.nz) &lt;-<span class="st"> </span>rows.meta[<span class="op">!</span>sparse.genes, ]</span>
<span id="cb222-10"><a href="PreProcAllCellsTop.html#cb222-10"></a>sce.nz</span></code></pre></div>
<div class="sourceCode" id="cb223"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb223-1"><a href="PreProcAllCellsTop.html#cb223-1"></a><span class="co"># Write object to file</span></span>
<span id="cb223-2"><a href="PreProcAllCellsTop.html#cb223-2"></a>tmpFn &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/%s/Robjects/sce_nz_postQc%s.Rds&quot;</span>,</span>
<span id="cb223-3"><a href="PreProcAllCellsTop.html#cb223-3"></a>         projDir, outDirBit, setSuf)</span>
<span id="cb223-4"><a href="PreProcAllCellsTop.html#cb223-4"></a><span class="kw">saveRDS</span>(sce.nz, tmpFn)</span></code></pre></div>
<div class="sourceCode" id="cb224"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb224-1"><a href="PreProcAllCellsTop.html#cb224-1"></a><span class="co"># Read object in:</span></span>
<span id="cb224-2"><a href="PreProcAllCellsTop.html#cb224-2"></a>tmpFn &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/%s/Robjects/sce_nz_postQc%s.Rds&quot;</span>,</span>
<span id="cb224-3"><a href="PreProcAllCellsTop.html#cb224-3"></a>         projDir, outDirBit, setSuf)</span>
<span id="cb224-4"><a href="PreProcAllCellsTop.html#cb224-4"></a><span class="kw">print</span>(<span class="st">&quot;DEV&quot;</span>); <span class="kw">print</span>(<span class="kw">getwd</span>()); <span class="kw">print</span>(tmpFn)</span></code></pre></div>
<pre><code>## [1] &quot;DEV&quot;</code></pre>
<pre><code>## [1] &quot;/ssd/personal/baller01/20200511_FernandesM_ME_crukBiSs2020/AnaWiSce/Ana1/ScriptsMkWiC&quot;</code></pre>
<pre><code>## [1] &quot;/ssd/personal/baller01/20200511_FernandesM_ME_crukBiSs2020/AnaWiSce/Ana1/Robjects/sce_nz_postQc_allCells.Rds&quot;</code></pre>
<div class="sourceCode" id="cb228"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb228-1"><a href="PreProcAllCellsTop.html#cb228-1"></a><span class="co">##sce.nz &lt;- readRDS(tmpFn)</span></span></code></pre></div>
<p>Compare with filter above (mind that the comparison is not fair because we used a less stringent, hard filtering on mitochondrial content):</p>
<div class="sourceCode" id="cb229"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb229-1"><a href="PreProcAllCellsTop.html#cb229-1"></a><span class="kw">table</span>(scePreQc<span class="op">$</span>discard, (sparse.cells <span class="op">|</span><span class="st"> </span>mito.cells))</span></code></pre></div>
<pre><code>##        
##          FALSE   TRUE
##   FALSE 235832   1008
##   TRUE    9164   2850</code></pre>
<div class="sourceCode" id="cb231"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb231-1"><a href="PreProcAllCellsTop.html#cb231-1"></a><span class="kw">rm</span>(scePreQc)</span></code></pre></div>
</div>
<div id="separate-caron-and-hca-batches" class="section level3">
<h3><span class="header-section-number">4.14.4</span> Separate Caron and Hca batches</h3>
<p>We will now check sparsity for each batch separately.</p>
<div class="sourceCode" id="cb232"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb232-1"><a href="PreProcAllCellsTop.html#cb232-1"></a>sce.nz.caron &lt;-<span class="st"> </span>sce.nz[,sce.nz<span class="op">$</span>setName<span class="op">==</span><span class="st">&quot;Caron&quot;</span>]</span>
<span id="cb232-2"><a href="PreProcAllCellsTop.html#cb232-2"></a>sce.nz.hca &lt;-<span class="st"> </span>sce.nz[,sce.nz<span class="op">$</span>setName<span class="op">==</span><span class="st">&quot;Hca&quot;</span>]</span></code></pre></div>
</div>
<div id="caron-only" class="section level3">
<h3><span class="header-section-number">4.14.5</span> Caron only</h3>
<div class="sourceCode" id="cb233"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb233-1"><a href="PreProcAllCellsTop.html#cb233-1"></a>setName &lt;-<span class="st"> &quot;caron&quot;</span></span>
<span id="cb233-2"><a href="PreProcAllCellsTop.html#cb233-2"></a>sce.x &lt;-<span class="st"> </span>sce.nz.caron <span class="co"># for code re-use</span></span>
<span id="cb233-3"><a href="PreProcAllCellsTop.html#cb233-3"></a><span class="kw">rm</span>(sce.nz.caron)</span></code></pre></div>
<div class="sourceCode" id="cb234"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb234-1"><a href="PreProcAllCellsTop.html#cb234-1"></a><span class="co"># compute - SLOW</span></span>
<span id="cb234-2"><a href="PreProcAllCellsTop.html#cb234-2"></a>cell_sparsity &lt;-<span class="st"> </span><span class="kw">apply</span>(<span class="kw">counts</span>(sce.x) <span class="op">==</span><span class="st"> </span><span class="dv">0</span>, <span class="dv">2</span>, sum)<span class="op">/</span><span class="kw">nrow</span>(<span class="kw">counts</span>(sce.x))</span>
<span id="cb234-3"><a href="PreProcAllCellsTop.html#cb234-3"></a>gene_sparsity &lt;-<span class="st"> </span><span class="kw">apply</span>(<span class="kw">counts</span>(sce.x) <span class="op">==</span><span class="st"> </span><span class="dv">0</span>, <span class="dv">1</span>, sum)<span class="op">/</span><span class="kw">ncol</span>(<span class="kw">counts</span>(sce.x))</span>
<span id="cb234-4"><a href="PreProcAllCellsTop.html#cb234-4"></a></span>
<span id="cb234-5"><a href="PreProcAllCellsTop.html#cb234-5"></a><span class="kw">colData</span>(sce.x)<span class="op">$</span>cell_sparsity &lt;-<span class="st"> </span>cell_sparsity</span>
<span id="cb234-6"><a href="PreProcAllCellsTop.html#cb234-6"></a><span class="kw">rowData</span>(sce.x)<span class="op">$</span>gene_sparsity &lt;-<span class="st"> </span>gene_sparsity</span>
<span id="cb234-7"><a href="PreProcAllCellsTop.html#cb234-7"></a></span>
<span id="cb234-8"><a href="PreProcAllCellsTop.html#cb234-8"></a><span class="co"># write outcome to file for later use</span></span>
<span id="cb234-9"><a href="PreProcAllCellsTop.html#cb234-9"></a>tmpFn &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/%s/Robjects/%s_sce_nz_sparsityCellGene%s.Rds&quot;</span>,</span>
<span id="cb234-10"><a href="PreProcAllCellsTop.html#cb234-10"></a>         projDir, outDirBit, setName, setSuf)</span>
<span id="cb234-11"><a href="PreProcAllCellsTop.html#cb234-11"></a><span class="kw">saveRDS</span>(<span class="kw">list</span>(<span class="st">&quot;colData&quot;</span> =<span class="st"> </span><span class="kw">colData</span>(sce.x),</span>
<span id="cb234-12"><a href="PreProcAllCellsTop.html#cb234-12"></a>         <span class="st">&quot;rowData&quot;</span> =<span class="st"> </span><span class="kw">rowData</span>(sce.x)),</span>
<span id="cb234-13"><a href="PreProcAllCellsTop.html#cb234-13"></a>    tmpFn)</span></code></pre></div>
<div class="sourceCode" id="cb235"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb235-1"><a href="PreProcAllCellsTop.html#cb235-1"></a><span class="co"># Read object in:</span></span>
<span id="cb235-2"><a href="PreProcAllCellsTop.html#cb235-2"></a>tmpFn &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/%s/Robjects/%s_sce_nz_sparsityCellGene%s.Rds&quot;</span>,</span>
<span id="cb235-3"><a href="PreProcAllCellsTop.html#cb235-3"></a>         projDir, outDirBit, setName, setSuf)</span>
<span id="cb235-4"><a href="PreProcAllCellsTop.html#cb235-4"></a>tmpList &lt;-<span class="st"> </span><span class="kw">readRDS</span>(tmpFn)</span>
<span id="cb235-5"><a href="PreProcAllCellsTop.html#cb235-5"></a>cell_sparsity &lt;-<span class="st"> </span>tmpList<span class="op">$</span>colData<span class="op">$</span>cell_sparsity</span>
<span id="cb235-6"><a href="PreProcAllCellsTop.html#cb235-6"></a>gene_sparsity &lt;-<span class="st"> </span>tmpList<span class="op">$</span>rowData<span class="op">$</span>gene_sparsity</span></code></pre></div>
<div class="sourceCode" id="cb236"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb236-1"><a href="PreProcAllCellsTop.html#cb236-1"></a><span class="co"># plot</span></span>
<span id="cb236-2"><a href="PreProcAllCellsTop.html#cb236-2"></a>tmpFn &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/%s/%s/%s_sparsity%s.png&quot;</span>,</span>
<span id="cb236-3"><a href="PreProcAllCellsTop.html#cb236-3"></a>         projDir, outDirBit, qcPlotDirBit, setName, setSuf)</span>
<span id="cb236-4"><a href="PreProcAllCellsTop.html#cb236-4"></a><span class="kw">png</span>(tmpFn)</span>
<span id="cb236-5"><a href="PreProcAllCellsTop.html#cb236-5"></a><span class="kw">par</span>(<span class="dt">mfrow=</span><span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb236-6"><a href="PreProcAllCellsTop.html#cb236-6"></a><span class="kw">hist</span>(cell_sparsity, <span class="dt">breaks=</span><span class="dv">50</span>, <span class="dt">col=</span><span class="st">&quot;grey80&quot;</span>, <span class="dt">xlab=</span><span class="st">&quot;Cell sparsity&quot;</span>, <span class="dt">main=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb236-7"><a href="PreProcAllCellsTop.html#cb236-7"></a><span class="kw">hist</span>(gene_sparsity, <span class="dt">breaks=</span><span class="dv">50</span>, <span class="dt">col=</span><span class="st">&quot;grey80&quot;</span>, <span class="dt">xlab=</span><span class="st">&quot;Gene sparsity&quot;</span>, <span class="dt">main=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb236-8"><a href="PreProcAllCellsTop.html#cb236-8"></a><span class="kw">abline</span>(<span class="dt">v=</span><span class="dv">40</span>, <span class="dt">lty=</span><span class="dv">2</span>, <span class="dt">col=</span><span class="st">&#39;purple&#39;</span>)</span>
<span id="cb236-9"><a href="PreProcAllCellsTop.html#cb236-9"></a><span class="kw">dev.off</span>()</span></code></pre></div>
<div class="sourceCode" id="cb237"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb237-1"><a href="PreProcAllCellsTop.html#cb237-1"></a>tmpFn &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/%s/%s_sparsity%s.png&quot;</span>,</span>
<span id="cb237-2"><a href="PreProcAllCellsTop.html#cb237-2"></a>         dirRel, qcPlotDirBit, setName, setSuf)</span>
<span id="cb237-3"><a href="PreProcAllCellsTop.html#cb237-3"></a>knitr<span class="op">::</span><span class="kw">include_graphics</span>(tmpFn, <span class="dt">auto_pdf =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<p><img src="../Plots/Qc/caron_sparsity_allCells.png" width="80%" /></p>
<div class="sourceCode" id="cb238"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb238-1"><a href="PreProcAllCellsTop.html#cb238-1"></a><span class="kw">rm</span>(tmpFn)</span></code></pre></div>
<div class="sourceCode" id="cb239"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb239-1"><a href="PreProcAllCellsTop.html#cb239-1"></a><span class="co"># filter</span></span>
<span id="cb239-2"><a href="PreProcAllCellsTop.html#cb239-2"></a>sparse.cells &lt;-<span class="st"> </span>cell_sparsity <span class="op">&gt;</span><span class="st"> </span><span class="fl">0.99</span></span>
<span id="cb239-3"><a href="PreProcAllCellsTop.html#cb239-3"></a>mito.cells &lt;-<span class="st"> </span>sce.x<span class="op">$</span>subsets_Mito_percent <span class="op">&gt;</span><span class="st"> </span><span class="dv">20</span></span>
<span id="cb239-4"><a href="PreProcAllCellsTop.html#cb239-4"></a></span>
<span id="cb239-5"><a href="PreProcAllCellsTop.html#cb239-5"></a>min.cells &lt;-<span class="st"> </span><span class="dv">1</span> <span class="op">-</span><span class="st"> </span>(<span class="dv">20</span><span class="op">/</span><span class="kw">length</span>(cell_sparsity))</span>
<span id="cb239-6"><a href="PreProcAllCellsTop.html#cb239-6"></a>sparse.genes &lt;-<span class="st"> </span>gene_sparsity <span class="op">&gt;</span><span class="st"> </span>min.cells</span></code></pre></div>
<div class="sourceCode" id="cb240"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb240-1"><a href="PreProcAllCellsTop.html#cb240-1"></a><span class="co"># remove cells from the SCE object that are poor quality</span></span>
<span id="cb240-2"><a href="PreProcAllCellsTop.html#cb240-2"></a><span class="co"># remove the sparse genes, then re-set the counts and row data accordingly</span></span>
<span id="cb240-3"><a href="PreProcAllCellsTop.html#cb240-3"></a>cols.meta &lt;-<span class="st"> </span><span class="kw">colData</span>(sce.x)</span>
<span id="cb240-4"><a href="PreProcAllCellsTop.html#cb240-4"></a>rows.meta &lt;-<span class="st"> </span><span class="kw">rowData</span>(sce.x)</span>
<span id="cb240-5"><a href="PreProcAllCellsTop.html#cb240-5"></a></span>
<span id="cb240-6"><a href="PreProcAllCellsTop.html#cb240-6"></a>counts.x &lt;-<span class="st"> </span><span class="kw">counts</span>(sce.x)[<span class="op">!</span>sparse.genes, <span class="op">!</span>(sparse.cells <span class="op">|</span><span class="st"> </span>mito.cells)]</span>
<span id="cb240-7"><a href="PreProcAllCellsTop.html#cb240-7"></a>sce.x &lt;-<span class="st"> </span><span class="kw">SingleCellExperiment</span>(<span class="dt">assays=</span><span class="kw">list</span>(<span class="dt">counts=</span>counts.x))</span>
<span id="cb240-8"><a href="PreProcAllCellsTop.html#cb240-8"></a><span class="kw">colData</span>(sce.x) &lt;-<span class="st"> </span>cols.meta[<span class="op">!</span>(sparse.cells <span class="op">|</span><span class="st"> </span>mito.cells),]</span>
<span id="cb240-9"><a href="PreProcAllCellsTop.html#cb240-9"></a><span class="kw">rowData</span>(sce.x) &lt;-<span class="st"> </span>rows.meta[<span class="op">!</span>sparse.genes, ]</span>
<span id="cb240-10"><a href="PreProcAllCellsTop.html#cb240-10"></a>sce.x</span></code></pre></div>
<p>We write the R object to caron_sce_nz_postQc_allCells.Rds.</p>
<div class="sourceCode" id="cb241"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb241-1"><a href="PreProcAllCellsTop.html#cb241-1"></a><span class="co"># Write object to file</span></span>
<span id="cb241-2"><a href="PreProcAllCellsTop.html#cb241-2"></a>tmpFn &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/%s/Robjects/%s_sce_nz_postQc%s.Rds&quot;</span>,</span>
<span id="cb241-3"><a href="PreProcAllCellsTop.html#cb241-3"></a>         projDir, outDirBit, setName, setSuf)</span>
<span id="cb241-4"><a href="PreProcAllCellsTop.html#cb241-4"></a><span class="kw">saveRDS</span>(sce.x, tmpFn)</span>
<span id="cb241-5"><a href="PreProcAllCellsTop.html#cb241-5"></a></span>
<span id="cb241-6"><a href="PreProcAllCellsTop.html#cb241-6"></a><span class="co"># rename to sce.nz.caron</span></span>
<span id="cb241-7"><a href="PreProcAllCellsTop.html#cb241-7"></a>sce.nz.caron &lt;-<span class="st"> </span>sce.x <span class="co"># </span><span class="al">TODO</span><span class="co"> sce.nz.caron not used</span></span>
<span id="cb241-8"><a href="PreProcAllCellsTop.html#cb241-8"></a><span class="kw">rm</span>(sce.x)</span></code></pre></div>
<div class="sourceCode" id="cb242"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb242-1"><a href="PreProcAllCellsTop.html#cb242-1"></a><span class="co"># Read object in:</span></span>
<span id="cb242-2"><a href="PreProcAllCellsTop.html#cb242-2"></a>tmpFn &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/%s/Robjects/%s_sce_nz_postQc%s.Rds&quot;</span>,</span>
<span id="cb242-3"><a href="PreProcAllCellsTop.html#cb242-3"></a>         projDir, outDirBit, setName, setSuf)</span>
<span id="cb242-4"><a href="PreProcAllCellsTop.html#cb242-4"></a>sce.nz.caron &lt;-<span class="st"> </span><span class="kw">readRDS</span>(tmpFn)</span></code></pre></div>
</div>
<div id="hca-only" class="section level3">
<h3><span class="header-section-number">4.14.6</span> Hca only</h3>
<div class="sourceCode" id="cb243"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb243-1"><a href="PreProcAllCellsTop.html#cb243-1"></a>setName &lt;-<span class="st"> &quot;hca&quot;</span></span>
<span id="cb243-2"><a href="PreProcAllCellsTop.html#cb243-2"></a>sce.x &lt;-<span class="st"> </span>sce.nz.hca <span class="co"># for code re-use</span></span>
<span id="cb243-3"><a href="PreProcAllCellsTop.html#cb243-3"></a><span class="kw">rm</span>(sce.nz.hca)</span></code></pre></div>
<div class="sourceCode" id="cb244"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb244-1"><a href="PreProcAllCellsTop.html#cb244-1"></a><span class="co"># compute - SLOW</span></span>
<span id="cb244-2"><a href="PreProcAllCellsTop.html#cb244-2"></a>cell_sparsity &lt;-<span class="st"> </span><span class="kw">apply</span>(<span class="kw">counts</span>(sce.x) <span class="op">==</span><span class="st"> </span><span class="dv">0</span>, <span class="dv">2</span>, sum)<span class="op">/</span><span class="kw">nrow</span>(<span class="kw">counts</span>(sce.x))</span>
<span id="cb244-3"><a href="PreProcAllCellsTop.html#cb244-3"></a>gene_sparsity &lt;-<span class="st"> </span><span class="kw">apply</span>(<span class="kw">counts</span>(sce.x) <span class="op">==</span><span class="st"> </span><span class="dv">0</span>, <span class="dv">1</span>, sum)<span class="op">/</span><span class="kw">ncol</span>(<span class="kw">counts</span>(sce.x))</span>
<span id="cb244-4"><a href="PreProcAllCellsTop.html#cb244-4"></a></span>
<span id="cb244-5"><a href="PreProcAllCellsTop.html#cb244-5"></a><span class="kw">colData</span>(sce.x)<span class="op">$</span>cell_sparsity &lt;-<span class="st"> </span>cell_sparsity</span>
<span id="cb244-6"><a href="PreProcAllCellsTop.html#cb244-6"></a><span class="kw">rowData</span>(sce.x)<span class="op">$</span>gene_sparsity &lt;-<span class="st"> </span>gene_sparsity</span>
<span id="cb244-7"><a href="PreProcAllCellsTop.html#cb244-7"></a></span>
<span id="cb244-8"><a href="PreProcAllCellsTop.html#cb244-8"></a><span class="co"># write outcome to file for later use</span></span>
<span id="cb244-9"><a href="PreProcAllCellsTop.html#cb244-9"></a>tmpFn &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/%s/Robjects/%s_sce_nz_sparsityCellGene%s.Rds&quot;</span>,</span>
<span id="cb244-10"><a href="PreProcAllCellsTop.html#cb244-10"></a>         projDir, outDirBit, setName, setSuf)</span>
<span id="cb244-11"><a href="PreProcAllCellsTop.html#cb244-11"></a><span class="kw">saveRDS</span>(<span class="kw">list</span>(<span class="st">&quot;colData&quot;</span> =<span class="st"> </span><span class="kw">colData</span>(sce.x),</span>
<span id="cb244-12"><a href="PreProcAllCellsTop.html#cb244-12"></a>         <span class="st">&quot;rowData&quot;</span> =<span class="st"> </span><span class="kw">rowData</span>(sce.x)),</span>
<span id="cb244-13"><a href="PreProcAllCellsTop.html#cb244-13"></a>    tmpFn)</span></code></pre></div>
<div class="sourceCode" id="cb245"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb245-1"><a href="PreProcAllCellsTop.html#cb245-1"></a><span class="co"># Read object in:</span></span>
<span id="cb245-2"><a href="PreProcAllCellsTop.html#cb245-2"></a>tmpFn &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/%s/Robjects/%s_sce_nz_sparsityCellGene%s.Rds&quot;</span>,</span>
<span id="cb245-3"><a href="PreProcAllCellsTop.html#cb245-3"></a>         projDir, outDirBit, setName, setSuf)</span>
<span id="cb245-4"><a href="PreProcAllCellsTop.html#cb245-4"></a>tmpList &lt;-<span class="st"> </span><span class="kw">readRDS</span>(tmpFn)</span>
<span id="cb245-5"><a href="PreProcAllCellsTop.html#cb245-5"></a>cell_sparsity &lt;-<span class="st"> </span>tmpList<span class="op">$</span>colData<span class="op">$</span>cell_sparsity</span>
<span id="cb245-6"><a href="PreProcAllCellsTop.html#cb245-6"></a>gene_sparsity &lt;-<span class="st"> </span>tmpList<span class="op">$</span>rowData<span class="op">$</span>gene_sparsity</span></code></pre></div>
<div class="sourceCode" id="cb246"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb246-1"><a href="PreProcAllCellsTop.html#cb246-1"></a><span class="co">#```{r Hca_sparsity_plot_allCells, eval=runAll}</span></span>
<span id="cb246-2"><a href="PreProcAllCellsTop.html#cb246-2"></a><span class="co"># plot</span></span>
<span id="cb246-3"><a href="PreProcAllCellsTop.html#cb246-3"></a>tmpFn &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/%s/%s/%s_sparsity%s.png&quot;</span>,</span>
<span id="cb246-4"><a href="PreProcAllCellsTop.html#cb246-4"></a>                 projDir, outDirBit, qcPlotDirBit, setName, setSuf)</span>
<span id="cb246-5"><a href="PreProcAllCellsTop.html#cb246-5"></a><span class="kw">print</span>(<span class="st">&quot;DEV&quot;</span>); <span class="kw">print</span>(<span class="kw">getwd</span>()); <span class="kw">print</span>(tmpFn)</span></code></pre></div>
<pre><code>## [1] &quot;DEV&quot;</code></pre>
<pre><code>## [1] &quot;/ssd/personal/baller01/20200511_FernandesM_ME_crukBiSs2020/AnaWiSce/Ana1/ScriptsMkWiC&quot;</code></pre>
<pre><code>## [1] &quot;/ssd/personal/baller01/20200511_FernandesM_ME_crukBiSs2020/AnaWiSce/Ana1/Plots/Qc/hca_sparsity_allCells.png&quot;</code></pre>
<div class="sourceCode" id="cb250"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb250-1"><a href="PreProcAllCellsTop.html#cb250-1"></a><span class="co">##png(tmpFn)</span></span>
<span id="cb250-2"><a href="PreProcAllCellsTop.html#cb250-2"></a><span class="co">##par(mfrow=c(1, 2))</span></span>
<span id="cb250-3"><a href="PreProcAllCellsTop.html#cb250-3"></a><span class="co">##hist(cell_sparsity, breaks=50, col=&quot;grey80&quot;, xlab=&quot;Cell sparsity&quot;, main=&quot;&quot;)</span></span>
<span id="cb250-4"><a href="PreProcAllCellsTop.html#cb250-4"></a><span class="co">##hist(gene_sparsity, breaks=50, col=&quot;grey80&quot;, xlab=&quot;Gene sparsity&quot;, main=&quot;&quot;)</span></span>
<span id="cb250-5"><a href="PreProcAllCellsTop.html#cb250-5"></a><span class="co">##abline(v=40, lty=2, col=&#39;purple&#39;)</span></span>
<span id="cb250-6"><a href="PreProcAllCellsTop.html#cb250-6"></a><span class="co">##dev.off()</span></span></code></pre></div>
<div class="sourceCode" id="cb251"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb251-1"><a href="PreProcAllCellsTop.html#cb251-1"></a><span class="co">#tmpFn &lt;- sprintf(&quot;%s/%s/%s/%s_sparsity.png&quot;, projDir, outDirBit, qcPlotDirBit, setName)</span></span>
<span id="cb251-2"><a href="PreProcAllCellsTop.html#cb251-2"></a>tmpFn &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/%s/%s_sparsity%s.png&quot;</span>,</span>
<span id="cb251-3"><a href="PreProcAllCellsTop.html#cb251-3"></a>         dirRel, qcPlotDirBit, setName, setSuf)</span>
<span id="cb251-4"><a href="PreProcAllCellsTop.html#cb251-4"></a>knitr<span class="op">::</span><span class="kw">include_graphics</span>(tmpFn, <span class="dt">auto_pdf =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<p><img src="../Plots/Qc/hca_sparsity_allCells.png" width="80%" /></p>
<div class="sourceCode" id="cb252"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb252-1"><a href="PreProcAllCellsTop.html#cb252-1"></a><span class="kw">rm</span>(tmpFn)</span></code></pre></div>
<div class="sourceCode" id="cb253"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb253-1"><a href="PreProcAllCellsTop.html#cb253-1"></a><span class="co"># filter</span></span>
<span id="cb253-2"><a href="PreProcAllCellsTop.html#cb253-2"></a>sparse.cells &lt;-<span class="st"> </span>cell_sparsity <span class="op">&gt;</span><span class="st"> </span><span class="fl">0.99</span></span>
<span id="cb253-3"><a href="PreProcAllCellsTop.html#cb253-3"></a>mito.cells &lt;-<span class="st"> </span>sce.x<span class="op">$</span>subsets_Mito_percent <span class="op">&gt;</span><span class="st"> </span><span class="dv">20</span></span>
<span id="cb253-4"><a href="PreProcAllCellsTop.html#cb253-4"></a></span>
<span id="cb253-5"><a href="PreProcAllCellsTop.html#cb253-5"></a>min.cells &lt;-<span class="st"> </span><span class="dv">1</span> <span class="op">-</span><span class="st"> </span>(<span class="dv">20</span><span class="op">/</span><span class="kw">length</span>(cell_sparsity))</span>
<span id="cb253-6"><a href="PreProcAllCellsTop.html#cb253-6"></a>sparse.genes &lt;-<span class="st"> </span>gene_sparsity <span class="op">&gt;</span><span class="st"> </span>min.cells</span></code></pre></div>
<div class="sourceCode" id="cb254"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb254-1"><a href="PreProcAllCellsTop.html#cb254-1"></a><span class="co"># remove cells from the SCE object that are poor quality</span></span>
<span id="cb254-2"><a href="PreProcAllCellsTop.html#cb254-2"></a><span class="co"># remove the sparse genes, then re-set the counts and row data accordingly</span></span>
<span id="cb254-3"><a href="PreProcAllCellsTop.html#cb254-3"></a>cols.meta &lt;-<span class="st"> </span><span class="kw">colData</span>(sce.x)</span>
<span id="cb254-4"><a href="PreProcAllCellsTop.html#cb254-4"></a>rows.meta &lt;-<span class="st"> </span><span class="kw">rowData</span>(sce.x)</span>
<span id="cb254-5"><a href="PreProcAllCellsTop.html#cb254-5"></a></span>
<span id="cb254-6"><a href="PreProcAllCellsTop.html#cb254-6"></a>counts.x &lt;-<span class="st"> </span><span class="kw">counts</span>(sce.x)[<span class="op">!</span>sparse.genes, <span class="op">!</span>(sparse.cells <span class="op">|</span><span class="st"> </span>mito.cells)]</span>
<span id="cb254-7"><a href="PreProcAllCellsTop.html#cb254-7"></a>sce.x &lt;-<span class="st"> </span><span class="kw">SingleCellExperiment</span>(<span class="dt">assays=</span><span class="kw">list</span>(<span class="dt">counts=</span>counts.x))</span>
<span id="cb254-8"><a href="PreProcAllCellsTop.html#cb254-8"></a><span class="kw">colData</span>(sce.x) &lt;-<span class="st"> </span>cols.meta[<span class="op">!</span>(sparse.cells <span class="op">|</span><span class="st"> </span>mito.cells),]</span>
<span id="cb254-9"><a href="PreProcAllCellsTop.html#cb254-9"></a><span class="kw">rowData</span>(sce.x) &lt;-<span class="st"> </span>rows.meta[<span class="op">!</span>sparse.genes, ]</span>
<span id="cb254-10"><a href="PreProcAllCellsTop.html#cb254-10"></a>sce.x</span></code></pre></div>
<p>We write the R object to hca_sce_nz_postQc_allCells.Rds.</p>
<div class="sourceCode" id="cb255"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb255-1"><a href="PreProcAllCellsTop.html#cb255-1"></a><span class="co"># Write object to file</span></span>
<span id="cb255-2"><a href="PreProcAllCellsTop.html#cb255-2"></a>tmpFn &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/%s/Robjects/%s_sce_nz_postQc%s.Rds&quot;</span>,</span>
<span id="cb255-3"><a href="PreProcAllCellsTop.html#cb255-3"></a>         projDir, outDirBit, setName, setSuf)</span>
<span id="cb255-4"><a href="PreProcAllCellsTop.html#cb255-4"></a><span class="kw">saveRDS</span>(sce.x, tmpFn)</span>
<span id="cb255-5"><a href="PreProcAllCellsTop.html#cb255-5"></a></span>
<span id="cb255-6"><a href="PreProcAllCellsTop.html#cb255-6"></a><span class="co"># rename to sce.nz.hca</span></span>
<span id="cb255-7"><a href="PreProcAllCellsTop.html#cb255-7"></a>sce.nz.hca &lt;-<span class="st"> </span>sce.x <span class="co"># </span><span class="al">TODO</span><span class="co"> sce.nz.hca only used for sce.nz.hca.5k</span></span>
<span id="cb255-8"><a href="PreProcAllCellsTop.html#cb255-8"></a><span class="kw">rm</span>(sce.x)</span></code></pre></div>
<div class="sourceCode" id="cb256"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb256-1"><a href="PreProcAllCellsTop.html#cb256-1"></a><span class="co"># Read object in:</span></span>
<span id="cb256-2"><a href="PreProcAllCellsTop.html#cb256-2"></a>tmpFn &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/%s/Robjects/%s_sce_nz_postQc%s.Rds&quot;</span>,</span>
<span id="cb256-3"><a href="PreProcAllCellsTop.html#cb256-3"></a>         projDir, outDirBit, setName, setSuf)</span>
<span id="cb256-4"><a href="PreProcAllCellsTop.html#cb256-4"></a>sce.nz.hca &lt;-<span class="st"> </span><span class="kw">readRDS</span>(tmpFn)</span></code></pre></div>
</div>
</div>
<div id="subsample-hca-set" class="section level2">
<h2><span class="header-section-number">4.15</span> Subsample Hca set</h2>
<p>The HCA data comprises about 25,000 cells per samples, compared to 5,000 for the Caron study. We will randomly subsample the HCA samples down to 5000 cells.</p>
<div class="sourceCode" id="cb257"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb257-1"><a href="PreProcAllCellsTop.html#cb257-1"></a>sce.nz.hca</span>
<span id="cb257-2"><a href="PreProcAllCellsTop.html#cb257-2"></a></span>
<span id="cb257-3"><a href="PreProcAllCellsTop.html#cb257-3"></a><span class="co"># have new list of cell barcodes for each sample</span></span>
<span id="cb257-4"><a href="PreProcAllCellsTop.html#cb257-4"></a>sce.nz.hca<span class="fl">.5</span>k.bc &lt;-<span class="st"> </span><span class="kw">colData</span>(sce.nz.hca) <span class="op">%&gt;%</span></span>
<span id="cb257-5"><a href="PreProcAllCellsTop.html#cb257-5"></a><span class="st">    </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span></span>
<span id="cb257-6"><a href="PreProcAllCellsTop.html#cb257-6"></a><span class="st">    </span><span class="kw">group_by</span>(Sample.Name) <span class="op">%&gt;%</span></span>
<span id="cb257-7"><a href="PreProcAllCellsTop.html#cb257-7"></a><span class="st">    </span><span class="kw">sample_n</span>(<span class="dv">5000</span>) <span class="op">%&gt;%</span></span>
<span id="cb257-8"><a href="PreProcAllCellsTop.html#cb257-8"></a><span class="st">    </span><span class="kw">pull</span>(Barcode)</span>
<span id="cb257-9"><a href="PreProcAllCellsTop.html#cb257-9"></a></span>
<span id="cb257-10"><a href="PreProcAllCellsTop.html#cb257-10"></a><span class="kw">table</span>(<span class="kw">colData</span>(sce.nz.hca)<span class="op">$</span>Barcode <span class="op">%in%</span><span class="st"> </span>sce.nz.hca<span class="fl">.5</span>k.bc)</span>
<span id="cb257-11"><a href="PreProcAllCellsTop.html#cb257-11"></a>tmpInd &lt;-<span class="st"> </span><span class="kw">which</span>(<span class="kw">colData</span>(sce.nz.hca)<span class="op">$</span>Barcode <span class="op">%in%</span><span class="st"> </span>sce.nz.hca<span class="fl">.5</span>k.bc)</span>
<span id="cb257-12"><a href="PreProcAllCellsTop.html#cb257-12"></a></span>
<span id="cb257-13"><a href="PreProcAllCellsTop.html#cb257-13"></a>sce.nz.hca<span class="fl">.5</span>k &lt;-<span class="st"> </span>sce.nz.hca[,tmpInd]</span>
<span id="cb257-14"><a href="PreProcAllCellsTop.html#cb257-14"></a></span>
<span id="cb257-15"><a href="PreProcAllCellsTop.html#cb257-15"></a><span class="co"># mind that genes were filtered using all cells, not just those sampled here.</span></span></code></pre></div>
<p>We write the R object to ‘hca_sce_nz_postQc_5kCellPerSpl.Rds’.</p>
<div class="sourceCode" id="cb258"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb258-1"><a href="PreProcAllCellsTop.html#cb258-1"></a><span class="co"># Write object to file</span></span>
<span id="cb258-2"><a href="PreProcAllCellsTop.html#cb258-2"></a>tmpFn &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/%s/Robjects/%s_sce_nz_postQc_5kCellPerSpl.Rds&quot;</span>, projDir, outDirBit, setName)</span>
<span id="cb258-3"><a href="PreProcAllCellsTop.html#cb258-3"></a><span class="kw">saveRDS</span>(sce.nz.hca<span class="fl">.5</span>k, tmpFn)</span></code></pre></div>
<div class="sourceCode" id="cb259"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb259-1"><a href="PreProcAllCellsTop.html#cb259-1"></a><span class="kw">rm</span>(sce.nz.hca)</span>
<span id="cb259-2"><a href="PreProcAllCellsTop.html#cb259-2"></a><span class="kw">rm</span>(sce.nz.hca<span class="fl">.5</span>k)</span>
<span id="cb259-3"><a href="PreProcAllCellsTop.html#cb259-3"></a><span class="kw">gc</span>()</span></code></pre></div>
<pre><code>##              used    (Mb) gc trigger    (Mb)   max used    (Mb)
## Ncells    9519624   508.5   16305648   870.9   16305648   870.9
## Vcells 1421357338 10844.1 2765812427 21101.5 2297115936 17525.7</code></pre>
</div>
<div id="session-information" class="section level2">
<h2><span class="header-section-number">4.16</span> Session information</h2>
<div class="sourceCode" id="cb261"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb261-1"><a href="PreProcAllCellsTop.html#cb261-1"></a><span class="kw">sessionInfo</span>()</span></code></pre></div>
<pre><code>## R version 4.0.3 (2020-10-10)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: CentOS Linux 8
## 
## Matrix products: default
## BLAS:   /opt/R/R-4.0.3/lib64/R/lib/libRblas.so
## LAPACK: /opt/R/R-4.0.3/lib64/R/lib/libRlapack.so
## 
## locale:
##  [1] LC_CTYPE=en_GB.UTF-8       LC_NUMERIC=C              
##  [3] LC_TIME=en_GB.UTF-8        LC_COLLATE=en_GB.UTF-8    
##  [5] LC_MONETARY=en_GB.UTF-8    LC_MESSAGES=en_GB.UTF-8   
##  [7] LC_PAPER=en_GB.UTF-8       LC_NAME=C                 
##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            
## [11] LC_MEASUREMENT=en_GB.UTF-8 LC_IDENTIFICATION=C       
## 
## attached base packages:
## [1] stats4    parallel  stats     graphics  grDevices utils     datasets 
## [8] methods   base     
## 
## other attached packages:
##  [1] BiocSingular_1.6.0          scuttle_1.0.4              
##  [3] robustbase_0.93-7           mixtools_1.2.0             
##  [5] irlba_2.3.3                 biomaRt_2.46.3             
##  [7] Matrix_1.2-18               igraph_1.2.6               
##  [9] DropletUtils_1.10.3         scater_1.18.6              
## [11] ggplot2_3.3.3               scran_1.18.7               
## [13] SingleCellExperiment_1.12.0 SummarizedExperiment_1.20.0
## [15] Biobase_2.50.0              GenomicRanges_1.42.0       
## [17] GenomeInfoDb_1.26.7         IRanges_2.24.1             
## [19] S4Vectors_0.28.1            BiocGenerics_0.36.1        
## [21] MatrixGenerics_1.2.1        matrixStats_0.58.0         
## [23] dplyr_1.0.5                 DT_0.18                    
## [25] knitr_1.32                 
## 
## loaded via a namespace (and not attached):
##   [1] BiocFileCache_1.14.0      splines_4.0.3            
##   [3] BiocParallel_1.24.1       crosstalk_1.1.1          
##   [5] digest_0.6.27             htmltools_0.5.1.1        
##   [7] viridis_0.5.1             fansi_0.4.2              
##   [9] magrittr_2.0.1            memoise_2.0.0            
##  [11] limma_3.46.0              readr_1.4.0              
##  [13] R.utils_2.10.1            askpass_1.1              
##  [15] prettyunits_1.1.1         colorspace_2.0-0         
##  [17] blob_1.2.1                rappdirs_0.3.1           
##  [19] xfun_0.22                 crayon_1.4.1             
##  [21] RCurl_1.98-1.3            jsonlite_1.7.2           
##  [23] survival_3.2-7            glue_1.4.2               
##  [25] gtable_0.3.0              zlibbioc_1.36.0          
##  [27] XVector_0.30.0            DelayedArray_0.16.3      
##  [29] kernlab_0.9-29            Rhdf5lib_1.12.1          
##  [31] DEoptimR_1.0-8            HDF5Array_1.18.1         
##  [33] scales_1.1.1              DBI_1.1.1                
##  [35] edgeR_3.32.1              miniUI_0.1.1.1           
##  [37] Rcpp_1.0.6                isoband_0.2.4            
##  [39] xtable_1.8-4              viridisLite_0.3.0        
##  [41] progress_1.2.2            dqrng_0.2.1              
##  [43] bit_4.0.4                 rsvd_1.0.3               
##  [45] htmlwidgets_1.5.3         httr_1.4.2               
##  [47] ellipsis_0.3.1            pkgconfig_2.0.3          
##  [49] XML_3.99-0.5              R.methodsS3_1.8.1        
##  [51] farver_2.1.0              sass_0.3.1               
##  [53] dbplyr_2.0.0              locfit_1.5-9.4           
##  [55] utf8_1.2.1                later_1.1.0.1            
##  [57] tidyselect_1.1.0          labeling_0.4.2           
##  [59] rlang_0.4.10              AnnotationDbi_1.52.0     
##  [61] munsell_0.5.0             tools_4.0.3              
##  [63] cachem_1.0.4              generics_0.1.0           
##  [65] RSQLite_2.2.6             evaluate_0.14            
##  [67] stringr_1.4.0             fastmap_1.1.0            
##  [69] yaml_2.2.1                bit64_4.0.5              
##  [71] purrr_0.3.4               nlme_3.1-149             
##  [73] sparseMatrixStats_1.2.1   mime_0.10                
##  [75] R.oo_1.24.0               ggExtra_0.9              
##  [77] xml2_1.3.2                compiler_4.0.3           
##  [79] rstudioapi_0.13           beeswarm_0.2.3           
##  [81] curl_4.3                  tibble_3.1.1             
##  [83] statmod_1.4.35            bslib_0.2.4              
##  [85] stringi_1.5.3             highr_0.8                
##  [87] lattice_0.20-41           bluster_1.0.0            
##  [89] vctrs_0.3.7               pillar_1.6.0             
##  [91] lifecycle_1.0.0           rhdf5filters_1.2.0       
##  [93] jquerylib_0.1.3           BiocNeighbors_1.8.2      
##  [95] cowplot_1.1.1             bitops_1.0-6             
##  [97] httpuv_1.5.5              R6_2.5.0                 
##  [99] promises_1.1.1            bookdown_0.21            
## [101] gridExtra_2.3             vipor_0.4.5              
## [103] codetools_0.2-16          MASS_7.3-53              
## [105] assertthat_0.2.1          rhdf5_2.34.0             
## [107] openssl_1.4.3             withr_2.4.2              
## [109] GenomeInfoDbData_1.2.4    mgcv_1.8-33              
## [111] hms_1.0.0                 grid_4.0.3               
## [113] beachmat_2.6.4            rmarkdown_2.7            
## [115] DelayedMatrixStats_1.12.3 segmented_1.3-3          
## [117] shiny_1.5.0               ggbeeswarm_0.6.0</code></pre>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="AliFeatCountTop.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="PreProcTop.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/rstudio/bookdown-demo/edit/master/preProcAllCells.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["MkWiC.pdf", "MkWiC.epub"],
"toc": {
"collapse": "subsection",
"scroll_highlight": true
},
"code_folding": "hide"
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
